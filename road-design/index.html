<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÅìË∑ØË©≥Á¥∞Ë®≠Ë®àÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* „Çø„Çπ„ÇØ„Ç¢„Ç§„ÉÜ„É†„ÅÆÊîπÂñÑ */
        .task-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .task-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .task-status-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .task-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .task-overdue {
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .task-meta {
            margin-bottom: 1rem;
        }

        .task-meta-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .task-assignee, .task-date {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
            color: #666;
        }

        .task-date.overdue {
            color: #dc3545;
            font-weight: 600;
        }

        .task-flags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .flag {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .flag.technical {
            background: #e3f2fd;
            color: #1976d2;
        }

        .flag.manual {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .task-actions {
            display: flex;
            justify-content: flex-end;
        }

        .btn-edit {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-edit:hover {
            background: #0056b3;
        }

        /* „Ç¢„Ç§„Ç≥„É≥ */
        .icon-user::before { content: "üë§ "; }
        .icon-calendar::before { content: "üìÖ "; }
        .icon-edit::before { content: "‚úèÔ∏è "; }

        /* „Çπ„ÉÜ„Éº„Çø„ÇπËâ≤ */
        .status-not-started {
            background: #f8f9fa;
            color: #6c757d;
        }

        .status-in-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-not-applicable {
            background: #f8d7da;
            color: #721c24;
        }

        /* Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„É¢„Éº„ÉÄ„É´ */
        .project-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 0 20px; /* Â∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíËøΩÂä† */
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 0 1rem 1rem 1rem; /* Â∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíËøΩÂä† */
            border-bottom: 1px solid #e0e0e0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.1rem;
        }

        /* „É¢„Éº„ÉÄ„É´„Éò„ÉÉ„ÉÄ„Éº„Å®„Éï„ÉÉ„Çø„Éº„ÅÆ‰ΩôÁôΩ */
        .modal-header {
            padding: 1rem 1.5rem; /* Â∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíÂ¢óÂä† */
        }

        .modal-footer {
            padding: 1rem 1.5rem; /* Â∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíÂ¢óÂä† */
        }

        .template-selection {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }

        .template-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .template-filters .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .template-filters .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .template-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .template-groups {
            padding: 1rem;
        }

        .template-group {
            margin-bottom: 1.5rem;
        }

        .template-group:last-child {
            margin-bottom: 0;
        }

        .phase-title {
            margin: 0 0 0.75rem 0;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.5rem;
            background: #e9ecef;
            border-radius: 4px;
        }

        .template-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .template-item {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.75rem;
            background: white;
            transition: all 0.2s ease;
        }

        .template-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .template-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            margin: 0;
        }

        .template-checkbox input[type="checkbox"] {
            margin: 0;
            margin-top: 0.25rem;
        }

        .template-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .template-name {
            font-weight: 600;
            color: #333;
        }

        .template-content {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .template-flags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .template-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        .template-summary span {
            font-weight: 600;
            color: #333;
        }

        .loading, .error, .empty {
            padding: 2rem;
            text-align: center;
            color: #666;
        }

        .error {
            color: #dc3545;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .task-meta-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .task-actions {
                justify-content: flex-start;
                margin-top: 1rem;
            }

            .project-modal {
                max-width: 95vw;
                margin: 1rem 1.5rem; /* Â∑¶Âè≥„ÅÆ‰ΩôÁôΩ„ÇíÂ¢óÂä† */
            }

            .template-filters {
                flex-direction: column;
            }

            .template-summary {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="header">
            <div class="header-left">
                <h1 class="app-title">üõ£Ô∏è ÈÅìË∑ØË©≥Á¥∞Ë®≠Ë®àÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <span class="user-role" id="userRole"></span>
                </div>
                <a href="settings.html" class="btn btn-info" id="settingsLink">Ë®≠ÂÆö</a>
                <button class="btn btn-outline" id="logoutBtn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
        </header>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <main class="main-content">
            <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû/‰ΩúÊàê„Ç®„É™„Ç¢ -->
            <section class="project-section">
                <div class="project-header">
                    <h2>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ</h2>
                    <button class="btn btn-primary" id="newProjectBtn">Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà</button>
                </div>
                
                <div class="project-selector">
                    <select id="projectSelect" class="project-select">
                        <option value="">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                    </select>
                </div>
            </section>

            <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†± -->
            <section class="project-info" id="projectInfo" style="display: none;">
                <div class="project-details">
                    <h3 id="projectName"></h3>
                    <div class="project-meta">
                        <span id="projectClient"></span>
                        <span id="projectPeriod"></span>
                        <span class="project-status" id="projectStatus"></span>
                    </div>
                </div>
                
                <!-- ÈÄ≤Êçó„Çµ„Éû„É™„Éº -->
                <div class="progress-summary">
                    <div class="progress-card">
                        <div class="progress-number" id="totalTasks">0</div>
                        <div class="progress-label">Á∑è„Çø„Çπ„ÇØÊï∞</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="completedTasks">0</div>
                        <div class="progress-label">ÂÆå‰∫ÜÊ∏à„Åø</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="inProgressTasks">0</div>
                        <div class="progress-label">ÈÄ≤Ë°å‰∏≠</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number danger" id="overdueTasks">0</div>
                        <div class="progress-label">ÈÅÖÂª∂</div>
                    </div>
                </div>
                
                <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
                <div class="overall-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </section>

            <!-- „Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç®„É™„Ç¢ -->
            <section class="task-section" id="taskSection" style="display: none;">
                <div class="task-filters" id="phaseFilters">
                    <button class="filter-btn active" data-phase="all">„Åô„Åπ„Å¶</button>
                    <!-- „Éï„Çß„Éº„Ç∫„ÅØÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åæ„Çå„Åæ„Åô -->
                </div>

                <!-- „Éï„Çß„Éº„Ç∫„Ç≥„É≥„ÉÜ„Éä„ÅØJavaScript„ÅßÂãïÁöÑÁîüÊàê -->
            </section>
        </main>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal project-modal" id="newProjectModalContent">
            <div class="modal-header draggable-header">
                <h3>Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê</h3>
                <button class="modal-close" id="closeNewProjectModal">&times;</button>
            </div>
            <form id="newProjectForm">
                <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂü∫Êú¨ÊÉÖÂ†± -->
                <div class="form-section">
                    <h4>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂü∫Êú¨ÊÉÖÂ†±</h4>
                    <div class="form-group">
                        <label for="projectNameInput">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç *</label>
                        <input type="text" id="projectNameInput" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="projectCodeInput">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≥„Éº„Éâ</label>
                        <input type="text" id="projectCodeInput" name="project_code" placeholder="‰æã: RD2024-001">
                    </div>
                    <div class="form-group">
                        <label for="clientNameInput">Áô∫Ê≥®ËÄÖÂêç</label>
                        <input type="text" id="clientNameInput" name="client_name">
                    </div>
                    <div class="form-group">
                        <label for="descriptionInput">Ê¶ÇË¶Å</label>
                        <textarea id="descriptionInput" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDateInput">ÈñãÂßã‰∫àÂÆöÊó•</label>
                            <input type="date" id="startDateInput" name="start_date">
                        </div>
                        <div class="form-group">
                            <label for="endDateInput">ÂÆå‰∫Ü‰∫àÂÆöÊó•</label>
                            <input type="date" id="endDateInput" name="target_end_date">
                        </div>
                    </div>
                </div>

                <!-- „Çø„Çπ„ÇØ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû -->
                <div class="form-section">
                    <h4>„Çø„Çπ„ÇØ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû</h4>
                    <div class="template-selection">
                        <div class="template-filters" id="templateFilters">
                            <button type="button" class="filter-btn active" data-phase="all">„Åô„Åπ„Å¶</button>
                            <!-- „Éï„Çß„Éº„Ç∫„ÅØÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åæ„Çå„Åæ„Åô -->
                        </div>
                        <div class="template-list" id="templateList">
                            <div class="loading">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                        </div>
                        <div class="template-summary">
                            <span>ÈÅ∏ÊäûÊ∏à„Åø: <span id="selectedCount">0</span>‰ª∂</span>
                            <button type="button" class="btn btn-small" id="selectAllBtn">„Åô„Åπ„Å¶ÈÅ∏Êäû</button>
                            <button type="button" class="btn btn-small" id="clearAllBtn">ÈÅ∏ÊäûËß£Èô§</button>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelNewProject">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-primary">„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê</button>
                </div>
            </form>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: „Çø„Çπ„ÇØË©≥Á¥∞ -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal task-modal" id="taskModalContent">
            <div class="modal-header draggable-header">
                <h3 id="taskModalTitle"></h3>
                <button class="modal-close" id="closeTaskModal">&times;</button>
            </div>
            <div class="task-modal-content">
                <div class="task-info">
                    <div class="task-status-selector">
                        <label>„Çπ„ÉÜ„Éº„Çø„Çπ:</label>
                        <select id="taskStatusSelect">
                            <option value="not_started">Êú™ÁùÄÊâã</option>
                            <option value="in_progress">ÈÄ≤Ë°å‰∏≠</option>
                            <option value="completed">ÂÆå‰∫Ü</option>
                            <option value="not_applicable">ÂØæË±°Â§ñ</option>
                        </select>
                    </div>
                    
                    <div class="task-assignment">
                        <label>ÊãÖÂΩìËÄÖ:</label>
                        <select id="taskAssigneeSelect">
                            <option value="">Êú™Ââ≤ÂΩì</option>
                        </select>
                    </div>
                    
                    <div class="task-date">
                        <label>‰∫àÂÆöÊó•:</label>
                        <input type="date" id="taskPlannedDate">
                    </div>
                    
                    <div class="task-meta">
                        <div class="task-meta-item">
                            <span class="meta-label">ÊäÄË°ìËÄÖ‰ΩúÊ•≠:</span>
                            <span id="taskTechnical"></span>
                        </div>
                        <div class="task-meta-item">
                            <span class="meta-label">„Éû„Éã„É•„Ç¢„É´:</span>
                            <span id="taskManual"></span>
                        </div>
                    </div>
                </div>
                
                <div class="task-notes">
                    <label>‰ΩúÊ•≠„É°„É¢:</label>
                    <textarea id="taskNotesInput" rows="4" placeholder="‰ΩúÊ•≠„Å´Èñ¢„Åô„Çã„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelTaskEdit">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" id="saveTaskChanges">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>

    <script>
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== ÈÅìË∑ØË©≥Á¥∞Ë®≠Ë®àÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ ===');
            
            // ÂàùÊúü„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            loadProjects();
            loadUserInfo();
            loadPhases();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            setupEventListeners();
            
            // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
            initializeDraggableModals();
        });

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßË™≠„ÅøËæº„Åø
        async function loadProjects() {
            try {
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÈñãÂßã');
                const response = await fetch('api.php?path=projects', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                console.log('API„É¨„Çπ„Éù„É≥„Çπ:', response);
                console.log('„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                console.log('„É¨„Çπ„Éù„É≥„Çπ„Éò„ÉÉ„ÉÄ„Éº:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ:', errorText);
                    throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP ${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('ÂèñÂæó„Åó„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø:', data);

                if (data.success && data.projects) {
                    displayProjects(data.projects);
                    
                    // ÊúÄÂàù„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíËá™ÂãïÈÅ∏Êäû
                    if (data.projects.length > 0) {
                        selectProject(data.projects[0].id);
                    } else {
                        console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå0‰ª∂„Åß„Åô');
                        document.getElementById('projectSelect').innerHTML = '<option value="">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</option>';
                    }
                } else {
                    console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü:', data);
                    throw new Error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                const errorMessage = error.message || '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                document.getElementById('projectSelect').innerHTML = `<option value="">„Ç®„É©„Éº: ${errorMessage}</option>`;
                
                // „Ç®„É©„ÉºË©≥Á¥∞„ÇíË°®Á§∫
                showErrorMessage(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${errorMessage}`);
            }
        }

        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showErrorMessage(message) {
            const projectSection = document.querySelector('.project-section');
            let errorDiv = projectSection.querySelector('.error-message');
            
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 1rem; border: 1px solid #f5c6cb; border-radius: 4px; margin: 1rem 0;';
                projectSection.appendChild(errorDiv);
            }
            
            errorDiv.innerHTML = `
                <h4>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h4>
                <p>${message}</p>
                <p><a href="debug_projects.php" target="_blank">„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÁ¢∫Ë™ç</a></p>
            `;
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßË°®Á§∫
        function displayProjects(projects) {
            const select = document.getElementById('projectSelect');
            
            // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢ÔºàÊúÄÂàù„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÅØ‰øùÊåÅÔºâ
            select.innerHTML = '<option value="">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.client_name || '„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊú™Ë®≠ÂÆö'})`;
                select.appendChild(option);
            });
            
            console.log(`${projects.length}‰ª∂„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü`);
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ
        async function selectProject(projectId) {
            if (!projectId) return;
            
            try {
                console.log(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû: ID ${projectId}`);
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞ÊÉÖÂ†±ÂèñÂæóÔºàprojects/<id> ÂΩ¢ÂºèÔºâ
                const response = await fetch(`api.php?path=projects/${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                const data = await response.json();
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞:', data);

                if (data.success && data.project) {
                    console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞ÂèñÂæóÊàêÂäü:', data.project);
                    displayProjectInfo(data.project);
                    
                    // Ë©≥Á¥∞API„ÅÆtasks„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
                    if (data.tasks && Array.isArray(data.tasks)) {
                        console.log('„Çø„Çπ„ÇØ„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', data.tasks.length, '‰ª∂');
                        displayTaskStatistics(data.tasks);
                        displayTasksByPhase(data.tasks);
                    } else {
                        console.log('„Çø„Çπ„ÇØ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÂÆüË°å');
                        // Âøµ„ÅÆ„Åü„ÇÅÂæìÊù•„ÅÆÂèñÂæó„ÇÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                        loadProjectTasks(projectId);
                    }
            } else {
                    console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó:', data);
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞ÂèñÂæó„Ç®„É©„Éº:', error);
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±Ë°®Á§∫
        function displayProjectInfo(project) {
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
            document.getElementById('projectInfo').style.display = 'block';
            document.getElementById('taskSection').style.display = 'block';
            
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç
            document.getElementById('projectName').textContent = project.name;
            
            // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç
            document.getElementById('projectClient').textContent = project.client_name || '„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊú™Ë®≠ÂÆö';
            
            // ÊúüÈñì
            const startDate = project.start_date ? new Date(project.start_date).toLocaleDateString('ja-JP') : 'Êú™Ë®≠ÂÆö';
            const endDate = project.end_date ? new Date(project.end_date).toLocaleDateString('ja-JP') : 'Êú™Ë®≠ÂÆö';
            document.getElementById('projectPeriod').textContent = `${startDate} ~ ${endDate}`;
            
            // „Çπ„ÉÜ„Éº„Çø„Çπ
            const statusElement = document.getElementById('projectStatus');
            const statusText = getStatusText(project.status);
            statusElement.textContent = statusText;
            statusElement.className = `project-status status-${project.status}`;
            
            console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø
        async function loadProjectTasks(projectId) {
            try {
                console.log(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà ${projectId} „ÅÆ„Çø„Çπ„ÇØË™≠„ÅøËæº„ÅøÈñãÂßã`);
                const response = await fetch(`api.php?path=tasks&project_id=${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                const data = await response.json();
                console.log('ÂèñÂæó„Åó„Åü„Çø„Çπ„ÇØ„Éá„Éº„Çø:', data);

                if (data.success && data.tasks) {
                    displayTaskStatistics(data.tasks);
                    displayTasksByPhase(data.tasks);
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // „Çø„Çπ„ÇØÁµ±Ë®àË°®Á§∫
        function displayTaskStatistics(tasks) {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in_progress').length;
            const overdueTasks = tasks.filter(task => {
                if (task.planned_date && task.status !== 'completed') {
                    return new Date(task.planned_date) < new Date();
                }
                return false;
            }).length;

            // Áµ±Ë®à„Ç´„Éº„ÉâÊõ¥Êñ∞
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('overdueTasks').textContent = overdueTasks;

            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊõ¥Êñ∞
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}%`;

            console.log(`„Çø„Çπ„ÇØÁµ±Ë®à: Á∑èÊï∞${totalTasks}, ÂÆå‰∫Ü${completedTasks}, ÈÄ≤Ë°å‰∏≠${inProgressTasks}, ÈÅÖÂª∂${overdueTasks}`);
        }

        // „Éï„Çß„Éº„Ç∫Âà•„Çø„Çπ„ÇØË°®Á§∫
        function displayTasksByPhase(tasks) {
            console.log('=== displayTasksByPhaseÈñãÂßã ===');
            console.log('Âèó„ÅëÂèñ„Å£„Åü„Çø„Çπ„ÇØÊï∞:', tasks.length);
            console.log('„Çø„Çπ„ÇØ„Çµ„É≥„Éó„É´:', tasks.slice(0, 3));
            
            const phaseContainers = {};
            
            // „Éï„Çß„Éº„Ç∫Âà•„Å´„Çø„Çπ„ÇØ„Çí„Ç∞„É´„Éº„ÉóÂåñ
            tasks.forEach(task => {
                const phaseName = task.phase_name || '„Éï„Çß„Éº„Ç∫Êú™Ë®≠ÂÆö';
                console.log(`„Çø„Çπ„ÇØ ${task.id}: ${task.task_name} -> ${phaseName}`);
                if (!phaseContainers[phaseName]) {
                    phaseContainers[phaseName] = [];
                }
                phaseContainers[phaseName].push(task);
            });
            
            console.log('„Éï„Çß„Éº„Ç∫Âà•„Ç∞„É´„Éº„ÉóÂåñÁµêÊûú:', phaseContainers);

            // „Çø„Çπ„ÇØ„Çª„ÇØ„Ç∑„Éß„É≥„Å´„Éï„Çß„Éº„Ç∫Âà•„Ç≥„É≥„ÉÜ„Éä„ÇíÁîüÊàê
            const taskSection = document.getElementById('taskSection');
            console.log('„Çø„Çπ„ÇØ„Çª„ÇØ„Ç∑„Éß„É≥Ë¶ÅÁ¥†:', taskSection);
            taskSection.innerHTML = ''; // Êó¢Â≠ò„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÇØ„É™„Ç¢

            // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÇíÂÜçËøΩÂä†
            const filtersDiv = document.createElement('div');
            filtersDiv.className = 'task-filters';
            filtersDiv.innerHTML = `
                <button class="filter-btn active" data-phase="all">„Åô„Åπ„Å¶</button>
                <button class="filter-btn" data-phase="„Éï„Çß„Éº„Ç∫1">„Éï„Çß„Éº„Ç∫1</button>
                <button class="filter-btn" data-phase="„Éï„Çß„Éº„Ç∫2">„Éï„Çß„Éº„Ç∫2</button>
                <button class="filter-btn" data-phase="„Éï„Çß„Éº„Ç∫3">„Éï„Çß„Éº„Ç∫3</button>
            `;
            taskSection.appendChild(filtersDiv);
            console.log('„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥ËøΩÂä†ÂÆå‰∫Ü');

            // „Éï„Çß„Éº„Ç∫Âà•„Ç≥„É≥„ÉÜ„Éä„ÇíÁîüÊàê
            Object.keys(phaseContainers).forEach(phaseName => {
                const phaseContainer = document.createElement('div');
                phaseContainer.className = 'phase-container';
                phaseContainer.setAttribute('data-phase', phaseName);
                
                const phaseHeader = document.createElement('h3');
                phaseHeader.textContent = `${phaseName} (${phaseContainers[phaseName].length}‰ª∂)`;
                phaseContainer.appendChild(phaseHeader);

                const taskList = document.createElement('div');
                taskList.className = 'task-list';
                
                phaseContainers[phaseName].forEach(task => {
                    const taskItem = createTaskItem(task);
                    taskList.appendChild(taskItem);
                });
                
                phaseContainer.appendChild(taskList);
                taskSection.appendChild(phaseContainer);
            });

            // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            setupFilterButtons();
        }

        // „Çø„Çπ„ÇØ„Ç¢„Ç§„ÉÜ„É†‰ΩúÊàê
        function createTaskItem(task) {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.setAttribute('data-task-id', task.id);
            
            const statusClass = getStatusClass(task.status);
            const statusText = getStatusText(task.status);
            const isOverdue = task.planned_date && task.status !== 'completed' && new Date(task.planned_date) < new Date();
            
            taskItem.innerHTML = `
                <div class="task-header">
                    <h4 class="task-title">${escapeHtml(task.task_name)}</h4>
                    <div class="task-status-group">
                        <span class="task-status ${statusClass}">${statusText}</span>
                        ${isOverdue ? '<span class="task-overdue">ÈÅÖÂª∂</span>' : ''}
                    </div>
                </div>
                <div class="task-meta">
                    <div class="task-meta-row">
                        <span class="task-assignee">
                            <i class="icon-user"></i>
                            ${task.assigned_to_name || 'Êú™Ââ≤ÂΩì'}
                        </span>
                        <span class="task-date ${isOverdue ? 'overdue' : ''}">
                            <i class="icon-calendar"></i>
                            ${task.planned_date ? new Date(task.planned_date).toLocaleDateString('ja-JP') : 'Êú™Ë®≠ÂÆö'}
                        </span>
                    </div>
                    <div class="task-flags">
                        ${task.is_technical_work == '1' ? '<span class="flag technical">ÊäÄË°ì‰ΩúÊ•≠</span>' : ''}
                        ${task.has_manual == '1' ? '<span class="flag manual">„Éû„Éã„É•„Ç¢„É´„ÅÇ„Çä</span>' : ''}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn btn-small btn-edit" onclick="editTask(${task.id})" title="„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ">
                        <i class="icon-edit"></i> Á∑®ÈõÜ
                    </button>
                </div>
            `;
            
            return taskItem;
        }

        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë™≠„ÅøËæº„Åø
        async function loadUserInfo() {
            try {
                const response = await fetch('api.php?path=user/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('userName').textContent = data.name;
                        document.getElementById('userRole').textContent = getRoleText(data.role);
                    }
                }
            } catch (error) {
                console.error('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                // „Éá„Éï„Ç©„É´„ÉàÂÄ§Ë®≠ÂÆö
                document.getElementById('userName').textContent = 'ÁÆ°ÁêÜËÄÖ';
                document.getElementById('userRole').textContent = 'ÁÆ°ÁêÜËÄÖ';
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupEventListeners() {
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûÂ§âÊõ¥
            document.getElementById('projectSelect').addEventListener('change', function(e) {
                if (e.target.value) {
                    selectProject(e.target.value);
                } else {
                    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊú™ÈÅ∏ÊäûÊôÇ„ÅØÊÉÖÂ†±„ÇíÈùûË°®Á§∫
                    document.getElementById('projectInfo').style.display = 'none';
                    document.getElementById('taskSection').style.display = 'none';
                }
            });

            // Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Éú„Çø„É≥
            document.getElementById('newProjectBtn').addEventListener('click', function() {
                document.getElementById('newProjectModal').style.display = 'block';
                loadTemplatesForSelection();
            });

            // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã„Éú„Çø„É≥
            document.getElementById('closeNewProjectModal').addEventListener('click', function() {
                document.getElementById('newProjectModal').style.display = 'none';
                resetProjectForm();
            });

            // „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥
            document.getElementById('cancelNewProject').addEventListener('click', function() {
                document.getElementById('newProjectModal').style.display = 'none';
                resetProjectForm();
            });

            // Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Éï„Ç©„Éº„É†
            document.getElementById('newProjectForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createNewProject(this);
            });

            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÈñ¢ÈÄ£
            document.getElementById('selectAllBtn').addEventListener('click', function() {
                selectAllTemplates();
            });

            document.getElementById('clearAllBtn').addEventListener('click', function() {
                clearAllTemplates();
            });

            // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    window.location.href = 'logout.php';
                }
            });

            // „Çø„Çπ„ÇØ„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
            document.getElementById('closeTaskModal').addEventListener('click', function() {
                document.getElementById('taskModal').style.display = 'none';
            });

            document.getElementById('cancelTaskEdit').addEventListener('click', function() {
                document.getElementById('taskModal').style.display = 'none';
            });

            document.getElementById('saveTaskChanges').addEventListener('click', async function() {
                await saveTaskChanges();
            });
        }

        // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥Ë®≠ÂÆö
        function setupFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const selectedPhase = this.getAttribute('data-phase');
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥Êõ¥Êñ∞
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // „Éï„Çß„Éº„Ç∫Âà•Ë°®Á§∫
                    filterTasksByPhase(selectedPhase);
                });
            });
        }

        // „Éï„Çß„Éº„Ç∫Âà•„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterTasksByPhase(phase) {
            const phaseContainers = document.querySelectorAll('.phase-container');
            
            phaseContainers.forEach(container => {
                if (phase === 'all' || container.getAttribute('data-phase') === phase) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
        }

        // „Éï„Çß„Éº„Ç∫Ë™≠„ÅøËæº„Åø
        async function loadPhases() {
            try {
                console.log('„Éï„Çß„Éº„Ç∫Ë™≠„ÅøËæº„ÅøÈñãÂßã');
                const response = await fetch('api.php?path=phases', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('„Éï„Çß„Éº„Ç∫‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                const data = await response.json();
                if (data.success && data.phases) {
                    displayPhases(data.phases);
                } else {
                    throw new Error(data.message || '„Éï„Çß„Éº„Ç∫‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('„Éï„Çß„Éº„Ç∫Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                // „Ç®„É©„ÉºÊôÇ„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅÆ„Éï„Çß„Éº„Ç∫„ÇíË°®Á§∫
                displayDefaultPhases();
            }
        }

        // „Éï„Çß„Éº„Ç∫Ë°®Á§∫
        function displayPhases(phases) {
            const phaseFilters = document.getElementById('phaseFilters');
            if (!phaseFilters) return;

            let html = '<button class="filter-btn active" data-phase="all">„Åô„Åπ„Å¶</button>';
            
            phases.forEach(phase => {
                html += `<button class="filter-btn" data-phase="${escapeHtml(phase.name)}">${escapeHtml(phase.name)}</button>`;
            });
            
            phaseFilters.innerHTML = html;
            
            // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupFilterButtons();
        }

        // „Éá„Éï„Ç©„É´„Éà„Éï„Çß„Éº„Ç∫Ë°®Á§∫Ôºà„Ç®„É©„ÉºÊôÇÁî®Ôºâ
        function displayDefaultPhases() {
            const phaseFilters = document.getElementById('phaseFilters');
            if (!phaseFilters) return;

            const defaultPhases = ['Ë®≠Ë®à', 'ÊñΩÂ∑•', 'Áõ£ÁêÜ'];
            let html = '<button class="filter-btn active" data-phase="all">„Åô„Åπ„Å¶</button>';
            
            defaultPhases.forEach(phase => {
                html += `<button class="filter-btn" data-phase="${escapeHtml(phase)}">${escapeHtml(phase)}</button>`;
            });
            
            phaseFilters.innerHTML = html;
            
            // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupFilterButtons();
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÁî®Ë™≠„ÅøËæº„Åø
        async function loadTemplatesForSelection() {
            try {
                console.log('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÁî®Ë™≠„ÅøËæº„ÅøÈñãÂßã');
                
                // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Éï„Çß„Éº„Ç∫„Çí‰∏¶Ë°å„Åó„Å¶Ë™≠„ÅøËæº„Åø
                const [templatesResponse, phasesResponse] = await Promise.all([
                    fetch('api.php?path=templates', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }),
                    fetch('api.php?path=phases', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                ]);

                let templates = [];
                let phases = [];

                // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ
                if (templatesResponse.ok) {
                    const templatesData = await templatesResponse.json();
                    if (templatesData.success && templatesData.templates) {
                        templates = templatesData.templates;
                    }
                }

                // „Éï„Çß„Éº„Ç∫„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ
                if (phasesResponse.ok) {
                    const phasesData = await phasesResponse.json();
                    if (phasesData.success && phasesData.phases) {
                        phases = phasesData.phases;
                    }
                }

                // „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº„ÇíË®≠ÂÆö
                displayPhaseFilters(phases);
                
                // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË°®Á§∫
                if (templates.length > 0) {
                    displayTemplatesForSelection(templates);
                } else {
                    document.getElementById('templateList').innerHTML = '<div class="empty">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
                }
                
                // „Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩ„ÇíË®≠ÂÆö
                setupTemplateFilters();
                
            } catch (error) {
                console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                document.getElementById('templateList').innerHTML = '<div class="error">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„ÉºË°®Á§∫
        function displayPhaseFilters(phases) {
            const filtersContainer = document.getElementById('templateFilters');
            filtersContainer.innerHTML = '';
            
            // „Éï„Çß„Éº„Ç∫„Éú„Çø„É≥„ÇíËøΩÂä†
            if (phases && phases.length > 0) {
                phases.forEach((phase, index) => {
                    const phaseButton = document.createElement('button');
                    phaseButton.type = 'button';
                    phaseButton.className = index === 0 ? 'filter-btn active' : 'filter-btn';
                    phaseButton.setAttribute('data-phase', phase.name);
                    phaseButton.textContent = phase.name;
                    filtersContainer.appendChild(phaseButton);
                });
                
                // ÊúÄÂàù„ÅÆ„Éï„Çß„Éº„Ç∫„Çí„Éá„Éï„Ç©„É´„Éà„ÅßË°®Á§∫
                if (phases.length > 0) {
                    filterTemplatesByPhase(phases[0].name);
                }
            } else {
                // „Éï„Çß„Éº„Ç∫„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const fallbackPhases = ['Ë®≠Ë®à', 'ÊñΩÂ∑•', 'Áõ£ÁêÜ'];
                fallbackPhases.forEach((phaseName, index) => {
                    const phaseButton = document.createElement('button');
                    phaseButton.type = 'button';
                    phaseButton.className = index === 0 ? 'filter-btn active' : 'filter-btn';
                    phaseButton.setAttribute('data-phase', phaseName);
                    phaseButton.textContent = phaseName;
                    filtersContainer.appendChild(phaseButton);
                });
                
                // ÊúÄÂàù„ÅÆ„Éï„Çß„Éº„Ç∫„Çí„Éá„Éï„Ç©„É´„Éà„ÅßË°®Á§∫
                if (fallbackPhases.length > 0) {
                    filterTemplatesByPhase(fallbackPhases[0]);
                }
            }
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûË°®Á§∫
        function displayTemplatesForSelection(templates) {
            const container = document.getElementById('templateList');
            
            if (!templates || templates.length === 0) {
                container.innerHTML = '<div class="empty">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
                return;
            }

            // „Éï„Çß„Éº„Ç∫Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const groupedTemplates = {};
            templates.forEach(template => {
                if (!groupedTemplates[template.phase_name]) {
                    groupedTemplates[template.phase_name] = [];
                }
                groupedTemplates[template.phase_name].push(template);
            });

            let html = '<div class="template-groups">';
            
            Object.keys(groupedTemplates).sort().forEach(phaseName => {
                const phaseTemplates = groupedTemplates[phaseName];
                phaseTemplates.sort((a, b) => a.task_order - b.task_order);
                
                html += `
                    <div class="template-group" data-phase="${escapeHtml(phaseName)}">
                        <h5 class="phase-title">${escapeHtml(phaseName)}</h5>
                        <div class="template-items">
                `;
                
                phaseTemplates.forEach(template => {
                    html += `
                        <div class="template-item" data-template-id="${template.id}">
                            <label class="template-checkbox">
                                <input type="checkbox" name="selected_templates[]" value="${template.id}">
                                <span class="template-info">
                                    <span class="template-name">${escapeHtml(template.task_name)}</span>
                                    <span class="template-content">${escapeHtml(template.content || '')}</span>
                                    <span class="template-flags">
                                        ${template.is_technical_work == '1' ? '<span class="flag technical">ÊäÄË°ì‰ΩúÊ•≠</span>' : ''}
                                        ${template.has_manual == '1' ? '<span class="flag manual">„Éû„Éã„É•„Ç¢„É´„ÅÇ„Çä</span>' : ''}
                                    </span>
                                </span>
                            </label>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            setupTemplateCheckboxes();
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö
        function setupTemplateFilters() {
            document.querySelectorAll('.template-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const selectedPhase = this.getAttribute('data-phase');
                    
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éú„Çø„É≥Êõ¥Êñ∞
                    document.querySelectorAll('.template-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Ç∞„É´„Éº„Éó„ÅÆË°®Á§∫/ÈùûË°®Á§∫
                    filterTemplatesByPhase(selectedPhase);
                });
            });
        }

        // „Éï„Çß„Éº„Ç∫Âà•„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterTemplatesByPhase(selectedPhase) {
            document.querySelectorAll('.template-group').forEach(group => {
                if (group.getAttribute('data-phase') === selectedPhase) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            });
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπË®≠ÂÆö
        function setupTemplateCheckboxes() {
            document.querySelectorAll('input[name="selected_templates[]"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });
        }

        // ÈÅ∏ÊäûÊ∏à„Åø‰ª∂Êï∞Êõ¥Êñ∞
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('input[name="selected_templates[]"]:checked').length;
            document.getElementById('selectedCount').textContent = selectedCount;
        }

        // „Åô„Åπ„Å¶ÈÅ∏Êäû
        function selectAllTemplates() {
            // ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éï„Çß„Éº„Ç∫„ÇíÂèñÂæó
            const activePhase = document.querySelector('.template-filters .filter-btn.active');
            if (!activePhase) return;
            
            const selectedPhase = activePhase.getAttribute('data-phase');
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Çß„Éº„Ç∫„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„Åø„ÇíÈÅ∏Êäû
            document.querySelectorAll('input[name="selected_templates[]"]').forEach(checkbox => {
                const templateItem = checkbox.closest('.template-item');
                const templateGroup = templateItem.closest('.template-group');
                
                if (templateGroup && templateGroup.getAttribute('data-phase') === selectedPhase) {
                    checkbox.checked = true;
                }
            });
            updateSelectedCount();
        }

        // „Åô„Åπ„Å¶ÈÅ∏ÊäûËß£Èô§
        function clearAllTemplates() {
            // ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éï„Çß„Éº„Ç∫„ÇíÂèñÂæó
            const activePhase = document.querySelector('.template-filters .filter-btn.active');
            if (!activePhase) return;
            
            const selectedPhase = activePhase.getAttribute('data-phase');
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éï„Çß„Éº„Ç∫„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„Åø„ÇíÈÅ∏ÊäûËß£Èô§
            document.querySelectorAll('input[name="selected_templates[]"]').forEach(checkbox => {
                const templateItem = checkbox.closest('.template-item');
                const templateGroup = templateItem.closest('.template-group');
                
                if (templateGroup && templateGroup.getAttribute('data-phase') === selectedPhase) {
                    checkbox.checked = false;
                }
            });
            updateSelectedCount();
        }

        // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetProjectForm() {
            document.getElementById('newProjectForm').reset();
            clearAllTemplates();
            document.getElementById('templateList').innerHTML = '<div class="loading">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
        }

        // „Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„É¢„Éº„ÉÄ„É´„ÅÆÂàùÊúüÂåñ
        function initializeDraggableModals() {
            const modals = [
                { id: 'newProjectModalContent', overlay: 'newProjectModal' },
                { id: 'taskModalContent', overlay: 'taskModal' }
            ];

            modals.forEach(modal => {
                const modalElement = document.getElementById(modal.id);
                const overlayElement = document.getElementById(modal.overlay);
                const headerElement = modalElement.querySelector('.draggable-header');

                if (modalElement && headerElement) {
                    makeDraggable(modalElement, headerElement, overlayElement);
                }
            });
        }

        // „É¢„Éº„ÉÄ„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´„Åô„Çã
        function makeDraggable(modalElement, headerElement, overlayElement) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            // ÂàùÊúü‰ΩçÁΩÆ„Çí‰∏≠Â§Æ„Å´Ë®≠ÂÆö
            function centerModal() {
                const modalRect = modalElement.getBoundingClientRect();
                const overlayRect = overlayElement.getBoundingClientRect();
                
                xOffset = (overlayRect.width - modalRect.width) / 2;
                yOffset = (overlayRect.height - modalRect.height) / 2;
                
                setTranslate(xOffset, yOffset, modalElement);
            }

            // ‰ΩçÁΩÆ„ÇíË®≠ÂÆö
            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
            }

            // „Éû„Ç¶„Çπ„ÉÄ„Ç¶„É≥„Ç§„Éô„É≥„Éà
            function dragStart(e) {
                if (e.target.closest('.modal-close') || e.target.closest('input') || e.target.closest('textarea') || e.target.closest('select')) {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === headerElement || headerElement.contains(e.target)) {
                    isDragging = true;
                    headerElement.style.cursor = 'grabbing';
                }
            }

            // „Éû„Ç¶„Çπ„É†„Éº„Éñ„Ç§„Éô„É≥„Éà
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modalElement);
                }
            }

            // „Éû„Ç¶„Çπ„Ç¢„ÉÉ„Éó„Ç§„Éô„É≥„Éà
            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                headerElement.style.cursor = 'grab';
            }

            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
            function touchStart(e) {
                if (e.target.closest('.modal-close') || e.target.closest('input') || e.target.closest('textarea') || e.target.closest('select')) {
                    return;
                }

                const touch = e.touches[0];
                initialX = touch.clientX - xOffset;
                initialY = touch.clientY - yOffset;

                if (e.target === headerElement || headerElement.contains(e.target)) {
                    isDragging = true;
                }
            }

            function touchMove(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    currentX = touch.clientX - initialX;
                    currentY = touch.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modalElement);
                }
            }

            function touchEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
            headerElement.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
            headerElement.addEventListener('touchstart', touchStart, { passive: false });
            document.addEventListener('touchmove', touchMove, { passive: false });
            document.addEventListener('touchend', touchEnd);

            // ÂàùÊúü‰ΩçÁΩÆ„ÇíË®≠ÂÆö
            centerModal();

            // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„Å´‰∏≠Â§Æ„Å´Êàª„Åô
            window.addEventListener('resize', centerModal);

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫ÊôÇ„Å´‰∏≠Â§Æ„Å´Êàª„Åô
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const display = overlayElement.style.display;
                        if (display === 'block') {
                            setTimeout(centerModal, 10);
                        }
                    }
                });
            });

            observer.observe(overlayElement, { attributes: true });
        }

        // Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
        async function createNewProject(form) {
            try {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // ÈÅ∏Êäû„Åï„Çå„Åü„ÉÜ„É≥„Éó„É¨„Éº„ÉàID„ÇíÂèñÂæó
                const selectedTemplates = Array.from(document.querySelectorAll('input[name="selected_templates[]"]:checked'))
                    .map(checkbox => checkbox.value);
                
                data.selected_templates = selectedTemplates;
                
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Éá„Éº„Çø:', data);
                
                const response = await fetch('api.php?path=projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                });

                console.log('„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                console.log('„É¨„Çπ„Éù„É≥„Çπ„Éò„ÉÉ„ÉÄ„Éº:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ:', errorText);
                    throw new Error(`„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP ${response.status}): ${errorText}`);
                }

                const result = await response.json();
                console.log('API„É¨„Çπ„Éù„É≥„Çπ:', result);
                
                if (result.success) {
                    alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÊ≠£Â∏∏„Å´‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü');
                    document.getElementById('newProjectModal').style.display = 'none';
                    resetProjectForm();
                    
                    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
                    loadProjects();
                } else {
                    throw new Error(result.message || '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
                alert('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „Çø„Çπ„ÇØÁ∑®ÈõÜ
        async function editTask(taskId) {
            try {
                console.log(`„Çø„Çπ„ÇØÁ∑®ÈõÜÈñãÂßã: ID ${taskId}`);
                
                // „Çø„Çπ„ÇØË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
                const response = await fetch(`api.php?path=tasks/${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                console.log('API„É¨„Çπ„Éù„É≥„Çπ:', response);
                console.log('„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ:', errorText);
                    throw new Error(`„Çø„Çπ„ÇØË©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (HTTP ${response.status})`);
                }

                const data = await response.json();
                console.log('„Çø„Çπ„ÇØË©≥Á¥∞:', data);

                if (data.success && data.task) {
                    // „Çø„Çπ„ÇØ„É¢„Éº„ÉÄ„É´„Å´ÊÉÖÂ†±„ÇíË®≠ÂÆö
                    document.getElementById('taskModalTitle').textContent = data.task.task_name;
                    document.getElementById('taskStatusSelect').value = data.task.status || 'not_started';
                    document.getElementById('taskAssigneeSelect').value = data.task.assigned_to || '';
                    document.getElementById('taskPlannedDate').value = data.task.planned_date || '';
                    document.getElementById('taskTechnical').textContent = data.task.is_technical_work == '1' ? 'ÊäÄË°ìËÄÖ‰ΩúÊ•≠' : '‰∏ÄËà¨‰ΩúÊ•≠';
                    document.getElementById('taskManual').textContent = data.task.has_manual == '1' ? '„Éû„Éã„É•„Ç¢„É´„ÅÇ„Çä' : '„Éû„Éã„É•„Ç¢„É´„Å™„Åó';
                    document.getElementById('taskNotesInput').value = data.task.notes || '';
                    
                    // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËÇ¢„ÇíË™≠„ÅøËæº„Åø
                    await loadUsers();
                    
                    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                    document.getElementById('taskModal').style.display = 'block';
                    
                    // „Çø„Çπ„ÇØID„Çí‰øùÂ≠ò
                    document.getElementById('taskModal').setAttribute('data-task-id', taskId);
                } else {
                    throw new Error(data.message || '„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØÁ∑®ÈõÜ„Ç®„É©„Éº:', error);
                alert('„Çø„Çπ„ÇØ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ßË™≠„ÅøËæº„Åø
        async function loadUsers() {
            try {
                const response = await fetch('api.php?path=users', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.users) {
                        const select = document.getElementById('taskAssigneeSelect');
                        select.innerHTML = '<option value="">Êú™Ââ≤ÂΩì</option>';
                        
                        data.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.name;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('„É¶„Éº„Ç∂„ÉºË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // „Çø„Çπ„ÇØÂ§âÊõ¥‰øùÂ≠ò
        async function saveTaskChanges() {
            const taskId = document.getElementById('taskModal').getAttribute('data-task-id');
            if (!taskId) {
                alert('„Çø„Çπ„ÇØID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                return;
            }

            try {
                const status = document.getElementById('taskStatusSelect').value;
                const assignedTo = document.getElementById('taskAssigneeSelect').value;
                const plannedDate = document.getElementById('taskPlannedDate').value;
                const notes = document.getElementById('taskNotesInput').value;

                console.log('„Çø„Çπ„ÇØ‰øùÂ≠ò:', { taskId, status, assignedTo, plannedDate, notes });

                // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                if (status) {
                    const statusResponse = await fetch('api.php?path=tasks/status', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            status: status,
                            notes: notes
                        })
                    });

                    if (!statusResponse.ok) {
                        throw new Error('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }

                // ÊãÖÂΩìËÄÖ„Éª‰∫àÂÆöÊó•Êõ¥Êñ∞
                if (assignedTo !== '' || plannedDate) {
                    const updateResponse = await fetch('api.php?path=tasks/update', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            assigned_to: assignedTo || null,
                            planned_date: plannedDate || null
                        })
                    });

                    if (!updateResponse.ok) {
                        throw new Error('„Çø„Çπ„ÇØÊÉÖÂ†±„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }

                alert('„Çø„Çπ„ÇØ„ÅåÊ≠£Â∏∏„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü');
                document.getElementById('taskModal').style.display = 'none';
                
                // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø
                const currentProjectId = document.getElementById('projectSelect').value;
                if (currentProjectId) {
                    selectProject(currentProjectId);
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function getStatusText(status) {
            const statusMap = {
                'not_started': 'Êú™ÁùÄÊâã',
                'in_progress': 'ÈÄ≤Ë°å‰∏≠',
                'completed': 'ÂÆå‰∫Ü',
                'not_applicable': 'ÂØæË±°Â§ñ',
                'planning': 'Ë®àÁîª‰∏≠',
                'in_progress': 'ÈÄ≤Ë°å‰∏≠',
                'completed': 'ÂÆå‰∫Ü',
                'on_hold': '‰øùÁïô'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            const classMap = {
                'not_started': 'status-not-started',
                'in_progress': 'status-in-progress',
                'completed': 'status-completed',
                'not_applicable': 'status-not-applicable',
                'planning': 'status-planning',
                'on_hold': 'status-on-hold'
            };
            return classMap[status] || 'status-default';
        }

        function getRoleText(role) {
            const roleMap = {
                'manager': 'ÁÆ°ÁêÜËÄÖ',
                'technical': 'ÊäÄË°ìËÄÖ',
                'general': '‰∏ÄËà¨„Çπ„Çø„ÉÉ„Éï'
            };
            return roleMap[role] || role;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>