<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“è·¯è©³ç´°è¨­è¨ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/index.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">ğŸš§</div>
                <div class="logo-text">
                    <h1>é“è·¯è©³ç´°è¨­è¨ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                    <p>Road Design Management System</p>
            </div>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-name" id="userName">èª­ã¿è¾¼ã¿ä¸­...</span>
                        <span class="user-role" id="userRole">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
                </div>
                <a href="settings.html" class="btn btn-secondary">âš™ï¸ è¨­å®š</a>
                <a href="logout.php" class="btn btn-secondary">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-container">
            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ/ä½œæˆã‚¨ãƒªã‚¢ -->
            <section class="project-section">
                <div class="card">
                <div class="project-header">
                    <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</h2>
                        <button class="btn btn-primary" id="newProjectBtn">ğŸš€ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</button>
                </div>
                
                <div class="project-selector">
                    <select id="projectSelect" class="project-select">
                        <option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    </div>
                </div>
            </section>

            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± -->
            <section class="project-info" id="projectInfo" style="display: none;">
                <div class="card">
                <div class="project-details">
                        <div class="project-header-row">
                    <h3 id="projectName"></h3>
                            <div class="project-actions">
                                <button class="btn btn-primary btn-small" id="editProjectBtn" onclick="editProject()">
                                    âœï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†
                                </button>
                                <button class="btn btn-secondary btn-small" id="refreshProjectBtn" onclick="refreshProjectData()" title="æœ€æ–°ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—">
                                    ğŸ”„ æ›´æ–°
                                </button>
                                <button class="btn btn-danger btn-small" id="deleteProjectBtn" onclick="deleteProject()">
                                    ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
                                </button>
                            </div>
                        </div>
                    <div class="project-meta">
                        <span id="projectClient"></span>
                        <span id="projectPeriod"></span>
                        <span class="project-status" id="projectStatus"></span>
                    </div>
                </div>
                
                <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
                <div class="progress-summary">
                    <div class="progress-card">
                        <div class="progress-number" id="totalTasks">0</div>
                        <div class="progress-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="completedTasks">0</div>
                        <div class="progress-label">å®Œäº†æ¸ˆã¿</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="inProgressTasks">0</div>
                        <div class="progress-label">é€²è¡Œä¸­</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number danger" id="overdueTasks">0</div>
                        <div class="progress-label">é…å»¶</div>
                    </div>
                </div>
                
                <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                <div class="overall-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
            </section>

            <!-- ã‚¿ã‚¹ã‚¯ç®¡ç† -->
            <section class="task-section" id="taskSection" style="display: none;">
                <div class="card">
                    <h3>ã‚¿ã‚¹ã‚¯ç®¡ç†</h3>
                    
                    <!-- ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div class="task-filters" id="taskFilters">
                        <!-- ãƒ•ã‚§ãƒ¼ã‚ºãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>

                    <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
                    <div id="taskList" class="task-content">
                        <!-- ã‚¿ã‚¹ã‚¯ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </section>
        </main>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
        <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 2000;"></div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
        
        <!-- æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="newProjectModal">
            <div class="modal project-modal">
            <div class="modal-header">
                    <h3 class="modal-title">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h3>
                    <button class="modal-close" onclick="closeNewProjectModal()">&times;</button>
            </div>
                <div class="modal-content">
            <form id="newProjectForm">
                        <div class="form-section">
                            <h4>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æƒ…å ±</h4>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                                    <input type="text" id="projectName" name="name" required>
                </div>
                <div class="form-group">
                                    <label for="projectClient">ç™ºæ³¨è€…</label>
                                    <select id="projectClient" name="client_id" required>
                                        <option value="">ç™ºæ³¨è€…ã‚’é¸æŠ</option>
                                    </select>
                </div>
                            </div>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectStartDate">é–‹å§‹æ—¥</label>
                                    <input type="date" id="projectStartDate" name="start_date" required>
                </div>
                <div class="form-group">
                                    <label for="projectEndDate">çµ‚äº†æ—¥</label>
                                    <input type="date" id="projectEndDate" name="end_date" required>
                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h4>
                            <div class="template-selection">
                                <div class="template-filters" id="templateFilters">
                                    <!-- ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                </div>
                                <div class="template-list">
                                    <div class="template-groups" id="templateGroups">
                                        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                    </div>
                                </div>
                                <div class="template-summary">
                                    <span>é¸æŠæ¸ˆã¿: <span id="selectedCount">0</span>ä»¶</span>
                                    <button type="button" class="btn btn-secondary" onclick="selectAllTemplates()">ã™ã¹ã¦é¸æŠ</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="createProject()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="editProjectModal">
            <div class="modal project-modal">
                <div class="modal-header">
                    <h3 class="modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†</h3>
                    <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="editProjectForm">
                        <input type="hidden" id="editProjectId">
                        <div class="form-section">
                            <h4>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æƒ…å ±</h4>
                <div class="form-row">
                    <div class="form-group">
                                    <label for="editProjectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                                    <input type="text" id="editProjectName" name="name" required>
                    </div>
                    <div class="form-group">
                                    <label for="editProjectClient">ç™ºæ³¨è€…</label>
                                    <select id="editProjectClient" name="client_id" required>
                                        <option value="">ç™ºæ³¨è€…ã‚’é¸æŠ</option>
                                    </select>
                    </div>
                </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProjectStartDate">é–‹å§‹æ—¥</label>
                                    <input type="date" id="editProjectStartDate" name="start_date" required>
                                </div>
                                <div class="form-group">
                                    <label for="editProjectEndDate">çµ‚äº†æ—¥</label>
                                    <input type="date" id="editProjectEndDate" name="end_date" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="editProjectStatus" name="status" required>
                                    <option value="active">é€²è¡Œä¸­</option>
                                    <option value="completed">å®Œäº†</option>
                                    <option value="on_hold">ä¿ç•™</option>
                                </select>
                            </div>
                </div>
            </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="updateProject()">æ›´æ–°</button>
                </div>
        </div>
    </div>

        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="deleteProjectModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ç¢ºèª</h3>
                    <button class="modal-close" onclick="closeDeleteProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="project-delete-info">
                        <strong>ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</strong>
                        <p id="deleteProjectInfo">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: <span id="deleteProjectName"></span></p>
                        <p style="color: #dc3545; font-weight: bold;">â€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProject()">å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal task-modal">
            <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">ã‚¿ã‚¹ã‚¯ç·¨é›†</h3>
                    <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
                <div class="modal-content task-modal-content">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        
                        <!-- ã‚¿ã‚¹ã‚¯åŸºæœ¬æƒ…å ± -->
                <div class="task-info">
                            <h4 id="taskTitle"></h4>
                        </div>
                        
                        <!-- ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ  -->
                        <div class="task-form-row">
                    <div class="task-status-selector">
                                <label for="taskStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="taskStatus" name="status" required>
                            <option value="not_started">æœªç€æ‰‹</option>
                            <option value="in_progress">é€²è¡Œä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="not_applicable">å¯¾è±¡å¤–</option>
                        </select>
                    </div>
                    <div class="task-assignment">
                                <label for="taskAssignee">æ‹…å½“è€…</label>
                                <select id="taskAssignee" name="assigned_to">
                            <option value="">æœªå‰²å½“</option>
                        </select>
                    </div>
                    <div class="task-date">
                                <label for="taskDueDate">æœŸé™</label>
                                <input type="date" id="taskDueDate" name="due_date">
                            </div>
                    </div>
                    
                        <!-- ã‚¿ã‚¹ã‚¯å†…å®¹è¡¨ç¤º -->
                        <div class="task-content">
                            <label>ä½œæ¥­å†…å®¹</label>
                            <div class="task-content-display" id="taskContentDisplay"></div>
                        </div>

                        <!-- ã‚¿ã‚¹ã‚¯ãƒ¡ã‚¿æƒ…å ± -->
                    <div class="task-meta">
                        <div class="task-meta-item">
                                <span class="meta-label">ãƒ•ã‚§ãƒ¼ã‚º:</span>
                                <span id="taskPhase"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">ä½œæ¥­é †åº:</span>
                                <span id="taskOrder"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">æŠ€è¡“ä½œæ¥­:</span>
                            <span id="taskTechnical"></span>
                        </div>
                        <div class="task-meta-item">
                            <span class="meta-label">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«:</span>
                                <span id="taskManualInfo"></span>
                    </div>
                </div>
                
                        <!-- ä½œæ¥­ãƒ¡ãƒ¢ -->
                <div class="task-notes">
                            <label>ä½œæ¥­ãƒ¡ãƒ¢</label>
                            
                            <!-- æ—¢å­˜ãƒ¡ãƒ¢ã®å±¥æ­´ -->
                            <div class="notes-history" id="notesHistory">
                                <!-- ãƒ¡ãƒ¢å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                            <!-- æ–°ã—ã„ãƒ¡ãƒ¢è¿½åŠ  -->
                            <div class="add-note-section">
                                <textarea id="newNote" placeholder="æ–°ã—ã„ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="4"></textarea>
                                <button type="button" class="btn btn-primary" onclick="addNote()">ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let allTasks = [];
        let filteredTasks = [];
        let allPhases = [];
        let currentPhaseFilter = 'all';
        let allUsers = [];
        let allClients = [];
        let allTemplates = [];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†');
            loadProjects();
            loadUserInfo();
            setupEventListeners();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
            document.getElementById('projectSelect').addEventListener('change', function() {
                const projectId = this.value;
                if (projectId) {
                    loadProject(projectId);
                } else {
                    hideProjectInfo();
                }
            });

            // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('newProjectBtn').addEventListener('click', function() {
                openNewProjectModal();
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, true);
                
                overlay.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, true);
            });
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¨­å®š
        function setDefaultUserInfo() {
            document.getElementById('userName').textContent = 'ç®¡ç†è€…';
            document.getElementById('userRole').textContent = 'ç®¡ç†è€…';
            console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¾ã—ãŸ');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
        async function loadUserInfo() {
            try {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                
                // ã¾ãšå°‚ç”¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã™
                const response = await fetch('api.php?path=user/profile');
                const data = await response.json();
                
                console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«APIå¿œç­”:', data);
                
                if (data.success && data.name) {
                    document.getElementById('userName').textContent = data.name;
                    document.getElementById('userRole').textContent = getRoleText(data.role || 'manager');
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¨­å®šå®Œäº†:', data.name, data.role);
                } else {
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š');
                    setDefaultUserInfo();
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                console.log('ä»£æ›¿æ‰‹æ®µã‚’è©¦è¡Œä¸­...');
                
                // ä»£æ›¿æ‰‹æ®µã‚’è©¦è¡Œ
                if (!await loadUserInfoAlternative()) {
                    setDefaultUserInfo();
                }
            }
        }

        // ä»£æ›¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
        async function loadUserInfoAlternative() {
            try {
                const response = await fetch('api.php?path=users');
                const data = await response.json();
                
                console.log('ä»£æ›¿ãƒ¦ãƒ¼ã‚¶ãƒ¼APIå¿œç­”:', data);
                
                if (data.success && data.users && data.users.length > 0) {
                    // æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆé€šå¸¸ã¯ç®¡ç†è€…ï¼‰ã‚’ä½¿ç”¨
                    const user = data.users[0];
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userRole').textContent = getRoleText(user.role);
                    console.log('ä»£æ›¿æ‰‹æ®µã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¨­å®šå®Œäº†:', user.name, user.role);
                    return true;
                }
                
                console.log('ä»£æ›¿æ‰‹æ®µã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return false;
            } catch (error) {
                console.error('ä»£æ›¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // å½¹è·åå¤‰æ›
        function getRoleText(role) {
            switch(role) {
                case 'admin': return 'ç®¡ç†è€…';
                case 'manager': return 'ç®¡ç†è€…';
                case 'user': return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                default: return 'ç®¡ç†è€…';
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadProjects() {
            try {
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('api.php?path=projects');
                const data = await response.json();
                
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAPIå¿œç­”:', data);
                
                if (data.success && data.projects) {
                    populateProjectSelect(data.projects);
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.error || 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠè‚¢ã‚’è¨­å®š
        function populateProjectSelect(projects) {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
            
            console.log(`${projects.length}å€‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿
        async function loadProject(projectId) {
            try {
                showLoading();
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­:', projectId);
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ã€ã‚¿ã‚¹ã‚¯ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’ä¸¦è¡Œå–å¾—
                const [projectResponse, tasksResponse, phasesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${projectId}`),
                    fetch(`api.php?path=projects/${projectId}/tasks`),
                    fetch('api.php?path=phases')
                ]);

                const [projectData, tasksData, phasesData] = await Promise.all([
                    projectResponse.json(),
                    tasksResponse.json(),
                    phasesResponse.json()
                ]);

                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿:', projectData);
                console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿:', tasksData);
                console.log('ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿:', phasesData);

                if (projectData.success && projectData.project) {
                    currentProject = projectData.project;
                    displayProject(currentProject);
                    
                    if (phasesData.success && phasesData.phases) {
                        allPhases = phasesData.phases;
                        setupPhaseFilters(allPhases);
                    }
                    
                    if (tasksData.success && tasksData.tasks) {
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', tasksData.tasks);
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°:', JSON.stringify(tasksData.tasks, null, 2));
                        allTasks = tasksData.tasks;
                        // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æƒ…å ±ã§ã‚¿ã‚¹ã‚¯ã‚’å……å®ŸåŒ–
                        await enrichTasksWithManualInfo();
                        console.log('enrichTasksWithManualInfo å®Œäº†å¾Œã® filteredTasks:', filteredTasks);
                        displayTasks(filteredTasks);
                        updateProgress();
                    } else {
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', tasksData);
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°:', JSON.stringify(tasksData, null, 2));
                    }
                    
                    showProjectInfo();
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', projectData.error);
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            } finally {
                hideLoading();
            }
        }

        // ã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æƒ…å ±ã§å……å®ŸåŒ–
        async function enrichTasksWithManualInfo() {
            try {
                console.log('ã‚¿ã‚¹ã‚¯ã‚’ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æƒ…å ±ã§å……å®ŸåŒ–ä¸­...');
                
                // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºç”¨ï¼‰
                const manualsResponse = await fetch('api.php?path=manuals');
                const manualsData = await manualsResponse.json();

                console.log('ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿:', manualsData);

                // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æƒ…å ±ã‚’ãƒãƒƒãƒ—ã«å¤‰æ›
                const manualsMap = new Map();
                if (manualsData.success && manualsData.manuals) {
                    manualsData.manuals.forEach(manual => {
                        manualsMap.set(manual.template_id, manual);
                    });
                }

                // ã‚¿ã‚¹ã‚¯ã‚’å……å®ŸåŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æ—¢ã«å–å¾—æ¸ˆã¿ã®æƒ…å ±ã‚’ä½¿ç”¨ï¼‰
                console.log('allTasks ã®å†…å®¹:', allTasks);
                console.log('allTasks ã®è©³ç´°:', JSON.stringify(allTasks, null, 2));
                console.log('manualsMap ã®å†…å®¹:', manualsMap);
                
                filteredTasks = allTasks.map(task => {
                    const manual = manualsMap.get(task.template_id);
                    
                    console.log(`ã‚¿ã‚¹ã‚¯ ${task.id} ã®å‡¦ç†:`, {
                        template_id: task.template_id,
                        template_name: task.template_name,
                        template_content: task.template_content,
                        is_technical_work: task.is_technical_work,
                        has_manual: task.has_manual,
                        phase_name: task.phase_name,
                        task_order: task.task_order,
                        manual: manual
                    });
                    
                    return {
                        ...task,
                        template_content: task.template_content || '',
                        is_technical_work: task.is_technical_work || '0',
                        has_manual: task.has_manual || '0',
                        manual_file_name: manual ? manual.file_name : '',
                        phase_name: task.phase_name || 'æœªåˆ†é¡',
                        task_order: task.task_order || 0
                    };
                });

                console.log('å……å®ŸåŒ–ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯:', filteredTasks);
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯å……å®ŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                filteredTasks = [...allTasks];
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
        function displayProject(project) {
            document.getElementById('projectName').textContent = project.name || 'ä¸æ˜ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';
            document.getElementById('projectClient').textContent = `ç™ºæ³¨è€…: ${project.client_name || 'ä¸æ˜'}`;
            document.getElementById('projectPeriod').textContent = `æœŸé–“: ${formatDate(project.start_date)} - ${formatDate(project.end_date)}`;
            document.getElementById('projectStatus').textContent = getStatusText(project.status);
            
            console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ:', project.name);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º/éè¡¨ç¤º
        function showProjectInfo() {
            document.getElementById('projectInfo').style.display = 'block';
            document.getElementById('taskSection').style.display = 'block';
        }

        function hideProjectInfo() {
            document.getElementById('projectInfo').style.display = 'none';
            document.getElementById('taskSection').style.display = 'none';
            currentProject = null;
            allTasks = [];
            filteredTasks = [];
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setupPhaseFilters(phases) {
            const filtersContainer = document.getElementById('taskFilters');
            filtersContainer.innerHTML = '';

            // å…¨ä½“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.textContent = 'å…¨ä½“';
            allBtn.onclick = () => filterByPhase('all');
            filtersContainer.appendChild(allBtn);

            // å„ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            phases.forEach(phase => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = phase.name;
                btn.onclick = () => filterByPhase(phase.id);
                filtersContainer.appendChild(btn);
            });
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterByPhase(phaseId) {
            currentPhaseFilter = phaseId;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            displayTasks(filteredTasks);
        }

        // ã‚¿ã‚¹ã‚¯è¡¨ç¤º
        function displayTasks(tasks) {
            console.log('displayTasks å‘¼ã³å‡ºã—:', tasks);
            console.log('displayTasks ã®è©³ç´°:', JSON.stringify(tasks, null, 2));
            const taskList = document.getElementById('taskList');
            console.log('taskList è¦ç´ :', taskList);
            
            if (!tasks || tasks.length === 0) {
                console.log('ã‚¿ã‚¹ã‚¯ãŒç©ºã¾ãŸã¯æœªå®šç¾©');
                taskList.innerHTML = '<div class="empty">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredByPhase = tasks;
            if (currentPhaseFilter !== 'all') {
                filteredByPhase = tasks.filter(task => {
                    const phase = allPhases.find(p => p.name === task.phase_name);
                    return phase && phase.id == currentPhaseFilter;
                });
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const tasksByPhase = {};
            filteredByPhase.forEach(task => {
                const phaseName = task.phase_name || 'æœªåˆ†é¡';
                if (!tasksByPhase[phaseName]) {
                    tasksByPhase[phaseName] = [];
                }
                tasksByPhase[phaseName].push(task);
            });

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«è¡¨ç¤º
            taskList.innerHTML = '';
            Object.entries(tasksByPhase).forEach(([phaseName, phaseTasks]) => {
                const phaseContainer = document.createElement('div');
                phaseContainer.className = 'phase-container';
                
                const phaseTitle = document.createElement('h3');
                phaseTitle.textContent = `${phaseName} (${phaseTasks.length})`;
                phaseContainer.appendChild(phaseTitle);
                
                const taskGrid = document.createElement('div');
                taskGrid.className = 'task-list';
                
                // ã‚¿ã‚¹ã‚¯ã‚’é †åºã§ã‚½ãƒ¼ãƒˆ
                phaseTasks.sort((a, b) => (a.task_order || 0) - (b.task_order || 0));
                
                phaseTasks.forEach(task => {
                    const taskItem = createTaskItem(task);
                    taskGrid.appendChild(taskItem);
                });
                
                phaseContainer.appendChild(taskGrid);
                taskList.appendChild(phaseContainer);
            });

            console.log(`${filteredByPhase.length}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
        }

        // ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
        function createTaskItem(task) {
            const item = document.createElement('div');
            item.className = 'task-item';
            item.onclick = () => editTask(task.id);
            
            const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed';
            
            item.innerHTML = `
                <div class="task-header">
                    <h4 class="task-title">${task.name}</h4>
                    <div class="task-status-group">
                        <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                        ${isOverdue ? '<span class="task-overdue">é…å»¶</span>' : ''}
    </div>
                </div>
                <div class="task-meta">
                    <div class="task-meta-row">
                        <div class="task-assignee">
                            <span class="icon-user"></span>
                            ${task.assigned_user_name || 'æœªå‰²å½“'}
                        </div>
                        <div class="task-date ${isOverdue ? 'overdue' : ''}">
                            <span class="icon-calendar"></span>
                            ${task.due_date ? formatDate(task.due_date) : 'æœŸé™ãªã—'}
                        </div>
                    </div>
                    <div class="task-flags">
                        ${task.is_technical_work == '1' ? '<span class="flag technical">æŠ€è¡“ä½œæ¥­</span>' : ''}
                        ${task.has_manual == '1' ? '<span class="flag manual">ğŸ“š ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š</span>' : ''}
                    </div>
                </div>
            `;
            
            return item;
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†
        async function editTask(taskId) {
            try {
                console.log('ã‚¿ã‚¹ã‚¯ç·¨é›†é–‹å§‹:', taskId);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å…ˆã«èª­ã¿è¾¼ã‚€
                await loadUsers();
                
                const task = filteredTasks.find(t => t.id == taskId);
                if (!task) {
                    console.error('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', taskId);
                    showMessage('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                console.log('ç·¨é›†å¯¾è±¡ã‚¿ã‚¹ã‚¯:', task);
                console.log('assigned_to å€¤:', task.assigned_to);

                // ã‚¿ã‚¹ã‚¯è©³ç´°ã‚’å–å¾—
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                const data = await response.json();
                
                console.log('ã‚¿ã‚¹ã‚¯è©³ç´°APIå¿œç­”:', data);
                
                if (data.success && data.task) {
                    const taskData = data.task;
                    console.log('APIå–å¾—ã‚¿ã‚¹ã‚¯ assigned_to:', taskData.assigned_to);
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    document.getElementById('taskId').value = taskData.id;
                    document.getElementById('taskTitle').textContent = taskData.name;
                    document.getElementById('taskStatus').value = taskData.status;
                    document.getElementById('taskDueDate').value = taskData.due_date || '';
                    document.getElementById('taskContentDisplay').textContent = task.template_content || 'å†…å®¹ãªã—';
                    
                    // ãƒ¡ã‚¿æƒ…å ±è¡¨ç¤º
                    document.getElementById('taskPhase').textContent = task.phase_name || 'æœªåˆ†é¡';
                    document.getElementById('taskOrder').textContent = task.task_order || '0';
                    document.getElementById('taskTechnical').textContent = task.is_technical_work == '1' ? 'ã¯ã„' : 'ã„ã„ãˆ';
                    document.getElementById('taskManualInfo').textContent = task.has_manual == '1' ? 'ã‚ã‚Š' : 'ãªã—';
                    
                    // æ‹…å½“è€…è¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿å¾Œã«è¨­å®šï¼‰
                    if (taskData.assigned_to) {
                        console.log('æ‹…å½“è€…ã‚’è¨­å®šä¸­:', taskData.assigned_to);
                        document.getElementById('taskAssignee').value = taskData.assigned_to;
                        console.log('è¨­å®šå¾Œã®å€¤:', document.getElementById('taskAssignee').value);
            } else {
                        console.log('æ‹…å½“è€…ãŒæœªè¨­å®š');
                        document.getElementById('taskAssignee').value = '';
                    }
                    
                    // ãƒ¡ãƒ¢å±¥æ­´èª­ã¿è¾¼ã¿
                    await loadTaskNotes(taskId);
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                    document.getElementById('taskModal').style.display = 'block';
            } else {
                    console.error('ã‚¿ã‚¹ã‚¯è©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ã‚¿ã‚¹ã‚¯è©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¿ã‚¹ã‚¯ç·¨é›†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadUsers() {
            try {
                const taskAssigneeSelect = document.getElementById('taskAssignee');
                const currentValue = taskAssigneeSelect.value; // ç¾åœ¨ã®å€¤ã‚’ä¿å­˜
                
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿ä¸­..., ç¾åœ¨ã®å€¤:', currentValue);
                
                const response = await fetch('api.php?path=users');
                const data = await response.json();
                
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼APIå¿œç­”:', data);
                
                if (data.success && data.users) {
                    allUsers = data.users;
                    
                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†æ§‹ç¯‰
                    taskAssigneeSelect.innerHTML = '<option value="">æœªå‰²å½“</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        taskAssigneeSelect.appendChild(option);
                    });
                    
                    // ä¿å­˜ã—ã¦ã„ãŸå€¤ã‚’å¾©å…ƒ
                    if (currentValue) {
                        taskAssigneeSelect.value = currentValue;
                        console.log('æ‹…å½“è€…å€¤ã‚’å¾©å…ƒ:', currentValue, 'â†’', taskAssigneeSelect.value);
                    }
                    
                    console.log(`${data.users.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } else {
                    console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.error);
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¿ã‚¹ã‚¯ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿
        async function loadTaskNotes(taskId) {
            try {
                const response = await fetch(`api.php?path=tasks/${taskId}/notes`);
                const data = await response.json();
                
                const notesHistory = document.getElementById('notesHistory');
                
                if (data.success && data.notes && data.notes.length > 0) {
                    notesHistory.innerHTML = '';
                    data.notes.forEach(note => {
                        const noteItem = document.createElement('div');
                        noteItem.className = 'note-item';
                        noteItem.innerHTML = `
                            <div class="note-header">
                                <span class="note-user">${note.user_name || 'ä¸æ˜'}</span>
                                <span class="note-date">${formatDateTime(note.created_at)}</span>
                            </div>
                            <div class="note-content">${note.content}</div>
                        `;
                        notesHistory.appendChild(noteItem);
                    });
            } else {
                    notesHistory.innerHTML = '<div class="note-item">ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('notesHistory').innerHTML = '<div class="note-item">ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ¡ãƒ¢è¿½åŠ 
        async function addNote() {
            const taskId = document.getElementById('taskId').value;
            const content = document.getElementById('newNote').value.trim();
            
            if (!content) {
                showMessage('ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                const response = await fetch('api.php?path=tasks/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        content: content
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('newNote').value = '';
                    await loadTaskNotes(taskId);
                    showMessage('ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                } else {
                    console.error('ãƒ¡ãƒ¢è¿½åŠ ã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ãƒ¡ãƒ¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ãƒ¡ãƒ¢è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ¡ãƒ¢ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ä¿å­˜
        async function saveTask() {
            try {
                const taskId = document.getElementById('taskId').value;
                const formData = {
                    id: taskId,
                    status: document.getElementById('taskStatus').value,
                    assigned_to: document.getElementById('taskAssignee').value || null,
                    due_date: document.getElementById('taskDueDate').value || null
                };

                console.log('ã‚¿ã‚¹ã‚¯ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', formData);

                const response = await fetch('api.php?path=tasks', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    closeTaskModal();
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    if (currentProject) {
                        await loadProject(currentProject.id);
                    }
        } else {
                    console.error('ã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // é€²æ—æ›´æ–°
        function updateProgress() {
            if (!filteredTasks || filteredTasks.length === 0) {
                document.getElementById('totalTasks').textContent = '0';
                document.getElementById('completedTasks').textContent = '0';
                document.getElementById('inProgressTasks').textContent = '0';
                document.getElementById('overdueTasks').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressText').textContent = '0%';
                return;
            }

            const total = filteredTasks.length;
            const completed = filteredTasks.filter(task => task.status === 'completed').length;
            const inProgress = filteredTasks.filter(task => task.status === 'in_progress').length;
            const overdue = filteredTasks.filter(task => {
                return task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed';
            }).length;

            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('overdueTasks').textContent = overdue;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}%`;
        }

        // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        async function openNewProjectModal() {
            try {
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ãƒ•ã‚§ãƒ¼ã‚ºã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¸¦è¡Œèª­ã¿è¾¼ã¿
                await Promise.all([
                    loadClients(),
                    loadPhases(),
                    loadTemplates()
                ]);
                
                document.getElementById('newProjectModal').style.display = 'block';
            } catch (error) {
                console.error('æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
            document.getElementById('newProjectForm').reset();
        }

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª­ã¿è¾¼ã¿
        async function loadClients() {
            try {
                const response = await fetch('api.php?path=clients');
                const data = await response.json();
                
                if (data.success && data.clients) {
                    allClients = data.clients;
                    populateClientSelect();
                }
            } catch (error) {
                console.error('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function populateClientSelect() {
            const selects = ['projectClient', 'editProjectClient'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">ç™ºæ³¨è€…ã‚’é¸æŠ</option>';
                    allClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºèª­ã¿è¾¼ã¿
        async function loadPhases() {
            try {
                const response = await fetch('api.php?path=phases');
                const data = await response.json();
                
                if (data.success && data.phases) {
                    allPhases = data.phases;
                    setupTemplateFilters();
                }
            } catch (error) {
                console.error('ãƒ•ã‚§ãƒ¼ã‚ºèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setupTemplateFilters() {
            const filtersContainer = document.getElementById('templateFilters');
            filtersContainer.innerHTML = '';

            // å…¨ä½“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.textContent = 'å…¨ä½“';
            allBtn.onclick = () => filterTemplates('all');
            filtersContainer.appendChild(allBtn);

            // å„ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            allPhases.forEach(phase => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = phase.name;
                btn.onclick = () => filterTemplates(phase.id);
                filtersContainer.appendChild(btn);
            });
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        async function loadTemplates() {
            try {
                const response = await fetch('api.php?path=task-templates');
                const data = await response.json();
                
                if (data.success && data.templates) {
                    allTemplates = data.templates;
                    displayTemplates(allTemplates);
                }
            } catch (error) {
                console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterTemplates(phaseId) {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('#templateFilters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (phaseId === 'all') {
                displayTemplates(allTemplates);
            } else {
                const filtered = allTemplates.filter(template => template.phase_id == phaseId);
                displayTemplates(filtered);
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
        function displayTemplates(templates) {
            const container = document.getElementById('templateGroups');
            container.innerHTML = '';

            if (!templates || templates.length === 0) {
                container.innerHTML = '<div class="empty">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const templatesByPhase = {};
            templates.forEach(template => {
                const phase = allPhases.find(p => p.id == template.phase_id);
                const phaseName = phase ? phase.name : 'æœªåˆ†é¡';
                
                if (!templatesByPhase[phaseName]) {
                    templatesByPhase[phaseName] = [];
                }
                templatesByPhase[phaseName].push(template);
            });

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«è¡¨ç¤º
            Object.entries(templatesByPhase).forEach(([phaseName, phaseTemplates]) => {
                const phaseGroup = document.createElement('div');
                phaseGroup.className = 'template-group';
                
                const phaseTitle = document.createElement('h5');
                phaseTitle.className = 'phase-title';
                phaseTitle.textContent = phaseName;
                phaseGroup.appendChild(phaseTitle);
                
                const templateItems = document.createElement('div');
                templateItems.className = 'template-items';
                
                phaseTemplates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.innerHTML = `
                        <label class="template-checkbox">
                            <input type="checkbox" name="templates" value="${template.id}">
                            <div class="template-info">
                                <div class="template-name">${template.name}</div>
                                <div class="template-content">${template.content || ''}</div>
                                <div class="template-flags">
                                    ${template.is_technical_work == '1' ? '<span class="flag technical">æŠ€è¡“ä½œæ¥­</span>' : ''}
                                    ${template.has_manual == '1' ? '<span class="flag manual">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š</span>' : ''}
                                </div>
                            </div>
                        </label>
                    `;
                    templateItems.appendChild(item);
                });
                
                phaseGroup.appendChild(templateItems);
                container.appendChild(phaseGroup);
            });

            updateSelectedCount();
        }

        // é¸æŠæ•°æ›´æ–°
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('input[name="templates"]:checked');
            document.getElementById('selectedCount').textContent = checkboxes.length;
        }

        // ã™ã¹ã¦é¸æŠ
        function selectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn.textContent;
            
            if (activePhaseText === 'å…¨ä½“') {
                // å…¨ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ
                document.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿é¸æŠ
                const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                    const title = group.querySelector('.phase-title');
                    return title && title.textContent === activePhaseText;
                });
                
                if (phaseGroup) {
                    phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                        checkbox.checked = true;
                    });
                }
            }
            
            updateSelectedCount();
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        async function createProject() {
            try {
                const form = document.getElementById('newProjectForm');
                const formData = new FormData(form);
                
                // é¸æŠã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                const selectedTemplates = Array.from(document.querySelectorAll('input[name="templates"]:checked'))
                    .map(cb => cb.value);

                if (selectedTemplates.length === 0) {
                    showMessage('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                const projectData = {
                    name: formData.get('name'),
                    client_id: formData.get('client_id'),
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date'),
                    templates: selectedTemplates
                };

                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ‡ãƒ¼ã‚¿:', projectData);

                const response = await fetch('api.php?path=projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                    closeNewProjectModal();
                    await loadProjects();
                    
                    // æ–°ã—ãä½œæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
                    if (data.project_id) {
                        document.getElementById('projectSelect').value = data.project_id;
                        await loadProject(data.project_id);
                    }
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†
        async function editProject() {
            if (!currentProject) {
                showMessage('ç·¨é›†ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
                await loadClients();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                document.getElementById('editProjectId').value = currentProject.id;
                document.getElementById('editProjectName').value = currentProject.name;
                document.getElementById('editProjectClient').value = currentProject.client_id;
                document.getElementById('editProjectStartDate').value = currentProject.start_date;
                document.getElementById('editProjectEndDate').value = currentProject.end_date;
                document.getElementById('editProjectStatus').value = currentProject.status;
                
                document.getElementById('editProjectModal').style.display = 'block';
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ç·¨é›†ç”»é¢ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function closeEditProjectModal() {
            document.getElementById('editProjectModal').style.display = 'none';
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°
        async function updateProject() {
            try {
                const formData = {
                    id: document.getElementById('editProjectId').value,
                    name: document.getElementById('editProjectName').value,
                    client_id: document.getElementById('editProjectClient').value,
                    start_date: document.getElementById('editProjectStartDate').value,
                    end_date: document.getElementById('editProjectEndDate').value,
                    status: document.getElementById('editProjectStatus').value
                };

                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ãƒ‡ãƒ¼ã‚¿:', formData);

                const response = await fetch('api.php?path=projects', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    closeEditProjectModal();
                    await loadProjects();
                    await loadProject(formData.id);
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
        function deleteProject() {
            if (!currentProject) {
                showMessage('å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            document.getElementById('deleteProjectName').textContent = currentProject.name;
            document.getElementById('deleteProjectModal').style.display = 'block';
        }

        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').style.display = 'none';
        }

        async function confirmDeleteProject() {
            try {
                const projectId = currentProject.id;
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤å®Ÿè¡Œ:', projectId);

                const response = await fetch(`api.php?path=projects/${projectId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                console.log('å‰Šé™¤APIå¿œç­”:', data);

                if (data.success) {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    closeDeleteProjectModal();
                    hideProjectInfo();
                    await loadProjects();
                    document.getElementById('projectSelect').value = '';
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
        async function refreshProjectData() {
            if (!currentProject) {
                showMessage('æ›´æ–°ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...', 'info');
                await loadProject(currentProject.id);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('newNote').value = '';
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }

        function getStatusText(status) {
            switch(status) {
                case 'not_started': return 'æœªç€æ‰‹';
                case 'in_progress': return 'é€²è¡Œä¸­';
                case 'completed': return 'å®Œäº†';
                case 'not_applicable': return 'å¯¾è±¡å¤–';
                case 'active': return 'é€²è¡Œä¸­';
                case 'on_hold': return 'ä¿ç•™';
                default: return status;
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                background: ${type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#667eea'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease;
            `;

            container.appendChild(messageDiv);

            // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ•°æ›´æ–°ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('change', function(e) {
            if (e.target.name === 'templates') {
                updateSelectedCount();
            }
        });
    </script>
</body>
</html>
