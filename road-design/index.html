<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“è·¯è©³ç´°è¨­è¨ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        /* ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ã®æ”¹å–„ */
        .task-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .task-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .task-status-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .task-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .task-overdue {
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .task-meta {
            margin-bottom: 1rem;
        }

        .task-meta-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .task-assignee, .task-date {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
            color: #666;
        }

        .task-date.overdue {
            color: #dc3545;
            font-weight: 600;
        }

        .task-flags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .flag {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .flag.technical {
            background: #e3f2fd;
            color: #1976d2;
        }

        .flag.manual {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .task-actions {
            display: flex;
            justify-content: flex-end;
        }

        .btn-edit {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-edit:hover {
            background: #0056b3;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ */
        .icon-user::before { content: "ğŸ‘¤ "; }
        .icon-calendar::before { content: "ğŸ“… "; }
        .icon-edit::before { content: "âœï¸ "; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰² */
        .status-not-started {
            background: #f8f9fa;
            color: #6c757d;
        }

        .status-in-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-not-applicable {
            background: #f8d7da;
            color: #721c24;
        }

        /* æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« */
        .project-modal {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 0 20px; /* å·¦å³ã®ä½™ç™½ã‚’è¿½åŠ  */
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 0 1rem 1rem 1rem; /* å·¦å³ã®ä½™ç™½ã‚’è¿½åŠ  */
            border-bottom: 1px solid #e0e0e0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.1rem;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã®ä½™ç™½ */
        .modal-header {
            padding: 1rem 1.5rem; /* å·¦å³ã®ä½™ç™½ã‚’å¢—åŠ  */
        }

        .modal-footer {
            padding: 1rem 1.5rem; /* å·¦å³ã®ä½™ç™½ã‚’å¢—åŠ  */
        }

        .template-selection {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }

        .template-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .template-filters .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .template-filters .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .template-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .template-groups {
            padding: 1rem;
        }

        .template-group {
            margin-bottom: 1.5rem;
        }

        .template-group:last-child {
            margin-bottom: 0;
        }

        .phase-title {
            margin: 0 0 0.75rem 0;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            padding: 0.5rem;
            background: #e9ecef;
            border-radius: 4px;
        }

        .template-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .template-item {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.75rem;
            background: white;
            transition: all 0.2s ease;
        }

        .template-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .template-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            margin: 0;
        }

        .template-checkbox input[type="checkbox"] {
            margin: 0;
            margin-top: 0.25rem;
        }

        .template-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .template-name {
            font-weight: 600;
            color: #333;
        }

        .template-content {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .template-flags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .template-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        .template-summary span {
            font-weight: 600;
            color: #333;
        }

        .loading, .error, .empty {
            padding: 2rem;
            text-align: center;
            color: #666;
        }

        .error {
            color: #dc3545;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .task-meta-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .task-actions {
                justify-content: flex-start;
                margin-top: 1rem;
            }

            .project-modal {
                max-width: 95vw;
                margin: 1rem 1.5rem; /* å·¦å³ã®ä½™ç™½ã‚’å¢—åŠ  */
            }

            .template-filters {
                flex-direction: column;
            }

            .template-summary {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <div class="header-left">
                <h1 class="app-title">ğŸ›£ï¸ é“è·¯è©³ç´°è¨­è¨ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <span class="user-role" id="userRole"></span>
                </div>
                <a href="settings.html" class="btn btn-info" id="settingsLink">è¨­å®š</a>
                <button class="btn btn-outline" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ/ä½œæˆã‚¨ãƒªã‚¢ -->
            <section class="project-section">
                <div class="project-header">
                    <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</h2>
                    <button class="btn btn-primary" id="newProjectBtn">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</button>
                </div>
                
                <div class="project-selector">
                    <select id="projectSelect" class="project-select">
                        <option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
            </section>

            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± -->
            <section class="project-info" id="projectInfo" style="display: none;">
                <div class="project-details">
                    <h3 id="projectName"></h3>
                    <div class="project-meta">
                        <span id="projectClient"></span>
                        <span id="projectPeriod"></span>
                        <span class="project-status" id="projectStatus"></span>
                    </div>
                </div>
                
                <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
                <div class="progress-summary">
                    <div class="progress-card">
                        <div class="progress-number" id="totalTasks">0</div>
                        <div class="progress-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="completedTasks">0</div>
                        <div class="progress-label">å®Œäº†æ¸ˆã¿</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="inProgressTasks">0</div>
                        <div class="progress-label">é€²è¡Œä¸­</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number danger" id="overdueTasks">0</div>
                        <div class="progress-label">é…å»¶</div>
                    </div>
                </div>
                
                <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                <div class="overall-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </section>

            <!-- ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¨ãƒªã‚¢ -->
            <section class="task-section" id="taskSection" style="display: none;">
                <div class="task-filters" id="phaseFilters">
                    <button class="filter-btn active" data-phase="all">ã™ã¹ã¦</button>
                    <!-- ãƒ•ã‚§ãƒ¼ã‚ºã¯å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                </div>

                <!-- ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠã¯JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </section>
        </main>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal project-modal" id="newProjectModalContent">
            <div class="modal-header draggable-header">
                <h3>æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h3>
                <button class="modal-close" id="closeNewProjectModal">&times;</button>
            </div>
            <form id="newProjectForm">
                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æƒ…å ± -->
                <div class="form-section">
                    <h4>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æƒ…å ±</h4>
                    <div class="form-group">
                        <label for="projectNameInput">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå *</label>
                        <input type="text" id="projectNameInput" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="projectCodeInput">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" id="projectCodeInput" name="project_code" placeholder="ä¾‹: RD2024-001">
                    </div>
                    <div class="form-group">
                        <label for="clientNameInput">ç™ºæ³¨è€…å</label>
                        <input type="text" id="clientNameInput" name="client_name">
                    </div>
                    <div class="form-group">
                        <label for="descriptionInput">æ¦‚è¦</label>
                        <textarea id="descriptionInput" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDateInput">é–‹å§‹äºˆå®šæ—¥</label>
                            <input type="date" id="startDateInput" name="start_date">
                        </div>
                        <div class="form-group">
                            <label for="endDateInput">å®Œäº†äºˆå®šæ—¥</label>
                            <input type="date" id="endDateInput" name="target_end_date">
                        </div>
                    </div>
                </div>

                <!-- ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
                <div class="form-section">
                    <h4>ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h4>
                    <div class="template-selection">
                        <div class="template-filters" id="templateFilters">
                            <button type="button" class="filter-btn active" data-phase="all">ã™ã¹ã¦</button>
                            <!-- ãƒ•ã‚§ãƒ¼ã‚ºã¯å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                        </div>
                        <div class="template-list" id="templateList">
                            <div class="loading">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                        <div class="template-summary">
                            <span>é¸æŠæ¸ˆã¿: <span id="selectedCount">0</span>ä»¶</span>
                            <button type="button" class="btn btn-small" id="selectAllBtn">ã™ã¹ã¦é¸æŠ</button>
                            <button type="button" class="btn btn-small" id="clearAllBtn">é¸æŠè§£é™¤</button>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelNewProject">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¿ã‚¹ã‚¯è©³ç´° -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal task-modal" id="taskModalContent">
            <div class="modal-header draggable-header">
                <h3 id="taskModalTitle"></h3>
                <button class="modal-close" id="closeTaskModal">&times;</button>
            </div>
            <div class="task-modal-content">
                <div class="task-info">
                    <div class="task-status-selector">
                        <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                        <select id="taskStatusSelect">
                            <option value="not_started">æœªç€æ‰‹</option>
                            <option value="in_progress">é€²è¡Œä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="not_applicable">å¯¾è±¡å¤–</option>
                        </select>
                    </div>
                    
                    <div class="task-assignment">
                        <label>æ‹…å½“è€…:</label>
                        <select id="taskAssigneeSelect">
                            <option value="">æœªå‰²å½“</option>
                        </select>
                    </div>
                    
                    <div class="task-date">
                        <label>äºˆå®šæ—¥:</label>
                        <input type="date" id="taskPlannedDate">
                    </div>
                    
                    <div class="task-meta">
                        <div class="task-meta-item">
                            <span class="meta-label">æŠ€è¡“è€…ä½œæ¥­:</span>
                            <span id="taskTechnical"></span>
                        </div>
                        <div class="task-meta-item">
                            <span class="meta-label">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«:</span>
                            <span id="taskManual"></span>
                        </div>
                    </div>
                </div>
                
                <div class="task-notes">
                    <label>ä½œæ¥­ãƒ¡ãƒ¢:</label>
                    <textarea id="taskNotesInput" rows="4" placeholder="ä½œæ¥­ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelTaskEdit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" id="saveTaskChanges">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== é“è·¯è©³ç´°è¨­è¨ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ– ===');
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadProjects();
            loadUserInfo();
            loadPhases();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners();
            
            // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã®åˆæœŸåŒ–
            initializeDraggableModals();
        });

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadProjects() {
            try {
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹');
                const response = await fetch('api.php?path=projects', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                console.log('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
                    throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('å–å¾—ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿:', data);

                if (data.success && data.projects) {
                    displayProjects(data.projects);
                    
                    // æœ€åˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•é¸æŠ
                    if (data.projects.length > 0) {
                        selectProject(data.projects[0].id);
                    } else {
                        console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒ0ä»¶ã§ã™');
                        document.getElementById('projectSelect').innerHTML = '<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</option>';
                    }
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ:', data);
                    throw new Error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const errorMessage = error.message || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                document.getElementById('projectSelect').innerHTML = `<option value="">ã‚¨ãƒ©ãƒ¼: ${errorMessage}</option>`;
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
                showErrorMessage(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showErrorMessage(message) {
            const projectSection = document.querySelector('.project-section');
            let errorDiv = projectSection.querySelector('.error-message');
            
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 1rem; border: 1px solid #f5c6cb; border-radius: 4px; margin: 1rem 0;';
                projectSection.appendChild(errorDiv);
            }
            
            errorDiv.innerHTML = `
                <h4>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                <p>${message}</p>
                <p><a href="debug_projects.php" target="_blank">ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèª</a></p>
            `;
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§è¡¨ç¤º
        function displayProjects(projects) {
            const select = document.getElementById('projectSelect');
            
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒï¼‰
            select.innerHTML = '<option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.client_name || 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªè¨­å®š'})`;
                select.appendChild(option);
            });
            
            console.log(`${projects.length}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠæ™‚ã®å‡¦ç†
        async function selectProject(projectId) {
            if (!projectId) return;
            
            try {
                console.log(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ: ID ${projectId}`);
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°æƒ…å ±å–å¾—ï¼ˆprojects/<id> å½¢å¼ï¼‰
                const response = await fetch(`api.php?path=projects/${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°:', data);

                if (data.success && data.project) {
                    console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°å–å¾—æˆåŠŸ:', data.project);
                    displayProjectInfo(data.project);
                    
                    // è©³ç´°APIã®tasksã‚’ãã®ã¾ã¾ä½¿ç”¨
                    if (data.tasks && Array.isArray(data.tasks)) {
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data.tasks.length, 'ä»¶');
                        displayTaskStatistics(data.tasks);
                        displayTasksByPhase(data.tasks);
                    } else {
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè¡Œ');
                        // å¿µã®ãŸã‚å¾“æ¥ã®å–å¾—ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        loadProjectTasks(projectId);
                    }
            } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ã®å–å¾—ã«å¤±æ•—:', data);
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
        function displayProjectInfo(project) {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('projectInfo').style.display = 'block';
            document.getElementById('taskSection').style.display = 'block';
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
            document.getElementById('projectName').textContent = project.name;
            
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
            document.getElementById('projectClient').textContent = project.client_name || 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªè¨­å®š';
            
            // æœŸé–“
            const startDate = project.start_date ? new Date(project.start_date).toLocaleDateString('ja-JP') : 'æœªè¨­å®š';
            const endDate = project.end_date ? new Date(project.end_date).toLocaleDateString('ja-JP') : 'æœªè¨­å®š';
            document.getElementById('projectPeriod').textContent = `${startDate} ~ ${endDate}`;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            const statusElement = document.getElementById('projectStatus');
            const statusText = getStatusText(project.status);
            statusElement.textContent = statusText;
            statusElement.className = `project-status status-${project.status}`;
            
            console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿
        async function loadProjectTasks(projectId) {
            try {
                console.log(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ${projectId} ã®ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿é–‹å§‹`);
                const response = await fetch(`api.php?path=tasks&project_id=${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                console.log('å–å¾—ã—ãŸã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿:', data);

                if (data.success && data.tasks) {
                    displayTaskStatistics(data.tasks);
                    displayTasksByPhase(data.tasks);
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¿ã‚¹ã‚¯çµ±è¨ˆè¡¨ç¤º
        function displayTaskStatistics(tasks) {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const inProgressTasks = tasks.filter(task => task.status === 'in_progress').length;
            const overdueTasks = tasks.filter(task => {
                if (task.planned_date && task.status !== 'completed') {
                    return new Date(task.planned_date) < new Date();
                }
                return false;
            }).length;

            // çµ±è¨ˆã‚«ãƒ¼ãƒ‰æ›´æ–°
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('overdueTasks').textContent = overdueTasks;

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}%`;

            console.log(`ã‚¿ã‚¹ã‚¯çµ±è¨ˆ: ç·æ•°${totalTasks}, å®Œäº†${completedTasks}, é€²è¡Œä¸­${inProgressTasks}, é…å»¶${overdueTasks}`);
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã‚¿ã‚¹ã‚¯è¡¨ç¤º
        function displayTasksByPhase(tasks) {
            console.log('=== displayTasksByPhaseé–‹å§‹ ===');
            console.log('å—ã‘å–ã£ãŸã‚¿ã‚¹ã‚¯æ•°:', tasks.length);
            console.log('ã‚¿ã‚¹ã‚¯ã‚µãƒ³ãƒ—ãƒ«:', tasks.slice(0, 3));
            
            const phaseContainers = {};
            
            // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã«ã‚¿ã‚¹ã‚¯ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            tasks.forEach(task => {
                const phaseName = task.phase_name || 'ãƒ•ã‚§ãƒ¼ã‚ºæœªè¨­å®š';
                console.log(`ã‚¿ã‚¹ã‚¯ ${task.id}: ${task.task_name} -> ${phaseName}`);
                if (!phaseContainers[phaseName]) {
                    phaseContainers[phaseName] = [];
                }
                phaseContainers[phaseName].push(task);
            });
            
            console.log('ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã‚°ãƒ«ãƒ¼ãƒ—åŒ–çµæœ:', phaseContainers);

            // ã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã‚³ãƒ³ãƒ†ãƒŠã‚’ç”Ÿæˆ
            const taskSection = document.getElementById('taskSection');
            console.log('ã‚¿ã‚¹ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦ç´ :', taskSection);
            taskSection.innerHTML = ''; // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’å†è¿½åŠ 
            const filtersDiv = document.createElement('div');
            filtersDiv.className = 'task-filters';
            filtersDiv.innerHTML = `
                <button class="filter-btn active" data-phase="all">ã™ã¹ã¦</button>
                <button class="filter-btn" data-phase="ãƒ•ã‚§ãƒ¼ã‚º1">ãƒ•ã‚§ãƒ¼ã‚º1</button>
                <button class="filter-btn" data-phase="ãƒ•ã‚§ãƒ¼ã‚º2">ãƒ•ã‚§ãƒ¼ã‚º2</button>
                <button class="filter-btn" data-phase="ãƒ•ã‚§ãƒ¼ã‚º3">ãƒ•ã‚§ãƒ¼ã‚º3</button>
            `;
            taskSection.appendChild(filtersDiv);
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³è¿½åŠ å®Œäº†');

            // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã‚³ãƒ³ãƒ†ãƒŠã‚’ç”Ÿæˆ
            Object.keys(phaseContainers).forEach(phaseName => {
                const phaseContainer = document.createElement('div');
                phaseContainer.className = 'phase-container';
                phaseContainer.setAttribute('data-phase', phaseName);
                
                const phaseHeader = document.createElement('h3');
                phaseHeader.textContent = `${phaseName} (${phaseContainers[phaseName].length}ä»¶)`;
                phaseContainer.appendChild(phaseHeader);

                const taskList = document.createElement('div');
                taskList.className = 'task-list';
                
                phaseContainers[phaseName].forEach(task => {
                    const taskItem = createTaskItem(task);
                    taskList.appendChild(taskItem);
                });
                
                phaseContainer.appendChild(taskList);
                taskSection.appendChild(phaseContainer);
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupFilterButtons();
        }

        // ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
        function createTaskItem(task) {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.setAttribute('data-task-id', task.id);
            
            const statusClass = getStatusClass(task.status);
            const statusText = getStatusText(task.status);
            const isOverdue = task.planned_date && task.status !== 'completed' && new Date(task.planned_date) < new Date();
            
            taskItem.innerHTML = `
                <div class="task-header">
                    <h4 class="task-title">${escapeHtml(task.task_name)}</h4>
                    <div class="task-status-group">
                        <span class="task-status ${statusClass}">${statusText}</span>
                        ${isOverdue ? '<span class="task-overdue">é…å»¶</span>' : ''}
                    </div>
                </div>
                <div class="task-meta">
                    <div class="task-meta-row">
                        <span class="task-assignee">
                            <i class="icon-user"></i>
                            ${task.assigned_to_name || 'æœªå‰²å½“'}
                        </span>
                        <span class="task-date ${isOverdue ? 'overdue' : ''}">
                            <i class="icon-calendar"></i>
                            ${task.planned_date ? new Date(task.planned_date).toLocaleDateString('ja-JP') : 'æœªè¨­å®š'}
                        </span>
                    </div>
                    <div class="task-flags">
                        ${task.is_technical_work == '1' ? '<span class="flag technical">æŠ€è¡“ä½œæ¥­</span>' : ''}
                        ${task.has_manual == '1' ? '<span class="flag manual">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š</span>' : ''}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn btn-small btn-edit" onclick="editTask(${task.id})" title="ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†">
                        <i class="icon-edit"></i> ç·¨é›†
                    </button>
                </div>
            `;
            
            return taskItem;
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
        async function loadUserInfo() {
            try {
                const response = await fetch('api.php?path=user/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('userName').textContent = data.name;
                        document.getElementById('userRole').textContent = getRoleText(data.role);
                    }
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
                document.getElementById('userName').textContent = 'ç®¡ç†è€…';
                document.getElementById('userRole').textContent = 'ç®¡ç†è€…';
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠå¤‰æ›´
            document.getElementById('projectSelect').addEventListener('change', function(e) {
                if (e.target.value) {
                    selectProject(e.target.value);
                } else {
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠæ™‚ã¯æƒ…å ±ã‚’éè¡¨ç¤º
                    document.getElementById('projectInfo').style.display = 'none';
                    document.getElementById('taskSection').style.display = 'none';
                }
            });

            // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒœã‚¿ãƒ³
            document.getElementById('newProjectBtn').addEventListener('click', function() {
                document.getElementById('newProjectModal').style.display = 'block';
                loadTemplatesForSelection();
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            document.getElementById('closeNewProjectModal').addEventListener('click', function() {
                document.getElementById('newProjectModal').style.display = 'none';
                resetProjectForm();
            });

            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            document.getElementById('cancelNewProject').addEventListener('click', function() {
                document.getElementById('newProjectModal').style.display = 'none';
                resetProjectForm();
            });

            // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('newProjectForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createNewProject(this);
            });

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠé–¢é€£
            document.getElementById('selectAllBtn').addEventListener('click', function() {
                selectAllTemplates();
            });

            document.getElementById('clearAllBtn').addEventListener('click', function() {
                clearAllTemplates();
            });

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    window.location.href = 'logout.php';
                }
            });

            // ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
            document.getElementById('closeTaskModal').addEventListener('click', function() {
                document.getElementById('taskModal').style.display = 'none';
            });

            document.getElementById('cancelTaskEdit').addEventListener('click', function() {
                document.getElementById('taskModal').style.display = 'none';
            });

            document.getElementById('saveTaskChanges').addEventListener('click', async function() {
                await saveTaskChanges();
            });
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³è¨­å®š
        function setupFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const selectedPhase = this.getAttribute('data-phase');
                    
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³æ›´æ–°
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥è¡¨ç¤º
                    filterTasksByPhase(selectedPhase);
                });
            });
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterTasksByPhase(phase) {
            const phaseContainers = document.querySelectorAll('.phase-container');
            
            phaseContainers.forEach(container => {
                if (phase === 'all' || container.getAttribute('data-phase') === phase) {
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºèª­ã¿è¾¼ã¿
        async function loadPhases() {
            try {
                console.log('ãƒ•ã‚§ãƒ¼ã‚ºèª­ã¿è¾¼ã¿é–‹å§‹');
                const response = await fetch('api.php?path=phases', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('ãƒ•ã‚§ãƒ¼ã‚ºä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                if (data.success && data.phases) {
                    displayPhases(data.phases);
                } else {
                    throw new Error(data.message || 'ãƒ•ã‚§ãƒ¼ã‚ºä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ•ã‚§ãƒ¼ã‚ºèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¡¨ç¤º
                displayDefaultPhases();
            }
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º
        function displayPhases(phases) {
            const phaseFilters = document.getElementById('phaseFilters');
            if (!phaseFilters) return;

            let html = '<button class="filter-btn active" data-phase="all">ã™ã¹ã¦</button>';
            
            phases.forEach(phase => {
                html += `<button class="filter-btn" data-phase="${escapeHtml(phase.name)}">${escapeHtml(phase.name)}</button>`;
            });
            
            phaseFilters.innerHTML = html;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupFilterButtons();
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ç”¨ï¼‰
        function displayDefaultPhases() {
            const phaseFilters = document.getElementById('phaseFilters');
            if (!phaseFilters) return;

            const defaultPhases = ['è¨­è¨ˆ', 'æ–½å·¥', 'ç›£ç†'];
            let html = '<button class="filter-btn active" data-phase="all">ã™ã¹ã¦</button>';
            
            defaultPhases.forEach(phase => {
                html += `<button class="filter-btn" data-phase="${escapeHtml(phase)}">${escapeHtml(phase)}</button>`;
            });
            
            phaseFilters.innerHTML = html;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupFilterButtons();
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠç”¨èª­ã¿è¾¼ã¿
        async function loadTemplatesForSelection() {
            try {
                console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠç”¨èª­ã¿è¾¼ã¿é–‹å§‹');
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ãƒ•ã‚§ãƒ¼ã‚ºã‚’ä¸¦è¡Œã—ã¦èª­ã¿è¾¼ã¿
                const [templatesResponse, phasesResponse] = await Promise.all([
                    fetch('api.php?path=templates', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }),
                    fetch('api.php?path=phases', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                ]);

                let templates = [];
                let phases = [];

                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                if (templatesResponse.ok) {
                    const templatesData = await templatesResponse.json();
                    if (templatesData.success && templatesData.templates) {
                        templates = templatesData.templates;
                    }
                }

                // ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                if (phasesResponse.ok) {
                    const phasesData = await phasesResponse.json();
                    if (phasesData.success && phasesData.phases) {
                        phases = phasesData.phases;
                    }
                }

                // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®š
                displayPhaseFilters(phases);
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¡¨ç¤º
                if (templates.length > 0) {
                    displayTemplatesForSelection(templates);
                } else {
                    document.getElementById('templateList').innerHTML = '<div class="empty">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                }
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã‚’è¨­å®š
                setupTemplateFilters();
                
            } catch (error) {
                console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('templateList').innerHTML = '<div class="error">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º
        function displayPhaseFilters(phases) {
            const filtersContainer = document.getElementById('templateFilters');
            filtersContainer.innerHTML = '';
            
            // ãƒ•ã‚§ãƒ¼ã‚ºãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            if (phases && phases.length > 0) {
                phases.forEach((phase, index) => {
                    const phaseButton = document.createElement('button');
                    phaseButton.type = 'button';
                    phaseButton.className = index === 0 ? 'filter-btn active' : 'filter-btn';
                    phaseButton.setAttribute('data-phase', phase.name);
                    phaseButton.textContent = phase.name;
                    filtersContainer.appendChild(phaseButton);
                });
                
                // æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤º
                if (phases.length > 0) {
                    filterTemplatesByPhase(phases[0].name);
                }
            } else {
                // ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const fallbackPhases = ['è¨­è¨ˆ', 'æ–½å·¥', 'ç›£ç†'];
                fallbackPhases.forEach((phaseName, index) => {
                    const phaseButton = document.createElement('button');
                    phaseButton.type = 'button';
                    phaseButton.className = index === 0 ? 'filter-btn active' : 'filter-btn';
                    phaseButton.setAttribute('data-phase', phaseName);
                    phaseButton.textContent = phaseName;
                    filtersContainer.appendChild(phaseButton);
                });
                
                // æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤º
                if (fallbackPhases.length > 0) {
                    filterTemplatesByPhase(fallbackPhases[0]);
                }
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠè¡¨ç¤º
        function displayTemplatesForSelection(templates) {
            const container = document.getElementById('templateList');
            
            if (!templates || templates.length === 0) {
                container.innerHTML = '<div class="empty">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedTemplates = {};
            templates.forEach(template => {
                if (!groupedTemplates[template.phase_name]) {
                    groupedTemplates[template.phase_name] = [];
                }
                groupedTemplates[template.phase_name].push(template);
            });

            let html = '<div class="template-groups">';
            
            Object.keys(groupedTemplates).sort().forEach(phaseName => {
                const phaseTemplates = groupedTemplates[phaseName];
                phaseTemplates.sort((a, b) => a.task_order - b.task_order);
                
                html += `
                    <div class="template-group" data-phase="${escapeHtml(phaseName)}">
                        <h5 class="phase-title">${escapeHtml(phaseName)}</h5>
                        <div class="template-items">
                `;
                
                phaseTemplates.forEach(template => {
                    html += `
                        <div class="template-item" data-template-id="${template.id}">
                            <label class="template-checkbox">
                                <input type="checkbox" name="selected_templates[]" value="${template.id}">
                                <span class="template-info">
                                    <span class="template-name">${escapeHtml(template.task_name)}</span>
                                    <span class="template-content">${escapeHtml(template.content || '')}</span>
                                    <span class="template-flags">
                                        ${template.is_technical_work == '1' ? '<span class="flag technical">æŠ€è¡“ä½œæ¥­</span>' : ''}
                                        ${template.has_manual == '1' ? '<span class="flag manual">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š</span>' : ''}
                                    </span>
                                </span>
                            </label>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupTemplateCheckboxes();
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setupTemplateFilters() {
            document.querySelectorAll('.template-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const selectedPhase = this.getAttribute('data-phase');
                    
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³æ›´æ–°
                    document.querySelectorAll('.template-filters .filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®è¡¨ç¤º/éè¡¨ç¤º
                    filterTemplatesByPhase(selectedPhase);
                });
            });
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterTemplatesByPhase(selectedPhase) {
            document.querySelectorAll('.template-group').forEach(group => {
                if (group.getAttribute('data-phase') === selectedPhase) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            });
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š
        function setupTemplateCheckboxes() {
            document.querySelectorAll('input[name="selected_templates[]"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });
        }

        // é¸æŠæ¸ˆã¿ä»¶æ•°æ›´æ–°
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('input[name="selected_templates[]"]:checked').length;
            document.getElementById('selectedCount').textContent = selectedCount;
        }

        // ã™ã¹ã¦é¸æŠ
        function selectAllTemplates() {
            // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚§ãƒ¼ã‚ºã‚’å–å¾—
            const activePhase = document.querySelector('.template-filters .filter-btn.active');
            if (!activePhase) return;
            
            const selectedPhase = activePhase.getAttribute('data-phase');
            
            // é¸æŠã•ã‚ŒãŸãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿ã‚’é¸æŠ
            document.querySelectorAll('input[name="selected_templates[]"]').forEach(checkbox => {
                const templateItem = checkbox.closest('.template-item');
                const templateGroup = templateItem.closest('.template-group');
                
                if (templateGroup && templateGroup.getAttribute('data-phase') === selectedPhase) {
                    checkbox.checked = true;
                }
            });
            updateSelectedCount();
        }

        // ã™ã¹ã¦é¸æŠè§£é™¤
        function clearAllTemplates() {
            // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚§ãƒ¼ã‚ºã‚’å–å¾—
            const activePhase = document.querySelector('.template-filters .filter-btn.active');
            if (!activePhase) return;
            
            const selectedPhase = activePhase.getAttribute('data-phase');
            
            // é¸æŠã•ã‚ŒãŸãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿ã‚’é¸æŠè§£é™¤
            document.querySelectorAll('input[name="selected_templates[]"]').forEach(checkbox => {
                const templateItem = checkbox.closest('.template-item');
                const templateGroup = templateItem.closest('.template-group');
                
                if (templateGroup && templateGroup.getAttribute('data-phase') === selectedPhase) {
                    checkbox.checked = false;
                }
            });
            updateSelectedCount();
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetProjectForm() {
            document.getElementById('newProjectForm').reset();
            clearAllTemplates();
            document.getElementById('templateList').innerHTML = '<div class="loading">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
        }

        // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–
        function initializeDraggableModals() {
            const modals = [
                { id: 'newProjectModalContent', overlay: 'newProjectModal' },
                { id: 'taskModalContent', overlay: 'taskModal' }
            ];

            modals.forEach(modal => {
                const modalElement = document.getElementById(modal.id);
                const overlayElement = document.getElementById(modal.overlay);
                const headerElement = modalElement.querySelector('.draggable-header');

                if (modalElement && headerElement) {
                    makeDraggable(modalElement, headerElement, overlayElement);
                }
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
        function makeDraggable(modalElement, headerElement, overlayElement) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            // åˆæœŸä½ç½®ã‚’ä¸­å¤®ã«è¨­å®š
            function centerModal() {
                const modalRect = modalElement.getBoundingClientRect();
                const overlayRect = overlayElement.getBoundingClientRect();
                
                xOffset = (overlayRect.width - modalRect.width) / 2;
                yOffset = (overlayRect.height - modalRect.height) / 2;
                
                setTranslate(xOffset, yOffset, modalElement);
            }

            // ä½ç½®ã‚’è¨­å®š
            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
            }

            // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            function dragStart(e) {
                if (e.target.closest('.modal-close') || e.target.closest('input') || e.target.closest('textarea') || e.target.closest('select')) {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === headerElement || headerElement.contains(e.target)) {
                    isDragging = true;
                    headerElement.style.cursor = 'grabbing';
                }
            }

            // ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modalElement);
                }
            }

            // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                headerElement.style.cursor = 'grab';
            }

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
            function touchStart(e) {
                if (e.target.closest('.modal-close') || e.target.closest('input') || e.target.closest('textarea') || e.target.closest('select')) {
                    return;
                }

                const touch = e.touches[0];
                initialX = touch.clientX - xOffset;
                initialY = touch.clientY - yOffset;

                if (e.target === headerElement || headerElement.contains(e.target)) {
                    isDragging = true;
                }
            }

            function touchMove(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    currentX = touch.clientX - initialX;
                    currentY = touch.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modalElement);
                }
            }

            function touchEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            headerElement.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
            headerElement.addEventListener('touchstart', touchStart, { passive: false });
            document.addEventListener('touchmove', touchMove, { passive: false });
            document.addEventListener('touchend', touchEnd);

            // åˆæœŸä½ç½®ã‚’è¨­å®š
            centerModal();

            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ä¸­å¤®ã«æˆ»ã™
            window.addEventListener('resize', centerModal);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«ä¸­å¤®ã«æˆ»ã™
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const display = overlayElement.style.display;
                        if (display === 'block') {
                            setTimeout(centerModal, 10);
                        }
                    }
                });
            });

            observer.observe(overlayElement, { attributes: true });
        }

        // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        async function createNewProject(form) {
            try {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // é¸æŠã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’å–å¾—
                const selectedTemplates = Array.from(document.querySelectorAll('input[name="selected_templates[]"]:checked'))
                    .map(checkbox => checkbox.value);
                
                data.selected_templates = selectedTemplates;
                
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ‡ãƒ¼ã‚¿:', data);
                
                const response = await fetch('api.php?path=projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                });

                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
                    throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${response.status}): ${errorText}`);
                }

                const result = await response.json();
                console.log('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
                
                if (result.success) {
                    alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ');
                    document.getElementById('newProjectModal').style.display = 'none';
                    resetProjectForm();
                    
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    loadProjects();
                } else {
                    throw new Error(result.message || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†
        async function editTask(taskId) {
            try {
                console.log(`ã‚¿ã‚¹ã‚¯ç·¨é›†é–‹å§‹: ID ${taskId}`);
                
                // ã‚¿ã‚¹ã‚¯è©³ç´°æƒ…å ±ã‚’å–å¾—
                const response = await fetch(`api.php?path=tasks/${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                console.log('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
                console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTPã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
                    throw new Error(`ã‚¿ã‚¹ã‚¯è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${response.status})`);
                }

                const data = await response.json();
                console.log('ã‚¿ã‚¹ã‚¯è©³ç´°:', data);

                if (data.success && data.task) {
                    // ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’è¨­å®š
                    document.getElementById('taskModalTitle').textContent = data.task.task_name;
                    document.getElementById('taskStatusSelect').value = data.task.status || 'not_started';
                    document.getElementById('taskAssigneeSelect').value = data.task.assigned_to || '';
                    document.getElementById('taskPlannedDate').value = data.task.planned_date || '';
                    document.getElementById('taskTechnical').textContent = data.task.is_technical_work == '1' ? 'æŠ€è¡“è€…ä½œæ¥­' : 'ä¸€èˆ¬ä½œæ¥­';
                    document.getElementById('taskManual').textContent = data.task.has_manual == '1' ? 'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š' : 'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãªã—';
                    document.getElementById('taskNotesInput').value = data.task.notes || '';
                    
                    // æ‹…å½“è€…é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿
                    await loadUsers();
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    document.getElementById('taskModal').style.display = 'block';
                    
                    // ã‚¿ã‚¹ã‚¯IDã‚’ä¿å­˜
                    document.getElementById('taskModal').setAttribute('data-task-id', taskId);
                } else {
                    throw new Error(data.message || 'ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¿ã‚¹ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadUsers() {
            try {
                const response = await fetch('api.php?path=users', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.users) {
                        const select = document.getElementById('taskAssigneeSelect');
                        select.innerHTML = '<option value="">æœªå‰²å½“</option>';
                        
                        data.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.name;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¿ã‚¹ã‚¯å¤‰æ›´ä¿å­˜
        async function saveTaskChanges() {
            const taskId = document.getElementById('taskModal').getAttribute('data-task-id');
            if (!taskId) {
                alert('ã‚¿ã‚¹ã‚¯IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            try {
                const status = document.getElementById('taskStatusSelect').value;
                const assignedTo = document.getElementById('taskAssigneeSelect').value;
                const plannedDate = document.getElementById('taskPlannedDate').value;
                const notes = document.getElementById('taskNotesInput').value;

                console.log('ã‚¿ã‚¹ã‚¯ä¿å­˜:', { taskId, status, assignedTo, plannedDate, notes });

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                if (status) {
                    const statusResponse = await fetch('api.php?path=tasks/status', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            status: status,
                            notes: notes
                        })
                    });

                    if (!statusResponse.ok) {
                        throw new Error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }

                // æ‹…å½“è€…ãƒ»äºˆå®šæ—¥æ›´æ–°
                if (assignedTo !== '' || plannedDate) {
                    const updateResponse = await fetch('api.php?path=tasks/update', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            assigned_to: assignedTo || null,
                            planned_date: plannedDate || null
                        })
                    });

                    if (!updateResponse.ok) {
                        throw new Error('ã‚¿ã‚¹ã‚¯æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }

                alert('ã‚¿ã‚¹ã‚¯ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                document.getElementById('taskModal').style.display = 'none';
                
                // ç¾åœ¨é¸æŠä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                const currentProjectId = document.getElementById('projectSelect').value;
                if (currentProjectId) {
                    selectProject(currentProjectId);
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getStatusText(status) {
            const statusMap = {
                'not_started': 'æœªç€æ‰‹',
                'in_progress': 'é€²è¡Œä¸­',
                'completed': 'å®Œäº†',
                'not_applicable': 'å¯¾è±¡å¤–',
                'planning': 'è¨ˆç”»ä¸­',
                'in_progress': 'é€²è¡Œä¸­',
                'completed': 'å®Œäº†',
                'on_hold': 'ä¿ç•™'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            const classMap = {
                'not_started': 'status-not-started',
                'in_progress': 'status-in-progress',
                'completed': 'status-completed',
                'not_applicable': 'status-not-applicable',
                'planning': 'status-planning',
                'on_hold': 'status-on-hold'
            };
            return classMap[status] || 'status-default';
        }

        function getRoleText(role) {
            const roleMap = {
                'manager': 'ç®¡ç†è€…',
                'technical': 'æŠ€è¡“è€…',
                'general': 'ä¸€èˆ¬ã‚¹ã‚¿ãƒƒãƒ•'
            };
            return roleMap[role] || role;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>