<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÅìË∑ØË®≠Ë®àÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/index.css">
</head>
<body>
    <div class="container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üöß</div>
                <div class="logo-text">
                    <h1>ÈÅìË∑ØË®≠Ë®àÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                    <p>Road Design Management System</p>
            </div>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-name" id="userName">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                        <span class="user-role" id="userRole">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                </div>
                </div>
                <a href="settings.html" id="settingsBtn" class="btn btn-secondary" style="display:none;">‚öôÔ∏è Ë®≠ÂÆö</a>
                <a href="logout.php" class="btn btn-secondary">üö™ „É≠„Ç∞„Ç¢„Ç¶„Éà</a>
            </div>
        </header>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <main class="main-container">
            <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû/‰ΩúÊàê„Ç®„É™„Ç¢ -->
            <section class="project-section">
                <div class="card">
                <div class="project-header">
                    <h2>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ</h2>
                    <div class="header-buttons">
                        <button class="btn btn-primary" id="newProjectBtn">üöÄ Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà</button>
                    </div>
                </div>
                
                <div class="project-selector">
                    <select id="projectSelect" class="project-select">
                        <option value="">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                    </select>
                    </div>
                </div>
            </section>

            <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†± -->
            <section class="project-info" id="projectInfo" style="display: none;">
                <div class="card">
                <div class="project-details">
                        <div class="project-header-row">
                    <h3 id="projectName"></h3>
                            <div class="project-actions">
                                <button class="btn btn-primary btn-small" id="editProjectBtn" onclick="editProject()">
                                    ‚úèÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ
                                </button>
                                <button class="btn btn-secondary btn-small" id="refreshProjectBtn" onclick="refreshProjectData()" title="ÊúÄÊñ∞„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÇíÂèñÂæó">
                                    üîÑ Êõ¥Êñ∞
                                </button>
                                <button class="btn btn-danger btn-small" id="deleteProjectBtn" onclick="deleteProject()">
                                    üóëÔ∏è „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§
                                </button>
                            </div>
                        </div>
                    <div class="project-meta">
                        <span id="projectClientInfo"></span>
                        <span id="projectPeriod"></span>
                        <span class="project-status" id="projectStatus"></span>
                    </div>
                </div>
                
                <!-- ÈÄ≤Êçó„Çµ„Éû„É™„Éº -->
                <div class="progress-summary">
                    <div class="progress-card">
                        <div class="progress-number" id="totalTasks">0</div>
                        <div class="progress-label">Á∑è„Çø„Çπ„ÇØÊï∞</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="completedTasks">0</div>
                        <div class="progress-label">ÂÆå‰∫ÜÊ∏à„Åø</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="inProgressTasks">0</div>
                        <div class="progress-label">ÈÄ≤Ë°å‰∏≠</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number danger" id="needsConfirmationTasks">0</div>
                        <div class="progress-label">Ë¶ÅÁ¢∫Ë™ç</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number danger" id="overdueTasks">0</div>
                        <div class="progress-label">ÈÅÖÂª∂</div>
                    </div>
                </div>
                
                <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
                <div class="overall-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
            </section>

            <!-- „Çø„Çπ„ÇØÁÆ°ÁêÜ -->
            <section class="task-section" id="taskSection" style="display: none;">
                <div class="card">
                    <h3>„Çø„Çπ„ÇØÁÆ°ÁêÜ</h3>
                    
                    <!-- „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº -->
                    <div class="task-filters" id="taskFilters">
                        <!-- „Éï„Çß„Éº„Ç∫„Éú„Çø„É≥„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                </div>

                    <!-- „Çø„Çπ„ÇØ„É™„Çπ„Éà -->
                    <div id="taskList" class="task-content">
                        <!-- „Çø„Çπ„ÇØ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                </div>
            </section>
        </main>

        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>

        <!-- „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
        <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 2000;"></div>

        <!-- „É¢„Éº„ÉÄ„É´„Åì„Åì„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
        
        <!-- Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="newProjectModal">
            <div class="modal project-modal">
            <div class="modal-header">
                    <h3 class="modal-title">Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê</h3>
                    <button class="modal-close" onclick="closeNewProjectModal()">&times;</button>
            </div>
                <div class="modal-content">
            <form id="newProjectForm">
                        <div class="form-section">
                            <h4>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂü∫Êú¨ÊÉÖÂ†±</h4>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectName">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç</label>
                                    <input type="text" id="projectName" name="name" required>
                </div>
                <div class="form-group">
                                    <label for="newProjectClient">Áô∫Ê≥®ËÄÖ</label>
                                    <select id="newProjectClient" name="client_id" required>
                                        <option value="">Áô∫Ê≥®ËÄÖ„ÇíÈÅ∏Êäû</option>
                                    </select>
                </div>
                            </div>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectStartDate">ÈñãÂßãÊó•</label>
                                    <input type="date" id="projectStartDate" name="start_date" required>
                </div>
                <div class="form-group">
                                    <label for="projectEndDate">ÁµÇ‰∫ÜÊó•</label>
                                    <input type="date" id="projectEndDate" name="end_date" required>
                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû</h4>
                            <div class="template-selection">
                                <div class="template-filters" id="templateFilters">
                                    <!-- „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                </div>
                                <div class="template-list">
                                    <div class="template-groups" id="templateGroups">
                                        <!-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                    </div>
                                </div>
                                <div class="template-summary">
                                    <span>ÈÅ∏ÊäûÊ∏à„Åø: <span id="selectedCount">0</span>‰ª∂</span>
                                    <button type="button" class="btn btn-secondary" onclick="selectAllTemplates()">„Åô„Åπ„Å¶ÈÅ∏Êäû</button>
                                    <button type="button" class="btn btn-secondary" onclick="deselectAllTemplates()">„Åô„Åπ„Å¶Ëß£Èô§</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" onclick="createProject()">„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê</button>
                </div>
            </div>
        </div>

        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
        <div class="modal-overlay" id="editProjectModal">
            <div class="modal project-modal">
                <div class="modal-header">
                    <h3 class="modal-title">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ</h3>
                    <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="editProjectForm">
                        <input type="hidden" id="editProjectId">
                        <div class="form-section">
                            <h4>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂü∫Êú¨ÊÉÖÂ†±</h4>
                <div class="form-row">
                    <div class="form-group">
                                    <label for="editProjectName">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç</label>
                                    <input type="text" id="editProjectName" name="name" required>
                    </div>
                    <div class="form-group">
                                    <label for="editProjectClient">Áô∫Ê≥®ËÄÖ</label>
                                    <select id="editProjectClient" name="client_id" required>
                                        <option value="">Áô∫Ê≥®ËÄÖ„ÇíÈÅ∏Êäû</option>
                                    </select>
                    </div>
                </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProjectStartDate">ÈñãÂßãÊó•</label>
                                    <input type="date" id="editProjectStartDate" name="start_date" required>
                                </div>
                                <div class="form-group">
                                    <label for="editProjectEndDate">ÁµÇ‰∫ÜÊó•</label>
                                    <input type="date" id="editProjectEndDate" name="end_date" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <select id="editProjectStatus" name="status" required>
                                    <option value="planning">Ë®àÁîª‰∏≠</option>
                                    <option value="in_progress">ÈÄ≤Ë°å‰∏≠</option>
                                    <option value="completed">ÂÆå‰∫Ü</option>
                                    <option value="cancelled">‰∏≠Ê≠¢</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- „Çø„Çπ„ÇØÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="form-section">
                            <h4>„Çø„Çπ„ÇØÁÆ°ÁêÜ</h4>
                            
                            <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„Ç®„É™„Ç¢ -->
                            <div class="template-selection-area" id="templateSelectionArea">
                                <h5>„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû</h5>
                                <div class="template-selection">
                                    <div class="template-filters" id="editTemplateFilters">
                                        <!-- „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                    </div>
                                    <div class="template-list">
                                        <div class="template-groups" id="editTemplateGroups">
                                            <!-- „ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                        </div>
                                    </div>
                                    <div class="template-actions">
                                        <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" onclick="updateProject()">Êõ¥Êñ∞</button>
                </div>
        </div>
    </div>

        <!-- „Çø„Çπ„ÇØËøΩÂä†„ÉªÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
        <div class="modal-overlay" id="taskEditModal">
            <div class="modal task-modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="taskEditModalTitle">„Çø„Çπ„ÇØËøΩÂä†</h3>
                    <button class="modal-close" onclick="closeTaskEditModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="taskEditForm">
                        <input type="hidden" id="editTaskId">
                        <input type="hidden" id="editTaskProjectId">
                        
                        <div class="form-group">
                            <label for="editTaskName">„Çø„Çπ„ÇØÂêç</label>
                            <input type="text" id="editTaskName" name="task_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskPhase">„Éï„Çß„Éº„Ç∫</label>
                            <select id="editTaskPhase" name="phase_name" required>
                                <option value="„Éï„Çß„Éº„Ç∫1">„Éï„Çß„Éº„Ç∫1</option>
                                <option value="„Éï„Çß„Éº„Ç∫2">„Éï„Çß„Éº„Ç∫2</option>
                                <option value="„Éï„Çß„Éº„Ç∫3">„Éï„Çß„Éº„Ç∫3</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskOrder">È†ÜÂ∫è</label>
                            <input type="number" id="editTaskOrder" name="task_order" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskEstimatedHours">Ë¶ãÁ©çÊôÇÈñìÔºàÊôÇÈñìÔºâ</label>
                            <input type="number" id="editTaskEstimatedHours" name="estimated_hours" min="0" step="0.5">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editTaskIsTechnical" name="is_technical_work">
                                ÊäÄË°ì‰ΩúÊ•≠
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editTaskHasManual" name="has_manual">
                                „Éû„Éã„É•„Ç¢„É´„ÅÇ„Çä
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskEditModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>

        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
        <div class="modal-overlay" id="deleteProjectModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§Á¢∫Ë™ç</h3>
                    <button class="modal-close" onclick="closeDeleteProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="project-delete-info">
                        <strong>„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</strong>
                        <p id="deleteProjectInfo">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç: <span id="deleteProjectName"></span></p>
                        <p style="color: #dc3545; font-weight: bold;">‚Äª „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Èñ¢ÈÄ£„Åô„Çã„Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇÇÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteProjectModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProject()">ÂâäÈô§</button>
                </div>
            </div>
        </div>

        <!-- „Çø„Çπ„ÇØÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal task-modal">
            <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">„Çø„Çπ„ÇØÁ∑®ÈõÜ</h3>
                    <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
                <div class="modal-content task-modal-content">
                    <form id="taskForm" onsubmit="return false;">
                        <input type="hidden" id="taskId">
                        
                        <!-- „Çø„Çπ„ÇØÂü∫Êú¨ÊÉÖÂ†± -->
                <div class="task-info">
                            <h4 id="taskTitle"></h4>
                        </div>
                        
                        <!-- „Çø„Çπ„ÇØ„Éï„Ç©„Éº„É† -->
                        <div class="task-form-row">
                    <div class="task-status-selector">
                                <label for="taskStatus">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <select id="taskStatus" name="status" required>
                            <option value="not_started">Êú™ÁùÄÊâã</option>
                            <option value="in_progress">ÈÄ≤Ë°å‰∏≠</option>
                            <option value="completed">ÂÆå‰∫Ü</option>
                            <option value="needs_confirmation">Ë¶ÅÁ¢∫Ë™ç</option>
                            <option value="not_applicable">ÂØæË±°Â§ñ</option>
                            <option value="pending">‰øùÁïô‰∏≠</option>
                        </select>
                    </div>
                    <div class="task-assignment">
                                <label for="taskAssignee">ÊãÖÂΩìËÄÖ</label>
                                <select id="taskAssignee" name="assigned_to">
                            <option value="">Êú™Ââ≤ÂΩì</option>
                        </select>
                    </div>
                    <div class="task-date">
                                <label for="taskDueDate">ÊúüÈôê</label>
                                <input type="date" id="taskDueDate" name="due_date">
                            </div>
                    </div>
                    
                        <!-- „Çø„Çπ„ÇØÂÜÖÂÆπË°®Á§∫ -->
                        <div class="task-content">
                            <label>‰ΩúÊ•≠ÂÜÖÂÆπ</label>
                            <div class="task-content-display" id="taskContentDisplay"></div>
                        </div>

                        <!-- „Çø„Çπ„ÇØ„É°„ÇøÊÉÖÂ†± -->
                    <div class="task-meta">
                        <div class="task-meta-item">
                                <span class="meta-label">„Éï„Çß„Éº„Ç∫:</span>
                                <span id="taskPhase"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">‰ΩúÊ•≠È†ÜÂ∫è:</span>
                                <span id="taskOrder"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">ÊäÄË°ì‰ΩúÊ•≠:</span>
                            <span id="taskTechnical"></span>
                        </div>
                        <div class="task-meta-item">
                            <span class="meta-label">„Éû„Éã„É•„Ç¢„É´:</span>
                                <span id="taskManualInfo"></span>
                                <div id="taskManualLinks" class="task-manual" style="margin-top:8px; display:none;">
                                    <div id="taskManualList"></div>
                                </div>
                    </div>
                </div>
                
                        <!-- ‰ΩúÊ•≠„É°„É¢ -->
                <div class="task-notes">
                            <label>‰ΩúÊ•≠„É°„É¢</label>
                            
                            <!-- Êó¢Â≠ò„É°„É¢„ÅÆÂ±•Ê≠¥ -->
                            <div class="notes-history" id="notesHistory">
                                <!-- „É°„É¢Â±•Ê≠¥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
                
                            <!-- Êñ∞„Åó„ÅÑ„É°„É¢ËøΩÂä† -->
                            <div class="add-note-section">
                                <div class="note-input-container">
                                    <textarea id="newNote" placeholder="Êñ∞„Åó„ÅÑ„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ... (@„Åß„É¶„Éº„Ç∂„Éº„Çí„É°„É≥„Ç∑„Éß„É≥„Åß„Åç„Åæ„Åô)" rows="4" title="@„ÇíÂÖ•Âäõ„Åô„Çã„Å®„É¶„Éº„Ç∂„Éº„Çí„É°„É≥„Ç∑„Éß„É≥„Åß„Åç„Åæ„Åô„ÄÇ„É°„É≥„Ç∑„Éß„É≥„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´Ë¶ÅÁ¢∫Ë™ç„Çπ„ÉÜ„Éº„Çø„Çπ„Å´„Å™„Çä„Åæ„Åô„ÄÇ"></textarea>
                                    <div id="userSuggestions" class="user-suggestions" style="display: none;"></div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addNote()">„É°„É¢„ÇíËøΩÂä†</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let allTasks = [];
        let filteredTasks = [];
        let allPhases = [];
        let currentPhaseFilter = 'all';
        let allUsers = [];
        let allClients = [];
        let allTemplates = [];
        let selectedTemplateIds = new Set(); // ÈÅ∏Êäû„Åï„Çå„Åü„ÉÜ„É≥„Éó„É¨„Éº„ÉàID„Çí‰øùÊåÅ

        // ÈÅ∏Êäû„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÊ∞∏Á∂öÂåñ
        function loadSelectedTemplatesFromStorage() {
            try {
                const raw = localStorage.getItem('selectedTemplateIds');
                if (raw) {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr)) {
                        selectedTemplateIds = new Set(arr.map(String));
                    }
                }
            } catch (e) {
                console.warn('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó:', e);
            }
        }

        function saveSelectedTemplatesToStorage() {
            try {
                localStorage.setItem('selectedTemplateIds', JSON.stringify(Array.from(selectedTemplateIds)));
            } catch (e) {
                console.warn('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', e);
            }
        }

        // Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„ÉÄ„É´„ÅÆÈñãÈñâÁä∂ÊÖã„Éª‰∏ãÊõ∏„Åç„ÅÆÊ∞∏Á∂öÂåñ
        function markNewProjectModalOpen(isOpen) {
            try { localStorage.setItem('newProjectModalOpen', isOpen ? 'true' : 'false'); } catch(e) {}
        }

        function saveNewProjectDraft() {
            try {
                const draft = {
                    name: document.getElementById('projectName')?.value || '',
                    client_id: document.getElementById('newProjectClient')?.value || '',
                    start_date: document.getElementById('projectStartDate')?.value || '',
                    end_date: document.getElementById('projectEndDate')?.value || ''
                };
                localStorage.setItem('newProjectDraft', JSON.stringify(draft));
            } catch (e) {
                console.warn('Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ãÊõ∏„Åç‰øùÂ≠ò„Å´Â§±Êïó:', e);
            }
        }

        function loadNewProjectDraft() {
            try {
                const raw = localStorage.getItem('newProjectDraft');
                if (!raw) return;
                const draft = JSON.parse(raw);
                if (!draft) return;
                if (draft.name) document.getElementById('projectName').value = draft.name;
                // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅØ„É≠„Éº„ÉâÂæå„Å´Ë®≠ÂÆö
                if (draft.start_date) document.getElementById('projectStartDate').value = draft.start_date;
                if (draft.end_date) document.getElementById('projectEndDate').value = draft.end_date;
                // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅØ loadClients ÂÆå‰∫ÜÂæå„Å´ÈÅ©Áî®
                setTimeout(() => {
                    if (draft.client_id) document.getElementById('newProjectClient').value = draft.client_id;
                }, 0);
            } catch (e) {
                console.warn('Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ãÊõ∏„ÅçÂæ©ÂÖÉ„Å´Â§±Êïó:', e);
            }
        }

        // „É¢„Éº„ÉÄ„É´Âº∑Âà∂„ÇØ„É≠„Éº„Ç∫Èò≤Ê≠¢Ôºà‰øùÂ≠ò/„Ç≠„É£„É≥„Çª„É´‰ª•Â§ñ„Åß„ÅØÈñâ„Åò„Å™„ÅÑÔºâ
        let newProjectModalObserver = null;
        function startNewProjectModalGuard() {
            try {
                const modal = document.getElementById('newProjectModal');
                if (!modal) return;
                if (newProjectModalObserver) newProjectModalObserver.disconnect();
                newProjectModalObserver = new MutationObserver(() => {
                    const shouldBeOpen = localStorage.getItem('newProjectModalOpen') === 'true';
                    if (!shouldBeOpen) return;
                    // display/hidden „ÅåÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„Åü„ÇâÂæ©ÂÖÉ
                    if (modal.style.display === 'none' || modal.hidden) {
                        modal.style.display = 'block';
                        modal.hidden = false;
                    }
                });
                newProjectModalObserver.observe(modal, { attributes: true, attributeFilter: ['style', 'hidden'] });
            } catch (e) {
                console.warn('„É¢„Éº„ÉÄ„É´„Ç¨„Éº„ÉâË®≠ÂÆö„Å´Â§±Êïó:', e);
            }
        }

        function stopNewProjectModalGuard() {
            try {
                if (newProjectModalObserver) newProjectModalObserver.disconnect();
                newProjectModalObserver = null;
            } catch (e) {}
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
            loadSelectedTemplatesFromStorage();
            // ‰∏ÄÂ∫¶Èñã„ÅÑ„Å¶„ÅÑ„ÅüÂ†¥Âêà„ÅØÂÜçË°®Á§∫
            if (localStorage.getItem('newProjectModalOpen') === 'true') {
                // ÂøÖË¶Å„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂæå„Å´Âæ©ÂÖÉ
                Promise.allSettled([loadClients(), loadPhases(), loadTemplates()]).then(() => {
                    loadNewProjectDraft();
                    document.getElementById('newProjectModal').style.display = 'block';
                    startNewProjectModalGuard();
                });
            }
            loadProjects();
            loadUserInfo();
            setupEventListeners();
        });

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupEventListeners() {
            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû
            document.getElementById('projectSelect').addEventListener('change', function() {
                const projectId = this.value;
                if (projectId) {
                    // ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                    localStorage.setItem('selectedProjectId', projectId);
                    loadProject(projectId);
                } else {
                    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                    localStorage.removeItem('selectedProjectId');
                    hideProjectInfo();
                }
            });

            // Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éú„Çø„É≥
            document.getElementById('newProjectBtn').addEventListener('click', function() {
                openNewProjectModal();
            });

            // „É¢„Éº„ÉÄ„É´ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñÔºà„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆË¶ÅÁ¥†„ÅØÈô§Â§ñÔºâ
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆË¶ÅÁ¥†„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                    if (e.target.closest('.modal')) {
                        return;
                    }
                    // ËÉåÊôØ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÅÆ„ÅøÁÑ°ÂäπÂåñ
                    e.preventDefault();
                    e.stopPropagation();
                }, true);
            });

            // ÂÖ•ÂäõÂ§âÊõ¥„ÅÆËá™Âãï‰øùÂ≠òÔºàÊñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç©„Éº„É†Ôºâ
            ['projectName','newProjectClient','projectStartDate','projectEndDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', saveNewProjectDraft);
                    el.addEventListener('change', saveNewProjectDraft);
                }
            });

            // „Çø„ÉñÂæ©Â∏∞ÊôÇ„Å´Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„ÉÄ„É´„ÇíÂÜçË°®Á§∫
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && localStorage.getItem('newProjectModalOpen') === 'true') {
                    document.getElementById('newProjectModal').style.display = 'block';
                    loadNewProjectDraft();
                }
            });
        }

        // „Éá„Éï„Ç©„É´„Éà„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë®≠ÂÆö
        function setDefaultUserInfo() {
            document.getElementById('userName').textContent = '„Ç≤„Çπ„Éà';
            document.getElementById('userRole').textContent = '„Ç≤„Çπ„Éà';
            console.log('„Éá„Éï„Ç©„É´„Éà„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí„Ç≤„Çπ„Éà„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü');
            updateRoleBasedVisibility('guest');
        }

        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë™≠„ÅøËæº„Åø
        async function loadUserInfo() {
            try {
                console.log('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                
                // „Åæ„ÅöÂ∞ÇÁî®„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíË©¶„Åô
                const response = await fetch('api.php?path=user/profile&t=' + Date.now(), { cache: 'no-store' });
                const data = await response.json();
                
                console.log('„Éó„É≠„Éï„Ç£„Éº„É´APIÂøúÁ≠î:', data);
                
                if (data.success && data.name) {
                    document.getElementById('userName').textContent = data.name;
                    document.getElementById('userRole').textContent = getRoleText(data.role || 'guest');
                    // Ë®≠ÂÆö„Éú„Çø„É≥Ë°®Á§∫Âà∂Âæ°
                    const settingsBtn = document.getElementById('settingsBtn');
                    if (settingsBtn) settingsBtn.style.display = (data.role === 'manager' || data.role === 'technical') ? 'inline-block' : 'none';
                    updateRoleBasedVisibility(data.role);
                    console.log('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë®≠ÂÆöÂÆå‰∫Ü:', data.name, data.role);
                } else {
                    console.log('Ë™çË®º„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åó„Åæ„Åô');
                    // Êú™Ë™çË®º„ÅÆÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                    window.location.href = 'login.html?message=' + encodeURIComponent('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                    return;
                }
            } catch (error) {
                console.error('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                console.log('Ë™çË®º„Ç®„É©„Éº„ÅÆ„Åü„ÇÅ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åó„Åæ„Åô');
                // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÇÇ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                window.location.href = 'login.html?message=' + encodeURIComponent('Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                return;
            }
        }

        // ‰ª£Êõø„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë™≠„ÅøËæº„ÅøÔºàÂâäÈô§ - „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅÆ„Åü„ÇÅÔºâ

        // ÂΩπËÅ∑ÂêçÂ§âÊèõ
        function getRoleText(role) {
            switch(role) {
                case 'manager': return 'ÁÆ°ÁêÜËÄÖ';
                case 'technical': return 'ÊäÄË°ìËÄÖ';
                case 'general': return '‰∏ÄËà¨';
                default: return '„Ç≤„Çπ„Éà';
            }
        }

        // ÂΩπÂâ≤„Å´Âøú„Åò„Å¶„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊìç‰Ωú„Éú„Çø„É≥„ÇíÂà∂Âæ°
        function updateRoleBasedVisibility(role) {
            const isGeneralOrGuest = !role || role === 'general' || role === 'guest';
            const createBtn = document.getElementById('newProjectBtn');
            const editBtn = document.getElementById('editProjectBtn');
            const deleteBtn = document.getElementById('deleteProjectBtn');
            if (createBtn) createBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
            if (editBtn) editBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
            if (deleteBtn) deleteBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßË™≠„ÅøËæº„Åø
        async function loadProjects() {
            try {
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                console.log('API URL:', `api.php?path=projects&t=${Date.now()}`);
                
                const response = await fetch(`api.php?path=projects&t=${Date.now()}`, { cache: 'no-store' });
                console.log('„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
                console.log('„É¨„Çπ„Éù„É≥„Çπ„Éò„ÉÉ„ÉÄ„Éº:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                console.log('Áîü„É¨„Çπ„Éù„É≥„Çπ:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSONËß£Êûê„Ç®„É©„Éº:', parseError);
                    console.error('„É¨„Çπ„Éù„É≥„ÇπÂÜÖÂÆπ:', responseText);
                    throw new Error('API„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåJSONÂΩ¢Âºè„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàAPIÂøúÁ≠î:', data);
                
                if (data.success && data.projects) {
                    populateProjectSelect(data.projects);
                } else {
                    console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', data.error || '„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'), 'error');
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏ÊäûËÇ¢„ÇíË®≠ÂÆö
        function populateProjectSelect(projects) {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
            
            // ‰øùÂ≠ò„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂæ©ÂÖÉ
            const savedProjectId = localStorage.getItem('selectedProjectId');
            if (savedProjectId) {
                // ‰øùÂ≠ò„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const projectExists = projects.some(project => project.id == savedProjectId);
                if (projectExists) {
                    select.value = savedProjectId;
                    console.log('‰øùÂ≠ò„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂæ©ÂÖÉ:', savedProjectId);
                    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíËá™ÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø
                    loadProject(savedProjectId);
                } else {
                    // Â≠òÂú®„Åó„Å™„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÅØ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
                    localStorage.removeItem('selectedProjectId');
                    console.log('‰øùÂ≠ò„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
                }
            }
            
            console.log(`${projects.length}ÂÄã„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø
        async function loadProject(projectId) {
            try {
                showLoading();
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠:', projectId);
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË©≥Á¥∞„ÄÅ„Çø„Çπ„ÇØ„ÄÅ„Éï„Çß„Éº„Ç∫„Çí‰∏¶Ë°åÂèñÂæó
                const [projectResponse, tasksResponse, phasesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${projectId}&t=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`api.php?path=projects/${projectId}/tasks&t=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`api.php?path=phases&t=${Date.now()}`, { cache: 'no-store' })
                ]);

                const [projectData, tasksData, phasesData] = await Promise.all([
                    projectResponse.json(),
                    tasksResponse.json(),
                    phasesResponse.json()
                ]);

                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø:', projectData);
                console.log('„Çø„Çπ„ÇØ„Éá„Éº„Çø:', tasksData);
                console.log('„Éï„Çß„Éº„Ç∫„Éá„Éº„Çø:', phasesData);

                if (projectData.success && projectData.project) {
                    currentProject = projectData.project;
                    displayProject(currentProject);
                    
                    if (phasesData.success && phasesData.phases) {
                        allPhases = phasesData.phases;
                        setupPhaseFilters(allPhases);
                    }
                    
                    if (tasksData.success && tasksData.tasks) {
                        console.log('=== „Çø„Çπ„ÇØ„Éá„Éº„ÇøÂèñÂæóÊàêÂäü ===');
                        console.log('„Çø„Çπ„ÇØ„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', tasksData.tasks);
                        console.log('„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÅÆË©≥Á¥∞:', JSON.stringify(tasksData.tasks, null, 2));
                        
                        // ÂêÑ„Çø„Çπ„ÇØ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÄÅÊãÖÂΩìËÄÖ„ÄÅÊúüÈôê„ÇíÁ¢∫Ë™ç
                        tasksData.tasks.forEach((task, index) => {
                            console.log(`„Çø„Çπ„ÇØ${index + 1} (ID: ${task.id}):`, {
                                name: task.task_name || task.name,
                                status: task.status,
                                status_type: typeof task.status,
                                assigned_to: task.assigned_to,
                                assigned_to_name: task.assigned_to_name,
                                planned_date: task.planned_date,
                                full_task_data: task // ÂÆåÂÖ®„Å™„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÇíË°®Á§∫
                            });
                            
                            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊú™ÂÆöÁæ©„ÅÆÂ†¥Âêà„ÅØË≠¶Âëä
                            if (task.status === undefined || task.status === null || task.status === '') {
                                console.warn(`‚ö†Ô∏è „Çø„Çπ„ÇØ${index + 1} (${task.task_name || task.name}) „ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊú™ÂÆöÁæ©„Åß„Åô:`, task.status);
                                console.warn('„Çø„Çπ„ÇØ„ÅÆÂÆåÂÖ®„Å™„Éá„Éº„Çø:', task);
                            }
                        });
                        
                        allTasks = tasksData.tasks;
                        filteredTasks = [...allTasks]; // Áõ¥Êé•„Ç≥„Éî„Éº
                        console.log('filteredTasks Ë®≠ÂÆöÂÆå‰∫Ü:', filteredTasks);
                        displayTasks(filteredTasks);
                        updateProgress();
                    } else {
                        console.log('„Çø„Çπ„ÇØ„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó:', tasksData);
                        console.log('„Çø„Çπ„ÇØ„Éá„Éº„Çø„ÅÆË©≥Á¥∞:', JSON.stringify(tasksData, null, 2));
                        allTasks = [];
                        filteredTasks = [];
                        displayTasks([]);
                        updateProgress();
                    }
                    
                    showProjectInfo();
                } else {
                    console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', projectData.error);
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                hideLoading();
            }
        }


        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±Ë°®Á§∫
        function displayProject(project) {
            document.getElementById('projectName').textContent = project.name || '‰∏çÊòé„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà';
            document.getElementById('projectClientInfo').textContent = `Áô∫Ê≥®ËÄÖ: ${project.client_name || '‰∏çÊòé'}`;
            const end = project.end_date || project.target_end_date || '';
            document.getElementById('projectPeriod').textContent = `ÊúüÈñì: ${formatDate(project.start_date)} - ${formatDate(end)}`;
            document.getElementById('projectStatus').textContent = getStatusText(project.status);
            
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±Ë°®Á§∫/ÈùûË°®Á§∫
        function showProjectInfo() {
            document.getElementById('projectInfo').style.display = 'block';
            document.getElementById('taskSection').style.display = 'block';
        }

        function hideProjectInfo() {
            document.getElementById('projectInfo').style.display = 'none';
            document.getElementById('taskSection').style.display = 'none';
            currentProject = null;
            allTasks = [];
            filteredTasks = [];
        }

        // „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆöÔºàÁèæÂú®„ÅÆÈÅ∏Êäû„ÇíÁ∂≠ÊåÅÔºâ
        function setupPhaseFilters(phases) {
            const filtersContainer = document.getElementById('taskFilters');
            filtersContainer.innerHTML = '';

            if (phases.length > 0) {
                // Áõ¥Ëøë„ÅÆÈÅ∏Êäû„ÇíÂÑ™ÂÖàÔºà„É≠„Éº„Ç´„É´‰øùÂ≠ò„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇÇËÄÉÊÖÆÔºâ
                const savedPhaseId = localStorage.getItem('currentPhaseFilter');
                let desiredPhaseId = currentPhaseFilter || savedPhaseId;
                const exists = phases.some(p => String(p.id) === String(desiredPhaseId));
                if (!exists) {
                    desiredPhaseId = phases[0].id;
                }
                currentPhaseFilter = desiredPhaseId;

                // ÂêÑ„Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº
                phases.forEach((phase) => {
                    const btn = document.createElement('button');
                    btn.className = String(phase.id) === String(currentPhaseFilter) ? 'filter-btn active' : 'filter-btn';
                    btn.textContent = phase.name;
                    btn.onclick = () => filterByPhase(phase.id);
                    filtersContainer.appendChild(btn);
                });
            }
        }

        // „Éï„Çß„Éº„Ç∫„Å´„Çà„Çã„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterByPhase(phaseId) {
            currentPhaseFilter = phaseId;
            try { localStorage.setItem('currentPhaseFilter', String(phaseId)); } catch (e) {}
            
            // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // ÁèæÂú®„ÅÆ„Éú„Çø„É≥„Å´active„Çí‰ªò‰∏é
            const buttons = Array.from(document.querySelectorAll('.filter-btn'));
            const idx = buttons.findIndex(b => b.textContent === (allPhases.find(p => String(p.id) === String(phaseId))?.name));
            if (idx >= 0) {
                buttons[idx].classList.add('active');
            }

            displayTasks(filteredTasks);
        }

        // „Çø„Çπ„ÇØË°®Á§∫
        function displayTasks(tasks) {
            console.log('displayTasks Âëº„Å≥Âá∫„Åó:', tasks);
            console.log('displayTasks „ÅÆË©≥Á¥∞:', JSON.stringify(tasks, null, 2));
            const taskList = document.getElementById('taskList');
            console.log('taskList Ë¶ÅÁ¥†:', taskList);
            
            if (!tasks || tasks.length === 0) {
                console.log('„Çø„Çπ„ÇØ„ÅåÁ©∫„Åæ„Åü„ÅØÊú™ÂÆöÁæ©');
                taskList.innerHTML = '<div class="empty">„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            // „Éï„Çß„Éº„Ç∫„Å´„Çà„Çã„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            let filteredByPhase = tasks.filter(task => {
                const phase = allPhases.find(p => p.name === task.phase_name);
                return phase && phase.id == currentPhaseFilter;
            });

            // „Éï„Çß„Éº„Ç∫„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const tasksByPhase = {};
            filteredByPhase.forEach(task => {
                const phaseName = task.phase_name || 'Êú™ÂàÜÈ°û';
                if (!tasksByPhase[phaseName]) {
                    tasksByPhase[phaseName] = [];
                }
                tasksByPhase[phaseName].push(task);
            });

            // „Éï„Çß„Éº„Ç∫„Åî„Å®„Å´Ë°®Á§∫
            taskList.innerHTML = '';
            Object.entries(tasksByPhase).forEach(([phaseName, phaseTasks]) => {
                const phaseContainer = document.createElement('div');
                phaseContainer.className = 'phase-container';
                
                const phaseTitle = document.createElement('h3');
                phaseTitle.textContent = `${phaseName} (${phaseTasks.length})`;
                phaseContainer.appendChild(phaseTitle);
                
                const taskGrid = document.createElement('div');
                taskGrid.className = 'task-list';
                
                // „Çø„Çπ„ÇØ„ÇíÈ†ÜÂ∫è„Åß„ÇΩ„Éº„Éà
                phaseTasks.sort((a, b) => (a.task_order || 0) - (b.task_order || 0));
                
                phaseTasks.forEach(task => {
                    const taskItem = createTaskItem(task);
                    taskGrid.appendChild(taskItem);
                });
                
                phaseContainer.appendChild(taskGrid);
                taskList.appendChild(phaseContainer);
            });

        }

        // „Çø„Çπ„ÇØ„Ç¢„Ç§„ÉÜ„É†‰ΩúÊàê
        function createTaskItem(task) {
            const item = document.createElement('div');
            item.className = `task-item status-${task.status || 'not_started'}`;
            item.setAttribute('data-task-id', task.id);
            item.onclick = () => editTask(task.id);
            
            const isOverdue = task.planned_date && new Date(task.planned_date) < new Date() && task.status !== 'completed';
            const isNeedsConfirmation = task.status === 'needs_confirmation';
            
            // Ë¶ÅÁ¢∫Ë™ç„ÅÆÂ†¥Âêà„ÅÆÁ¢∫Ë™çÂØæË±°ËÄÖ„ÇíÂèñÂæó
            const confirmationTarget = isNeedsConfirmation ? getConfirmationTarget(task) : '';
            
            // Ë¶ÅÁ¢∫Ë™ç„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂ†¥Âêà„ÄÅÁõ¥Êé•„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
            if (isNeedsConfirmation) {
                item.style.background = 'linear-gradient(135deg, #fff5f5, #ffe6e6)';
                item.style.border = '3px solid #ff0000';
                item.style.borderLeft = '6px solid #ff0000';
                item.style.boxShadow = '0 4px 15px rgba(255, 0, 0, 0.4)';
                item.style.transform = 'scale(1.02)';
                item.style.position = 'relative';
                item.style.zIndex = '10';
            }

            // „Åù„ÅÆ„Åª„Åã„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Ç´„Éº„ÉâËâ≤„ÇíÊòéÁ§∫ÔºàCSSÊú™ÈÅ©Áî®Áí∞Â¢ÉÂØæÁ≠ñÔºâ
            if (!isNeedsConfirmation) {
                switch (task.status) {
                    case 'not_started':
                        item.style.background = '#f8f9fa';
                        item.style.borderLeft = '4px solid #6c757d';
                        break;
                    case 'in_progress':
                        item.style.background = '#fff8e1';
                        item.style.borderLeft = '4px solid #ffc107';
                        break;
                    case 'completed':
                        item.style.background = '#eaf7ee';
                        item.style.borderLeft = '4px solid #28a745';
                        break;
                    case 'not_applicable':
                        item.style.background = '#f1f3f5';
                        item.style.borderLeft = '4px solid #adb5bd';
                        item.style.opacity = '0.95';
                        break;
                    case 'pending':
                        item.style.background = '#fff3e0';
                        item.style.borderLeft = '4px solid #ff9800';
                        item.style.border = '2px solid #ff9800';
                        item.style.boxShadow = '0 4px 15px rgba(255, 152, 0, 0.3)';
                        break;
                }
            }
            
            item.innerHTML = `
                ${isNeedsConfirmation ? '<div style="position: absolute; top: -12px; right: 8px; background: #ff0000; color: white; padding: 6px 16px; border-radius: 16px; font-size: 0.8rem; font-weight: 700; box-shadow: 0 4px 8px rgba(255, 0, 0, 0.5); z-index: 1000; border: 2px solid white;">‚ö†Ô∏è Ë¶ÅÁ¢∫Ë™ç</div>' : ''}
                <div class="task-header">
                    <h4 class="task-title">${task.task_name || task.name}</h4>
                    <div class="task-status-group">
                        <span class="task-status status-${task.status || 'not_started'}">${getStatusText(task.status || 'not_started')}</span>
                        ${isOverdue ? '<span class="task-overdue">ÈÅÖÂª∂</span>' : ''}
                    </div>
                </div>
                ${isNeedsConfirmation ? `
                <div style="background: rgba(255, 0, 0, 0.15); border: 2px solid #ff0000; border-radius: 12px; padding: 12px 16px; margin: 12px 0; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(255, 0, 0, 0.2);">
                    <span style="font-size: 1rem; color: #ff0000; font-weight: 700;">Á¢∫Ë™çÂØæË±°:</span>
                    <span style="font-size: 1.1rem; color: #cc0000; font-weight: 800; background: rgba(255, 0, 0, 0.3); padding: 4px 12px; border-radius: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${confirmationTarget}</span>
                </div>
                ` : ''}
                <div class="task-meta">
                    <div class="task-meta-row">
                        <div class="task-assignee">
                            <span class="icon-user"></span>
                            ${task.assigned_to_name || 'Êú™Ââ≤ÂΩì'}
                        </div>
                        <div class="task-date ${isOverdue ? 'overdue' : ''}">
                            <span class="icon-calendar"></span>
                            ${task.planned_date ? formatDate(task.planned_date) : 'ÊúüÈôê„Å™„Åó'}
                        </div>
                    </div>
                    <div class="task-flags">
                        ${task.is_technical_work == '1' ? '<span class="flag technical">ÊäÄË°ì‰ΩúÊ•≠</span>' : ''}
                        ${task.has_manual == '1' ? '<span class="flag manual">üìö „Éû„Éã„É•„Ç¢„É´„ÅÇ„Çä</span>' : ''}
                    </div>
                </div>
            `;
            
            return item;
        }

        // „Çø„Çπ„ÇØÁ∑®ÈõÜ
        async function editTask(taskId) {
            try {
                console.log('„Çø„Çπ„ÇØÁ∑®ÈõÜÈñãÂßã:', taskId);
                
                // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÇíÂÖà„Å´Ë™≠„ÅøËæº„ÇÄ
                await loadUsers();
                
                const task = filteredTasks.find(t => t.id == taskId);
                if (!task) {
                    console.error('„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', taskId);
                    showMessage('„Çø„Çπ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                    return;
                }

                console.log('Á∑®ÈõÜÂØæË±°„Çø„Çπ„ÇØ:', task);
                console.log('assigned_to ÂÄ§:', task.assigned_to);

                // „Çø„Çπ„ÇØË©≥Á¥∞„ÇíÂèñÂæó
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                const data = await response.json();
                
                console.log('„Çø„Çπ„ÇØË©≥Á¥∞APIÂøúÁ≠î:', data);
                
                if (data.success && data.task) {
                    const taskData = data.task;
                    console.log('APIÂèñÂæó„Çø„Çπ„ÇØ assigned_to:', taskData.assigned_to);
                    
                    // „É¢„Éº„ÉÄ„É´„Å´„Éá„Éº„Çø„ÇíË®≠ÂÆö
                    console.log('=== „Çø„Çπ„ÇØÁ∑®ÈõÜ„Éá„Éº„ÇøË®≠ÂÆöÈñãÂßã ===');
                    console.log('APIÂèñÂæó„Çø„Çπ„ÇØ„Éá„Éº„Çø:', taskData);
                    
                    document.getElementById('taskId').value = taskData.id;
                    console.log('„Çø„Çπ„ÇØIDË®≠ÂÆö:', taskData.id);
                    
                    document.getElementById('taskTitle').textContent = taskData.task_name || taskData.name;
                    console.log('„Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´Ë®≠ÂÆö:', taskData.task_name || taskData.name);
                    
                    // „Çπ„ÉÜ„Éº„Çø„ÇπË®≠ÂÆö
                    console.log('APIÂèñÂæó„Çø„Çπ„ÇØ status:', taskData.status);
                    const statusValue = taskData.status || 'not_started';
                    document.getElementById('taskStatus').value = statusValue;
                    console.log('„Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„Éº„É´„ÉâË®≠ÂÆöÂæå„ÅÆÂÄ§:', document.getElementById('taskStatus').value);
                    console.log('„Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏ÊäûËÇ¢„ÅÆÁ¢∫Ë™ç:', document.getElementById('taskStatus').options);
                    
                    // ÊúüÈôê„Éï„Ç£„Éº„É´„Éâ„ÅÆË®≠ÂÆö
                    const plannedDate = taskData.planned_date || '';
                    console.log('APIÂèñÂæó„Çø„Çπ„ÇØ planned_date:', taskData.planned_date);
                    console.log('ÊúüÈôê„Éï„Ç£„Éº„É´„Éâ„Å´Ë®≠ÂÆö„Åô„ÇãÂÄ§:', plannedDate);
                    document.getElementById('taskDueDate').value = plannedDate;
                    console.log('ÊúüÈôê„Éï„Ç£„Éº„É´„ÉâË®≠ÂÆöÂæå„ÅÆÂÄ§:', document.getElementById('taskDueDate').value);
                    
                    document.getElementById('taskContentDisplay').textContent = taskData.template_content || 'ÂÜÖÂÆπ„Å™„Åó';
                    console.log('=== „Çø„Çπ„ÇØÁ∑®ÈõÜ„Éá„Éº„ÇøË®≠ÂÆöÂÆå‰∫Ü ===');
                    
                    // „É°„ÇøÊÉÖÂ†±Ë°®Á§∫
                    document.getElementById('taskPhase').textContent = task.phase_name || 'Êú™ÂàÜÈ°û';
                    document.getElementById('taskOrder').textContent = task.task_order || '0';
                    document.getElementById('taskTechnical').textContent = task.is_technical_work == '1' ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà';
                    document.getElementById('taskManualInfo').textContent = task.has_manual == '1' ? '„ÅÇ„Çä' : '„Å™„Åó';
                    await loadTaskManuals(taskData.task_name || taskData.name);
                    
                    // ÊãÖÂΩìËÄÖË®≠ÂÆöÔºà„É¶„Éº„Ç∂„ÉºË™≠„ÅøËæº„ÅøÂæå„Å´Ë®≠ÂÆöÔºâ
                    console.log('APIÂèñÂæó„Çø„Çπ„ÇØ assigned_to:', taskData.assigned_to);
                    console.log('APIÂèñÂæó„Çø„Çπ„ÇØ assigned_to_name:', taskData.assigned_to_name);
                    
                    if (taskData.assigned_to) {
                        console.log('ÊãÖÂΩìËÄÖ„ÇíË®≠ÂÆö‰∏≠:', taskData.assigned_to);
                        document.getElementById('taskAssignee').value = taskData.assigned_to;
                        console.log('ÊãÖÂΩìËÄÖ„Éï„Ç£„Éº„É´„ÉâË®≠ÂÆöÂæå„ÅÆÂÄ§:', document.getElementById('taskAssignee').value);
                    } else {
                        console.log('ÊãÖÂΩìËÄÖ„ÅåÊú™Ë®≠ÂÆö');
                        document.getElementById('taskAssignee').value = '';
                        console.log('ÊãÖÂΩìËÄÖ„Éï„Ç£„Éº„É´„Éâ„ÇíÁ©∫„Å´Ë®≠ÂÆö');
                    }
                    
                    // „É°„É¢Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
                    await loadTaskNotes(taskId);
                    
                    // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
                    setupNoteInputEvents();
                    
                    // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
                    document.getElementById('taskModal').style.display = 'block';
            } else {
                    console.error('„Çø„Çπ„ÇØË©≥Á¥∞Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', data.error);
                    showMessage('„Çø„Çπ„ÇØË©≥Á¥∞„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØÁ∑®ÈõÜ„Ç®„É©„Éº:', error);
                showMessage('„Çø„Çπ„ÇØÁ∑®ÈõÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ßË™≠„ÅøËæº„Åø
        async function loadUsers() {
            try {
                const taskAssigneeSelect = document.getElementById('taskAssignee');
                const currentValue = taskAssigneeSelect.value; // ÁèæÂú®„ÅÆÂÄ§„Çí‰øùÂ≠ò
                
                console.log('„É¶„Éº„Ç∂„Éº‰∏ÄË¶ßË™≠„ÅøËæº„Åø‰∏≠..., ÁèæÂú®„ÅÆÂÄ§:', currentValue);
                
                const response = await fetch('api.php?path=users');
                const data = await response.json();
                
                console.log('„É¶„Éº„Ç∂„ÉºAPIÂøúÁ≠î:', data);
                
                if (data.success && data.users) {
                    allUsers = data.users;
                    
                    // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÂÜçÊßãÁØâ
                    taskAssigneeSelect.innerHTML = '<option value="">Êú™Ââ≤ÂΩì</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        taskAssigneeSelect.appendChild(option);
                    });
                    
                    // ‰øùÂ≠ò„Åó„Å¶„ÅÑ„ÅüÂÄ§„ÇíÂæ©ÂÖÉ
                    if (currentValue) {
                        taskAssigneeSelect.value = currentValue;
                        console.log('ÊãÖÂΩìËÄÖÂÄ§„ÇíÂæ©ÂÖÉ:', currentValue, '‚Üí', taskAssigneeSelect.value);
                    }
                    
                    console.log(`${data.users.length}‰∫∫„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
            } else {
                    console.error('„É¶„Éº„Ç∂„ÉºË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', data.error);
                }
            } catch (error) {
                console.error('„É¶„Éº„Ç∂„ÉºË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // „Çø„Çπ„ÇØ„É°„É¢Ë™≠„ÅøËæº„Åø
        async function loadTaskNotes(taskId) {
            try {
                console.log('loadTaskNotes called with taskId:', taskId);
                const response = await fetch(`api.php?path=tasks/${taskId}/notes&t=${Date.now()}`, { cache: 'no-store' });
                const data = await response.json();
                
                console.log('loadTaskNotes response:', data);
                
                const notesHistory = document.getElementById('notesHistory');
                
                if (data.success && data.notes && data.notes.length > 0) {
                    console.log('Found notes:', data.notes);
                    console.log('Number of notes found:', data.notes.length);
                    notesHistory.innerHTML = '';
                    data.notes.forEach((note, index) => {
                        console.log(`Processing note ${index + 1}:`, note);
                        const noteItem = document.createElement('div');
                        noteItem.className = 'note-item';
                        noteItem.setAttribute('data-note-id', note.id);
                        noteItem.innerHTML = `
                            <div class="note-header">
                                <div class="note-info">
                                    <span class="note-user">${note.user_name || '‰∏çÊòé'}</span>
                                    <span class="note-date">${formatDateTime(note.created_at)}</span>
                                </div>
                                <div class="note-actions">
                                    <button type="button" class="btn-edit-note" onclick="editNote(${note.id})" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                                    <button type="button" class="btn-delete-note" onclick="deleteNote(${note.id})" title="ÂâäÈô§">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="note-content" id="note-content-${note.id}">${formatNoteContent(note.note)}</div>
                            <div class="note-edit-form" id="note-edit-${note.id}" style="display: none;">
                                <textarea class="note-edit-textarea" id="note-edit-text-${note.id}">${note.note}</textarea>
                                <div class="note-edit-actions">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="saveNoteEdit(${note.id})">‰øùÂ≠ò</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="cancelNoteEdit(${note.id})">„Ç≠„É£„É≥„Çª„É´</button>
                                </div>
                            </div>
                        `;
                        notesHistory.appendChild(noteItem);
                    });
            } else {
                    console.log('No notes found or error:', data);
                    notesHistory.innerHTML = '<div class="note-item">„É°„É¢„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                }
            } catch (error) {
                console.error('„É°„É¢Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                document.getElementById('notesHistory').innerHTML = '<div class="note-item">„É°„É¢„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // „Çø„Çπ„ÇØÂêç„Å´Á¥ê„Å•„Åè„Éû„Éã„É•„Ç¢„É´‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø„ÄÅË°®Á§∫/„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ„ÇíÁîüÊàê
        async function loadTaskManuals(taskName) {
            try {
                const linksWrap = document.getElementById('taskManualLinks');
                const list = document.getElementById('taskManualList');
                if (!linksWrap || !list) return;

                // „Çø„Çπ„ÇØÂêç„Åß„Éï„Ç£„É´„Çø„Åó„Å¶ÂèñÂæóÔºàDB„Åã„ÇâÁ¢∫ÂÆü„Å´Ë©≤ÂΩì„Éá„Éº„Çø„ÅÆ„ÅøÔºâ
                const q = encodeURIComponent(taskName || '');
                const res = await fetch(`api.php?path=manuals&task_name=${q}&t=${Date.now()}`, { cache: 'no-store' });
                const data = await res.json();
                if (!data.success || !Array.isArray(data.manuals)) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                    return;
                }

                const manuals = data.manuals;
                if (manuals.length === 0) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                    return;
                }

                list.innerHTML = manuals.map(m => {
                    const id = m.id;
                    const name = m.original_name || m.file_name;
                    const sizeKb = m.file_size ? Math.round(m.file_size / 1024) + 'KB' : '';
                    const viewUrl = `api.php?path=admin/manuals/${id}`;
                    const dlUrl = `api.php?path=admin/manuals/${id}&download=1`;
                    return `
                        <div class="manual-link" style="margin:4px 0;">
                            <a href="${viewUrl}" target="_blank" rel="noopener">üìÑ Ë°®Á§∫</a>
                            <span style="margin: 0 6px; color:#adb5bd;">|</span>
                            <a href="${dlUrl}">‚¨áÔ∏é „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</a>
                            <span style="margin-left:8px; color:#6c757d;">${name}${sizeKb ? ' ('+sizeKb+')' : ''}</span>
                        </div>`;
                }).join('');
                linksWrap.style.display = 'block';
            } catch (e) {
                console.warn('„Éû„Éã„É•„Ç¢„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
                const linksWrap = document.getElementById('taskManualLinks');
                const list = document.getElementById('taskManualList');
                if (linksWrap && list) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                }
            }
        }

        // „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÅÆÂ§âÊï∞
        let mentionStartPos = -1;
        let currentMentionQuery = '';
        let selectedSuggestionIndex = -1;

        // „É°„É¢ÂÖ•Âäõ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupNoteInputEvents() {
            const noteInput = document.getElementById('newNote');
            if (noteInput) {
                noteInput.addEventListener('input', handleNoteInput);
                noteInput.addEventListener('keydown', handleNoteKeydown);
                
                // blur„Ç§„Éô„É≥„Éà„ÇíÈÅÖÂª∂ÂÆüË°å„Åó„Å¶„ÄÅÂÄôË£ú„É™„Çπ„Éà„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÇíÂ¶®„Åí„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                noteInput.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        hideUserSuggestions();
                    }, 150);
                });
            }
        }

        // „É°„É¢ÂÖ•Âäõ„ÅÆÂá¶ÁêÜ
        function handleNoteInput(event) {
            const textarea = event.target;
            const cursorPos = textarea.selectionStart;
            const text = textarea.value;
            
            // @„ÅßÂßã„Åæ„ÇãÊñáÂ≠óÂàó„ÇíÊ§úÁ¥¢ÔºàÊó•Êú¨Ë™ûÊñáÂ≠ó„ÇÇÂê´„ÇÄÔºâ
            const mentionMatch = text.substring(0, cursorPos).match(/@([^\s]*)$/);
            
            if (mentionMatch) {
                mentionStartPos = cursorPos - mentionMatch[0].length;
                currentMentionQuery = mentionMatch[1];
                showUserSuggestions(currentMentionQuery, mentionStartPos);
            } else {
                hideUserSuggestions();
            }
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„ÅÆÂá¶ÁêÜ
        function handleNoteKeydown(event) {
            const suggestions = document.getElementById('userSuggestions');
            if (suggestions.style.display === 'none') return;

            const suggestionItems = suggestions.querySelectorAll('.suggestion-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                    updateSuggestionSelection();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSuggestionSelection();
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedSuggestionIndex >= 0) {
                        selectUserSuggestion(suggestionItems[selectedSuggestionIndex]);
                    }
                    break;
                case 'Escape':
                    hideUserSuggestions();
                    break;
            }
        }

        // „É¶„Éº„Ç∂„ÉºÂÄôË£ú„ÅÆË°®Á§∫
        function showUserSuggestions(query, position) {
            const suggestions = document.getElementById('userSuggestions');
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase())
            );

            console.log('showUserSuggestions called:', {
                query: query,
                position: position,
                allUsers: allUsers,
                filteredUsers: filteredUsers
            });

            if (filteredUsers.length === 0) {
                hideUserSuggestions();
                return;
            }

            suggestions.innerHTML = '';
            filteredUsers.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.setAttribute('data-user-name', user.name);
                item.innerHTML = `
                    <span class="user-name">${user.name}</span>
                    <span class="user-role">${getRoleText(user.role)}</span>
                `;
                
                // „Çà„ÇäÁ¢∫ÂÆü„Å™„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅÆÂÆüË£Ö
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('User suggestion mousedown:', user.name);
                });
                
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('User suggestion clicked:', user.name);
                    selectUserSuggestion(item);
                });
                
                // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÇÇËøΩÂä†Ôºà„É¢„Éê„Ç§„É´ÂØæÂøúÔºâ
                item.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('User suggestion touchend:', user.name);
                    selectUserSuggestion(item);
                });
                
                suggestions.appendChild(item);
            });
            
            // „Ç§„Éô„É≥„ÉàÂßîË≠≤„ÇÇËøΩÂä†
            suggestions.addEventListener('click', (e) => {
                const item = e.target.closest('.suggestion-item');
                if (item) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('User suggestion clicked via delegation:', item.getAttribute('data-user-name'));
                    selectUserSuggestion(item);
                }
            });

            selectedSuggestionIndex = 0;
            updateSuggestionSelection();
            suggestions.style.display = 'block';
        }

        // ÂÄôË£úÈÅ∏Êäû„ÅÆÊõ¥Êñ∞
        function updateSuggestionSelection() {
            const suggestions = document.getElementById('userSuggestions');
            const items = suggestions.querySelectorAll('.suggestion-item');
            
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedSuggestionIndex);
            });
        }

        // „É¶„Éº„Ç∂„ÉºÂÄôË£ú„ÅÆÈÅ∏Êäû
        function selectUserSuggestion(selectedItem) {
            const textarea = document.getElementById('newNote');
            const userName = selectedItem.getAttribute('data-user-name') || selectedItem.querySelector('.user-name').textContent;
            const currentPos = textarea.selectionStart;
            const beforeMention = textarea.value.substring(0, mentionStartPos);
            const afterMention = textarea.value.substring(currentPos);
            
            console.log('selectUserSuggestion called:', {
                userName: userName,
                mentionStartPos: mentionStartPos,
                currentPos: currentPos,
                beforeMention: beforeMention,
                afterMention: afterMention,
                originalValue: textarea.value
            });
            
            // „É°„É≥„Ç∑„Éß„É≥ÈÉ®ÂàÜ„ÇíÁΩÆ„ÅçÊèõ„Åà
            const newValue = beforeMention + '@' + userName + ' ' + afterMention;
            textarea.value = newValue;
            
            // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíË™øÊï¥Ôºà„É°„É≥„Ç∑„Éß„É≥„ÅÆÂæå„Å´ÈÖçÁΩÆÔºâ
            const newCursorPos = beforeMention.length + userName.length + 2;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            
            console.log('Text updated:', {
                newValue: newValue,
                newCursorPos: newCursorPos
            });
            
            // „É°„É≥„Ç∑„Éß„É≥„ÅåËøΩÂä†„Åï„Çå„ÅüÂ†¥Âêà„ÄÅË¶ÅÁ¢∫Ë™ç„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Ëá™ÂãïÂ§âÊõ¥
            const statusSelect = document.getElementById('taskStatus');
            if (statusSelect && statusSelect.value !== 'needs_confirmation') {
                console.log('„É°„É≥„Ç∑„Éß„É≥„ÅåËøΩÂä†„Åï„Çå„Åü„Åü„ÇÅ„ÄÅË¶ÅÁ¢∫Ë™ç„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Ëá™ÂãïÂ§âÊõ¥');
                console.log('Â§âÊõ¥Ââç„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ:', statusSelect.value);
                statusSelect.value = 'needs_confirmation';
                console.log('Â§âÊõ¥Âæå„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ:', statusSelect.value);
                
                // Ë¶ñË¶öÁöÑ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                statusSelect.style.backgroundColor = '#fff5f5';
                statusSelect.style.borderColor = '#ff6b6b';
                setTimeout(() => {
                    statusSelect.style.backgroundColor = '';
                    statusSelect.style.borderColor = '';
                }, 2000);
            } else {
                console.log('Êó¢„Å´Ë¶ÅÁ¢∫Ë™ç„Çπ„ÉÜ„Éº„Çø„Çπ„Åæ„Åü„ÅØ„Çπ„ÉÜ„Éº„Çø„ÇπÈÅ∏ÊäûË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            hideUserSuggestions();
        }

        // „É¶„Éº„Ç∂„ÉºÂÄôË£ú„ÅÆÈùûË°®Á§∫
        function hideUserSuggestions() {
            const suggestions = document.getElementById('userSuggestions');
            suggestions.style.display = 'none';
            selectedSuggestionIndex = -1;
        }

        // „É°„É¢ÂÜÖÂÆπ„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºà„É°„É≥„Ç∑„Éß„É≥„Çí„Éè„Ç§„É©„Ç§„ÉàÔºâ
        function formatNoteContent(content) {
            if (!content) return '';
            
            // @„É¶„Éº„Ç∂„ÉºÂêç „ÅÆ„Éë„Çø„Éº„É≥„ÇíÊ§úÁ¥¢„Åó„Å¶„Éè„Ç§„É©„Ç§„Éà
            return content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        // „É°„É¢Á∑®ÈõÜÈñãÂßã
        function editNote(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            console.log('editNote called with noteId:', noteId);
            
            // Á∑®ÈõÜ„Éï„Ç©„Éº„É†„ÇíË°®Á§∫
            document.getElementById(`note-edit-${noteId}`).style.display = 'block';
            document.getElementById(`note-content-${noteId}`).style.display = 'none';
            
            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ
            const textarea = document.getElementById(`note-edit-text-${noteId}`);
            textarea.focus();
            textarea.select();
        }

        // „É°„É¢Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
        function cancelNoteEdit(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            console.log('cancelNoteEdit called with noteId:', noteId);
            
            // Á∑®ÈõÜ„Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫
            document.getElementById(`note-edit-${noteId}`).style.display = 'none';
            document.getElementById(`note-content-${noteId}`).style.display = 'block';
        }

        // „É°„É¢Á∑®ÈõÜ‰øùÂ≠ò
        async function saveNoteEdit(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const content = document.getElementById(`note-edit-text-${noteId}`).value.trim();
            
            console.log('saveNoteEdit called with noteId:', noteId, 'content:', content);
            
            if (!content) {
                showMessage('„É°„É¢ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            try {
                const requestData = {
                    note: content
                };
                console.log('Sending edit request to:', `api.php?path=notes/${noteId}`);
                console.log('Request data:', requestData);
                
                const response = await fetch(`api.php?path=notes/${noteId}&t=${Date.now()}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Edit response status:', response.status);
                const data = await response.json();
                console.log('Edit response data:', data);
                
                if (data.success) {
                    // Âç≥Â∫ß„Å´„É°„É¢ÂÜÖÂÆπ„ÇíÊõ¥Êñ∞
                    document.getElementById(`note-content-${noteId}`).innerHTML = formatNoteContent(content);
                    
                    // Á∑®ÈõÜ„Éï„Ç©„Éº„É†„ÇíÈùûË°®Á§∫
                    document.getElementById(`note-edit-${noteId}`).style.display = 'none';
                    document.getElementById(`note-content-${noteId}`).style.display = 'block';
                    
                    showMessage('„É°„É¢„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    console.error('„É°„É¢Êõ¥Êñ∞„Ç®„É©„Éº:', data.error || data.message);
                    showMessage('„É°„É¢„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                console.error('„É°„É¢Êõ¥Êñ∞„Ç®„É©„Éº:', error);
                showMessage('„É°„É¢„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „É°„É¢ÂâäÈô§
        async function deleteNote(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            console.log('deleteNote called with noteId:', noteId);
            
            if (!confirm('„Åì„ÅÆ„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            try {
                console.log('Sending delete request to:', `api.php?path=notes/${noteId}`);
                
                const response = await fetch(`api.php?path=notes/${noteId}&t=${Date.now()}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log('Delete response status:', response.status);
                const data = await response.json();
                console.log('Delete response data:', data);
                
                if (data.success) {
                    // Âç≥Â∫ß„Å´„É°„É¢Ë¶ÅÁ¥†„ÇíÂâäÈô§Ôºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„ÅçÔºâ
                    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
                    if (noteElement) {
                        // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                        noteElement.style.transition = 'all 0.3s ease';
                        noteElement.style.opacity = '0';
                        noteElement.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            noteElement.remove();
                        }, 300);
                    }
                    
                    showMessage('„É°„É¢„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    console.error('„É°„É¢ÂâäÈô§„Ç®„É©„Éº:', data.error || data.message);
                    showMessage('„É°„É¢„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                console.error('„É°„É¢ÂâäÈô§„Ç®„É©„Éº:', error);
                showMessage('„É°„É¢„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „É°„É¢ËøΩÂä†
        async function addNote(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const taskId = document.getElementById('taskId').value;
            const content = document.getElementById('newNote').value.trim();
            
            console.log('addNote called with taskId:', taskId, 'content:', content);
            
            if (!content) {
                showMessage('„É°„É¢ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (!taskId) {
                showMessage('„Çø„Çπ„ÇØID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            try {
                const requestData = {
                    note: content
                };
                console.log('Sending request to:', `api.php?path=tasks/${taskId}/notes`);
                console.log('Request data:', requestData);
                
                const response = await fetch(`api.php?path=tasks/${taskId}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    console.log('„É°„É¢ËøΩÂä†ÊàêÂäü„ÄÅÂç≥Â∫ß„Å´UI„Å´ÂèçÊò†‰∏≠...');
                    
                    // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
                    document.getElementById('newNote').value = '';
                    
                    // Âç≥Â∫ß„Å´UI„Å´Êñ∞„Åó„ÅÑ„É°„É¢„ÇíËøΩÂä†
                    addMemoToUI(content, data.note_id || Date.now());
                    
                    console.log('„É°„É¢„ÇíUI„Å´Âç≥Â∫ß„Å´ÂèçÊò†ÂÆå‰∫Ü');
                    showMessage('„É°„É¢„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    console.error('„É°„É¢ËøΩÂä†„Ç®„É©„Éº:', data.error || data.message);
                    showMessage('„É°„É¢„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                console.error('„É°„É¢ËøΩÂä†„Ç®„É©„Éº:', error);
                showMessage('„É°„É¢„ÅÆËøΩÂä†‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Çø„Çπ„ÇØ‰øùÂ≠òÔºà„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
        async function saveTask(retryCount = 0) {
            const maxRetries = 3;
            
            // ÈáçË§áÂÆüË°åÈò≤Ê≠¢
            if (window.isSavingTask) {
                console.log('„Çø„Çπ„ÇØ‰øùÂ≠ò„ÅåÊó¢„Å´ÂÆüË°å‰∏≠„Åß„Åô');
                return;
            }
            
            window.isSavingTask = true;
            
            try {
                const taskId = document.getElementById('taskId').value;
                
                if (!taskId) {
                    showMessage('„Çø„Çπ„ÇØID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì', 'error');
                    return;
                }
                
                // ÂêÑ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂÄ§„ÇíÂÄãÂà•„Å´ÂèñÂæó„ÉªÁ¢∫Ë™ç
                const statusValue = document.getElementById('taskStatus').value;
                const assigneeValue = document.getElementById('taskAssignee').value;
                const dateValue = document.getElementById('taskDueDate').value;
                
                
                const formData = {
                    task_id: taskId,
                    status: statusValue,
                    assigned_to: assigneeValue || null,
                    planned_date: dateValue || null
                };


                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                const saveButton = document.querySelector('button[onclick="saveTask()"]');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = '‰øùÂ≠ò‰∏≠...';
                }

                // „É™„ÇØ„Ç®„Çπ„Éà„Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÇíË®≠ÂÆö
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Åø„ÅÆÊõ¥Êñ∞„ÅÆÂ†¥Âêà„ÅØÂ∞ÇÁî®„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩøÁî®
                const isStatusOnlyUpdate = formData.status && !formData.assigned_to && !formData.planned_date;
                const endpoint = isStatusOnlyUpdate ? 'tasks/status' : 'tasks/update';
                const method = isStatusOnlyUpdate ? 'POST' : 'PUT';
                
                
                const response = await fetch(`api.php?path=${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    showMessage('„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                    
                    // API„É¨„Çπ„Éù„É≥„Çπ„Åã„ÇâÁõ¥Êé•„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæó
                    const responseStatus = data.task?.status || statusValue;
                    
                    // „Çø„Çπ„ÇØ„Ç´„Éº„Éâ„ÅÆË°®Á§∫„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞Ôºà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜçË™≠„ÅøËæº„ÅøÂâçÔºâ
                    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        const finalStatus = responseStatus || statusValue || 'not_started';
                        
                        // „Çø„Çπ„ÇØ„Ç´„Éº„ÉâÂÖ®‰Ωì„ÅÆ„ÇØ„É©„ÇπÂêç„ÇíÊõ¥Êñ∞
                        taskCard.className = `task-item status-${finalStatus}`;
                        
                        // ‰øùÁïô‰∏≠„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂ†¥Âêà„ÄÅÁõ¥Êé•„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
                        if (finalStatus === 'pending') {
                            taskCard.style.background = '#fff3e0 !important';
                            taskCard.style.borderLeft = '4px solid #ff9800 !important';
                            taskCard.style.border = '2px solid #ff9800 !important';
                            taskCard.style.boxShadow = '0 4px 15px rgba(255, 152, 0, 0.3) !important';
                            taskCard.style.transform = 'scale(1.02) !important';
                            taskCard.style.position = 'relative !important';
                            taskCard.style.zIndex = '5 !important';
                            taskCard.setAttribute('style', taskCard.getAttribute('style') + '; background: #fff3e0 !important; border-left: 4px solid #ff9800 !important; border: 2px solid #ff9800 !important; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3) !important; transform: scale(1.02) !important; position: relative !important; z-index: 5 !important;');
                        }
                        
                        const statusElement = taskCard.querySelector('.task-status');
                        if (statusElement) {
                            // „Çπ„ÉÜ„Éº„Çø„ÇπË¶ÅÁ¥†„ÇíÂº∑Âà∂ÁöÑ„Å´Êõ¥Êñ∞
                            statusElement.className = `task-status status-${finalStatus}`;
                            statusElement.textContent = getStatusText(finalStatus);
                        }
                    }
                    
                    closeTaskModal();
                    
                    // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
                    if (currentProject) {
                        await loadProject(currentProject.id);
                    }
                } else {
                    throw new Error(data.error || data.message || 'Unknown error');
                }
            } catch (error) {
                if (retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // ÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï
                    return saveTask(retryCount + 1);
                } else {
                    showMessage('„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
                }
            } finally {
                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÂæ©ÂÖÉ
                const saveButton = document.querySelector('button[onclick="saveTask()"]');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = '‰øùÂ≠ò';
                }
                
                // „Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                window.isSavingTask = false;
            }
        }

        // ÈÄ≤ÊçóÊõ¥Êñ∞
        function updateProgress() {
            if (!filteredTasks || filteredTasks.length === 0) {
                document.getElementById('totalTasks').textContent = '0';
                document.getElementById('completedTasks').textContent = '0';
                document.getElementById('inProgressTasks').textContent = '0';
                document.getElementById('needsConfirmationTasks').textContent = '0';
                document.getElementById('overdueTasks').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressText').textContent = '0%';
                return;
            }

            const total = filteredTasks.length;
            const completed = filteredTasks.filter(task => task.status === 'completed').length;
            const inProgress = filteredTasks.filter(task => task.status === 'in_progress').length;
            const needsConfirmation = filteredTasks.filter(task => task.status === 'needs_confirmation').length;
            const overdue = filteredTasks.filter(task => {
                return task.planned_date && new Date(task.planned_date) < new Date() && task.status !== 'completed';
            }).length;

            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('overdueTasks').textContent = overdue;
            
            // Ë¶ÅÁ¢∫Ë™ç„Çø„Çπ„ÇØ„ÅÆË°®Á§∫ÔºàË¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
            const needsConfirmationElement = document.getElementById('needsConfirmationTasks');
            if (needsConfirmationElement) {
                needsConfirmationElement.textContent = needsConfirmation;
            }
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}%`;
        }

        // Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
        async function openNewProjectModal() {
            try {
                console.log('=== Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„ÉÄ„É´Ë°®Á§∫ÈñãÂßã ===');
                
                // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÄÅ„Éï„Çß„Éº„Ç∫„Çí‰∏¶Ë°åË™≠„ÅøËæº„Åø
                console.log('„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã...');
                await Promise.allSettled([
                    loadClients(),
                    loadPhases()
                ]);
                
                // „É©„Ç§„Éñ„É©„É™Âåñ„Åó„Åü„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÊ©üËÉΩ„ÇíÂàùÊúüÂåñ
                TemplateSelector.init({
                    containerId: 'newProjectModal',
                    mode: 'new_project',
                    onSelectionChange: function(selectedIds) {
                        selectedTemplateIds.clear();
                        selectedIds.forEach(id => selectedTemplateIds.add(id));
                        saveSelectedTemplatesToStorage();
                    }
                });
                
                console.log('„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
                console.log('allClients:', allClients);
                console.log('allPhases:', allPhases);
                console.log('allTemplates:', allTemplates);
                
                // Áô∫Ê≥®ËÄÖ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                const clientSelect = document.getElementById('newProjectClient');
                if (clientSelect) {
                    console.log('Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁô∫Ê≥®ËÄÖ„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ:', clientSelect);
                    console.log('ÈÅ∏ÊäûËÇ¢Êï∞:', clientSelect.options.length);
                } else {
                    console.error('newProjectClient „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
                
                document.getElementById('newProjectModal').style.display = 'block';
                markNewProjectModalOpen(true);
                // ÈÄî‰∏≠„ÅÆ‰∏ãÊõ∏„Åç„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ
                loadNewProjectDraft();
                startNewProjectModalGuard();
                console.log('Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„ÉÄ„É´Ë°®Á§∫ÂÆå‰∫Ü');
            } catch (error) {
                console.error('Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„ÉÄ„É´Ë°®Á§∫„Ç®„É©„Éº:', error);
                showMessage('„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
            document.getElementById('newProjectForm').reset();
            markNewProjectModalOpen(false);
            stopNewProjectModalGuard();
        }

        // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàË™≠„ÅøËæº„Åø
        async function loadClients() {
            try {
                console.log('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË™≠„ÅøËæº„ÅøÈñãÂßã...');
                const response = await fetch(`api.php?path=clients&t=${Date.now()}`, { cache: 'no-store' });
                console.log('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàAPIÂøúÁ≠î:', response.status);
                
                const data = await response.json();
                console.log('„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éá„Éº„Çø:', data);
                
                if (data.success && data.clients) {
                    allClients = data.clients;
                    console.log('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂèñÂæóÊàêÂäü:', allClients);
                    populateClientSelect();
                } else {
                    console.error('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË™≠„ÅøËæº„ÅøÂ§±Êïó:', data.error || '„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
            } catch (error) {
                console.error('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        function populateClientSelect() {
            console.log('populateClientSelect called with allClients:', allClients);
            const selects = ['newProjectClient', 'editProjectClient'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                console.log(`Select element ${selectId}:`, select);
                if (select) {
                    select.innerHTML = '<option value="">Áô∫Ê≥®ËÄÖ„ÇíÈÅ∏Êäû</option>';
                    allClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        select.appendChild(option);
                        console.log(`Added client option: ${client.name} (ID: ${client.id})`);
                    });
                    console.log(`Client select ${selectId} populated with ${allClients.length} clients`);
                } else {
                    console.error(`Select element ${selectId} not found`);
                }
            });
        }

        // „Éï„Çß„Éº„Ç∫Ë™≠„ÅøËæº„Åø
        async function loadPhases() {
            try {
                const response = await fetch(`api.php?path=phases&t=${Date.now()}`, { cache: 'no-store' });
                const data = await response.json();
                
                if (data.success && data.phases) {
                    allPhases = data.phases;
                    setupTemplateFilters();
                }
            } catch (error) {
                console.error('„Éï„Çß„Éº„Ç∫Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö
        function setupTemplateFilters() {
            const filtersContainer = document.getElementById('templateFilters');
            filtersContainer.innerHTML = '';

            // ÂÖ®‰Ωì„Éï„Ç£„É´„Çø„Éº„ÅØÈùûË°®Á§∫ÔºàÊúÄÂàù„ÅÆ„Éï„Çß„Éº„Ç∫„Çí„Éá„Éï„Ç©„É´„ÉàÈÅ∏ÊäûÔºâ
            if (allPhases.length > 0) {
                // ÂêÑ„Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº
                allPhases.forEach((phase, index) => {
                    const btn = document.createElement('button');
                    btn.className = index === 0 ? 'filter-btn active' : 'filter-btn';
                    btn.textContent = phase.name;
                    btn.dataset.phaseId = phase.id;
                    btn.addEventListener('click', function() {
                        filterTemplates(parseInt(this.dataset.phaseId));
                    });
                    filtersContainer.appendChild(btn);
                });
                
                // ÊúÄÂàù„ÅÆ„Éï„Çß„Éº„Ç∫„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË°®Á§∫
                if (allTemplates.length > 0) {
                    filterTemplates(allPhases[0].id);
                }
            }
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø
        async function loadTemplates() {
            try {
                console.log('„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„ÅøÈñãÂßã...');
                const response = await fetch(`api.php?path=templates&t=${Date.now()}`, { cache: 'no-store' });
                console.log('„ÉÜ„É≥„Éó„É¨„Éº„ÉàAPIÂøúÁ≠î:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éá„Éº„Çø:', data);
                
                if (data.success && data.templates) {
                    allTemplates = data.templates;
                    console.log('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂèñÂæóÊàêÂäü:', allTemplates);
                    
                    // „Éï„Çß„Éº„Ç∫„ÅåÊó¢„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÊúÄÂàù„ÅÆ„Éï„Çß„Éº„Ç∫„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË°®Á§∫
                    if (allPhases.length > 0) {
                        filterTemplates(allPhases[0].id);
                    } else {
                        displayTemplates(allTemplates);
                    }
                } else {
                    console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„ÅøÂ§±Êïó:', data.error || data.message || '„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    allTemplates = [];
                    displayTemplates([]);
                }
            } catch (error) {
                console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                allTemplates = [];
                displayTemplates([]);
            }
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterTemplates(phaseId) {
            console.log('filterTemplates called with phaseId:', phaseId);
            
            // „Éï„Çß„Éº„Ç∫ID„Åã„Çâ„Éï„Çß„Éº„Ç∫Âêç„ÇíÂèñÂæó
            const phase = allPhases.find(p => p.id == phaseId);
            if (!phase) {
                console.error('Phase not found for ID:', phaseId);
                return;
            }
            
            const phaseName = phase.name;
            console.log('Found phase name:', phaseName);
            
            // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('#templateFilters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
            const clickedBtn = document.querySelector(`#templateFilters .filter-btn[data-phase-id="${phaseId}"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }

            // „Éï„Çß„Éº„Ç∫Âêç„Åß„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filtered = allTemplates.filter(template => template.phase_name === phaseName);
            console.log('Filtered templates for phase', phaseName, ':', filtered);
            displayTemplates(filtered);
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË°®Á§∫
        function displayTemplates(templates) {
            console.log('displayTemplates called with templates:', templates);
            if (templates && templates.length > 0) {
                console.log('First template structure:', templates[0]);
                console.log('Template properties:', Object.keys(templates[0]));
            }
            const container = document.getElementById('templateGroups');
            console.log('Template container element:', container);
            
            if (!container) {
                console.error('Template container element not found');
                return;
            }
            
            container.innerHTML = '';

            if (!templates || templates.length === 0) {
                console.log('No templates to display');
                container.innerHTML = '<div class="empty">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            console.log(`Displaying ${templates.length} templates`);

            // „Éï„Çß„Éº„Ç∫„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const templatesByPhase = {};
            templates.forEach(template => {
                const phaseName = template.phase_name || 'Êú™ÂàÜÈ°û';
                
                if (!templatesByPhase[phaseName]) {
                    templatesByPhase[phaseName] = [];
                }
                templatesByPhase[phaseName].push(template);
            });

            // „Éï„Çß„Éº„Ç∫„Åî„Å®„Å´Ë°®Á§∫
            Object.entries(templatesByPhase).forEach(([phaseName, phaseTemplates]) => {
                const phaseGroup = document.createElement('div');
                phaseGroup.className = 'template-group';
                
                const phaseTitle = document.createElement('h5');
                phaseTitle.className = 'phase-title';
                phaseTitle.textContent = phaseName;
                phaseGroup.appendChild(phaseTitle);
                
                const templateItems = document.createElement('div');
                templateItems.className = 'template-items';
                
                phaseTemplates.forEach(template => {
                    console.log('Creating template item for:', template);
                    console.log('Template task_name:', template.task_name);
                    console.log('Template content:', template.content);
                    
                    const isSelected = selectedTemplateIds.has(template.id.toString());
                    console.log('Template', template.id, 'is selected:', isSelected);
                    
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.innerHTML = `
                        <label class="template-checkbox">
                            <input type="checkbox" name="templates" value="${template.id}" ${isSelected ? 'checked' : ''}>
                            <div class="template-info">
                                <div class="template-name">${template.task_name || '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„Å™„Åó'}</div>
                                <div class="template-content">${template.content || ''}</div>
                                <div class="template-flags">
                                    ${template.is_technical_work == '1' ? '<span class="flag technical">ÊäÄË°ì‰ΩúÊ•≠</span>' : ''}
                                    ${template.has_manual == '1' ? '<span class="flag manual">„Éû„Éã„É•„Ç¢„É´„ÅÇ„Çä</span>' : ''}
                                </div>
                            </div>
                        </label>
                    `;
                    
                    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedTemplateIds.add(template.id.toString());
                        } else {
                            selectedTemplateIds.delete(template.id.toString());
                        }
                        saveSelectedTemplatesToStorage();
                        updateSelectedCount();
                        console.log('Selected templates:', Array.from(selectedTemplateIds));
                    });
                    
                    templateItems.appendChild(item);
                });
                
                phaseGroup.appendChild(templateItems);
                container.appendChild(phaseGroup);
            });

            updateSelectedCount();
        }

        // ÈÅ∏ÊäûÊï∞Êõ¥Êñ∞
        function updateSelectedCount() {
            const count = selectedTemplateIds.size;
            document.getElementById('selectedCount').textContent = count;
            console.log('Updated selected count:', count);
        }

        // „Åô„Åπ„Å¶ÈÅ∏Êäû
        function selectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn.textContent;
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éï„Çß„Éº„Ç∫„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„ÅøÈÅ∏Êäû
            const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                const title = group.querySelector('.phase-title');
                return title && title.textContent === activePhaseText;
            });
            
            if (phaseGroup) {
                phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = true;
                    selectedTemplateIds.add(checkbox.value);
                });
            }
            
            saveSelectedTemplatesToStorage();
            updateSelectedCount();
            console.log('All templates selected for phase:', activePhaseText);
            console.log('Selected templates:', Array.from(selectedTemplateIds));
        }

        // „Åô„Åπ„Å¶Ëß£Èô§
        function deselectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn ? activePhaseBtn.textContent : null;
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Éï„Çß„Éº„Ç∫„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆ„ÅøËß£Èô§
            const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                const title = group.querySelector('.phase-title');
                return title && (!activePhaseText || title.textContent === activePhaseText);
            });
            
            if (phaseGroup) {
                phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = false;
                    selectedTemplateIds.delete(checkbox.value);
                });
            }
            
            saveSelectedTemplatesToStorage();
            updateSelectedCount();
            console.log('All templates deselected for phase:', activePhaseText);
            console.log('Selected templates:', Array.from(selectedTemplateIds));
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
        async function createProject() {
            try {
                const form = document.getElementById('newProjectForm');
                const formData = new FormData(form);
                
                // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÅÆÂèñÂæó„Å®Ê§úË®º
                const name = formData.get('name')?.trim();
                const clientId = formData.get('client_id');
                const startDate = formData.get('start_date');
                const endDate = formData.get('end_date');
                
                console.log('„Éï„Ç©„Éº„É†„Éá„Éº„ÇøÊ§úË®º:');
                console.log('- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç:', name);
                console.log('- Áô∫Ê≥®ËÄÖID:', clientId);
                console.log('- ÈñãÂßãÊó•:', startDate);
                console.log('- ÁµÇ‰∫ÜÊó•:', endDate);
                
                // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆÊ§úË®º
                if (!name) {
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }
                
                if (!clientId) {
                    showMessage('Áô∫Ê≥®ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }
                
                if (!startDate) {
                    showMessage('ÈñãÂßãÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }
                
                if (!endDate) {
                    showMessage('ÁµÇ‰∫ÜÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }
                
                // ÈÅ∏Êäû„Åï„Çå„Åü„ÉÜ„É≥„Éó„É¨„Éº„ÉàÔºàÂÖ®„Éï„Çß„Éº„Ç∫Ê®™Êñ≠„Åß‰øùÊåÅ„Åó„Å¶„ÅÑ„ÇãSet„Åã„ÇâÂèñÂæóÔºâ
                const selectedTemplates = Array.from(selectedTemplateIds);

                if (selectedTemplates.length === 0) {
                    showMessage('Â∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }

                const projectData = {
                    name: name,
                    client_id: clientId,
                    start_date: startDate,
                    end_date: endDate,
                    templates: selectedTemplates
                };

                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Éá„Éº„Çø:', projectData);

                const response = await fetch('api.php?path=projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„É¨„Çπ„Éù„É≥„Çπ:', response.status);

                const data = await response.json();
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø:', data);

                if (data.success) {
                    console.log('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàêÊàêÂäü');
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü', 'success');
                    closeNewProjectModal(); // ‰øùÂ≠òÊôÇ„ÅÆ„Åø„ÇØ„É≠„Éº„Ç∫
                    await loadProjects();
                    
                    // Êñ∞„Åó„Åè‰ΩúÊàê„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû
                    if (data.project_id) {
                        document.getElementById('projectSelect').value = data.project_id;
                        await loadProject(data.project_id);
                    }
                } else {
                    console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Ç®„É©„Éº:', data.error || data.message);
                    const errorMessage = data.error || data.message || '‰∏çÊòé„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + errorMessage, 'error');
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
                showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ
        window.editProject = async function() {
            if (!currentProject) {
                showMessage('Á∑®ÈõÜ„Åô„Çã„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
                await loadClients();
                
                // „Éï„Ç©„Éº„É†„Å´„Éá„Éº„Çø„ÇíË®≠ÂÆö
                document.getElementById('editProjectId').value = currentProject.id;
                document.getElementById('editProjectName').value = currentProject.name;
                document.getElementById('editProjectClient').value = currentProject.client_id;
                document.getElementById('editProjectStartDate').value = currentProject.start_date;
                document.getElementById('editProjectEndDate').value = currentProject.end_date || currentProject.target_end_date || '';
                document.getElementById('editProjectStatus').value = currentProject.status;
                
                // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÇíÂàùÊúüÂåñ
                await initProjectTemplateSelection();
                
                document.getElementById('editProjectModal').style.display = 'block';
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´Ë°®Á§∫„Ç®„É©„Éº:', error);
                showMessage('Á∑®ÈõÜÁîªÈù¢„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        };

        window.closeEditProjectModal = function() {
            document.getElementById('editProjectModal').style.display = 'none';
        };

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞
        window.updateProject = async function() {
            try {
                const formData = {
                    id: document.getElementById('editProjectId').value,
                    name: document.getElementById('editProjectName').value,
                    client_id: document.getElementById('editProjectClient').value,
                    start_date: document.getElementById('editProjectStartDate').value,
                    end_date: document.getElementById('editProjectEndDate').value,
                    status: document.getElementById('editProjectStatus').value
                };

                console.log('=== „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞ÈñãÂßã ===');
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞„Éá„Éº„Çø:', formData);
                console.log('ÈÄÅ‰ø°„Åô„Çã„Éó„É≠„Ç∏„Çß„ÇØ„ÉàID:', formData.id);
                console.log('ÈÄÅ‰ø°„Åô„Çã„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç:', formData.name);
                console.log('ÈÄÅ‰ø°„Åô„Çã„ÇØ„É©„Ç§„Ç¢„É≥„ÉàID:', formData.client_id);

                const response = await fetch(`api.php?path=projects/${formData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞„É¨„Çπ„Éù„É≥„Çπ:', response.status);

                const data = await response.json();
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞„É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø:', data);

                if (data.success) {
                    console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞ÊàêÂäü');
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                    closeEditProjectModal();
                    await loadProjects();
                    await loadProject(formData.id);
                    console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞Âá¶ÁêÜÂÆå‰∫Ü');
                } else {
                    console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', data.error || data.message);
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || data.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'), 'error');
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        };

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§
        function deleteProject() {
            if (!currentProject) {
                showMessage('ÂâäÈô§„Åô„Çã„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            document.getElementById('deleteProjectName').textContent = currentProject.name;
            document.getElementById('deleteProjectModal').style.display = 'block';
        }

        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').style.display = 'none';
        }

        async function confirmDeleteProject() {
            try {
                const projectId = currentProject.id;
                console.log('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§ÂÆüË°å:', projectId);

                const response = await fetch(`api.php?path=projects/${projectId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                console.log('ÂâäÈô§APIÂøúÁ≠î:', data);

                if (data.success) {
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
                    closeDeleteProjectModal();
                    hideProjectInfo();
                    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÇÇÂâäÈô§
                    localStorage.removeItem('selectedProjectId');
                    await loadProjects();
                    document.getElementById('projectSelect').value = '';
                } else {
                    console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§„Ç®„É©„Éº:', data.error);
                    showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'), 'error');
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂâäÈô§„Ç®„É©„Éº:', error);
                showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„ÇøÊõ¥Êñ∞
        async function refreshProjectData() {
            if (!currentProject) {
                showMessage('Êõ¥Êñ∞„Åô„Çã„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                showMessage('„Éá„Éº„Çø„ÇíÊõ¥Êñ∞‰∏≠...', 'info');
                await loadProject(currentProject.id);
                showMessage('„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('„Éá„Éº„ÇøÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                showMessage('„Éá„Éº„Çø„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Çø„Çπ„ÇØ„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('newNote').value = '';
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function formatDate(dateString) {
            console.log('formatDate called with:', dateString);
            if (!dateString) {
                console.log('formatDate: empty dateString, returning empty string');
                return '';
            }
            const date = new Date(dateString);
            const formatted = date.toLocaleDateString('ja-JP');
            console.log('formatDate result:', formatted);
            return formatted;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }

        function getStatusText(status) {
            switch(status) {
                case 'not_started': return 'Êú™ÁùÄÊâã';
                case 'in_progress': return 'ÈÄ≤Ë°å‰∏≠';
                case 'completed': return 'ÂÆå‰∫Ü';
                case 'needs_confirmation': return 'Ë¶ÅÁ¢∫Ë™ç';
                case 'not_applicable': return 'ÂØæË±°Â§ñ';
                case 'pending': return '‰øùÁïô‰∏≠';

                default: return status;
            }
        }

        // Á¢∫Ë™çÂØæË±°ËÄÖ„ÇíÂèñÂæó
        function getConfirmationTarget(task) {
            console.log('getConfirmationTarget called with task:', task);
            
            // „Çø„Çπ„ÇØ„ÅÆ„É°„É¢„Åã„Çâ@„É°„É≥„Ç∑„Éß„É≥„ÇíÊ§úÁ¥¢ÔºàÊó•Êú¨Ë™ûÂØæÂøúÔºâ
            if (task.notes) {
                console.log('„Çø„Çπ„ÇØ„ÅÆ„É°„É¢„ÇíÁ¢∫Ë™ç:', task.notes);
                
                // „Çà„ÇäÊüîËªü„Å™„É°„É≥„Ç∑„Éß„É≥Ê§úÁ¥¢ÔºàÊó•Êú¨Ë™û„ÄÅËã±Êï∞Â≠ó„ÄÅË®òÂè∑„Å´ÂØæÂøúÔºâ
                const mentionMatches = task.notes.match(/@([^\s@]+)/g);
                if (mentionMatches && mentionMatches.length > 0) {
                    // ÊúÄÊñ∞„ÅÆ„É°„É≥„Ç∑„Éß„É≥„ÇíÂèñÂæó
                    const latestMention = mentionMatches[mentionMatches.length - 1];
                    const mentionedUser = latestMention.replace('@', '');
                    console.log('„É°„É≥„Ç∑„Éß„É≥„Åï„Çå„Åü„É¶„Éº„Ç∂„Éº:', mentionedUser);
                    return mentionedUser;
                }
            }
            
            // „É°„É¢„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊãÖÂΩìËÄÖ„ÇíÁ¢∫Ë™çÂØæË±°„Å®„Åô„Çã
            if (task.assigned_to_name) {
                console.log('ÊãÖÂΩìËÄÖ„ÇíÁ¢∫Ë™çÂØæË±°„Å´Ë®≠ÂÆö:', task.assigned_to_name);
                return task.assigned_to_name;
            }
            
            // ÊãÖÂΩìËÄÖ„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÅØÁÆ°ÁêÜËÄÖ
            console.log('„Éá„Éï„Ç©„É´„ÉàÁ¢∫Ë™çÂØæË±°: ÁÆ°ÁêÜËÄÖ');
            return 'ÁÆ°ÁêÜËÄÖ';
        }

        // Êñ∞„Åó„ÅÑ„É°„É¢„ÇíÂç≥Â∫ß„Å´UI„Å´ËøΩÂä†
        function addMemoToUI(content, noteId) {
            const notesHistory = document.getElementById('notesHistory');
            
            // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„Éà„ÅØ„Äå‰∫ï‰∏äÁõ¥Ê®π„ÄçÔºâ
            const currentUserName = '‰∫ï‰∏äÁõ¥Ê®π'; // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØË™çË®ºÊÉÖÂ†±„Åã„ÇâÂèñÂæó
            
            // Êñ∞„Åó„ÅÑ„É°„É¢„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
            const noteItem = document.createElement('div');
            noteItem.className = 'note-item new-memo';
            noteItem.setAttribute('data-note-id', noteId);
            noteItem.innerHTML = `
                <div class="note-header">
                    <div class="note-info">
                        <span class="note-user">${currentUserName}</span>
                        <span class="note-date">${formatDateTime(new Date())}</span>
                    </div>
                    <div class="note-actions">
                        <button type="button" class="btn-edit-note" onclick="editNote(${noteId})" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                        <button type="button" class="btn-delete-note" onclick="deleteNote(${noteId})" title="ÂâäÈô§">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="note-content" id="note-content-${noteId}">${formatNoteContent(content)}</div>
                <div class="note-edit-form" id="note-edit-${noteId}" style="display: none;">
                    <textarea class="note-edit-textarea" id="note-edit-text-${noteId}">${content}</textarea>
                    <div class="note-edit-actions">
                        <button type="button" class="btn btn-primary btn-sm" onclick="saveNoteEdit(${noteId})">‰øùÂ≠ò</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelNoteEdit(${noteId})">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </div>
            `;
            
            // „É°„É¢‰∏ÄË¶ß„ÅÆÂÖàÈ†≠„Å´ËøΩÂä†
            if (notesHistory.firstChild) {
                notesHistory.insertBefore(noteItem, notesHistory.firstChild);
            } else {
                notesHistory.appendChild(noteItem);
            }
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíËøΩÂä†
            noteItem.style.opacity = '0';
            noteItem.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                noteItem.style.transition = 'all 0.3s ease';
                noteItem.style.opacity = '1';
                noteItem.style.transform = 'translateY(0)';
            }, 10);
        }

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫/ÈùûË°®Á§∫
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                background: ${type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#667eea'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease;
            `;

            container.appendChild(messageDiv);

            // 3ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÊï∞Êõ¥Êñ∞„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('change', function(e) {
            if (e.target.name === 'templates') {
                updateSelectedCount();
            }
        });


        // ==================== „Çø„Çπ„ÇØÁÆ°ÁêÜÊ©üËÉΩ ====================
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÇíÁ∑®ÈõÜÁî®„Å´Ë™≠„ÅøËæº„Åø
        async function loadProjectTasksForEdit() {
            if (!currentProject) return;
            
            try {
                const response = await fetch(`api.php?path=projects/${currentProject.id}/tasks`);
                const data = await response.json();
                
                if (data.success) {
                    displayProjectTasksForEdit(data.tasks);
                } else {
                    console.error('„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó:', data.message);
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Ç®„É©„Éº:', error);
            }
        }

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÇíÁ∑®ÈõÜÁîªÈù¢„Å´Ë°®Á§∫
        function displayProjectTasksForEdit(tasks) {
            const tasksList = document.getElementById('projectTasksList');
            tasksList.innerHTML = '';
            
            if (!tasks || tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // „Éï„Çß„Éº„Ç∫„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const tasksByPhase = {};
            tasks.forEach(task => {
                if (!tasksByPhase[task.phase_name]) {
                    tasksByPhase[task.phase_name] = [];
                }
                tasksByPhase[task.phase_name].push(task);
            });
            
            // „Éï„Çß„Éº„Ç∫„Åî„Å®„Å´Ë°®Á§∫
            Object.keys(tasksByPhase).sort().forEach(phaseName => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase-tasks-group';
                phaseDiv.innerHTML = `<h5>${phaseName}</h5>`;
                
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'phase-tasks-container';
                
                tasksByPhase[phaseName].forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'project-task-item';
                    taskItem.innerHTML = `
                        <div class="task-info">
                            <span class="task-name">${task.task_name}</span>
                            <span class="task-status status-${task.status || 'not_started'}">${getStatusText(task.status || 'not_started')}</span>
                            ${task.estimated_hours ? `<span class="task-hours">${task.estimated_hours}h</span>` : ''}
                            ${task.is_technical_work ? '<span class="task-flag technical">ÊäÄË°ì</span>' : ''}
                            ${task.has_manual ? '<span class="task-flag manual">„Éû„Éã„É•„Ç¢„É´</span>' : ''}
                        </div>
                        <div class="task-actions">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="editProjectTask(${task.id})" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeProjectTask(${task.id})" title="ÂâäÈô§">üóëÔ∏è</button>
                        </div>
                    `;
                    tasksContainer.appendChild(taskItem);
                });
                
                phaseDiv.appendChild(tasksContainer);
                tasksList.appendChild(phaseDiv);
            });
        }

        // Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíËøΩÂä†
        window.addNewTaskToProject = function() {
            if (!currentProject) {
                showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('taskEditForm').reset();
            document.getElementById('editTaskId').value = '';
            document.getElementById('editTaskProjectId').value = currentProject.id;
            document.getElementById('taskEditModalTitle').textContent = '„Çø„Çπ„ÇØËøΩÂä†';
            
            document.getElementById('taskEditModal').style.display = 'block';
        };

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ
        async function editProjectTask(taskId) {
            try {
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                const data = await response.json();
                
                if (data.success) {
                    const task = data.task;
                    
                    // „Éï„Ç©„Éº„É†„Å´„Éá„Éº„Çø„ÇíË®≠ÂÆö
                    document.getElementById('editTaskId').value = task.id;
                    document.getElementById('editTaskProjectId').value = task.project_id;
                    document.getElementById('editTaskName').value = task.task_name;
                    document.getElementById('editTaskPhase').value = task.phase_name;
                    document.getElementById('editTaskOrder').value = task.task_order || 0;
                    document.getElementById('editTaskEstimatedHours').value = task.estimated_hours || '';
                    document.getElementById('editTaskIsTechnical').checked = task.is_technical_work == 1;
                    document.getElementById('editTaskHasManual').checked = task.has_manual == 1;
                    
                    document.getElementById('taskEditModalTitle').textContent = '„Çø„Çπ„ÇØÁ∑®ÈõÜ';
                    document.getElementById('taskEditModal').style.display = 'block';
                } else {
                    showMessage('„Çø„Çπ„ÇØÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØÁ∑®ÈõÜ„Ç®„É©„Éº:', error);
                showMessage('„Çø„Çπ„ÇØÊÉÖÂ†±„ÅÆÂèñÂæó‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Çø„Çπ„ÇØÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        window.closeTaskEditModal = function() {
            document.getElementById('taskEditModal').style.display = 'none';
        };

        // „Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò
        window.saveTaskEdit = async function() {
            const taskId = document.getElementById('editTaskId').value;
            const projectId = document.getElementById('editTaskProjectId').value;
            const taskName = document.getElementById('editTaskName').value.trim();
            const phaseName = document.getElementById('editTaskPhase').value;
            const taskOrder = parseInt(document.getElementById('editTaskOrder').value) || 0;
            const estimatedHours = parseFloat(document.getElementById('editTaskEstimatedHours').value) || null;
            const isTechnicalWork = document.getElementById('editTaskIsTechnical').checked;
            const hasManual = document.getElementById('editTaskHasManual').checked;
            
            if (!taskName) {
                showMessage('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            try {
                const isEdit = taskId !== '';
                const endpoint = isEdit ? 'projects/tasks/update' : 'projects/tasks/add';
                
                const requestData = {
                    task_name: taskName,
                    phase_name: phaseName,
                    task_order: taskOrder,
                    estimated_hours: estimatedHours,
                    is_technical_work: isTechnicalWork,
                    has_manual: hasManual
                };
                
                if (isEdit) {
                    requestData.task_id = taskId;
                } else {
                    requestData.project_id = projectId;
                }
                
                const response = await fetch(`api.php?path=${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeTaskEditModal();
                    await loadProjectTasksForEdit();
                } else {
                    showMessage(data.message || '„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showMessage('„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        };

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åã„Çâ„Çø„Çπ„ÇØ„ÇíÂâäÈô§
        async function removeProjectTask(taskId) {
            if (!confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            try {
                const response = await fetch('api.php?path=projects/tasks/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task_id: taskId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    await loadProjectTasksForEdit();
                } else {
                    showMessage(data.message || '„Çø„Çπ„ÇØ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('„Çø„Çπ„ÇØÂâäÈô§„Ç®„É©„Éº:', error);
                showMessage('„Çø„Çπ„ÇØ„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // ==================== „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„É©„Ç§„Éñ„É©„É™ ====================
        
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„É©„Ç§„Éñ„É©„É™
        const TemplateSelector = {
            // Ë®≠ÂÆö
            config: {
                containerId: null,
                onSelectionChange: null,
                onAddTemplates: null,
                mode: 'new_project' // 'new_project' or 'edit_project'
            },
            
            // Áä∂ÊÖã
            state: {
                allTemplates: [],
                filteredTemplates: [],
                selectedTemplateIds: new Set(),
                activePhase: 'all'
            },
            
            // ÂàùÊúüÂåñ
            init: function(config) {
                this.config = { ...this.config, ...config };
                this.state.selectedTemplateIds.clear();
                this.state.activePhase = 'all';
                this.loadTemplates();
            },
            
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø
            loadTemplates: async function() {
                try {
                    const response = await fetch('api.php?path=templates');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.success && data.templates) {
                        this.state.allTemplates = data.templates;
                        this.render();
                    } else {
                        console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', data.error || data.message);
                    }
                } catch (error) {
                    console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                }
            },
            
            // „É¨„É≥„ÉÄ„É™„É≥„Ç∞
            render: function() {
                if (!this.config.containerId) return;
                
                const container = document.getElementById(this.config.containerId);
                if (!container) return;
                
                // „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÇíÁîüÊàê
                this.renderPhaseFilters(container);
                
                // „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„ÇíÁîüÊàê
                this.renderTemplateList(container);
                
                // „Çµ„Éû„É™„Éº„ÇíÁîüÊàê
                this.renderSummary(container);
                
                // ÈÅ∏ÊäûÊ∏à„Åø‰ª∂Êï∞„ÇíÊõ¥Êñ∞
                this.updateSelectedCount();
            },
            
            // „Éï„Çß„Éº„Ç∫„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÇíÁîüÊàê
            renderPhaseFilters: function(container) {
                const filtersContainer = container.querySelector('.template-filters') || 
                                       container.querySelector('#templateFilters');
                if (!filtersContainer) return;
                
                // „Éï„Çß„Éº„Ç∫„ÇíÂèñÂæó
                const phases = [...new Set(this.state.allTemplates.map(t => t.phase_name))].sort();
                
                filtersContainer.innerHTML = '';
                phases.forEach(phase => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'phase-filter-btn';
                    button.textContent = phase;
                    button.onclick = () => this.setActivePhase(phase);
                    filtersContainer.appendChild(button);
                });
                
                // „Åô„Åπ„Å¶„Éú„Çø„É≥„ÇíËøΩÂä†
                const allButton = document.createElement('button');
                allButton.type = 'button';
                allButton.className = 'phase-filter-btn active';
                allButton.textContent = '„Åô„Åπ„Å¶';
                allButton.onclick = () => this.setActivePhase('all');
                filtersContainer.insertBefore(allButton, filtersContainer.firstChild);
            },
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„ÇíÁîüÊàê
            renderTemplateList: function(container) {
                const listContainer = container.querySelector('.template-groups') || 
                                    container.querySelector('#templateGroups') ||
                                    container.querySelector('#templateList');
                if (!listContainer) return;
                
                // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                this.filterTemplates();
                
                // „Éï„Çß„Éº„Ç∫„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
                const groupedTemplates = {};
                this.state.filteredTemplates.forEach(template => {
                    if (!groupedTemplates[template.phase_name]) {
                        groupedTemplates[template.phase_name] = [];
                    }
                    groupedTemplates[template.phase_name].push(template);
                });
                
                listContainer.innerHTML = '';
                Object.keys(groupedTemplates).sort().forEach(phase => {
                    const phaseGroup = document.createElement('div');
                    phaseGroup.className = 'template-phase-group';
                    phaseGroup.innerHTML = `<h6>${phase}</h6>`;
                    
                    const templatesContainer = document.createElement('div');
                    templatesContainer.className = 'template-items';
                    
                    groupedTemplates[phase].forEach(template => {
                        const templateItem = this.createTemplateItem(template);
                        templatesContainer.appendChild(templateItem);
                    });
                    
                    phaseGroup.appendChild(templatesContainer);
                    listContainer.appendChild(phaseGroup);
                });
                
                // ÈÅ∏ÊäûÊ∏à„Åø‰ª∂Êï∞„ÇíÊõ¥Êñ∞
                this.updateSelectedCount();
            },
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩúÊàê
            createTemplateItem: function(template) {
                const item = document.createElement('div');
                item.className = 'template-item';
                
                const isSelected = this.state.selectedTemplateIds.has(template.id.toString());
                
                item.innerHTML = `
                    <label class="template-checkbox-label">
                        <input type="checkbox" name="templates" value="${template.id}" 
                               ${isSelected ? 'checked' : ''}>
                        <div class="template-info">
                            <div class="template-name">${template.task_name}</div>
                            <div class="template-meta">
                                ${template.is_technical_work ? '<span class="template-flag technical">ÊäÄË°ì</span>' : ''}
                                ${template.has_manual ? '<span class="template-flag manual">„Éû„Éã„É•„Ç¢„É´</span>' : ''}
                                ${template.estimated_hours ? `<span class="template-hours">${template.estimated_hours}h</span>` : ''}
                            </div>
                        </div>
                    </label>
                `;
                
                // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', (e) => {
                    console.log('Checkbox changed for template:', template.id, 'checked:', e.target.checked);
                    
                    if (e.target.checked) {
                        this.state.selectedTemplateIds.add(template.id.toString());
                    } else {
                        this.state.selectedTemplateIds.delete(template.id.toString());
                    }
                    
                    console.log('Current selectedTemplateIds:', Array.from(this.state.selectedTemplateIds));
                    
                    // Ë§áÊï∞ÂõûË©¶Ë°å„Åó„Å¶Á¢∫ÂÆü„Å´Êõ¥Êñ∞
                    this.updateSelectedCount();
                    setTimeout(() => this.updateSelectedCount(), 50);
                    setTimeout(() => this.updateSelectedCount(), 150);
                    
                    if (this.config.onSelectionChange) {
                        this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                    }
                });
                
                return item;
            },
            
            // „Çµ„Éû„É™„Éº„ÇíÁîüÊàê
            renderSummary: function(container) {
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÅØ template-actions „ÇíÂÑ™ÂÖà
                let summaryContainer;
                if (this.config.mode === 'edit_project') {
                    summaryContainer = container.querySelector('.template-actions');
                } else {
                    summaryContainer = container.querySelector('.template-summary') || 
                                     container.querySelector('.template-actions');
                }
                
                if (!summaryContainer) {
                    console.warn('Summary container not found for mode:', this.config.mode);
                    return;
                }
                
                console.log('Rendering summary for mode:', this.config.mode);
                console.log('Using container class:', summaryContainer.className);
                
                if (this.config.mode === 'new_project') {
                    summaryContainer.innerHTML = `
                        <span>ÈÅ∏ÊäûÊ∏à„Åø: <span id="selectedCount">0</span>‰ª∂</span>
                        <button type="button" class="btn btn-secondary" onclick="TemplateSelector.selectAll()">„Åô„Åπ„Å¶ÈÅ∏Êäû</button>
                        <button type="button" class="btn btn-secondary" onclick="TemplateSelector.deselectAll()">„Åô„Åπ„Å¶Ëß£Èô§</button>
                    `;
                } else {
                    summaryContainer.innerHTML = `
                        <span>ÈÅ∏ÊäûÊ∏à„Åø: <span id="selectedCount">0</span>‰ª∂</span>
                        <span style="color: #666; font-size: 0.9em; margin-left: 10px;">‚Äª „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§âÊõ¥„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åô</span>
                    `;
                }
                
                console.log('Summary rendered, selectedCount element created in:', summaryContainer.className);
            },
            
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éï„Çß„Éº„Ç∫„ÇíË®≠ÂÆö
            setActivePhase: function(phase) {
                this.state.activePhase = phase;
                
                // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                const buttons = document.querySelectorAll('.phase-filter-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent === phase || (phase === 'all' && btn.textContent === '„Åô„Åπ„Å¶')) {
                        btn.classList.add('active');
                    }
                });
                
                this.renderTemplateList(document.getElementById(this.config.containerId));
            },
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            filterTemplates: function() {
                this.state.filteredTemplates = this.state.allTemplates.filter(template => {
                    if (this.state.activePhase !== 'all' && template.phase_name !== this.state.activePhase) {
                        return false;
                    }
                    return true;
                });
            },
            
            // ÈÅ∏ÊäûÊ∏à„ÅøÊï∞„ÇíÊõ¥Êñ∞
            updateSelectedCount: function() {
                const count = this.state.selectedTemplateIds.size;
                console.log('updateSelectedCount called, count:', count);
                console.log('selectedTemplateIds:', Array.from(this.state.selectedTemplateIds));
                
                // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„ÄÅtemplateSelectionAreaÂÜÖ„ÅÆË¶ÅÁ¥†„ÅÆ„Åø„ÇíÊõ¥Êñ∞
                if (this.config.mode === 'edit_project') {
                    const templateArea = document.getElementById('templateSelectionArea');
                    if (templateArea) {
                        // template-actionsÂÜÖ„ÅÆselectedCountË¶ÅÁ¥†„ÇíÊõ¥Êñ∞
                        const actionsContainer = templateArea.querySelector('.template-actions');
                        if (actionsContainer) {
                            const countElement = actionsContainer.querySelector('#selectedCount');
                            if (countElement) {
                                countElement.textContent = count;
                                console.log('Updated edit mode selectedCount to:', count);
                            } else {
                                // Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÂÜçÁîüÊàê
                                actionsContainer.innerHTML = `
                                    <span>ÈÅ∏ÊäûÊ∏à„Åø: <span id="selectedCount">${count}</span>‰ª∂</span>
                                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">‚Äª „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§âÊõ¥„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åô</span>
                                `;
                                console.log('Recreated edit mode actions container with count:', count);
                            }
                        }
                    }
                } else {
                    // Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„ÄÅÂÖ®„Å¶„ÅÆselectedCountË¶ÅÁ¥†„ÇíÊõ¥Êñ∞
                    const allCountElements = document.querySelectorAll('#selectedCount');
                    console.log('Found selectedCount elements:', allCountElements.length);
                    
                    allCountElements.forEach((element, index) => {
                        element.textContent = count;
                        console.log(`Updated selectedCount element ${index + 1} to:`, count);
                    });
                }
            },
            
            // „Åô„Åπ„Å¶ÈÅ∏Êäû
            selectAll: function() {
                this.state.filteredTemplates.forEach(template => {
                    this.state.selectedTemplateIds.add(template.id.toString());
                });
                this.renderTemplateList(document.getElementById(this.config.containerId));
                this.updateSelectedCount();
                if (this.config.onSelectionChange) {
                    this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // „Åô„Åπ„Å¶Ëß£Èô§
            deselectAll: function() {
                this.state.filteredTemplates.forEach(template => {
                    this.state.selectedTemplateIds.delete(template.id.toString());
                });
                this.renderTemplateList(document.getElementById(this.config.containerId));
                this.updateSelectedCount();
                if (this.config.onSelectionChange) {
                    this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // ÈÅ∏Êäû„Åó„Åü„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíËøΩÂä†ÔºàÁ∑®ÈõÜ„É¢„Éº„ÉâÁî®Ôºâ
            addSelectedTemplates: async function() {
                if (this.state.selectedTemplateIds.size === 0) {
                    showMessage('ËøΩÂä†„Åô„Çã„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                    return;
                }
                
                if (this.config.onAddTemplates) {
                    await this.config.onAddTemplates(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // „Ç≠„É£„É≥„Çª„É´ÔºàÁ∑®ÈõÜ„É¢„Éº„ÉâÁî®Ôºâ
            cancel: function() {
                if (this.config.onCancel) {
                    this.config.onCancel();
                }
            },
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„ÉÜ„É≥„Éó„É¨„Éº„ÉàID„ÇíÂèñÂæó
            getSelectedTemplateIds: function() {
                return Array.from(this.state.selectedTemplateIds);
            },
            
            // ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            clearSelection: function() {
                this.state.selectedTemplateIds.clear();
                this.updateSelectedCount();
            }
        };
        
        // ==================== Êó¢Â≠ò„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÊ©üËÉΩÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ‰øùÊåÅÔºâ ====================
        
        let filteredTemplates = [];
        
        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁ∑®ÈõÜ„Åß„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÇíÂàùÊúüÂåñ
        async function initProjectTemplateSelection() {
            if (!currentProject) return;
            
            try {
                // ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„Å®„ÉÜ„É≥„Éó„É¨„Éº„Éà‰∏ÄË¶ß„Çí‰∏¶Ë°åÂèñÂæó
                const [tasksResponse, templatesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${currentProject.id}/tasks`),
                    fetch('api.php?path=templates')
                ]);
                
                const [tasksData, templatesData] = await Promise.all([
                    tasksResponse.json(),
                    templatesResponse.json()
                ]);
                
                let usedTemplateIds = new Set();
                
                if (tasksData.success && tasksData.tasks && templatesData.success && templatesData.templates) {
                    // „Çø„Çπ„ÇØÂêç„Åã„Çâ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁâπÂÆö
                    tasksData.tasks.forEach(task => {
                        // „Åæ„Åötemplate_id„ÅßÁ¢∫Ë™ç
                        if (task.template_id) {
                            usedTemplateIds.add(task.template_id.toString());
                        } else {
                            // template_id„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Çø„Çπ„ÇØÂêç„Åß„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊ§úÁ¥¢
                            const matchingTemplate = templatesData.templates.find(template => 
                                template.task_name === task.task_name || template.task_name === task.name
                            );
                            if (matchingTemplate) {
                                usedTemplateIds.add(matchingTemplate.id.toString());
                            }
                        }
                    });
                    
                    console.log('‰ΩøÁî®‰∏≠„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„ÉàID:', Array.from(usedTemplateIds));
                }
                
                // „É©„Ç§„Éñ„É©„É™Âåñ„Åó„Åü„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÊ©üËÉΩ„ÇíÂàùÊúüÂåñ
                TemplateSelector.init({
                    containerId: 'templateSelectionArea',
                    mode: 'edit_project',
                    onSelectionChange: async function(selectedIds) {
                        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÂ§âÊõ¥ÊôÇ„Å´Ëá™ÂãïÁöÑ„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞
                        try {
                            console.log('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü:', selectedIds);
                            
                            // ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÇíÂèñÂæó
                            const currentTasks = allTasks.filter(task => task.project_id == currentProject.id);
                            const currentTemplateIds = currentTasks
                                .filter(task => task.template_id)
                                .map(task => task.template_id.toString());
                            
                            console.log('ÁèæÂú®„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„ÉàID:', currentTemplateIds);
                            console.log('ÈÅ∏Êäû„Åï„Çå„Åü„ÉÜ„É≥„Éó„É¨„Éº„ÉàID:', selectedIds);
                            
                            // ËøΩÂä†„Åô„Çã„ÉÜ„É≥„Éó„É¨„Éº„ÉàÔºàÈÅ∏Êäû„Åï„Çå„Åü„ÅåÁèæÂú®Â≠òÂú®„Åó„Å™„ÅÑ„ÇÇ„ÅÆÔºâ
                            const toAdd = selectedIds.filter(id => !currentTemplateIds.includes(id));
                            
                            // ÂâäÈô§„Åô„Çã„ÉÜ„É≥„Éó„É¨„Éº„ÉàÔºàÁèæÂú®Â≠òÂú®„Åô„Çã„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÇÇ„ÅÆÔºâ
                            const toRemove = currentTemplateIds.filter(id => !selectedIds.includes(id));
                            
                            console.log('ËøΩÂä†„Åô„Çã„ÉÜ„É≥„Éó„É¨„Éº„Éà:', toAdd);
                            console.log('ÂâäÈô§„Åô„Çã„ÉÜ„É≥„Éó„É¨„Éº„Éà:', toRemove);
                            
                            // ÂâäÈô§Âá¶ÁêÜ
                            if (toRemove.length > 0) {
                                for (const templateId of toRemove) {
                                    const tasksToRemove = currentTasks.filter(task => task.template_id == templateId);
                                    for (const task of tasksToRemove) {
                                        const response = await fetch('api.php?path=projects/tasks/remove', {
                                            method: 'DELETE',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({
                                                task_id: task.id
                                            })
                                        });
                                        
                                        const data = await response.json();
                                        if (data.success) {
                                            console.log(`„Çø„Çπ„ÇØ ${task.id} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
                                        }
                                    }
                                }
                            }
                            
                            // ËøΩÂä†Âá¶ÁêÜ
                            if (toAdd.length > 0) {
                                const response = await fetch('api.php?path=projects/tasks/add-from-templates', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        project_id: currentProject.id,
                                        template_ids: toAdd
                                    })
                                });
                                
                                const data = await response.json();
                                if (data.success) {
                                    console.log('„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„Çâ„Çø„Çπ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü:', data.message);
                                }
                            }
                            
                            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø
                            if (toAdd.length > 0 || toRemove.length > 0) {
                                await loadProject(currentProject.id);
                                showMessage('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
                            }
                            
                        } catch (error) {
                            console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÂ§âÊõ¥„Ç®„É©„Éº:', error);
                            showMessage('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                        }
                    },
                    onCancel: function() {
                        // „Ç≠„É£„É≥„Çª„É´ÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ
                    }
                });
                
                // ‰ΩøÁî®‰∏≠„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Çã
                setTimeout(() => {
                    console.log('Setting up initial template selection for project edit');
                    console.log('usedTemplateIds:', usedTemplateIds);
                    
                    usedTemplateIds.forEach(templateId => {
                        const checkbox = document.querySelector(`input[name="templates"][value="${templateId}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            TemplateSelector.state.selectedTemplateIds.add(templateId);
                            console.log(`Checked template ${templateId}`);
                        } else {
                            console.warn(`Checkbox not found for template ${templateId}`);
                        }
                    });
                    
                    console.log('Final selectedTemplateIds:', Array.from(TemplateSelector.state.selectedTemplateIds));
                    
                    // Ë§áÊï∞ÂõûË©¶Ë°å„Åó„Å¶Á¢∫ÂÆü„Å´Êõ¥Êñ∞
                    TemplateSelector.updateSelectedCount();
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 100);
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 300);
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 500);
                    
                    // Âº∑Âà∂ÁöÑ„Å´DOM„ÇíÊõ¥Êñ∞
                    setTimeout(() => {
                        const templateArea = document.getElementById('templateSelectionArea');
                        if (templateArea) {
                            const summaryContainer = templateArea.querySelector('.template-summary');
                            if (summaryContainer) {
                                const currentCount = TemplateSelector.state.selectedTemplateIds.size;
                                summaryContainer.innerHTML = `
                                    <span>ÈÅ∏ÊäûÊ∏à„Åø: <span id="selectedCount">${currentCount}</span>‰ª∂</span>
                                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">‚Äª „ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§âÊõ¥„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åô</span>
                                `;
                                console.log('Force updated summary container with count:', currentCount);
                            }
                        }
                    }, 600);
                }, 200);
                
            } catch (error) {
                console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }
        
        // Âè§„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏ÊäûÊ©üËÉΩ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„ÅüÔºà„É©„Ç§„Éñ„É©„É™Âåñ„Å´„Çà„ÇäÁΩÆ„ÅçÊèõ„ÅàÔºâ
    </script>
</body>
</html>
