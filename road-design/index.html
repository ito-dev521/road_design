<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>道路詳細設計管理システム</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/index.css">
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">🚧</div>
                <div class="logo-text">
                    <h1>道路詳細設計管理システム</h1>
                    <p>Road Design Management System</p>
            </div>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-name" id="userName">読み込み中...</span>
                        <span class="user-role" id="userRole">読み込み中...</span>
                </div>
                </div>
                <a href="settings.html" class="btn btn-secondary">⚙️ 設定</a>
                <a href="logout.php" class="btn btn-secondary">🚪 ログアウト</a>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main-container">
            <!-- プロジェクト選択/作成エリア -->
            <section class="project-section">
                <div class="card">
                <div class="project-header">
                    <h2>プロジェクト管理</h2>
                        <button class="btn btn-primary" id="newProjectBtn">🚀 新規プロジェクト</button>
                </div>
                
                <div class="project-selector">
                    <select id="projectSelect" class="project-select">
                        <option value="">プロジェクトを選択してください</option>
                    </select>
                    </div>
                </div>
            </section>

            <!-- プロジェクト情報 -->
            <section class="project-info" id="projectInfo" style="display: none;">
                <div class="card">
                <div class="project-details">
                        <div class="project-header-row">
                    <h3 id="projectName"></h3>
                            <div class="project-actions">
                                <button class="btn btn-primary btn-small" id="editProjectBtn" onclick="editProject()">
                                    ✏️ プロジェクト編集
                                </button>
                                <button class="btn btn-secondary btn-small" id="refreshProjectBtn" onclick="refreshProjectData()" title="最新のテンプレート情報を取得">
                                    🔄 更新
                                </button>
                                <button class="btn btn-danger btn-small" id="deleteProjectBtn" onclick="deleteProject()">
                                    🗑️ プロジェクト削除
                                </button>
                            </div>
                        </div>
                    <div class="project-meta">
                        <span id="projectClient"></span>
                        <span id="projectPeriod"></span>
                        <span class="project-status" id="projectStatus"></span>
                    </div>
                </div>
                
                <!-- 進捗サマリー -->
                <div class="progress-summary">
                    <div class="progress-card">
                        <div class="progress-number" id="totalTasks">0</div>
                        <div class="progress-label">総タスク数</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="completedTasks">0</div>
                        <div class="progress-label">完了済み</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number" id="inProgressTasks">0</div>
                        <div class="progress-label">進行中</div>
                    </div>
                    <div class="progress-card">
                        <div class="progress-number danger" id="overdueTasks">0</div>
                        <div class="progress-label">遅延</div>
                    </div>
                </div>
                
                <!-- プログレスバー -->
                <div class="overall-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
            </section>

            <!-- タスク管理 -->
            <section class="task-section" id="taskSection" style="display: none;">
                <div class="card">
                    <h3>タスク管理</h3>
                    
                    <!-- フェーズフィルター -->
                    <div class="task-filters" id="taskFilters">
                        <!-- フェーズボタンがここに動的に追加される -->
                </div>

                    <!-- タスクリスト -->
                    <div id="taskList" class="task-content">
                        <!-- タスクがここに動的に追加される -->
                    </div>
                </div>
            </section>
        </main>

        <!-- ローディング表示 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">読み込み中...</div>
    </div>

        <!-- メッセージ表示 -->
        <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 2000;"></div>

        <!-- モーダルここに挿入される -->
        
        <!-- 新規プロジェクト作成モーダル -->
    <div class="modal-overlay" id="newProjectModal">
            <div class="modal project-modal">
            <div class="modal-header">
                    <h3 class="modal-title">新規プロジェクト作成</h3>
                    <button class="modal-close" onclick="closeNewProjectModal()">&times;</button>
            </div>
                <div class="modal-content">
            <form id="newProjectForm">
                        <div class="form-section">
                            <h4>プロジェクト基本情報</h4>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectName">プロジェクト名</label>
                                    <input type="text" id="projectName" name="name" required>
                </div>
                <div class="form-group">
                                    <label for="projectClient">発注者</label>
                                    <select id="projectClient" name="client_id" required>
                                        <option value="">発注者を選択</option>
                                    </select>
                </div>
                            </div>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectStartDate">開始日</label>
                                    <input type="date" id="projectStartDate" name="start_date" required>
                </div>
                <div class="form-group">
                                    <label for="projectEndDate">終了日</label>
                                    <input type="date" id="projectEndDate" name="end_date" required>
                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>テンプレート選択</h4>
                            <div class="template-selection">
                                <div class="template-filters" id="templateFilters">
                                    <!-- フェーズフィルターボタンがここに動的に追加される -->
                                </div>
                                <div class="template-list">
                                    <div class="template-groups" id="templateGroups">
                                        <!-- テンプレートがここに動的に追加される -->
                                    </div>
                                </div>
                                <div class="template-summary">
                                    <span>選択済み: <span id="selectedCount">0</span>件</span>
                                    <button type="button" class="btn btn-secondary" onclick="selectAllTemplates()">すべて選択</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="createProject()">プロジェクト作成</button>
                </div>
            </div>
        </div>

        <!-- プロジェクト編集モーダル -->
        <div class="modal-overlay" id="editProjectModal">
            <div class="modal project-modal">
                <div class="modal-header">
                    <h3 class="modal-title">プロジェクト編集</h3>
                    <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="editProjectForm">
                        <input type="hidden" id="editProjectId">
                        <div class="form-section">
                            <h4>プロジェクト基本情報</h4>
                <div class="form-row">
                    <div class="form-group">
                                    <label for="editProjectName">プロジェクト名</label>
                                    <input type="text" id="editProjectName" name="name" required>
                    </div>
                    <div class="form-group">
                                    <label for="editProjectClient">発注者</label>
                                    <select id="editProjectClient" name="client_id" required>
                                        <option value="">発注者を選択</option>
                                    </select>
                    </div>
                </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProjectStartDate">開始日</label>
                                    <input type="date" id="editProjectStartDate" name="start_date" required>
                                </div>
                                <div class="form-group">
                                    <label for="editProjectEndDate">終了日</label>
                                    <input type="date" id="editProjectEndDate" name="end_date" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">ステータス</label>
                                <select id="editProjectStatus" name="status" required>
                                    <option value="active">進行中</option>
                                    <option value="completed">完了</option>
                                    <option value="on_hold">保留</option>
                                </select>
                            </div>
                </div>
            </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="updateProject()">更新</button>
                </div>
        </div>
    </div>

        <!-- プロジェクト削除確認モーダル -->
        <div class="modal-overlay" id="deleteProjectModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">プロジェクト削除確認</h3>
                    <button class="modal-close" onclick="closeDeleteProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="project-delete-info">
                        <strong>このプロジェクトを削除しますか？</strong>
                        <p id="deleteProjectInfo">プロジェクト名: <span id="deleteProjectName"></span></p>
                        <p style="color: #dc3545; font-weight: bold;">※ この操作は取り消せません。プロジェクトに関連するすべてのタスクも削除されます。</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteProjectModal()">キャンセル</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProject()">削除</button>
                </div>
            </div>
        </div>

        <!-- タスク編集モーダル -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal task-modal">
            <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">タスク編集</h3>
                    <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
                <div class="modal-content task-modal-content">
                    <form id="taskForm">
                        <input type="hidden" id="taskId">
                        
                        <!-- タスク基本情報 -->
                <div class="task-info">
                            <h4 id="taskTitle"></h4>
                        </div>
                        
                        <!-- タスクフォーム -->
                        <div class="task-form-row">
                    <div class="task-status-selector">
                                <label for="taskStatus">ステータス</label>
                                <select id="taskStatus" name="status" required>
                            <option value="not_started">未着手</option>
                            <option value="in_progress">進行中</option>
                            <option value="completed">完了</option>
                            <option value="not_applicable">対象外</option>
                        </select>
                    </div>
                    <div class="task-assignment">
                                <label for="taskAssignee">担当者</label>
                                <select id="taskAssignee" name="assigned_to">
                            <option value="">未割当</option>
                        </select>
                    </div>
                    <div class="task-date">
                                <label for="taskDueDate">期限</label>
                                <input type="date" id="taskDueDate" name="due_date">
                            </div>
                    </div>
                    
                        <!-- タスク内容表示 -->
                        <div class="task-content">
                            <label>作業内容</label>
                            <div class="task-content-display" id="taskContentDisplay"></div>
                        </div>

                        <!-- タスクメタ情報 -->
                    <div class="task-meta">
                        <div class="task-meta-item">
                                <span class="meta-label">フェーズ:</span>
                                <span id="taskPhase"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">作業順序:</span>
                                <span id="taskOrder"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">技術作業:</span>
                            <span id="taskTechnical"></span>
                        </div>
                        <div class="task-meta-item">
                            <span class="meta-label">マニュアル:</span>
                                <span id="taskManualInfo"></span>
                    </div>
                </div>
                
                        <!-- 作業メモ -->
                <div class="task-notes">
                            <label>作業メモ</label>
                            
                            <!-- 既存メモの履歴 -->
                            <div class="notes-history" id="notesHistory">
                                <!-- メモ履歴がここに表示される -->
                </div>
                
                            <!-- 新しいメモ追加 -->
                            <div class="add-note-section">
                                <textarea id="newNote" placeholder="新しいメモを入力してください..." rows="4"></textarea>
                                <button type="button" class="btn btn-primary" onclick="addNote()">メモを追加</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let allTasks = [];
        let filteredTasks = [];
        let allPhases = [];
        let currentPhaseFilter = 'all';
        let allUsers = [];
        let allClients = [];
        let allTemplates = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM読み込み完了');
            loadProjects();
            loadUserInfo();
            setupEventListeners();
        });

        // イベントリスナー設定
        function setupEventListeners() {
            // プロジェクト選択
            document.getElementById('projectSelect').addEventListener('change', function() {
                const projectId = this.value;
                if (projectId) {
                    loadProject(projectId);
                } else {
                    hideProjectInfo();
                }
            });

            // 新規プロジェクトボタン
            document.getElementById('newProjectBtn').addEventListener('click', function() {
                openNewProjectModal();
            });

            // モーダル背景クリックを無効化
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, true);
                
                overlay.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, true);
            });
        }

        // デフォルトユーザー情報設定
        function setDefaultUserInfo() {
            document.getElementById('userName').textContent = '管理者';
            document.getElementById('userRole').textContent = '管理者';
            console.log('デフォルトユーザー情報を設定しました');
        }

        // ユーザー情報読み込み
        async function loadUserInfo() {
            try {
                console.log('ユーザー情報を読み込み中...');
                
                // まず専用のプロフィールエンドポイントを試す
                const response = await fetch('api.php?path=user/profile');
                const data = await response.json();
                
                console.log('プロフィールAPI応答:', data);
                
                if (data.success && data.name) {
                    document.getElementById('userName').textContent = data.name;
                    document.getElementById('userRole').textContent = getRoleText(data.role || 'manager');
                    console.log('ユーザー情報設定完了:', data.name, data.role);
                } else {
                    console.log('ユーザー情報が取得できませんでした、デフォルト値を設定');
                    setDefaultUserInfo();
                }
            } catch (error) {
                console.error('ユーザー情報読み込みエラー:', error);
                console.log('代替手段を試行中...');
                
                // 代替手段を試行
                if (!await loadUserInfoAlternative()) {
                    setDefaultUserInfo();
                }
            }
        }

        // 代替ユーザー情報読み込み
        async function loadUserInfoAlternative() {
            try {
                const response = await fetch('api.php?path=users');
                const data = await response.json();
                
                console.log('代替ユーザーAPI応答:', data);
                
                if (data.success && data.users && data.users.length > 0) {
                    // 最初のユーザー（通常は管理者）を使用
                    const user = data.users[0];
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userRole').textContent = getRoleText(user.role);
                    console.log('代替手段でユーザー情報設定完了:', user.name, user.role);
                    return true;
                }
                
                console.log('代替手段でもユーザー情報を取得できませんでした');
                return false;
            } catch (error) {
                console.error('代替ユーザー情報読み込みエラー:', error);
                return false;
            }
        }

        // 役職名変換
        function getRoleText(role) {
            switch(role) {
                case 'admin': return '管理者';
                case 'manager': return '管理者';
                case 'user': return 'ユーザー';
                default: return '管理者';
            }
        }

        // プロジェクト一覧読み込み
        async function loadProjects() {
            try {
                console.log('プロジェクト一覧を読み込み中...');
                const response = await fetch('api.php?path=projects');
                const data = await response.json();
                
                console.log('プロジェクトAPI応答:', data);
                
                if (data.success && data.projects) {
                    populateProjectSelect(data.projects);
                } else {
                    console.error('プロジェクト読み込みエラー:', data.error || 'データが見つかりません');
                    showMessage('プロジェクトの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                console.error('プロジェクト読み込みエラー:', error);
                showMessage('プロジェクトの読み込み中にエラーが発生しました', 'error');
            }
        }

        // プロジェクト選択肢を設定
        function populateProjectSelect(projects) {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">プロジェクトを選択してください</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
            
            console.log(`${projects.length}個のプロジェクトを読み込みました`);
        }

        // プロジェクト読み込み
        async function loadProject(projectId) {
            try {
                showLoading();
                console.log('プロジェクトを読み込み中:', projectId);
                
                // プロジェクト詳細、タスク、フェーズを並行取得
                const [projectResponse, tasksResponse, phasesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${projectId}`),
                    fetch(`api.php?path=projects/${projectId}/tasks`),
                    fetch('api.php?path=phases')
                ]);

                const [projectData, tasksData, phasesData] = await Promise.all([
                    projectResponse.json(),
                    tasksResponse.json(),
                    phasesResponse.json()
                ]);

                console.log('プロジェクトデータ:', projectData);
                console.log('タスクデータ:', tasksData);
                console.log('フェーズデータ:', phasesData);

                if (projectData.success && projectData.project) {
                    currentProject = projectData.project;
                    displayProject(currentProject);
                    
                    if (phasesData.success && phasesData.phases) {
                        allPhases = phasesData.phases;
                        setupPhaseFilters(allPhases);
                    }
                    
                    if (tasksData.success && tasksData.tasks) {
                        console.log('タスクデータ取得成功:', tasksData.tasks);
                        console.log('タスクデータの詳細:', JSON.stringify(tasksData.tasks, null, 2));
                        allTasks = tasksData.tasks;
                        // マニュアル情報でタスクを充実化
                        await enrichTasksWithManualInfo();
                        console.log('enrichTasksWithManualInfo 完了後の filteredTasks:', filteredTasks);
                        displayTasks(filteredTasks);
                        updateProgress();
                    } else {
                        console.log('タスクデータ取得失敗:', tasksData);
                        console.log('タスクデータの詳細:', JSON.stringify(tasksData, null, 2));
                    }
                    
                    showProjectInfo();
                } else {
                    console.error('プロジェクト読み込みエラー:', projectData.error);
                    showMessage('プロジェクトの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                console.error('プロジェクト読み込みエラー:', error);
                showMessage('プロジェクトの読み込み中にエラーが発生しました', 'error');
            } finally {
                hideLoading();
            }
        }

        // タスクをマニュアル情報で充実化
        async function enrichTasksWithManualInfo() {
            try {
                console.log('タスクをマニュアル情報で充実化中...');
                
                // マニュアル情報を取得（ファイル名表示用）
                const manualsResponse = await fetch('api.php?path=manuals');
                const manualsData = await manualsResponse.json();

                console.log('マニュアルデータ:', manualsData);

                // マニュアル情報をマップに変換
                const manualsMap = new Map();
                if (manualsData.success && manualsData.manuals) {
                    manualsData.manuals.forEach(manual => {
                        manualsMap.set(manual.template_id, manual);
                    });
                }

                // タスクを充実化（データベースから既に取得済みの情報を使用）
                console.log('allTasks の内容:', allTasks);
                console.log('allTasks の詳細:', JSON.stringify(allTasks, null, 2));
                console.log('manualsMap の内容:', manualsMap);
                
                filteredTasks = allTasks.map(task => {
                    const manual = manualsMap.get(task.template_id);
                    
                    console.log(`タスク ${task.id} の処理:`, {
                        template_id: task.template_id,
                        template_name: task.template_name,
                        template_content: task.template_content,
                        is_technical_work: task.is_technical_work,
                        has_manual: task.has_manual,
                        phase_name: task.phase_name,
                        task_order: task.task_order,
                        manual: manual
                    });
                    
                    return {
                        ...task,
                        template_content: task.template_content || '',
                        is_technical_work: task.is_technical_work || '0',
                        has_manual: task.has_manual || '0',
                        manual_file_name: manual ? manual.file_name : '',
                        phase_name: task.phase_name || '未分類',
                        task_order: task.task_order || 0
                    };
                });

                console.log('充実化されたタスク:', filteredTasks);
            } catch (error) {
                console.error('タスク充実化エラー:', error);
                filteredTasks = [...allTasks];
            }
        }

        // プロジェクト情報表示
        function displayProject(project) {
            document.getElementById('projectName').textContent = project.name || '不明なプロジェクト';
            document.getElementById('projectClient').textContent = `発注者: ${project.client_name || '不明'}`;
            document.getElementById('projectPeriod').textContent = `期間: ${formatDate(project.start_date)} - ${formatDate(project.end_date)}`;
            document.getElementById('projectStatus').textContent = getStatusText(project.status);
            
            console.log('プロジェクト情報を表示しました:', project.name);
        }

        // プロジェクト情報表示/非表示
        function showProjectInfo() {
            document.getElementById('projectInfo').style.display = 'block';
            document.getElementById('taskSection').style.display = 'block';
        }

        function hideProjectInfo() {
            document.getElementById('projectInfo').style.display = 'none';
            document.getElementById('taskSection').style.display = 'none';
            currentProject = null;
            allTasks = [];
            filteredTasks = [];
        }

        // フェーズフィルター設定
        function setupPhaseFilters(phases) {
            const filtersContainer = document.getElementById('taskFilters');
            filtersContainer.innerHTML = '';

            // 全体フィルター
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.textContent = '全体';
            allBtn.onclick = () => filterByPhase('all');
            filtersContainer.appendChild(allBtn);

            // 各フェーズフィルター
            phases.forEach(phase => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = phase.name;
                btn.onclick = () => filterByPhase(phase.id);
                filtersContainer.appendChild(btn);
            });
        }

        // フェーズによるフィルタリング
        function filterByPhase(phaseId) {
            currentPhaseFilter = phaseId;
            
            // フィルターボタンのアクティブ状態更新
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            displayTasks(filteredTasks);
        }

        // タスク表示
        function displayTasks(tasks) {
            console.log('displayTasks 呼び出し:', tasks);
            console.log('displayTasks の詳細:', JSON.stringify(tasks, null, 2));
            const taskList = document.getElementById('taskList');
            console.log('taskList 要素:', taskList);
            
            if (!tasks || tasks.length === 0) {
                console.log('タスクが空または未定義');
                taskList.innerHTML = '<div class="empty">タスクがありません</div>';
                return;
            }

            // フェーズによるフィルタリング
            let filteredByPhase = tasks;
            if (currentPhaseFilter !== 'all') {
                filteredByPhase = tasks.filter(task => {
                    const phase = allPhases.find(p => p.name === task.phase_name);
                    return phase && phase.id == currentPhaseFilter;
                });
            }

            // フェーズごとにグループ化
            const tasksByPhase = {};
            filteredByPhase.forEach(task => {
                const phaseName = task.phase_name || '未分類';
                if (!tasksByPhase[phaseName]) {
                    tasksByPhase[phaseName] = [];
                }
                tasksByPhase[phaseName].push(task);
            });

            // フェーズごとに表示
            taskList.innerHTML = '';
            Object.entries(tasksByPhase).forEach(([phaseName, phaseTasks]) => {
                const phaseContainer = document.createElement('div');
                phaseContainer.className = 'phase-container';
                
                const phaseTitle = document.createElement('h3');
                phaseTitle.textContent = `${phaseName} (${phaseTasks.length})`;
                phaseContainer.appendChild(phaseTitle);
                
                const taskGrid = document.createElement('div');
                taskGrid.className = 'task-list';
                
                // タスクを順序でソート
                phaseTasks.sort((a, b) => (a.task_order || 0) - (b.task_order || 0));
                
                phaseTasks.forEach(task => {
                    const taskItem = createTaskItem(task);
                    taskGrid.appendChild(taskItem);
                });
                
                phaseContainer.appendChild(taskGrid);
                taskList.appendChild(phaseContainer);
            });

            console.log(`${filteredByPhase.length}個のタスクを表示しました`);
        }

        // タスクアイテム作成
        function createTaskItem(task) {
            const item = document.createElement('div');
            item.className = 'task-item';
            item.onclick = () => editTask(task.id);
            
            const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed';
            
            item.innerHTML = `
                <div class="task-header">
                    <h4 class="task-title">${task.name}</h4>
                    <div class="task-status-group">
                        <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                        ${isOverdue ? '<span class="task-overdue">遅延</span>' : ''}
    </div>
                </div>
                <div class="task-meta">
                    <div class="task-meta-row">
                        <div class="task-assignee">
                            <span class="icon-user"></span>
                            ${task.assigned_user_name || '未割当'}
                        </div>
                        <div class="task-date ${isOverdue ? 'overdue' : ''}">
                            <span class="icon-calendar"></span>
                            ${task.due_date ? formatDate(task.due_date) : '期限なし'}
                        </div>
                    </div>
                    <div class="task-flags">
                        ${task.is_technical_work == '1' ? '<span class="flag technical">技術作業</span>' : ''}
                        ${task.has_manual == '1' ? '<span class="flag manual">📚 マニュアルあり</span>' : ''}
                    </div>
                </div>
            `;
            
            return item;
        }

        // タスク編集
        async function editTask(taskId) {
            try {
                console.log('タスク編集開始:', taskId);
                
                // ユーザー一覧を先に読み込む
                await loadUsers();
                
                const task = filteredTasks.find(t => t.id == taskId);
                if (!task) {
                    console.error('タスクが見つかりません:', taskId);
                    showMessage('タスクが見つかりません', 'error');
                    return;
                }

                console.log('編集対象タスク:', task);
                console.log('assigned_to 値:', task.assigned_to);

                // タスク詳細を取得
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                const data = await response.json();
                
                console.log('タスク詳細API応答:', data);
                
                if (data.success && data.task) {
                    const taskData = data.task;
                    console.log('API取得タスク assigned_to:', taskData.assigned_to);
                    
                    // モーダルにデータを設定
                    document.getElementById('taskId').value = taskData.id;
                    document.getElementById('taskTitle').textContent = taskData.name;
                    document.getElementById('taskStatus').value = taskData.status;
                    document.getElementById('taskDueDate').value = taskData.due_date || '';
                    document.getElementById('taskContentDisplay').textContent = task.template_content || '内容なし';
                    
                    // メタ情報表示
                    document.getElementById('taskPhase').textContent = task.phase_name || '未分類';
                    document.getElementById('taskOrder').textContent = task.task_order || '0';
                    document.getElementById('taskTechnical').textContent = task.is_technical_work == '1' ? 'はい' : 'いいえ';
                    document.getElementById('taskManualInfo').textContent = task.has_manual == '1' ? 'あり' : 'なし';
                    
                    // 担当者設定（ユーザー読み込み後に設定）
                    if (taskData.assigned_to) {
                        console.log('担当者を設定中:', taskData.assigned_to);
                        document.getElementById('taskAssignee').value = taskData.assigned_to;
                        console.log('設定後の値:', document.getElementById('taskAssignee').value);
            } else {
                        console.log('担当者が未設定');
                        document.getElementById('taskAssignee').value = '';
                    }
                    
                    // メモ履歴読み込み
                    await loadTaskNotes(taskId);
                    
                    // モーダル表示
                    document.getElementById('taskModal').style.display = 'block';
            } else {
                    console.error('タスク詳細読み込みエラー:', data.error);
                    showMessage('タスク詳細の読み込みに失敗しました', 'error');
                }
            } catch (error) {
                console.error('タスク編集エラー:', error);
                showMessage('タスク編集中にエラーが発生しました', 'error');
            }
        }

        // ユーザー一覧読み込み
        async function loadUsers() {
            try {
                const taskAssigneeSelect = document.getElementById('taskAssignee');
                const currentValue = taskAssigneeSelect.value; // 現在の値を保存
                
                console.log('ユーザー一覧読み込み中..., 現在の値:', currentValue);
                
                const response = await fetch('api.php?path=users');
                const data = await response.json();
                
                console.log('ユーザーAPI応答:', data);
                
                if (data.success && data.users) {
                    allUsers = data.users;
                    
                    // ドロップダウンを再構築
                    taskAssigneeSelect.innerHTML = '<option value="">未割当</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        taskAssigneeSelect.appendChild(option);
                    });
                    
                    // 保存していた値を復元
                    if (currentValue) {
                        taskAssigneeSelect.value = currentValue;
                        console.log('担当者値を復元:', currentValue, '→', taskAssigneeSelect.value);
                    }
                    
                    console.log(`${data.users.length}人のユーザーを読み込みました`);
            } else {
                    console.error('ユーザー読み込みエラー:', data.error);
                }
            } catch (error) {
                console.error('ユーザー読み込みエラー:', error);
            }
        }

        // タスクメモ読み込み
        async function loadTaskNotes(taskId) {
            try {
                const response = await fetch(`api.php?path=tasks/${taskId}/notes`);
                const data = await response.json();
                
                const notesHistory = document.getElementById('notesHistory');
                
                if (data.success && data.notes && data.notes.length > 0) {
                    notesHistory.innerHTML = '';
                    data.notes.forEach(note => {
                        const noteItem = document.createElement('div');
                        noteItem.className = 'note-item';
                        noteItem.innerHTML = `
                            <div class="note-header">
                                <span class="note-user">${note.user_name || '不明'}</span>
                                <span class="note-date">${formatDateTime(note.created_at)}</span>
                            </div>
                            <div class="note-content">${note.content}</div>
                        `;
                        notesHistory.appendChild(noteItem);
                    });
            } else {
                    notesHistory.innerHTML = '<div class="note-item">メモはありません</div>';
                }
            } catch (error) {
                console.error('メモ読み込みエラー:', error);
                document.getElementById('notesHistory').innerHTML = '<div class="note-item">メモの読み込みに失敗しました</div>';
            }
        }

        // メモ追加
        async function addNote() {
            const taskId = document.getElementById('taskId').value;
            const content = document.getElementById('newNote').value.trim();
            
            if (!content) {
                showMessage('メモ内容を入力してください', 'error');
                return;
            }
            
            try {
                const response = await fetch('api.php?path=tasks/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_id: taskId,
                        content: content
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('newNote').value = '';
                    await loadTaskNotes(taskId);
                    showMessage('メモを追加しました', 'success');
                } else {
                    console.error('メモ追加エラー:', data.error);
                    showMessage('メモの追加に失敗しました', 'error');
                }
            } catch (error) {
                console.error('メモ追加エラー:', error);
                showMessage('メモの追加中にエラーが発生しました', 'error');
            }
        }

        // タスク保存
        async function saveTask() {
            try {
                const taskId = document.getElementById('taskId').value;
                const formData = {
                    id: taskId,
                    status: document.getElementById('taskStatus').value,
                    assigned_to: document.getElementById('taskAssignee').value || null,
                    due_date: document.getElementById('taskDueDate').value || null
                };

                console.log('タスク保存データ:', formData);

                const response = await fetch('api.php?path=tasks', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('タスクを更新しました', 'success');
                    closeTaskModal();
                    // プロジェクトデータを再読み込み
                    if (currentProject) {
                        await loadProject(currentProject.id);
                    }
        } else {
                    console.error('タスク保存エラー:', data.error);
                    showMessage('タスクの保存に失敗しました', 'error');
                }
            } catch (error) {
                console.error('タスク保存エラー:', error);
                showMessage('タスクの保存中にエラーが発生しました', 'error');
            }
        }

        // 進捗更新
        function updateProgress() {
            if (!filteredTasks || filteredTasks.length === 0) {
                document.getElementById('totalTasks').textContent = '0';
                document.getElementById('completedTasks').textContent = '0';
                document.getElementById('inProgressTasks').textContent = '0';
                document.getElementById('overdueTasks').textContent = '0';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressText').textContent = '0%';
                return;
            }

            const total = filteredTasks.length;
            const completed = filteredTasks.filter(task => task.status === 'completed').length;
            const inProgress = filteredTasks.filter(task => task.status === 'in_progress').length;
            const overdue = filteredTasks.filter(task => {
                return task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed';
            }).length;

            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('overdueTasks').textContent = overdue;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${progressPercent}%`;
        }

        // 新規プロジェクトモーダル関連
        async function openNewProjectModal() {
            try {
                // クライアント、フェーズ、テンプレートを並行読み込み
                await Promise.all([
                    loadClients(),
                    loadPhases(),
                    loadTemplates()
                ]);
                
                document.getElementById('newProjectModal').style.display = 'block';
            } catch (error) {
                console.error('新規プロジェクトモーダル表示エラー:', error);
                showMessage('モーダルの表示に失敗しました', 'error');
            }
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
            document.getElementById('newProjectForm').reset();
        }

        // クライアント読み込み
        async function loadClients() {
            try {
                const response = await fetch('api.php?path=clients');
                const data = await response.json();
                
                if (data.success && data.clients) {
                    allClients = data.clients;
                    populateClientSelect();
                }
            } catch (error) {
                console.error('クライアント読み込みエラー:', error);
            }
        }

        function populateClientSelect() {
            const selects = ['projectClient', 'editProjectClient'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">発注者を選択</option>';
                    allClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // フェーズ読み込み
        async function loadPhases() {
            try {
                const response = await fetch('api.php?path=phases');
                const data = await response.json();
                
                if (data.success && data.phases) {
                    allPhases = data.phases;
                    setupTemplateFilters();
                }
            } catch (error) {
                console.error('フェーズ読み込みエラー:', error);
            }
        }

        // テンプレートフィルター設定
        function setupTemplateFilters() {
            const filtersContainer = document.getElementById('templateFilters');
            filtersContainer.innerHTML = '';

            // 全体フィルター
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.textContent = '全体';
            allBtn.onclick = () => filterTemplates('all');
            filtersContainer.appendChild(allBtn);

            // 各フェーズフィルター
            allPhases.forEach(phase => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = phase.name;
                btn.onclick = () => filterTemplates(phase.id);
                filtersContainer.appendChild(btn);
            });
        }

        // テンプレート読み込み
        async function loadTemplates() {
            try {
                const response = await fetch('api.php?path=task-templates');
                const data = await response.json();
                
                if (data.success && data.templates) {
                    allTemplates = data.templates;
                    displayTemplates(allTemplates);
                }
            } catch (error) {
                console.error('テンプレート読み込みエラー:', error);
            }
        }

        // テンプレートフィルタリング
        function filterTemplates(phaseId) {
            // フィルターボタンのアクティブ状態更新
            document.querySelectorAll('#templateFilters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (phaseId === 'all') {
                displayTemplates(allTemplates);
            } else {
                const filtered = allTemplates.filter(template => template.phase_id == phaseId);
                displayTemplates(filtered);
            }
        }

        // テンプレート表示
        function displayTemplates(templates) {
            const container = document.getElementById('templateGroups');
            container.innerHTML = '';

            if (!templates || templates.length === 0) {
                container.innerHTML = '<div class="empty">テンプレートがありません</div>';
                return;
            }

            // フェーズごとにグループ化
            const templatesByPhase = {};
            templates.forEach(template => {
                const phase = allPhases.find(p => p.id == template.phase_id);
                const phaseName = phase ? phase.name : '未分類';
                
                if (!templatesByPhase[phaseName]) {
                    templatesByPhase[phaseName] = [];
                }
                templatesByPhase[phaseName].push(template);
            });

            // フェーズごとに表示
            Object.entries(templatesByPhase).forEach(([phaseName, phaseTemplates]) => {
                const phaseGroup = document.createElement('div');
                phaseGroup.className = 'template-group';
                
                const phaseTitle = document.createElement('h5');
                phaseTitle.className = 'phase-title';
                phaseTitle.textContent = phaseName;
                phaseGroup.appendChild(phaseTitle);
                
                const templateItems = document.createElement('div');
                templateItems.className = 'template-items';
                
                phaseTemplates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.innerHTML = `
                        <label class="template-checkbox">
                            <input type="checkbox" name="templates" value="${template.id}">
                            <div class="template-info">
                                <div class="template-name">${template.name}</div>
                                <div class="template-content">${template.content || ''}</div>
                                <div class="template-flags">
                                    ${template.is_technical_work == '1' ? '<span class="flag technical">技術作業</span>' : ''}
                                    ${template.has_manual == '1' ? '<span class="flag manual">マニュアルあり</span>' : ''}
                                </div>
                            </div>
                        </label>
                    `;
                    templateItems.appendChild(item);
                });
                
                phaseGroup.appendChild(templateItems);
                container.appendChild(phaseGroup);
            });

            updateSelectedCount();
        }

        // 選択数更新
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('input[name="templates"]:checked');
            document.getElementById('selectedCount').textContent = checkboxes.length;
        }

        // すべて選択
        function selectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn.textContent;
            
            if (activePhaseText === '全体') {
                // 全てのテンプレートを選択
                document.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                // アクティブなフェーズのテンプレートのみ選択
                const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                    const title = group.querySelector('.phase-title');
                    return title && title.textContent === activePhaseText;
                });
                
                if (phaseGroup) {
                    phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                        checkbox.checked = true;
                    });
                }
            }
            
            updateSelectedCount();
        }

        // プロジェクト作成
        async function createProject() {
            try {
                const form = document.getElementById('newProjectForm');
                const formData = new FormData(form);
                
                // 選択されたテンプレート
                const selectedTemplates = Array.from(document.querySelectorAll('input[name="templates"]:checked'))
                    .map(cb => cb.value);

                if (selectedTemplates.length === 0) {
                    showMessage('少なくとも1つのテンプレートを選択してください', 'error');
                    return;
                }

                const projectData = {
                    name: formData.get('name'),
                    client_id: formData.get('client_id'),
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date'),
                    templates: selectedTemplates
                };

                console.log('プロジェクト作成データ:', projectData);

                const response = await fetch('api.php?path=projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('プロジェクトを作成しました', 'success');
                    closeNewProjectModal();
                    await loadProjects();
                    
                    // 新しく作成されたプロジェクトを選択
                    if (data.project_id) {
                        document.getElementById('projectSelect').value = data.project_id;
                        await loadProject(data.project_id);
                    }
                } else {
                    console.error('プロジェクト作成エラー:', data.error);
                    showMessage('プロジェクトの作成に失敗しました', 'error');
                }
            } catch (error) {
                console.error('プロジェクト作成エラー:', error);
                showMessage('プロジェクトの作成中にエラーが発生しました', 'error');
            }
        }

        // プロジェクト編集
        async function editProject() {
            if (!currentProject) {
                showMessage('編集するプロジェクトが選択されていません', 'error');
                return;
            }

            try {
                // クライアント情報を読み込み
                await loadClients();
                
                // フォームにデータを設定
                document.getElementById('editProjectId').value = currentProject.id;
                document.getElementById('editProjectName').value = currentProject.name;
                document.getElementById('editProjectClient').value = currentProject.client_id;
                document.getElementById('editProjectStartDate').value = currentProject.start_date;
                document.getElementById('editProjectEndDate').value = currentProject.end_date;
                document.getElementById('editProjectStatus').value = currentProject.status;
                
                document.getElementById('editProjectModal').style.display = 'block';
            } catch (error) {
                console.error('プロジェクト編集モーダル表示エラー:', error);
                showMessage('編集画面の表示に失敗しました', 'error');
            }
        }

        function closeEditProjectModal() {
            document.getElementById('editProjectModal').style.display = 'none';
        }

        // プロジェクト更新
        async function updateProject() {
            try {
                const formData = {
                    id: document.getElementById('editProjectId').value,
                    name: document.getElementById('editProjectName').value,
                    client_id: document.getElementById('editProjectClient').value,
                    start_date: document.getElementById('editProjectStartDate').value,
                    end_date: document.getElementById('editProjectEndDate').value,
                    status: document.getElementById('editProjectStatus').value
                };

                console.log('プロジェクト更新データ:', formData);

                const response = await fetch('api.php?path=projects', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('プロジェクトを更新しました', 'success');
                    closeEditProjectModal();
                    await loadProjects();
                    await loadProject(formData.id);
                } else {
                    console.error('プロジェクト更新エラー:', data.error);
                    showMessage('プロジェクトの更新に失敗しました', 'error');
                }
            } catch (error) {
                console.error('プロジェクト更新エラー:', error);
                showMessage('プロジェクトの更新中にエラーが発生しました', 'error');
            }
        }

        // プロジェクト削除
        function deleteProject() {
            if (!currentProject) {
                showMessage('削除するプロジェクトが選択されていません', 'error');
                return;
            }

            document.getElementById('deleteProjectName').textContent = currentProject.name;
            document.getElementById('deleteProjectModal').style.display = 'block';
        }

        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').style.display = 'none';
        }

        async function confirmDeleteProject() {
            try {
                const projectId = currentProject.id;
                console.log('プロジェクト削除実行:', projectId);

                const response = await fetch(`api.php?path=projects/${projectId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                console.log('削除API応答:', data);

                if (data.success) {
                    showMessage('プロジェクトを削除しました', 'success');
                    closeDeleteProjectModal();
                    hideProjectInfo();
                    await loadProjects();
                    document.getElementById('projectSelect').value = '';
                } else {
                    console.error('プロジェクト削除エラー:', data.error);
                    showMessage('プロジェクトの削除に失敗しました: ' + (data.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('プロジェクト削除エラー:', error);
                showMessage('プロジェクトの削除中にエラーが発生しました', 'error');
            }
        }

        // プロジェクトデータ更新
        async function refreshProjectData() {
            if (!currentProject) {
                showMessage('更新するプロジェクトが選択されていません', 'error');
                return;
            }

            try {
                showMessage('データを更新中...', 'info');
                await loadProject(currentProject.id);
                showMessage('データを更新しました', 'success');
            } catch (error) {
                console.error('データ更新エラー:', error);
                showMessage('データの更新に失敗しました', 'error');
            }
        }

        // タスクモーダル関連
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('newNote').value = '';
        }

        // ユーティリティ関数
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }

        function getStatusText(status) {
            switch(status) {
                case 'not_started': return '未着手';
                case 'in_progress': return '進行中';
                case 'completed': return '完了';
                case 'not_applicable': return '対象外';
                case 'active': return '進行中';
                case 'on_hold': return '保留';
                default: return status;
            }
        }

        // ローディング表示/非表示
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // メッセージ表示
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                background: ${type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#667eea'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease;
            `;

            container.appendChild(messageDiv);

            // 3秒後に自動削除
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // テンプレート選択数更新のイベントリスナー
        document.addEventListener('change', function(e) {
            if (e.target.name === 'templates') {
                updateSelectedCount();
            }
        });
    </script>
</body>
</html>
