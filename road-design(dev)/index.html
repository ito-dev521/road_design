<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“è·¯è¨­è¨ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/index.css">
    <script>
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼
        const timestamp = new Date().getTime();
        const styleLink = document.createElement('link');
        styleLink.rel = 'stylesheet';
        styleLink.href = 'assets/css/index.css?v=' + timestamp;
        document.head.appendChild(styleLink);
    </script>
</head>
<body>
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">ğŸš§</div>
                <div class="logo-text">
                    <h1>é“è·¯è¨­è¨ˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                    <p>Road Design Management System</p>
            </div>
            </div>
            <div class="header-actions">
                <div class="notification-area">
                    <button class="notification-btn" id="notificationBtn">
                        ğŸ”” <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown" style="display: none;">
                        <div class="notification-header">
                            <h4>é€šçŸ¥</h4>
                            <button class="btn btn-small" onclick="markAllAsRead()">ã™ã¹ã¦æ—¢èª­</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-name" id="userName">èª­ã¿è¾¼ã¿ä¸­...</span>
                        <span class="user-role" id="userRole">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
                </div>
                <a href="settings.html" id="settingsBtn" class="btn btn-secondary" style="display:none;">âš™ï¸ è¨­å®š</a>
                <a href="logout.php" class="btn btn-secondary">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-container three-column-layout">
            <!-- å·¦ã‚«ãƒ©ãƒ : ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ -->
            <aside class="left-column">
                <div class="column-header">
                    <h2>ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h2>
                    <button class="btn btn-primary btn-small" id="newProjectBtn">ğŸš€ æ–°è¦</button>
                </div>
                
                <div class="project-filters">
                    <div class="filter-group">
                        <label for="statusFilter">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="planning">è¨ˆç”»ä¸­</option>
                            <option value="in_progress">é€²è¡Œä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortBy">ä¸¦ã³é †:</label>
                        <select id="sortBy" class="filter-select">
                            <option value="created_at">ç™»éŒ²æ—¥</option>
                            <option value="name">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</option>
                            <option value="start_date">é–‹å§‹æ—¥</option>
                            <option value="target_end_date">çµ‚äº†æ—¥</option>
                            <option value="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                            <option value="total_tasks">ã‚¿ã‚¹ã‚¯æ•°</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortOrder">é †åº:</label>
                        <select id="sortOrder" class="filter-select">
                            <option value="DESC">é™é †</option>
                            <option value="ASC">æ˜‡é †</option>
                        </select>
                    </div>
                    <button id="applyFilters" class="btn btn-secondary btn-small">é©ç”¨</button>
                </div>
                
                <div class="project-list" id="projectList">
                    <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </aside>

            <!-- ä¸­å¤®ã‚«ãƒ©ãƒ : é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è©³ç´° -->
            <main class="center-column">
                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± -->
                <section class="project-info" id="projectInfo" style="display: none;">
                    <div class="project-header">
                        <div class="project-title">
                            <h2 id="projectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</h2>
                            <div class="project-meta">
                                <span id="projectPeriod"></span>
                                <span class="project-status" id="projectStatus"></span>
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-secondary" id="editProjectBtn">âœï¸ ç·¨é›†</button>
                            <button class="btn btn-danger" id="deleteProjectBtn">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                    
                    <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
                    <div class="progress-summary">
                        <div class="progress-card">
                            <div class="progress-number" id="totalTasks">0</div>
                            <div class="progress-label">ç·ã‚¿ã‚¹ã‚¯æ•°</div>
                        </div>
                        <div class="progress-card">
                            <div class="progress-number" id="notStartedTasks">0</div>
                            <div class="progress-label">æœªç€æ‰‹</div>
                        </div>
                        <div class="progress-card">
                            <div class="progress-number" id="inProgressTasks">0</div>
                            <div class="progress-label">é€²è¡Œä¸­</div>
                        </div>
                        <div class="progress-card">
                            <div class="progress-number" id="completedTasks">0</div>
                            <div class="progress-label">å®Œäº†æ¸ˆã¿</div>
                        </div>
                        <div class="progress-card clickable" onclick="openNeedsConfirmationModal()">
                            <div class="progress-number danger" id="needsConfirmationTasks">0</div>
                            <div class="progress-label">è¦ç¢ºèª</div>
                        </div>
                        <div class="progress-card clickable" onclick="openOverdueTasksModal()">
                            <div class="progress-number danger" id="overdueTasks">0</div>
                            <div class="progress-label">é…å»¶</div>
                        </div>
                    </div>
                    
                    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                    <div class="overall-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                </section>

                <!-- ã‚¿ã‚¹ã‚¯ä¸€è¦§ -->
                <section class="task-section" id="taskSection" style="display: none;">
                    <div class="task-header">
                        <h3>ğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§</h3>
                        <button class="btn btn-primary" id="addTaskBtn">â• ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
                    </div>
                    
                    <div class="task-filters">
                        <div class="filter-group">
                            <label for="taskStatusFilter">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                            <select id="taskStatusFilter" class="filter-select">
                                <option value="">ã™ã¹ã¦</option>
                                <option value="not_started">æœªç€æ‰‹</option>
                                <option value="in_progress">é€²è¡Œä¸­</option>
                                <option value="completed">å®Œäº†</option>
                                <option value="needs_confirmation">è¦ç¢ºèª</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="taskPhaseFilter">ãƒ•ã‚§ãƒ¼ã‚º:</label>
                            <select id="taskPhaseFilter" class="filter-select">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="task-list" id="taskList">
                        <div class="empty">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    </div>
                </section>

                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠçŠ¶æ…‹ -->
                <section class="no-project-selected" id="noProjectSelected">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                        <p>å·¦å´ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
                        <button class="btn btn-primary" onclick="document.getElementById('newProjectBtn').click()">ğŸš€ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
                    </div>
                </section>
            </main>

            <!-- å³ã‚«ãƒ©ãƒ : è¦ç¢ºèªãƒ»æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ -->
            <aside class="right-column">
                <div class="column-header">
                    <h2>âš ï¸ é‡è¦ãªã‚¿ã‚¹ã‚¯</h2>
                    <button class="btn btn-secondary btn-small" id="refreshImportantTasksBtn">ğŸ”„ æ›´æ–°</button>
                </div>
                
                <!-- è¦ç¢ºèªã‚¿ã‚¹ã‚¯ -->
                <div class="important-tasks-section">
                    <h3>è¦ç¢ºèªã‚¿ã‚¹ã‚¯</h3>
                    <div class="important-task-list" id="rightColumnNeedsConfirmation">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                
                <!-- æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ -->
                <div class="important-tasks-section">
                    <h3>æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯</h3>
                    <div class="important-task-list" id="rightColumnOverdueTasks">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                
                <!-- æœŸé™é–“è¿‘ã‚¿ã‚¹ã‚¯ -->
                <div class="important-tasks-section">
                    <h3>æœŸé™é–“è¿‘ã‚¿ã‚¹ã‚¯</h3>
                    <div class="important-task-list" id="rightColumnUpcomingTasks">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
        <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 2000;"></div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã“ã“ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
        
        <!-- æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="newProjectModal">
            <div class="modal project-modal">
            <div class="modal-header">
                    <h3 class="modal-title">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h3>
                    <button class="modal-close" onclick="closeNewProjectModal()">&times;</button>
            </div>
                <div class="modal-content">
            <form id="newProjectForm">
                        <div class="form-section">
                            <h4>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æƒ…å ±</h4>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                                    <input type="text" id="projectName" name="name" required>
                </div>
                <div class="form-group">
                                    <label for="newProjectClient">ç™ºæ³¨è€…</label>
                                    <select id="newProjectClient" name="client_id" required>
                                        <option value="">ç™ºæ³¨è€…ã‚’é¸æŠ</option>
                                    </select>
                </div>
                            </div>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectStartDate">é–‹å§‹æ—¥</label>
                                    <input type="date" id="projectStartDate" name="start_date" required>
                </div>
                <div class="form-group">
                                    <label for="projectEndDate">çµ‚äº†æ—¥</label>
                                    <input type="date" id="projectEndDate" name="end_date" required>
                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h4>
                            <div class="template-selection">
                                <div class="template-filters" id="templateFilters">
                                    <!-- ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                </div>
                                <div class="template-list">
                                    <div class="template-groups" id="templateGroups">
                                        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                    </div>
                                </div>
                                <div class="template-summary">
                                    <span>é¸æŠæ¸ˆã¿: <span id="selectedCount">0</span>ä»¶</span>
                                    <button type="button" class="btn btn-secondary" onclick="selectAllTemplates()">ã™ã¹ã¦é¸æŠ</button>
                                    <button type="button" class="btn btn-secondary" onclick="deselectAllTemplates()">ã™ã¹ã¦è§£é™¤</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="createProject()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="editProjectModal">
            <div class="modal project-modal">
                <div class="modal-header">
                    <h3 class="modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†</h3>
                    <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="editProjectForm">
                        <input type="hidden" id="editProjectId">
                        <div class="form-section">
                            <h4>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æƒ…å ±</h4>
                <div class="form-row">
                    <div class="form-group">
                                    <label for="editProjectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                                    <input type="text" id="editProjectName" name="name" required>
                    </div>
                    <div class="form-group">
                                    <label for="editProjectClient">ç™ºæ³¨è€…</label>
                                    <select id="editProjectClient" name="client_id" required>
                                        <option value="">ç™ºæ³¨è€…ã‚’é¸æŠ</option>
                                    </select>
                    </div>
                </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProjectStartDate">é–‹å§‹æ—¥</label>
                                    <input type="date" id="editProjectStartDate" name="start_date" required>
                                </div>
                                <div class="form-group">
                                    <label for="editProjectEndDate">çµ‚äº†æ—¥</label>
                                    <input type="date" id="editProjectEndDate" name="end_date" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="editProjectStatus" name="status" required>
                                    <option value="planning">è¨ˆç”»ä¸­</option>
                                    <option value="in_progress">é€²è¡Œä¸­</option>
                                    <option value="completed">å®Œäº†</option>
                                    <option value="cancelled">ä¸­æ­¢</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="form-section">
                            <h4>ã‚¿ã‚¹ã‚¯ç®¡ç†</h4>
                            
                            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚¨ãƒªã‚¢ -->
                            <div class="template-selection-area" id="templateSelectionArea">
                                <h5>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h5>
                                <div class="template-selection">
                                    <div class="template-filters" id="editTemplateFilters">
                                        <!-- ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                    </div>
                                    <div class="template-list">
                                        <div class="template-groups" id="editTemplateGroups">
                                            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                        </div>
                                    </div>
                                    <div class="template-actions">
                                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="updateProject()">æ›´æ–°</button>
                </div>
        </div>
    </div>

        <!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="taskEditModal">
            <div class="modal task-modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="taskEditModalTitle">ã‚¿ã‚¹ã‚¯è¿½åŠ </h3>
                    <button class="modal-close" onclick="closeTaskEditModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="taskEditForm">
                        <input type="hidden" id="editTaskId">
                        <input type="hidden" id="editTaskProjectId">
                        
                        <div class="form-group">
                            <label for="editTaskName">ã‚¿ã‚¹ã‚¯å</label>
                            <input type="text" id="editTaskName" name="task_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskPhase">ãƒ•ã‚§ãƒ¼ã‚º</label>
                            <select id="editTaskPhase" name="phase_name" required>
                                <option value="ãƒ•ã‚§ãƒ¼ã‚º1">ãƒ•ã‚§ãƒ¼ã‚º1</option>
                                <option value="ãƒ•ã‚§ãƒ¼ã‚º2">ãƒ•ã‚§ãƒ¼ã‚º2</option>
                                <option value="ãƒ•ã‚§ãƒ¼ã‚º3">ãƒ•ã‚§ãƒ¼ã‚º3</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskOrder">é †åº</label>
                            <input type="number" id="editTaskOrder" name="task_order" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskEstimatedHours">è¦‹ç©æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
                            <input type="number" id="editTaskEstimatedHours" name="estimated_hours" min="0" step="0.5">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editTaskIsTechnical" name="is_technical_work">
                                æŠ€è¡“ä½œæ¥­
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editTaskHasManual" name="has_manual">
                                ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="deleteProjectModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ç¢ºèª</h3>
                    <button class="modal-close" onclick="closeDeleteProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="project-delete-info">
                        <strong>ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</strong>
                        <p id="deleteProjectInfo">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: <span id="deleteProjectName"></span></p>
                        <p style="color: #dc3545; font-weight: bold;">â€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteProjectModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProject()">å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <!-- è¦ç¢ºèªã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="needsConfirmationModal">
            <div class="modal task-list-modal">
                <div class="modal-header">
                    <h3 class="modal-title">è¦ç¢ºèªã‚¿ã‚¹ã‚¯ä¸€è¦§</h3>
                    <button class="modal-close" onclick="closeNeedsConfirmationModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div id="needsConfirmationList" class="task-list-container">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNeedsConfirmationModal()">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-primary" onclick="refreshNeedsConfirmationList()">æ›´æ–°</button>
                </div>
            </div>
        </div>

        <!-- æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="overdueTasksModal">
            <div class="modal task-list-modal">
                <div class="modal-header">
                    <h3 class="modal-title">æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ä¸€è¦§</h3>
                    <button class="modal-close" onclick="closeOverdueTasksModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div id="overdueTasksList" class="task-list-container">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeOverdueTasksModal()">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-primary" onclick="refreshOverdueTasksList()">æ›´æ–°</button>
                </div>
            </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal task-modal">
            <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">ã‚¿ã‚¹ã‚¯ç·¨é›†</h3>
                    <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
                <div class="modal-content task-modal-content">
                    <form id="taskForm" onsubmit="return false;">
                        <input type="hidden" id="taskId">
                        
                        <!-- ã‚¿ã‚¹ã‚¯åŸºæœ¬æƒ…å ± -->
                <div class="task-info">
                            <h4 id="taskTitle"></h4>
                        </div>
                        
                        <!-- ã‚¿ã‚¹ã‚¯ãƒ•ã‚©ãƒ¼ãƒ  -->
                        <div class="task-form-row">
                    <div class="task-status-selector">
                                <label for="taskStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="taskStatus" name="status" required>
                            <option value="not_started">æœªç€æ‰‹</option>
                            <option value="in_progress">é€²è¡Œä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="needs_confirmation">è¦ç¢ºèª</option>
                            <option value="not_applicable">å¯¾è±¡å¤–</option>
                            <option value="pending">ä¿ç•™ä¸­</option>
                        </select>
                    </div>
                    <div class="task-assignment">
                                <label for="taskAssignee">æ‹…å½“è€…</label>
                                <select id="taskAssignee" name="assigned_to">
                            <option value="">æœªå‰²å½“</option>
                        </select>
                    </div>
                    <div class="task-date">
                                <label for="taskDueDate">æœŸé™</label>
                                <input type="date" id="taskDueDate" name="due_date">
                            </div>
                    </div>
                    
                        <!-- ã‚¿ã‚¹ã‚¯å†…å®¹è¡¨ç¤º -->
                        <div class="task-content">
                            <label>ä½œæ¥­å†…å®¹</label>
                            <div class="task-content-display" id="taskContentDisplay"></div>
                        </div>

                        <!-- ã‚¿ã‚¹ã‚¯ãƒ¡ã‚¿æƒ…å ± -->
                    <div class="task-meta">
                        <div class="task-meta-item">
                                <span class="meta-label">ãƒ•ã‚§ãƒ¼ã‚º:</span>
                                <span id="taskPhase"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">ä½œæ¥­é †åº:</span>
                                <span id="taskOrder"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">æŠ€è¡“ä½œæ¥­:</span>
                            <span id="taskTechnical"></span>
                        </div>
                        <div class="task-meta-item">
                            <span class="meta-label">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«:</span>
                                <span id="taskManualInfo"></span>
                                <div id="taskManualLinks" class="task-manual" style="margin-top:8px; display:none;">
                                    <div id="taskManualList"></div>
                                </div>
                    </div>
                </div>
                
                        <!-- ä½œæ¥­ãƒ¡ãƒ¢ -->
                <div class="task-notes">
                            <label>ä½œæ¥­ãƒ¡ãƒ¢</label>
                            
                            <!-- æ—¢å­˜ãƒ¡ãƒ¢ã®å±¥æ­´ -->
                            <div class="notes-history" id="notesHistory">
                                <!-- ãƒ¡ãƒ¢å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                            <!-- æ–°ã—ã„ãƒ¡ãƒ¢è¿½åŠ  -->
                            <div class="add-note-section">
                                <div class="note-input-container">
                                    <textarea id="newNote" placeholder="æ–°ã—ã„ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (@ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™)" rows="4" title="@ã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™ã€‚ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã™ã‚‹ã¨è‡ªå‹•çš„ã«è¦ç¢ºèªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ãªã‚Šã¾ã™ã€‚"></textarea>
                                    <div id="userSuggestions" class="user-suggestions" style="display: none;"></div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addNote()">ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let allTasks = [];
        let filteredTasks = [];
        let allPhases = [];
        let currentPhaseFilter = 'all';
        let allUsers = [];
        let allClients = [];
        let allTemplates = [];
        let selectedTemplateIds = new Set(); // é¸æŠã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’ä¿æŒ

        // é¸æŠãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ°¸ç¶šåŒ–
        function loadSelectedTemplatesFromStorage() {
            try {
                const raw = localStorage.getItem('selectedTemplateIds');
                if (raw) {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr)) {
                        selectedTemplateIds = new Set(arr.map(String));
                    }
                }
            } catch (e) {
            }
        }

        function saveSelectedTemplatesToStorage() {
            try {
                localStorage.setItem('selectedTemplateIds', JSON.stringify(Array.from(selectedTemplateIds)));
            } catch (e) {
            }
        }

        // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰çŠ¶æ…‹ãƒ»ä¸‹æ›¸ãã®æ°¸ç¶šåŒ–
        function markNewProjectModalOpen(isOpen) {
            try { localStorage.setItem('newProjectModalOpen', isOpen ? 'true' : 'false'); } catch(e) {}
        }

        function saveNewProjectDraft() {
            try {
                const draft = {
                    name: document.getElementById('projectName')?.value || '',
                    client_id: document.getElementById('newProjectClient')?.value || '',
                    start_date: document.getElementById('projectStartDate')?.value || '',
                    end_date: document.getElementById('projectEndDate')?.value || ''
                };
                localStorage.setItem('newProjectDraft', JSON.stringify(draft));
            } catch (e) {
            }
        }

        function loadNewProjectDraft() {
            try {
                const raw = localStorage.getItem('newProjectDraft');
                if (!raw) return;
                const draft = JSON.parse(raw);
                if (!draft) return;
                
                const projectName = document.getElementById('projectName');
                const projectStartDate = document.getElementById('projectStartDate');
                const projectEndDate = document.getElementById('projectEndDate');
                const newProjectClient = document.getElementById('newProjectClient');
                
                if (draft.name && projectName) projectName.value = draft.name;
                if (draft.start_date && projectStartDate) projectStartDate.value = draft.start_date;
                if (draft.end_date && projectEndDate) projectEndDate.value = draft.end_date;
                
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ loadClients å®Œäº†å¾Œã«é©ç”¨
                setTimeout(() => {
                    if (draft.client_id && newProjectClient) newProjectClient.value = draft.client_id;
                }, 0);
            } catch (e) {
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºé˜²æ­¢ï¼ˆä¿å­˜/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã§ã¯é–‰ã˜ãªã„ï¼‰
        let newProjectModalObserver = null;
        function startNewProjectModalGuard() {
            try {
                const modal = document.getElementById('newProjectModal');
                if (!modal) return;
                if (newProjectModalObserver) newProjectModalObserver.disconnect();
                newProjectModalObserver = new MutationObserver(() => {
                    const shouldBeOpen = localStorage.getItem('newProjectModalOpen') === 'true';
                    if (!shouldBeOpen) return;
                    // display/hidden ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãŸã‚‰å¾©å…ƒ
                    if (modal.style.display === 'none' || modal.hidden) {
                        modal.style.display = 'block';
                        modal.hidden = false;
                    }
                });
                newProjectModalObserver.observe(modal, { attributes: true, attributeFilter: ['style', 'hidden'] });
            } catch (e) {
            }
        }

        function stopNewProjectModalGuard() {
            try {
                if (newProjectModalObserver) newProjectModalObserver.disconnect();
                newProjectModalObserver = null;
            } catch (e) {}
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSelectedTemplatesFromStorage();
            loadProjects();
            loadPhases(); // ãƒ•ã‚§ãƒ¼ã‚ºã‚’èª­ã¿è¾¼ã¿
            loadDashboard();
            loadImportantTasks();
            loadNotifications();
            startNotificationCheck();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            const refreshImportantTasksBtn = document.getElementById('refreshImportantTasksBtn');
            if (refreshImportantTasksBtn) {
                refreshImportantTasksBtn.addEventListener('click', refreshImportantTasks);
            }
            
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                notificationBtn.addEventListener('click', toggleNotifications);
            }
            
            // ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒœã‚¿ãƒ³
            const addTaskBtn = document.getElementById('addTaskBtn');
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', openAddTaskModal);
            }
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒœã‚¿ãƒ³
            const editProjectBtn = document.getElementById('editProjectBtn');
            if (editProjectBtn) {
                editProjectBtn.addEventListener('click', openEditProjectModal);
            }
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³
            const deleteProjectBtn = document.getElementById('deleteProjectBtn');
            if (deleteProjectBtn) {
                deleteProjectBtn.addEventListener('click', openDeleteProjectModal);
            }
            
            // ä¸€åº¦é–‹ã„ã¦ã„ãŸå ´åˆã¯å†è¡¨ç¤º
            if (localStorage.getItem('newProjectModalOpen') === 'true') {
                // å¿…è¦ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«å¾©å…ƒ
                Promise.allSettled([loadClients(), loadPhases(), loadTemplates()]).then(() => {
                    loadNewProjectDraft();
                    document.getElementById('newProjectModal').style.display = 'block';
                    startNewProjectModalGuard();
                });
            }
            loadUserInfo();
        });


        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¨­å®š
        function setDefaultUserInfo() {
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            if (userName) userName.textContent = 'ã‚²ã‚¹ãƒˆ';
            if (userRole) userRole.textContent = 'ã‚²ã‚¹ãƒˆ';
            updateRoleBasedVisibility('guest');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿
        async function loadUserInfo() {
            try {
                
                // ã¾ãšå°‚ç”¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã™
                const response = await fetch('api.php?path=user/profile&t=' + Date.now(), { cache: 'no-store' });
                const data = await response.json();
                
                
                if (data.success && data.name) {
                    const userName = document.getElementById('userName');
                    const userRole = document.getElementById('userRole');
                    
                    if (userName) userName.textContent = data.name;
                    if (userRole) userRole.textContent = getRoleText(data.role || 'guest');
                    
                    // è¨­å®šãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
                    const settingsBtn = document.getElementById('settingsBtn');
                    if (settingsBtn) settingsBtn.style.display = (data.role === 'manager' || data.role === 'technical') ? 'inline-block' : 'none';
                    updateRoleBasedVisibility(data.role);
                } else {
                    // æœªèªè¨¼ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = 'login.html?message=' + encodeURIComponent('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = 'login.html?message=' + encodeURIComponent('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                return;
            }
        }

        // ä»£æ›¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±èª­ã¿è¾¼ã¿ï¼ˆå‰Šé™¤ - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰

        // å½¹è·åå¤‰æ›
        function getRoleText(role) {
            switch(role) {
                case 'manager': return 'ç®¡ç†è€…';
                case 'technical': return 'æŠ€è¡“è€…';
                case 'general': return 'ä¸€èˆ¬';
                default: return 'ã‚²ã‚¹ãƒˆ';
            }
        }

        // å½¹å‰²ã«å¿œã˜ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œãƒœã‚¿ãƒ³ã‚’åˆ¶å¾¡
        function updateRoleBasedVisibility(role) {
            const isGeneralOrGuest = !role || role === 'general' || role === 'guest';
            const createBtn = document.getElementById('newProjectBtn');
            const editBtn = document.getElementById('editProjectBtn');
            const deleteBtn = document.getElementById('deleteProjectBtn');
            if (createBtn) createBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
            if (editBtn) editBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
            if (deleteBtn) deleteBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadProjects() {
            try {
                
                // ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—
                const sortBy = document.getElementById('sortBy')?.value || 'created_at';
                const sortOrder = document.getElementById('sortOrder')?.value || 'DESC';
                const statusFilter = document.getElementById('statusFilter')?.value || '';
                
                const params = new URLSearchParams({
                    sort_by: sortBy,
                    sort_order: sortOrder,
                    t: Date.now()
                });
                
                if (statusFilter) {
                    params.append('status_filter', statusFilter);
                }
                
                const apiUrl = `api.php?path=projects&${params.toString()}`;
                
                const response = await fetch(apiUrl, { cache: 'no-store' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error('APIã‹ã‚‰ã®å¿œç­”ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                }
                
                
                if (data.success && data.projects) {
                    populateProjectList(data.projects);
                    updateProjectStats(data.projects);
                } else {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
            } catch (error) {
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
        function populateProjectList(projects) {
            const container = document.getElementById('projectList');
            if (!container) {
                return;
            }
            
            if (projects.length === 0) {
                container.innerHTML = '<div class="empty">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = projects.map(project => `
                <div class="project-item" data-project-id="${project.id}">
                    <div class="project-item-name">${project.name}</div>
                    <div class="project-item-meta">
                        <span>${project.total_tasks || 0}ã‚¿ã‚¹ã‚¯</span>
                        <span class="project-item-status ${project.status}">${getStatusText(project.status)}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé …ç›®ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            container.querySelectorAll('.project-item').forEach(item => {
                item.addEventListener('click', function() {
                    const projectId = this.getAttribute('data-project-id');
                    selectProject(parseInt(projectId));
                });
            });
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒ
            const savedProjectId = localStorage.getItem('selectedProjectId');
            if (savedProjectId) {
                // ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const projectExists = projects.some(project => project.id == savedProjectId);
                if (projectExists) {
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿
                    selectProject(savedProjectId);
                } else {
                    // å­˜åœ¨ã—ãªã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                    localStorage.removeItem('selectedProjectId');
                }
            }
            
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
        function selectProject(projectId) {
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedItem = document.querySelector(`[data-project-id="${projectId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            const noProjectSelected = document.getElementById('noProjectSelected');
            const projectInfo = document.getElementById('projectInfo');
            const taskSection = document.getElementById('taskSection');
            
            if (noProjectSelected) noProjectSelected.style.display = 'none';
            if (projectInfo) projectInfo.style.display = 'block';
            if (taskSection) taskSection.style.display = 'block';
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿
            loadProject(projectId);
            
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
            updateDashboardForCurrentProject();
            
            // é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('selectedProjectId', projectId);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿
        async function loadProject(projectId) {
            try {
                showLoading();
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°ã€ã‚¿ã‚¹ã‚¯ã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’ä¸¦è¡Œå–å¾—
                const [projectResponse, tasksResponse, phasesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${projectId}&t=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`api.php?path=projects/${projectId}/tasks&t=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`api.php?path=phases&t=${Date.now()}`, { cache: 'no-store' })
                ]);

                const [projectData, tasksData, phasesData] = await Promise.all([
                    projectResponse.json(),
                    tasksResponse.json(),
                    phasesResponse.json()
                ]);


                if (projectData.success && projectData.project) {
                    currentProject = projectData.project;
                    displayProject(currentProject);
                    
                    if (phasesData.success && phasesData.phases) {
                        allPhases = phasesData.phases;
                        setupPhaseFilters(allPhases);
                    }
                    
                    if (tasksData.success && tasksData.tasks) {
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', tasksData.tasks.length, 'ä»¶');
                        allTasks = tasksData.tasks;
                        filteredTasks = [...allTasks]; // ç›´æ¥ã‚³ãƒ”ãƒ¼
                        displayTasks(filteredTasks);
                        updateProgress();
                    } else {
                        console.log('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', tasksData);
                        allTasks = [];
                        filteredTasks = [];
                        displayTasks([]);
                        updateProgress();
                    }
                    
                    showProjectInfo();
                } else {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            } finally {
                hideLoading();
            }
        }


        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
        function displayProject(project) {
            const projectName = document.getElementById('projectName');
            const projectPeriod = document.getElementById('projectPeriod');
            const projectStatus = document.getElementById('projectStatus');
            
            if (projectName) projectName.textContent = project.name || 'ä¸æ˜ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';
            if (projectPeriod) {
                const end = project.end_date || project.target_end_date || '';
                projectPeriod.textContent = `æœŸé–“: ${formatDate(project.start_date)} - ${formatDate(end)}`;
            }
            if (projectStatus) projectStatus.textContent = getStatusText(project.status);
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
            showProjectInfo();
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º/éè¡¨ç¤º
        function showProjectInfo() {
            const projectInfo = document.getElementById('projectInfo');
            const taskSection = document.getElementById('taskSection');
            
            if (projectInfo) projectInfo.style.display = 'block';
            if (taskSection) taskSection.style.display = 'block';
        }

        function hideProjectInfo() {
            const projectInfo = document.getElementById('projectInfo');
            const taskSection = document.getElementById('taskSection');
            
            if (projectInfo) projectInfo.style.display = 'none';
            if (taskSection) taskSection.style.display = 'none';
            currentProject = null;
            allTasks = [];
            filteredTasks = [];
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šï¼ˆç¾åœ¨ã®é¸æŠã‚’ç¶­æŒï¼‰
        function setupPhaseFilters(phases) {
            console.log('setupPhaseFilterså‘¼ã³å‡ºã—:', phases);
            const filtersContainer = document.getElementById('taskFilters');
            if (!filtersContainer) {
                console.log('taskFiltersè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            filtersContainer.innerHTML = '';

            if (phases.length > 0) {
                console.log('ãƒ•ã‚§ãƒ¼ã‚ºæ•°:', phases.length);
                // ç›´è¿‘ã®é¸æŠã‚’å„ªå…ˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãŒã‚ã‚Œã°ãã‚Œã‚‚è€ƒæ…®ï¼‰
                const savedPhaseId = localStorage.getItem('currentPhaseFilter');
                let desiredPhaseId = currentPhaseFilter || savedPhaseId || 'all';
                const exists = phases.some(p => String(p.id) === String(desiredPhaseId));
                if (!exists && desiredPhaseId !== 'all') {
                    desiredPhaseId = 'all';
                }
                currentPhaseFilter = desiredPhaseId;

                // ã€Œã™ã¹ã¦ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const allBtn = document.createElement('button');
                allBtn.className = currentPhaseFilter === 'all' ? 'filter-btn active' : 'filter-btn';
                allBtn.textContent = 'ã™ã¹ã¦';
                allBtn.onclick = () => filterByPhase('all');
                filtersContainer.appendChild(allBtn);

                // å„ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                phases.forEach((phase) => {
                    const btn = document.createElement('button');
                    btn.className = String(phase.id) === String(currentPhaseFilter) ? 'filter-btn active' : 'filter-btn';
                    btn.textContent = phase.name;
                    btn.onclick = () => filterByPhase(phase.id);
                    filtersContainer.appendChild(btn);
                });
            }
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterByPhase(phaseId) {
            currentPhaseFilter = phaseId;
            try { localStorage.setItem('currentPhaseFilter', String(phaseId)); } catch (e) {}
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // ç¾åœ¨ã®ãƒœã‚¿ãƒ³ã«activeã‚’ä»˜ä¸
            const buttons = Array.from(document.querySelectorAll('.filter-btn'));
            const idx = buttons.findIndex(b => b.textContent === (allPhases.find(p => String(p.id) === String(phaseId))?.name));
            if (idx >= 0) {
                buttons[idx].classList.add('active');
            }

            displayTasks(filteredTasks);
        }

        // ã‚¿ã‚¹ã‚¯è¡¨ç¤º
        function displayTasks(tasks) {
            console.log('displayTaskså‘¼ã³å‡ºã—:', tasks ? tasks.length : 'null', 'ä»¶');
            const taskList = document.getElementById('taskList');
            
            if (!taskList) {
                console.log('taskListè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!tasks || tasks.length === 0) {
                console.log('ã‚¿ã‚¹ã‚¯ãŒç©ºã®ãŸã‚ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º');
                taskList.innerHTML = '<div class="empty">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredByPhase = tasks;
            console.log('ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:', currentPhaseFilter);
            if (currentPhaseFilter !== 'all') {
                filteredByPhase = tasks.filter(task => {
                    const phase = allPhases.find(p => p.name === task.phase_name);
                    return phase && phase.id == currentPhaseFilter;
                });
                console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œ:', filteredByPhase.length, 'ä»¶');
            } else {
                console.log('ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º');
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const tasksByPhase = {};
            filteredByPhase.forEach(task => {
                const phaseName = task.phase_name || 'æœªåˆ†é¡';
                if (!tasksByPhase[phaseName]) {
                    tasksByPhase[phaseName] = [];
                }
                tasksByPhase[phaseName].push(task);
            });

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«è¡¨ç¤º
            taskList.innerHTML = '';
            Object.entries(tasksByPhase).forEach(([phaseName, phaseTasks]) => {
                // ç©ºã®ãƒ•ã‚§ãƒ¼ã‚ºã¯è¡¨ç¤ºã—ãªã„
                if (phaseTasks.length === 0) {
                    return;
                }
                
                const phaseContainer = document.createElement('div');
                phaseContainer.className = 'phase-container';
                
                const phaseTitle = document.createElement('h3');
                phaseTitle.textContent = `${phaseName} (${phaseTasks.length})`;
                phaseContainer.appendChild(phaseTitle);
                
                const taskGrid = document.createElement('div');
                taskGrid.className = 'task-list';
                
                // ã‚¿ã‚¹ã‚¯ã‚’é †åºã§ã‚½ãƒ¼ãƒˆ
                phaseTasks.sort((a, b) => (a.task_order || 0) - (b.task_order || 0));
                
                phaseTasks.forEach(task => {
                    const taskItem = createTaskItem(task);
                    taskGrid.appendChild(taskItem);
                });
                
                phaseContainer.appendChild(taskGrid);
                taskList.appendChild(phaseContainer);
            });

        }

        // ã‚¿ã‚¹ã‚¯ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
        function createTaskItem(task) {
            const item = document.createElement('div');
            item.className = `task-item status-${task.status || 'not_started'}`;
            item.setAttribute('data-task-id', task.id);
            item.onclick = () => editTask(task.id);
            
            const isOverdue = task.planned_date && new Date(task.planned_date) < new Date() && task.status !== 'completed';
            const isNeedsConfirmation = task.status === 'needs_confirmation';
            
            // è¦ç¢ºèªã®å ´åˆã®ç¢ºèªå¯¾è±¡è€…ã‚’å–å¾—
            const confirmationTarget = isNeedsConfirmation ? getConfirmationTarget(task) : '';
            
            // è¦ç¢ºèªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã€ç›´æ¥ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            if (isNeedsConfirmation) {
                item.style.background = 'linear-gradient(135deg, #fff5f5, #ffe6e6)';
                item.style.border = '3px solid #ff0000';
                item.style.borderLeft = '6px solid #ff0000';
                item.style.boxShadow = '0 4px 15px rgba(255, 0, 0, 0.4)';
                item.style.transform = 'scale(1.02)';
                item.style.position = 'relative';
                item.style.zIndex = '10';
            }

            // ãã®ã»ã‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚«ãƒ¼ãƒ‰è‰²ã‚’æ˜ç¤ºï¼ˆCSSæœªé©ç”¨ç’°å¢ƒå¯¾ç­–ï¼‰
            if (!isNeedsConfirmation) {
                switch (task.status) {
                    case 'not_started':
                        item.style.background = '#f8f9fa';
                        item.style.borderLeft = '4px solid #6c757d';
                        break;
                    case 'in_progress':
                        item.style.background = '#fff8e1';
                        item.style.borderLeft = '4px solid #ffc107';
                        break;
                    case 'completed':
                        item.style.background = '#eaf7ee';
                        item.style.borderLeft = '4px solid #28a745';
                        break;
                    case 'not_applicable':
                        item.style.background = '#f1f3f5';
                        item.style.borderLeft = '4px solid #adb5bd';
                        item.style.opacity = '0.95';
                        break;
                    case 'pending':
                        item.style.background = '#fff3e0';
                        item.style.borderLeft = '4px solid #ff9800';
                        item.style.border = '2px solid #ff9800';
                        item.style.boxShadow = '0 4px 15px rgba(255, 152, 0, 0.3)';
                        break;
                }
            }
            
            item.innerHTML = `
                ${isNeedsConfirmation ? '<div style="position: absolute; top: -12px; right: 8px; background: #ff0000; color: white; padding: 6px 16px; border-radius: 16px; font-size: 0.8rem; font-weight: 700; box-shadow: 0 4px 8px rgba(255, 0, 0, 0.5); z-index: 1000; border: 2px solid white;">âš ï¸ è¦ç¢ºèª</div>' : ''}
                <div class="task-header">
                    <h4 class="task-title">${task.task_name || task.name}</h4>
                    <div class="task-status-group">
                        <span class="task-status status-${task.status || 'not_started'}">${getStatusText(task.status || 'not_started')}</span>
                        ${isOverdue ? '<span class="task-overdue">é…å»¶</span>' : ''}
                    </div>
                </div>
                ${isNeedsConfirmation ? `
                <div style="background: rgba(255, 0, 0, 0.15); border: 2px solid #ff0000; border-radius: 12px; padding: 12px 16px; margin: 12px 0; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(255, 0, 0, 0.2);">
                    <span style="font-size: 1rem; color: #ff0000; font-weight: 700;">ç¢ºèªå¯¾è±¡:</span>
                    <span style="font-size: 1.1rem; color: #cc0000; font-weight: 800; background: rgba(255, 0, 0, 0.3); padding: 4px 12px; border-radius: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${confirmationTarget}</span>
                </div>
                ` : ''}
                <div class="task-meta">
                    <div class="task-meta-row">
                        <div class="task-assignee">
                            <span class="icon-user"></span>
                            ${task.assigned_to_name || 'æœªå‰²å½“'}
                        </div>
                        <div class="task-date ${isOverdue ? 'overdue' : ''}">
                            <span class="icon-calendar"></span>
                            ${task.planned_date ? formatDate(task.planned_date) : 'æœŸé™ãªã—'}
                        </div>
                    </div>
                    <div class="task-flags">
                        ${task.is_technical_work == '1' ? '<span class="flag technical">æŠ€è¡“ä½œæ¥­</span>' : ''}
                        ${task.has_manual == '1' ? '<span class="flag manual">ğŸ“š ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š</span>' : ''}
                    </div>
                </div>
            `;
            
            return item;
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†
        async function editTask(taskId) {
            try {
                console.log('editTaskå‘¼ã³å‡ºã—:', taskId);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å…ˆã«èª­ã¿è¾¼ã‚€
                await loadUsers();
                
                // ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢ï¼ˆfilteredTasksã¨allTasksã®ä¸¡æ–¹ã‚’ç¢ºèªï¼‰
                let task = filteredTasks.find(t => t.id == taskId);
                if (!task) {
                    task = allTasks.find(t => t.id == taskId);
                }
                
                if (!task) {
                    console.log('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', taskId);
                    showMessage('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                console.log('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', task);


                // ã‚¿ã‚¹ã‚¯è©³ç´°ã‚’å–å¾—
                console.log('ã‚¿ã‚¹ã‚¯è©³ç´°ã‚’å–å¾—ä¸­:', taskId);
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ã‚¿ã‚¹ã‚¯è©³ç´°å–å¾—çµæœ:', data);
                
                if (data.success && data.task) {
                    const taskData = data.task;
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    
                    document.getElementById('taskId').value = taskData.id;
                    
                    document.getElementById('taskTitle').textContent = taskData.task_name || taskData.name;
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
                    const statusValue = taskData.status || 'not_started';
                    document.getElementById('taskStatus').value = statusValue;
                    
                    // æœŸé™ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨­å®š
                    const plannedDate = taskData.planned_date || '';
                    document.getElementById('taskDueDate').value = plannedDate;
                    
                    document.getElementById('taskContentDisplay').textContent = taskData.template_content || 'å†…å®¹ãªã—';
                    
                    // ãƒ¡ã‚¿æƒ…å ±è¡¨ç¤º
                    document.getElementById('taskPhase').textContent = task.phase_name || 'æœªåˆ†é¡';
                    document.getElementById('taskOrder').textContent = task.task_order || '0';
                    document.getElementById('taskTechnical').textContent = task.is_technical_work == '1' ? 'ã¯ã„' : 'ã„ã„ãˆ';
                    document.getElementById('taskManualInfo').textContent = task.has_manual == '1' ? 'ã‚ã‚Š' : 'ãªã—';
                    await loadTaskManuals(taskData.task_name || taskData.name);
                    
                    // æ‹…å½“è€…è¨­å®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿å¾Œã«è¨­å®šï¼‰
                    if (taskData.assigned_to) {
                        document.getElementById('taskAssignee').value = taskData.assigned_to;
                    } else {
                        document.getElementById('taskAssignee').value = '';
                    }
                    
                    // ãƒ¡ãƒ¢å±¥æ­´èª­ã¿è¾¼ã¿
                    await loadTaskNotes(taskId);
                    
                    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                    setupNoteInputEvents();
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                    document.getElementById('taskModal').style.display = 'block';
                } else {
                    console.error('ã‚¿ã‚¹ã‚¯è©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', data);
                    showMessage('ã‚¿ã‚¹ã‚¯è©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ç·¨é›†ä¸­ã®ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¿ã‚¹ã‚¯ç·¨é›†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadUsers() {
            try {
                const taskAssigneeSelect = document.getElementById('taskAssignee');
                const currentValue = taskAssigneeSelect.value; // ç¾åœ¨ã®å€¤ã‚’ä¿å­˜
                
                
                const response = await fetch('api.php?path=users');
                const data = await response.json();
                
                
                if (data.success && data.users) {
                    allUsers = data.users;
                    
                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†æ§‹ç¯‰
                    taskAssigneeSelect.innerHTML = '<option value="">æœªå‰²å½“</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        taskAssigneeSelect.appendChild(option);
                    });
                    
                    // ä¿å­˜ã—ã¦ã„ãŸå€¤ã‚’å¾©å…ƒ
                    if (currentValue) {
                        taskAssigneeSelect.value = currentValue;
                    }
                    
            } else {
                }
            } catch (error) {
            }
        }

        // ã‚¿ã‚¹ã‚¯ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿
        async function loadTaskNotes(taskId) {
            try {
                const response = await fetch(`api.php?path=tasks/${taskId}/notes&t=${Date.now()}`, { cache: 'no-store' });
                const data = await response.json();
                
                
                const notesHistory = document.getElementById('notesHistory');
                
                if (data.success && data.notes && data.notes.length > 0) {
                    notesHistory.innerHTML = '';
                    data.notes.forEach((note, index) => {
                        const noteItem = document.createElement('div');
                        noteItem.className = 'note-item';
                        noteItem.setAttribute('data-note-id', note.id);
                        noteItem.innerHTML = `
                            <div class="note-header">
                                <div class="note-info">
                                    <span class="note-user">${note.user_name || 'ä¸æ˜'}</span>
                                    <span class="note-date">${formatDateTime(note.created_at)}</span>
                                </div>
                                <div class="note-actions">
                                    <button type="button" class="btn-edit-note" onclick="editNote(${note.id})" title="ç·¨é›†">âœï¸</button>
                                    <button type="button" class="btn-delete-note" onclick="deleteNote(${note.id})" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="note-content" id="note-content-${note.id}">${formatNoteContent(note.note)}</div>
                            <div class="note-edit-form" id="note-edit-${note.id}" style="display: none;">
                                <textarea class="note-edit-textarea" id="note-edit-text-${note.id}">${note.note}</textarea>
                                <div class="note-edit-actions">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="saveNoteEdit(${note.id})">ä¿å­˜</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="cancelNoteEdit(${note.id})">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                </div>
                            </div>
                        `;
                        notesHistory.appendChild(noteItem);
                    });
            } else {
                    notesHistory.innerHTML = '<div class="note-item">ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                document.getElementById('notesHistory').innerHTML = '<div class="note-item">ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ã‚¿ã‚¹ã‚¯åã«ç´ã¥ããƒãƒ‹ãƒ¥ã‚¢ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ã€è¡¨ç¤º/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
        async function loadTaskManuals(taskName) {
            try {
                const linksWrap = document.getElementById('taskManualLinks');
                const list = document.getElementById('taskManualList');
                if (!linksWrap || !list) return;

                // ã‚¿ã‚¹ã‚¯åã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦å–å¾—ï¼ˆDBã‹ã‚‰ç¢ºå®Ÿã«è©²å½“ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
                const q = encodeURIComponent(taskName || '');
                const res = await fetch(`api.php?path=manuals&task_name=${q}&t=${Date.now()}`, { cache: 'no-store' });
                const data = await res.json();
                if (!data.success || !Array.isArray(data.manuals)) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                    return;
                }

                const manuals = data.manuals;
                if (manuals.length === 0) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                    return;
                }

                list.innerHTML = manuals.map(m => {
                    const id = m.id;
                    const name = m.original_name || m.file_name;
                    const sizeKb = m.file_size ? Math.round(m.file_size / 1024) + 'KB' : '';
                    const viewUrl = `api.php?path=admin/manuals/${id}`;
                    const dlUrl = `api.php?path=admin/manuals/${id}&download=1`;
                    return `
                        <div class="manual-link" style="margin:4px 0;">
                            <a href="${viewUrl}" target="_blank" rel="noopener">ğŸ“„ è¡¨ç¤º</a>
                            <span style="margin: 0 6px; color:#adb5bd;">|</span>
                            <a href="${dlUrl}">â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                            <span style="margin-left:8px; color:#6c757d;">${name}${sizeKb ? ' ('+sizeKb+')' : ''}</span>
                        </div>`;
                }).join('');
                linksWrap.style.display = 'block';
            } catch (e) {
                const linksWrap = document.getElementById('taskManualLinks');
                const list = document.getElementById('taskManualList');
                if (linksWrap && list) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                }
            }
        }

        // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®å¤‰æ•°
        let mentionStartPos = -1;
        let currentMentionQuery = '';
        let selectedSuggestionIndex = -1;

        // ãƒ¡ãƒ¢å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupNoteInputEvents() {
            const noteInput = document.getElementById('newNote');
            if (noteInput) {
                noteInput.addEventListener('input', handleNoteInput);
                noteInput.addEventListener('keydown', handleNoteKeydown);
                
                // blurã‚¤ãƒ™ãƒ³ãƒˆã‚’é…å»¶å®Ÿè¡Œã—ã¦ã€å€™è£œãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ã™ã‚‹
                noteInput.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        hideUserSuggestions();
                    }, 150);
                });
            }
        }

        // ãƒ¡ãƒ¢å…¥åŠ›ã®å‡¦ç†
        function handleNoteInput(event) {
            const textarea = event.target;
            const cursorPos = textarea.selectionStart;
            const text = textarea.value;
            
            // @ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ã‚’æ¤œç´¢ï¼ˆæ—¥æœ¬èªæ–‡å­—ã‚‚å«ã‚€ï¼‰
            const mentionMatch = text.substring(0, cursorPos).match(/@([^\s]*)$/);
            
            if (mentionMatch) {
                mentionStartPos = cursorPos - mentionMatch[0].length;
                currentMentionQuery = mentionMatch[1];
                showUserSuggestions(currentMentionQuery, mentionStartPos);
            } else {
                hideUserSuggestions();
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
        function handleNoteKeydown(event) {
            const suggestions = document.getElementById('userSuggestions');
            if (suggestions.style.display === 'none') return;

            const suggestionItems = suggestions.querySelectorAll('.suggestion-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                    updateSuggestionSelection();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSuggestionSelection();
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedSuggestionIndex >= 0) {
                        selectUserSuggestion(suggestionItems[selectedSuggestionIndex]);
                    }
                    break;
                case 'Escape':
                    hideUserSuggestions();
                    break;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œã®è¡¨ç¤º
        function showUserSuggestions(query, position) {
            const suggestions = document.getElementById('userSuggestions');
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase())
            );


            if (filteredUsers.length === 0) {
                hideUserSuggestions();
                return;
            }

            suggestions.innerHTML = '';
            filteredUsers.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.setAttribute('data-user-name', user.name);
                item.innerHTML = `
                    <span class="user-name">${user.name}</span>
                    <span class="user-role">${getRoleText(user.role)}</span>
                `;
                
                // ã‚ˆã‚Šç¢ºå®Ÿãªã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®å®Ÿè£…
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectUserSuggestion(item);
                });
                
                // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¿½åŠ ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
                item.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectUserSuggestion(item);
                });
                
                suggestions.appendChild(item);
            });
            
            // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã‚‚è¿½åŠ 
            suggestions.addEventListener('click', (e) => {
                const item = e.target.closest('.suggestion-item');
                if (item) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectUserSuggestion(item);
                }
            });

            selectedSuggestionIndex = 0;
            updateSuggestionSelection();
            suggestions.style.display = 'block';
        }

        // å€™è£œé¸æŠã®æ›´æ–°
        function updateSuggestionSelection() {
            const suggestions = document.getElementById('userSuggestions');
            const items = suggestions.querySelectorAll('.suggestion-item');
            
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedSuggestionIndex);
            });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œã®é¸æŠ
        function selectUserSuggestion(selectedItem) {
            const textarea = document.getElementById('newNote');
            const userName = selectedItem.getAttribute('data-user-name') || selectedItem.querySelector('.user-name').textContent;
            const currentPos = textarea.selectionStart;
            const beforeMention = textarea.value.substring(0, mentionStartPos);
            const afterMention = textarea.value.substring(currentPos);
            
            
            // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’ç½®ãæ›ãˆ
            const newValue = beforeMention + '@' + userName + ' ' + afterMention;
            textarea.value = newValue;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´ï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã®å¾Œã«é…ç½®ï¼‰
            const newCursorPos = beforeMention.length + userName.length + 2;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            
            
            // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã€è¦ç¢ºèªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«è‡ªå‹•å¤‰æ›´
            const statusSelect = document.getElementById('taskStatus');
            if (statusSelect && statusSelect.value !== 'needs_confirmation') {
                statusSelect.value = 'needs_confirmation';
                
                // è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                statusSelect.style.backgroundColor = '#fff5f5';
                statusSelect.style.borderColor = '#ff6b6b';
                setTimeout(() => {
                    statusSelect.style.backgroundColor = '';
                    statusSelect.style.borderColor = '';
                }, 2000);
            } else {
            }
            
            hideUserSuggestions();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å€™è£œã®éè¡¨ç¤º
        function hideUserSuggestions() {
            const suggestions = document.getElementById('userSuggestions');
            suggestions.style.display = 'none';
            selectedSuggestionIndex = -1;
        }

        // ãƒ¡ãƒ¢å†…å®¹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
        function formatNoteContent(content) {
            if (!content) return '';
            
            // @ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            return content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        // ãƒ¡ãƒ¢ç·¨é›†é–‹å§‹
        function editNote(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            document.getElementById(`note-edit-${noteId}`).style.display = 'block';
            document.getElementById(`note-content-${noteId}`).style.display = 'none';
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            const textarea = document.getElementById(`note-edit-text-${noteId}`);
            textarea.focus();
            textarea.select();
        }

        // ãƒ¡ãƒ¢ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelNoteEdit(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
            document.getElementById(`note-edit-${noteId}`).style.display = 'none';
            document.getElementById(`note-content-${noteId}`).style.display = 'block';
        }

        // ãƒ¡ãƒ¢ç·¨é›†ä¿å­˜
        async function saveNoteEdit(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const content = document.getElementById(`note-edit-text-${noteId}`).value.trim();
            
            
            if (!content) {
                showMessage('ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                const requestData = {
                    note: content
                };
                
                const response = await fetch(`api.php?path=notes/${noteId}&t=${Date.now()}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // å³åº§ã«ãƒ¡ãƒ¢å†…å®¹ã‚’æ›´æ–°
                    document.getElementById(`note-content-${noteId}`).innerHTML = formatNoteContent(content);
                    
                    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
                    document.getElementById(`note-edit-${noteId}`).style.display = 'none';
                    document.getElementById(`note-content-${noteId}`).style.display = 'block';
                    
                    showMessage('ãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage('ãƒ¡ãƒ¢ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                showMessage('ãƒ¡ãƒ¢ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¡ãƒ¢å‰Šé™¤
        async function deleteNote(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                
                const response = await fetch(`api.php?path=notes/${noteId}&t=${Date.now()}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // å³åº§ã«ãƒ¡ãƒ¢è¦ç´ ã‚’å‰Šé™¤ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
                    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
                    if (noteElement) {
                        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                        noteElement.style.transition = 'all 0.3s ease';
                        noteElement.style.opacity = '0';
                        noteElement.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            noteElement.remove();
                        }, 300);
                    }
                    
                    showMessage('ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage('ãƒ¡ãƒ¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                showMessage('ãƒ¡ãƒ¢ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¡ãƒ¢è¿½åŠ 
        async function addNote(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const taskId = document.getElementById('taskId').value;
            const content = document.getElementById('newNote').value.trim();
            
            
            if (!content) {
                showMessage('ãƒ¡ãƒ¢å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!taskId) {
                showMessage('ã‚¿ã‚¹ã‚¯IDãŒå–å¾—ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const requestData = {
                    note: content
                };
                
                const response = await fetch(`api.php?path=tasks/${taskId}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    
                    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('newNote').value = '';
                    
                    // å³åº§ã«UIã«æ–°ã—ã„ãƒ¡ãƒ¢ã‚’è¿½åŠ 
                    addMemoToUI(content, data.note_id || Date.now());
                    
                    showMessage('ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage('ãƒ¡ãƒ¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                showMessage('ãƒ¡ãƒ¢ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ä¿å­˜ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
        async function saveTask(retryCount = 0) {
            const maxRetries = 3;
            
            // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
            if (window.isSavingTask) {
                return;
            }
            
            window.isSavingTask = true;
            
            try {
                const taskId = document.getElementById('taskId').value;
                
                if (!taskId) {
                    showMessage('ã‚¿ã‚¹ã‚¯IDãŒå–å¾—ã§ãã¾ã›ã‚“', 'error');
                    return;
                }
                
                // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å€‹åˆ¥ã«å–å¾—ãƒ»ç¢ºèª
                const statusValue = document.getElementById('taskStatus').value;
                const assigneeValue = document.getElementById('taskAssignee').value;
                const dateValue = document.getElementById('taskDueDate').value;
                
                
                const formData = {
                    task_id: taskId,
                    status: statusValue,
                    assigned_to: assigneeValue || null,
                    planned_date: dateValue || null
                };


                // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                const saveButton = document.querySelector('button[onclick="saveTask()"]');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'ä¿å­˜ä¸­...';
                }

                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿ã®æ›´æ–°ã®å ´åˆã¯å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
                const isStatusOnlyUpdate = formData.status && !formData.assigned_to && !formData.planned_date;
                const endpoint = isStatusOnlyUpdate ? 'tasks/status' : 'tasks/update';
                const method = isStatusOnlyUpdate ? 'POST' : 'PUT';
                
                
                const response = await fetch(`api.php?path=${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    showMessage('ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    
                    // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ç›´æ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
                    const responseStatus = data.task?.status || statusValue;
                    
                    // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’å³åº§ã«æ›´æ–°ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†èª­ã¿è¾¼ã¿å‰ï¼‰
                    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        const finalStatus = responseStatus || statusValue || 'not_started';
                        
                        // ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®ã‚¯ãƒ©ã‚¹åã‚’æ›´æ–°
                        taskCard.className = `task-item status-${finalStatus}`;
                        
                        // ä¿ç•™ä¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã€ç›´æ¥ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                        if (finalStatus === 'pending') {
                            taskCard.style.background = '#fff3e0 !important';
                            taskCard.style.borderLeft = '4px solid #ff9800 !important';
                            taskCard.style.border = '2px solid #ff9800 !important';
                            taskCard.style.boxShadow = '0 4px 15px rgba(255, 152, 0, 0.3) !important';
                            taskCard.style.transform = 'scale(1.02) !important';
                            taskCard.style.position = 'relative !important';
                            taskCard.style.zIndex = '5 !important';
                            taskCard.setAttribute('style', taskCard.getAttribute('style') + '; background: #fff3e0 !important; border-left: 4px solid #ff9800 !important; border: 2px solid #ff9800 !important; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3) !important; transform: scale(1.02) !important; position: relative !important; z-index: 5 !important;');
                        }
                        
                        const statusElement = taskCard.querySelector('.task-status');
                        if (statusElement) {
                            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¦ç´ ã‚’å¼·åˆ¶çš„ã«æ›´æ–°
                            statusElement.className = `task-status status-${finalStatus}`;
                            statusElement.textContent = getStatusText(finalStatus);
                        }
                    }
                    
                    closeTaskModal();
                    
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    if (currentProject) {
                        await loadProject(currentProject.id);
                    }
                } else {
                    throw new Error(data.error || data.message || 'Unknown error');
                }
            } catch (error) {
                if (retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
                    return saveTask(retryCount + 1);
                } else {
                    showMessage('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            } finally {
                // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å¾©å…ƒ
                const saveButton = document.querySelector('button[onclick="saveTask()"]');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'ä¿å­˜';
                }
                
                // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                window.isSavingTask = false;
            }
        }

        // é€²æ—æ›´æ–°
        function updateProgress() {
            if (!filteredTasks || filteredTasks.length === 0) {
                const totalTasksEl = document.getElementById('totalTasks');
                const notStartedTasksEl = document.getElementById('notStartedTasks');
                const completedTasksEl = document.getElementById('completedTasks');
                const inProgressTasksEl = document.getElementById('inProgressTasks');
                const needsConfirmationTasksEl = document.getElementById('needsConfirmationTasks');
                const overdueTasksEl = document.getElementById('overdueTasks');
                const progressFillEl = document.getElementById('progressFill');
                const progressTextEl = document.getElementById('progressText');
                
                if (totalTasksEl) totalTasksEl.textContent = '0';
                if (notStartedTasksEl) notStartedTasksEl.textContent = '0';
                if (completedTasksEl) completedTasksEl.textContent = '0';
                if (inProgressTasksEl) inProgressTasksEl.textContent = '0';
                if (needsConfirmationTasksEl) needsConfirmationTasksEl.textContent = '0';
                if (overdueTasksEl) overdueTasksEl.textContent = '0';
                if (progressFillEl) progressFillEl.style.width = '0%';
                if (progressTextEl) progressTextEl.textContent = '0%';
                return;
            }

            const total = filteredTasks.length;
            const notStarted = filteredTasks.filter(task => task.status === 'not_started').length;
            const completed = filteredTasks.filter(task => task.status === 'completed').length;
            const inProgress = filteredTasks.filter(task => task.status === 'in_progress').length;
            const needsConfirmation = filteredTasks.filter(task => task.status === 'needs_confirmation').length;
            const overdue = filteredTasks.filter(task => {
                return task.planned_date && new Date(task.planned_date) < new Date() && task.status !== 'completed';
            }).length;

            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

            const totalTasksEl = document.getElementById('totalTasks');
            const notStartedTasksEl = document.getElementById('notStartedTasks');
            const completedTasksEl = document.getElementById('completedTasks');
            const inProgressTasksEl = document.getElementById('inProgressTasks');
            const overdueTasksEl = document.getElementById('overdueTasks');
            const progressFillEl = document.getElementById('progressFill');
            const progressTextEl = document.getElementById('progressText');
            
            if (totalTasksEl) totalTasksEl.textContent = total;
            if (notStartedTasksEl) notStartedTasksEl.textContent = notStarted;
            if (completedTasksEl) completedTasksEl.textContent = completed;
            if (inProgressTasksEl) inProgressTasksEl.textContent = inProgress;
            if (overdueTasksEl) overdueTasksEl.textContent = overdue;
            
            // è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã®è¡¨ç¤ºï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            const needsConfirmationElement = document.getElementById('needsConfirmationTasks');
            if (needsConfirmationElement) {
                needsConfirmationElement.textContent = needsConfirmation;
            }
            if (progressFillEl) progressFillEl.style.width = `${progressPercent}%`;
            if (progressTextEl) progressTextEl.textContent = `${progressPercent}%`;
        }

        // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        async function openNewProjectModal() {
            try {
                
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ãƒ•ã‚§ãƒ¼ã‚ºã‚’ä¸¦è¡Œèª­ã¿è¾¼ã¿
                await Promise.allSettled([
                    loadClients(),
                    loadPhases()
                ]);
                
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåŒ–ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                TemplateSelector.init({
                    containerId: 'newProjectModal',
                    mode: 'new_project',
                    onSelectionChange: function(selectedIds) {
                        selectedTemplateIds.clear();
                        selectedIds.forEach(id => selectedTemplateIds.add(id));
                        saveSelectedTemplatesToStorage();
                    }
                });
                
                
                // ç™ºæ³¨è€…ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                const clientSelect = document.getElementById('newProjectClient');
                if (clientSelect) {
                } else {
                }
                
                document.getElementById('newProjectModal').style.display = 'block';
                markNewProjectModalOpen(true);
                // é€”ä¸­ã®ä¸‹æ›¸ããŒã‚ã‚Œã°å¾©å…ƒ
                loadNewProjectDraft();
                startNewProjectModalGuard();
            } catch (error) {
                showMessage('ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
            document.getElementById('newProjectForm').reset();
            markNewProjectModalOpen(false);
            stopNewProjectModalGuard();
        }

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª­ã¿è¾¼ã¿
        async function loadClients() {
            try {
                const response = await fetch(`api.php?path=clients&t=${Date.now()}`, { cache: 'no-store' });
                
                const data = await response.json();
                
                if (data.success && data.clients) {
                    allClients = data.clients;
                    populateClientSelect();
                } else {
                }
            } catch (error) {
            }
        }

        function populateClientSelect() {
            const selects = ['newProjectClient', 'editProjectClient'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">ç™ºæ³¨è€…ã‚’é¸æŠ</option>';
                    allClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        select.appendChild(option);
                    });
                } else {
                }
            });
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºèª­ã¿è¾¼ã¿
        async function loadPhases() {
            try {
                const response = await fetch(`api.php?path=phases&t=${Date.now()}`, { cache: 'no-store' });
                const data = await response.json();
                
                if (data.success && data.phases) {
                    allPhases = data.phases;
                    setupTemplateFilters();
                    // ã‚¿ã‚¹ã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚è¨­å®š
                    setupPhaseFilters(allPhases);
                }
            } catch (error) {
                console.error('ãƒ•ã‚§ãƒ¼ã‚ºèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setupTemplateFilters() {
            const filtersContainer = document.getElementById('templateFilters');
            if (!filtersContainer) {
                return;
            }
            
            filtersContainer.innerHTML = '';

            // å…¨ä½“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯éè¡¨ç¤ºï¼ˆæœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠï¼‰
            if (allPhases.length > 0) {
                // å„ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                allPhases.forEach((phase, index) => {
                    const btn = document.createElement('button');
                    btn.className = index === 0 ? 'filter-btn active' : 'filter-btn';
                    btn.textContent = phase.name;
                    btn.dataset.phaseId = phase.id;
                    btn.addEventListener('click', function() {
                        filterTemplates(parseInt(this.dataset.phaseId));
                    });
                    filtersContainer.appendChild(btn);
                });
                
                // æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¡¨ç¤º
                if (allTemplates.length > 0) {
                    filterTemplates(allPhases[0].id);
                }
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        async function loadTemplates() {
            try {
                const response = await fetch(`api.php?path=templates&t=${Date.now()}`, { cache: 'no-store' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.templates) {
                    allTemplates = data.templates;
                    
                    // ãƒ•ã‚§ãƒ¼ã‚ºãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¡¨ç¤º
                    if (allPhases.length > 0) {
                        filterTemplates(allPhases[0].id);
                    } else {
                        displayTemplates(allTemplates);
                    }
                } else {
                    allTemplates = [];
                    displayTemplates([]);
                }
            } catch (error) {
                allTemplates = [];
                displayTemplates([]);
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterTemplates(phaseId) {
            // ãƒ•ã‚§ãƒ¼ã‚ºIDã‹ã‚‰ãƒ•ã‚§ãƒ¼ã‚ºåã‚’å–å¾—
            const phase = allPhases.find(p => p.id == phaseId);
            if (!phase) {
                console.error('Phase not found for ID:', phaseId);
                return;
            }
            
            const phaseName = phase.name;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            const filterBtns = document.querySelectorAll('#templateFilters .filter-btn');
            if (filterBtns.length > 0) {
                filterBtns.forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            const clickedBtn = document.querySelector(`#templateFilters .filter-btn[data-phase-id="${phaseId}"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºåã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filtered = allTemplates.filter(template => template.phase_name === phaseName);
            displayTemplates(filtered);
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
        function displayTemplates(templates) {
            const container = document.getElementById('templateGroups');
            
            if (!container) {
                console.error('Template container element not found');
                return;
            }
            
            container.innerHTML = '';

            if (!templates || templates.length === 0) {
                container.innerHTML = '<div class="empty">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const templatesByPhase = {};
            templates.forEach(template => {
                const phaseName = template.phase_name || 'æœªåˆ†é¡';
                
                if (!templatesByPhase[phaseName]) {
                    templatesByPhase[phaseName] = [];
                }
                templatesByPhase[phaseName].push(template);
            });

            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«è¡¨ç¤º
            Object.entries(templatesByPhase).forEach(([phaseName, phaseTemplates]) => {
                const phaseGroup = document.createElement('div');
                phaseGroup.className = 'template-group';
                
                const phaseTitle = document.createElement('h5');
                phaseTitle.className = 'phase-title';
                phaseTitle.textContent = phaseName;
                phaseGroup.appendChild(phaseTitle);
                
                const templateItems = document.createElement('div');
                templateItems.className = 'template-items';
                
                phaseTemplates.forEach(template => {
                    const isSelected = selectedTemplateIds.has(template.id.toString());
                    
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.innerHTML = `
                        <label class="template-checkbox">
                            <input type="checkbox" name="templates" value="${template.id}" ${isSelected ? 'checked' : ''}>
                            <div class="template-info">
                                <div class="template-name">${template.task_name || 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåãªã—'}</div>
                                <div class="template-content">${template.content || ''}</div>
                                <div class="template-flags">
                                    ${template.is_technical_work == '1' ? '<span class="flag technical">æŠ€è¡“ä½œæ¥­</span>' : ''}
                                    ${template.has_manual == '1' ? '<span class="flag manual">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚ã‚Š</span>' : ''}
                                </div>
                            </div>
                        </label>
                    `;
                    
                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedTemplateIds.add(template.id.toString());
                        } else {
                            selectedTemplateIds.delete(template.id.toString());
                        }
                        saveSelectedTemplatesToStorage();
                        updateSelectedCount();
                    });
                    
                    templateItems.appendChild(item);
                });
                
                phaseGroup.appendChild(templateItems);
                container.appendChild(phaseGroup);
            });

            updateSelectedCount();
        }

        // é¸æŠæ•°æ›´æ–°
        function updateSelectedCount() {
            const count = selectedTemplateIds.size;
            document.getElementById('selectedCount').textContent = count;
        }

        // ã™ã¹ã¦é¸æŠ
        function selectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn.textContent;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿é¸æŠ
            const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                const title = group.querySelector('.phase-title');
                return title && title.textContent === activePhaseText;
            });
            
            if (phaseGroup) {
                phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = true;
                    selectedTemplateIds.add(checkbox.value);
                });
            }
            
            saveSelectedTemplatesToStorage();
            updateSelectedCount();
        }

        // ã™ã¹ã¦è§£é™¤
        function deselectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn ? activePhaseBtn.textContent : null;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿è§£é™¤
            const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                const title = group.querySelector('.phase-title');
                return title && (!activePhaseText || title.textContent === activePhaseText);
            });
            
            if (phaseGroup) {
                phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = false;
                    selectedTemplateIds.delete(checkbox.value);
                });
            }
            
            saveSelectedTemplatesToStorage();
            updateSelectedCount();
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        async function createProject() {
            try {
                const form = document.getElementById('newProjectForm');
                const formData = new FormData(form);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨æ¤œè¨¼
                const name = formData.get('name')?.trim();
                const clientId = formData.get('client_id');
                const startDate = formData.get('start_date');
                const endDate = formData.get('end_date');
                
                
                // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
                if (!name) {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                if (!clientId) {
                    showMessage('ç™ºæ³¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                if (!startDate) {
                    showMessage('é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                if (!endDate) {
                    showMessage('çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                // é¸æŠã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå…¨ãƒ•ã‚§ãƒ¼ã‚ºæ¨ªæ–­ã§ä¿æŒã—ã¦ã„ã‚‹Setã‹ã‚‰å–å¾—ï¼‰
                const selectedTemplates = Array.from(selectedTemplateIds);

                if (selectedTemplates.length === 0) {
                    showMessage('å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                const projectData = {
                    name: name,
                    client_id: clientId,
                    start_date: startDate,
                    end_date: endDate,
                    templates: selectedTemplates
                };

                const response = await fetch('api.php?path=projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                    closeNewProjectModal(); // ä¿å­˜æ™‚ã®ã¿ã‚¯ãƒ­ãƒ¼ã‚º
                    await loadProjects();
                    
                    // æ–°ã—ãä½œæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
                    if (data.project_id) {
                        document.getElementById('projectSelect').value = data.project_id;
                        await loadProject(data.project_id);
                    }
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', data.error || data.message);
                    const errorMessage = data.error || data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errorMessage, 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†
        window.editProject = async function() {
            if (!currentProject) {
                showMessage('ç·¨é›†ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
                await loadClients();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                document.getElementById('editProjectId').value = currentProject.id;
                document.getElementById('editProjectName').value = currentProject.name;
                document.getElementById('editProjectClient').value = currentProject.client_id;
                document.getElementById('editProjectStartDate').value = currentProject.start_date;
                document.getElementById('editProjectEndDate').value = currentProject.end_date || currentProject.target_end_date || '';
                document.getElementById('editProjectStatus').value = currentProject.status;
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚’åˆæœŸåŒ–
                await initProjectTemplateSelection();
                
                document.getElementById('editProjectModal').style.display = 'block';
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ç·¨é›†ç”»é¢ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        };

        window.closeEditProjectModal = function() {
            document.getElementById('editProjectModal').style.display = 'none';
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°
        window.updateProject = async function() {
            try {
                const formData = {
                    id: document.getElementById('editProjectId').value,
                    name: document.getElementById('editProjectName').value,
                    client_id: document.getElementById('editProjectClient').value,
                    start_date: document.getElementById('editProjectStartDate').value,
                    end_date: document.getElementById('editProjectEndDate').value,
                    status: document.getElementById('editProjectStatus').value
                };


                const response = await fetch(`api.php?path=projects/${formData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                    closeEditProjectModal();
                    await loadProjects();
                    await loadProject(formData.id);
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', data.error || data.message);
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
        function deleteProject() {
            if (!currentProject) {
                showMessage('å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            document.getElementById('deleteProjectName').textContent = currentProject.name;
            document.getElementById('deleteProjectModal').style.display = 'block';
        }

        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').style.display = 'none';
        }

        async function confirmDeleteProject() {
            try {
                const projectId = currentProject.id;

                const response = await fetch(`api.php?path=projects/${projectId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                    closeDeleteProjectModal();
                    hideProjectInfo();
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚å‰Šé™¤
                    localStorage.removeItem('selectedProjectId');
                    await loadProjects();
                    document.getElementById('projectSelect').value = '';
                } else {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
        async function refreshProjectData() {
            if (!currentProject) {
                showMessage('æ›´æ–°ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...', 'info');
                await loadProject(currentProject.id);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('newNote').value = '';
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function formatDate(dateString) {
            if (!dateString) {
                return '';
            }
            const date = new Date(dateString);
            const formatted = date.toLocaleDateString('ja-JP');
            return formatted;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }

        function getStatusText(status) {
            switch(status) {
                case 'not_started': return 'æœªç€æ‰‹';
                case 'in_progress': return 'é€²è¡Œä¸­';
                case 'completed': return 'å®Œäº†';
                case 'needs_confirmation': return 'è¦ç¢ºèª';
                case 'not_applicable': return 'å¯¾è±¡å¤–';
                case 'pending': return 'ä¿ç•™ä¸­';

                default: return status;
            }
        }

        // ç¢ºèªå¯¾è±¡è€…ã‚’å–å¾—
        function getConfirmationTarget(task) {
            // ã‚¿ã‚¹ã‚¯ã®ãƒ¡ãƒ¢ã‹ã‚‰@ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
            if (task.notes) {
                
                // ã‚ˆã‚ŠæŸ”è»Ÿãªãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ¤œç´¢ï¼ˆæ—¥æœ¬èªã€è‹±æ•°å­—ã€è¨˜å·ã«å¯¾å¿œï¼‰
                const mentionMatches = task.notes.match(/@([^\s@]+)/g);
                if (mentionMatches && mentionMatches.length > 0) {
                    // æœ€æ–°ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                    const latestMention = mentionMatches[mentionMatches.length - 1];
                    const mentionedUser = latestMention.replace('@', '');
                    return mentionedUser;
                }
            }
            
            // ãƒ¡ãƒ¢ãŒãªã„å ´åˆã¯æ‹…å½“è€…ã‚’ç¢ºèªå¯¾è±¡ã¨ã™ã‚‹
            if (task.assigned_to_name) {
                return task.assigned_to_name;
            }
            
            // æ‹…å½“è€…ã‚‚ãªã„å ´åˆã¯ç®¡ç†è€…
            return 'ç®¡ç†è€…';
        }

        // æ–°ã—ã„ãƒ¡ãƒ¢ã‚’å³åº§ã«UIã«è¿½åŠ 
        function addMemoToUI(content, noteId) {
            const notesHistory = document.getElementById('notesHistory');
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œäº•ä¸Šç›´æ¨¹ã€ï¼‰
            const currentUserName = 'äº•ä¸Šç›´æ¨¹'; // å®Ÿéš›ã®å®Ÿè£…ã§ã¯èªè¨¼æƒ…å ±ã‹ã‚‰å–å¾—
            
            // æ–°ã—ã„ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
            const noteItem = document.createElement('div');
            noteItem.className = 'note-item new-memo';
            noteItem.setAttribute('data-note-id', noteId);
            noteItem.innerHTML = `
                <div class="note-header">
                    <div class="note-info">
                        <span class="note-user">${currentUserName}</span>
                        <span class="note-date">${formatDateTime(new Date())}</span>
                    </div>
                    <div class="note-actions">
                        <button type="button" class="btn-edit-note" onclick="editNote(${noteId})" title="ç·¨é›†">âœï¸</button>
                        <button type="button" class="btn-delete-note" onclick="deleteNote(${noteId})" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="note-content" id="note-content-${noteId}">${formatNoteContent(content)}</div>
                <div class="note-edit-form" id="note-edit-${noteId}" style="display: none;">
                    <textarea class="note-edit-textarea" id="note-edit-text-${noteId}">${content}</textarea>
                    <div class="note-edit-actions">
                        <button type="button" class="btn btn-primary btn-sm" onclick="saveNoteEdit(${noteId})">ä¿å­˜</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelNoteEdit(${noteId})">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            `;
            
            // ãƒ¡ãƒ¢ä¸€è¦§ã®å…ˆé ­ã«è¿½åŠ 
            if (notesHistory.firstChild) {
                notesHistory.insertBefore(noteItem, notesHistory.firstChild);
            } else {
                notesHistory.appendChild(noteItem);
            }
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’è¿½åŠ 
            noteItem.style.opacity = '0';
            noteItem.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                noteItem.style.transition = 'all 0.3s ease';
                noteItem.style.opacity = '1';
                noteItem.style.transform = 'translateY(0)';
            }, 10);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'block';
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            if (!container) {
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                background: ${type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#667eea'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease;
            `;

            container.appendChild(messageDiv);

            // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ•°æ›´æ–°ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('change', function(e) {
            if (e.target.name === 'templates') {
                updateSelectedCount();
            }
        });


        // ==================== ã‚¿ã‚¹ã‚¯ç®¡ç†æ©Ÿèƒ½ ====================
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ç·¨é›†ç”¨ã«èª­ã¿è¾¼ã¿
        async function loadProjectTasksForEdit() {
            if (!currentProject) return;
            
            try {
                const response = await fetch(`api.php?path=projects/${currentProject.id}/tasks`);
                const data = await response.json();
                
                if (data.success) {
                    displayProjectTasksForEdit(data.tasks);
                } else {
                    console.error('ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—:', data.message);
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ç·¨é›†ç”»é¢ã«è¡¨ç¤º
        function displayProjectTasksForEdit(tasks) {
            const tasksList = document.getElementById('projectTasksList');
            if (!tasksList) {
                return;
            }
            
            tasksList.innerHTML = '';
            
            if (!tasks || tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const tasksByPhase = {};
            tasks.forEach(task => {
                if (!tasksByPhase[task.phase_name]) {
                    tasksByPhase[task.phase_name] = [];
                }
                tasksByPhase[task.phase_name].push(task);
            });
            
            // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«è¡¨ç¤º
            Object.keys(tasksByPhase).sort().forEach(phaseName => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase-tasks-group';
                phaseDiv.innerHTML = `<h5>${phaseName}</h5>`;
                
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'phase-tasks-container';
                
                tasksByPhase[phaseName].forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'project-task-item';
                    taskItem.innerHTML = `
                        <div class="task-info">
                            <span class="task-name">${task.task_name}</span>
                            <span class="task-status status-${task.status || 'not_started'}">${getStatusText(task.status || 'not_started')}</span>
                            ${task.estimated_hours ? `<span class="task-hours">${task.estimated_hours}h</span>` : ''}
                            ${task.is_technical_work ? '<span class="task-flag technical">æŠ€è¡“</span>' : ''}
                            ${task.has_manual ? '<span class="task-flag manual">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</span>' : ''}
                        </div>
                        <div class="task-actions">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="editProjectTask(${task.id})" title="ç·¨é›†">âœï¸</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeProjectTask(${task.id})" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    tasksContainer.appendChild(taskItem);
                });
                
                phaseDiv.appendChild(tasksContainer);
                tasksList.appendChild(phaseDiv);
            });
        }

        // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
        window.addNewTaskToProject = function() {
            if (!currentProject) {
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('taskEditForm').reset();
            document.getElementById('editTaskId').value = '';
            document.getElementById('editTaskProjectId').value = currentProject.id;
            document.getElementById('taskEditModalTitle').textContent = 'ã‚¿ã‚¹ã‚¯è¿½åŠ ';
            
            document.getElementById('taskEditModal').style.display = 'block';
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†
        async function editProjectTask(taskId) {
            try {
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                const data = await response.json();
                
                if (data.success) {
                    const task = data.task;
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    document.getElementById('editTaskId').value = task.id;
                    document.getElementById('editTaskProjectId').value = task.project_id;
                    document.getElementById('editTaskName').value = task.task_name;
                    document.getElementById('editTaskPhase').value = task.phase_name;
                    document.getElementById('editTaskOrder').value = task.task_order || 0;
                    document.getElementById('editTaskEstimatedHours').value = task.estimated_hours || '';
                    document.getElementById('editTaskIsTechnical').checked = task.is_technical_work == 1;
                    document.getElementById('editTaskHasManual').checked = task.has_manual == 1;
                    
                    document.getElementById('taskEditModalTitle').textContent = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
                    document.getElementById('taskEditModal').style.display = 'block';
                } else {
                    showMessage('ã‚¿ã‚¹ã‚¯æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¿ã‚¹ã‚¯æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeTaskEditModal = function() {
            document.getElementById('taskEditModal').style.display = 'none';
        };

        // ã‚¿ã‚¹ã‚¯ã®ä¿å­˜
        window.saveTaskEdit = async function() {
            const taskId = document.getElementById('editTaskId').value;
            const projectId = document.getElementById('editTaskProjectId').value;
            const taskName = document.getElementById('editTaskName').value.trim();
            const phaseName = document.getElementById('editTaskPhase').value;
            const taskOrder = parseInt(document.getElementById('editTaskOrder').value) || 0;
            const estimatedHours = parseFloat(document.getElementById('editTaskEstimatedHours').value) || null;
            const isTechnicalWork = document.getElementById('editTaskIsTechnical').checked;
            const hasManual = document.getElementById('editTaskHasManual').checked;
            
            if (!taskName) {
                showMessage('ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                const isEdit = taskId !== '';
                const endpoint = isEdit ? 'projects/tasks/update' : 'projects/tasks/add';
                
                const requestData = {
                    task_name: taskName,
                    phase_name: phaseName,
                    task_order: taskOrder,
                    estimated_hours: estimatedHours,
                    is_technical_work: isTechnicalWork,
                    has_manual: hasManual
                };
                
                if (isEdit) {
                    requestData.task_id = taskId;
                } else {
                    requestData.project_id = projectId;
                }
                
                const response = await fetch(`api.php?path=${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeTaskEditModal();
                    await loadProjectTasksForEdit();
                } else {
                    showMessage(data.message || 'ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
        async function removeProjectTask(taskId) {
            if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('api.php?path=projects/tasks/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task_id: taskId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    await loadProjectTasksForEdit();
                } else {
                    showMessage(data.message || 'ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // ==================== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒ©ã‚¤ãƒ–ãƒ©ãƒª ====================
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒ©ã‚¤ãƒ–ãƒ©ãƒª
        const TemplateSelector = {
            // è¨­å®š
            config: {
                containerId: null,
                onSelectionChange: null,
                onAddTemplates: null,
                mode: 'new_project' // 'new_project' or 'edit_project'
            },
            
            // çŠ¶æ…‹
            state: {
                allTemplates: [],
                filteredTemplates: [],
                selectedTemplateIds: new Set(),
                activePhase: 'all'
            },
            
            // åˆæœŸåŒ–
            init: function(config) {
                this.config = { ...this.config, ...config };
                this.state.selectedTemplateIds.clear();
                this.state.activePhase = 'all';
                this.loadTemplates();
            },
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
            loadTemplates: async function() {
                try {
                    const response = await fetch('api.php?path=templates');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.success && data.templates) {
                        this.state.allTemplates = data.templates;
                        this.render();
                    } else {
                        console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.error || data.message);
                    }
                } catch (error) {
                    console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            },
            
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            render: function() {
                if (!this.config.containerId) return;
                
                const container = document.getElementById(this.config.containerId);
                if (!container) return;
                
                // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                this.renderPhaseFilters(container);
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’ç”Ÿæˆ
                this.renderTemplateList(container);
                
                // ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
                this.renderSummary(container);
                
                // é¸æŠæ¸ˆã¿ä»¶æ•°ã‚’æ›´æ–°
                this.updateSelectedCount();
            },
            
            // ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            renderPhaseFilters: function(container) {
                const filtersContainer = container.querySelector('.template-filters') || 
                                       container.querySelector('#templateFilters');
                if (!filtersContainer) return;
                
                // ãƒ•ã‚§ãƒ¼ã‚ºã‚’å–å¾—
                const phases = [...new Set(this.state.allTemplates.map(t => t.phase_name))].sort();
                
                filtersContainer.innerHTML = '';
                phases.forEach(phase => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'phase-filter-btn';
                    button.textContent = phase;
                    button.onclick = () => this.setActivePhase(phase);
                    filtersContainer.appendChild(button);
                });
                
                // ã™ã¹ã¦ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const allButton = document.createElement('button');
                allButton.type = 'button';
                allButton.className = 'phase-filter-btn active';
                allButton.textContent = 'ã™ã¹ã¦';
                allButton.onclick = () => this.setActivePhase('all');
                filtersContainer.insertBefore(allButton, filtersContainer.firstChild);
            },
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’ç”Ÿæˆ
            renderTemplateList: function(container) {
                const listContainer = container.querySelector('.template-groups') || 
                                    container.querySelector('#templateGroups') ||
                                    container.querySelector('#templateList');
                if (!listContainer) return;
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                this.filterTemplates();
                
                // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const groupedTemplates = {};
                this.state.filteredTemplates.forEach(template => {
                    if (!groupedTemplates[template.phase_name]) {
                        groupedTemplates[template.phase_name] = [];
                    }
                    groupedTemplates[template.phase_name].push(template);
                });
                
                listContainer.innerHTML = '';
                Object.keys(groupedTemplates).sort().forEach(phase => {
                    const phaseGroup = document.createElement('div');
                    phaseGroup.className = 'template-phase-group';
                    phaseGroup.innerHTML = `<h6>${phase}</h6>`;
                    
                    const templatesContainer = document.createElement('div');
                    templatesContainer.className = 'template-items';
                    
                    groupedTemplates[phase].forEach(template => {
                        const templateItem = this.createTemplateItem(template);
                        templatesContainer.appendChild(templateItem);
                    });
                    
                    phaseGroup.appendChild(templatesContainer);
                    listContainer.appendChild(phaseGroup);
                });
                
                // é¸æŠæ¸ˆã¿ä»¶æ•°ã‚’æ›´æ–°
                this.updateSelectedCount();
            },
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
            createTemplateItem: function(template) {
                const item = document.createElement('div');
                item.className = 'template-item';
                
                const isSelected = this.state.selectedTemplateIds.has(template.id.toString());
                
                item.innerHTML = `
                    <label class="template-checkbox-label">
                        <input type="checkbox" name="templates" value="${template.id}" 
                               ${isSelected ? 'checked' : ''}>
                        <div class="template-info">
                            <div class="template-name">${template.task_name}</div>
                            <div class="template-meta">
                                ${template.is_technical_work ? '<span class="template-flag technical">æŠ€è¡“</span>' : ''}
                                ${template.has_manual ? '<span class="template-flag manual">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</span>' : ''}
                                ${template.estimated_hours ? `<span class="template-hours">${template.estimated_hours}h</span>` : ''}
                            </div>
                        </div>
                    </label>
                `;
                
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.state.selectedTemplateIds.add(template.id.toString());
                    } else {
                        this.state.selectedTemplateIds.delete(template.id.toString());
                    }
                    
                    // è¤‡æ•°å›è©¦è¡Œã—ã¦ç¢ºå®Ÿã«æ›´æ–°
                    this.updateSelectedCount();
                    setTimeout(() => this.updateSelectedCount(), 50);
                    setTimeout(() => this.updateSelectedCount(), 150);
                    
                    if (this.config.onSelectionChange) {
                        this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                    }
                });
                
                return item;
            },
            
            // ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
            renderSummary: function(container) {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ template-actions ã‚’å„ªå…ˆ
                let summaryContainer;
                if (this.config.mode === 'edit_project') {
                    summaryContainer = container.querySelector('.template-actions');
                } else {
                    summaryContainer = container.querySelector('.template-summary') || 
                                     container.querySelector('.template-actions');
                }
                
                if (!summaryContainer) {
                    console.warn('Summary container not found for mode:', this.config.mode);
                    return;
                }
                
                
                if (this.config.mode === 'new_project') {
                    summaryContainer.innerHTML = `
                        <span>é¸æŠæ¸ˆã¿: <span id="selectedCount">0</span>ä»¶</span>
                        <button type="button" class="btn btn-secondary" onclick="TemplateSelector.selectAll()">ã™ã¹ã¦é¸æŠ</button>
                        <button type="button" class="btn btn-secondary" onclick="TemplateSelector.deselectAll()">ã™ã¹ã¦è§£é™¤</button>
                    `;
                } else {
                    summaryContainer.innerHTML = `
                        <span>é¸æŠæ¸ˆã¿: <span id="selectedCount">0</span>ä»¶</span>
                        <span style="color: #666; font-size: 0.9em; margin-left: 10px;">â€» ãƒã‚§ãƒƒã‚¯ã‚’å¤‰æ›´ã™ã‚‹ã¨è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™</span>
                    `;
                }
                
            },
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¨­å®š
            setActivePhase: function(phase) {
                this.state.activePhase = phase;
                
                // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
                const buttons = document.querySelectorAll('.phase-filter-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent === phase || (phase === 'all' && btn.textContent === 'ã™ã¹ã¦')) {
                        btn.classList.add('active');
                    }
                });
                
                this.renderTemplateList(document.getElementById(this.config.containerId));
            },
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            filterTemplates: function() {
                this.state.filteredTemplates = this.state.allTemplates.filter(template => {
                    if (this.state.activePhase !== 'all' && template.phase_name !== this.state.activePhase) {
                        return false;
                    }
                    return true;
                });
            },
            
            // é¸æŠæ¸ˆã¿æ•°ã‚’æ›´æ–°
            updateSelectedCount: function() {
                const count = this.state.selectedTemplateIds.size;
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€templateSelectionAreaå†…ã®è¦ç´ ã®ã¿ã‚’æ›´æ–°
                if (this.config.mode === 'edit_project') {
                    const templateArea = document.getElementById('templateSelectionArea');
                    if (templateArea) {
                        // template-actionså†…ã®selectedCountè¦ç´ ã‚’æ›´æ–°
                        const actionsContainer = templateArea.querySelector('.template-actions');
                        if (actionsContainer) {
                            const countElement = actionsContainer.querySelector('#selectedCount');
                            if (countElement) {
                                countElement.textContent = count;
                            } else {
                                // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å†ç”Ÿæˆ
                                actionsContainer.innerHTML = `
                                    <span>é¸æŠæ¸ˆã¿: <span id="selectedCount">${count}</span>ä»¶</span>
                                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">â€» ãƒã‚§ãƒƒã‚¯ã‚’å¤‰æ›´ã™ã‚‹ã¨è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™</span>
                                `;
                            }
                        }
                    }
                } else {
                    // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€å…¨ã¦ã®selectedCountè¦ç´ ã‚’æ›´æ–°
                    const allCountElements = document.querySelectorAll('#selectedCount');
                    // console.log('Found selectedCount elements:', allCountElements.length);
                    
                    allCountElements.forEach((element, index) => {
                        element.textContent = count;
                        // console.log(`Updated selectedCount element ${index + 1} to:`, count);
                    });
                }
            },
            
            // ã™ã¹ã¦é¸æŠ
            selectAll: function() {
                this.state.filteredTemplates.forEach(template => {
                    this.state.selectedTemplateIds.add(template.id.toString());
                });
                this.renderTemplateList(document.getElementById(this.config.containerId));
                this.updateSelectedCount();
                if (this.config.onSelectionChange) {
                    this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // ã™ã¹ã¦è§£é™¤
            deselectAll: function() {
                this.state.filteredTemplates.forEach(template => {
                    this.state.selectedTemplateIds.delete(template.id.toString());
                });
                this.renderTemplateList(document.getElementById(this.config.containerId));
                this.updateSelectedCount();
                if (this.config.onSelectionChange) {
                    this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // é¸æŠã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
            addSelectedTemplates: async function() {
                if (this.state.selectedTemplateIds.size === 0) {
                    showMessage('è¿½åŠ ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                    return;
                }
                
                if (this.config.onAddTemplates) {
                    await this.config.onAddTemplates(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
            cancel: function() {
                if (this.config.onCancel) {
                    this.config.onCancel();
                }
            },
            
            // é¸æŠã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’å–å¾—
            getSelectedTemplateIds: function() {
                return Array.from(this.state.selectedTemplateIds);
            },
            
            // é¸æŠã‚’ã‚¯ãƒªã‚¢
            clearSelection: function() {
                this.state.selectedTemplateIds.clear();
                this.updateSelectedCount();
            }
        };
        
        // ==================== æ—¢å­˜ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ©Ÿèƒ½ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰ ====================
        
        let filteredTemplates = [];
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚’åˆæœŸåŒ–
        async function initProjectTemplateSelection() {
            if (!currentProject) return;
            
            try {
                // ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’ä¸¦è¡Œå–å¾—
                const [tasksResponse, templatesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${currentProject.id}/tasks`),
                    fetch('api.php?path=templates')
                ]);
                
                const [tasksData, templatesData] = await Promise.all([
                    tasksResponse.json(),
                    templatesResponse.json()
                ]);
                
                let usedTemplateIds = new Set();
                
                if (tasksData.success && tasksData.tasks && templatesData.success && templatesData.templates) {
                    // ã‚¿ã‚¹ã‚¯åã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç‰¹å®š
                    tasksData.tasks.forEach(task => {
                        // ã¾ãštemplate_idã§ç¢ºèª
                        if (task.template_id) {
                            usedTemplateIds.add(task.template_id.toString());
                        } else {
                            // template_idãŒãªã„å ´åˆã¯ã€ã‚¿ã‚¹ã‚¯åã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œç´¢
                            const matchingTemplate = templatesData.templates.find(template => 
                                template.task_name === task.task_name || template.task_name === task.name
                            );
                            if (matchingTemplate) {
                                usedTemplateIds.add(matchingTemplate.id.toString());
                            }
                        }
                    });
                    
                    // console.log('ä½¿ç”¨ä¸­ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID:', Array.from(usedTemplateIds));
                }
                
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåŒ–ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
                TemplateSelector.init({
                    containerId: 'templateSelectionArea',
                    mode: 'edit_project',
                    onSelectionChange: async function(selectedIds) {
                        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«è‡ªå‹•çš„ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
                        try {
                            // console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', selectedIds);
                            
                            // ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
                            const currentTasks = allTasks.filter(task => task.project_id == currentProject.id);
                            const currentTemplateIds = currentTasks
                                .filter(task => task.template_id)
                                .map(task => task.template_id.toString());
                            
                            // console.log('ç¾åœ¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID:', currentTemplateIds);
                            // console.log('é¸æŠã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID:', selectedIds);
                            
                            // è¿½åŠ ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆé¸æŠã•ã‚ŒãŸãŒç¾åœ¨å­˜åœ¨ã—ãªã„ã‚‚ã®ï¼‰
                            const toAdd = selectedIds.filter(id => !currentTemplateIds.includes(id));
                            
                            // å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆç¾åœ¨å­˜åœ¨ã™ã‚‹ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‚‚ã®ï¼‰
                            const toRemove = currentTemplateIds.filter(id => !selectedIds.includes(id));
                            
                            // console.log('è¿½åŠ ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:', toAdd);
                            // console.log('å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:', toRemove);
                            
                            // å‰Šé™¤å‡¦ç†
                            if (toRemove.length > 0) {
                                for (const templateId of toRemove) {
                                    const tasksToRemove = currentTasks.filter(task => task.template_id == templateId);
                                    for (const task of tasksToRemove) {
                                        const response = await fetch('api.php?path=projects/tasks/remove', {
                                            method: 'DELETE',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({
                                                task_id: task.id
                                            })
                                        });
                                        
                                        const data = await response.json();
                                        if (data.success) {
                                            // console.log(`ã‚¿ã‚¹ã‚¯ ${task.id} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                                        }
                                    }
                                }
                            }
                            
                            // è¿½åŠ å‡¦ç†
                            if (toAdd.length > 0) {
                                const response = await fetch('api.php?path=projects/tasks/add-from-templates', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        project_id: currentProject.id,
                                        template_ids: toAdd
                                    })
                                });
                                
                                const data = await response.json();
                                if (data.success) {
                                    // console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', data.message);
                                }
                            }
                            
                            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                            if (toAdd.length > 0 || toRemove.length > 0) {
                                await loadProject(currentProject.id);
                                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                            }
                            
                        } catch (error) {
                            console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠå¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                            showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                        }
                    },
                    onCancel: function() {
                        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    }
                });
                
                // ä½¿ç”¨ä¸­ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
                setTimeout(() => {
                    // console.log('Setting up initial template selection for project edit');
                    // console.log('usedTemplateIds:', usedTemplateIds);
                    
                    usedTemplateIds.forEach(templateId => {
                        const checkbox = document.querySelector(`input[name="templates"][value="${templateId}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            TemplateSelector.state.selectedTemplateIds.add(templateId);
                            // console.log(`Checked template ${templateId}`);
                        } else {
                            console.warn(`Checkbox not found for template ${templateId}`);
                        }
                    });
                    
                    // console.log('Final selectedTemplateIds:', Array.from(TemplateSelector.state.selectedTemplateIds));
                    
                    // è¤‡æ•°å›è©¦è¡Œã—ã¦ç¢ºå®Ÿã«æ›´æ–°
                    TemplateSelector.updateSelectedCount();
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 100);
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 300);
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 500);
                    
                    // å¼·åˆ¶çš„ã«DOMã‚’æ›´æ–°
                    setTimeout(() => {
                        const templateArea = document.getElementById('templateSelectionArea');
                        if (templateArea) {
                            const summaryContainer = templateArea.querySelector('.template-summary');
                            if (summaryContainer) {
                                const currentCount = TemplateSelector.state.selectedTemplateIds.size;
                                summaryContainer.innerHTML = `
                                    <span>é¸æŠæ¸ˆã¿: <span id="selectedCount">${currentCount}</span>ä»¶</span>
                                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">â€» ãƒã‚§ãƒƒã‚¯ã‚’å¤‰æ›´ã™ã‚‹ã¨è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™</span>
                                `;
                                // console.log('Force updated summary container with count:', currentCount);
                            }
                        }
                    }, 600);
                }, 200);
                
            } catch (error) {
                console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å¤ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªåŒ–ã«ã‚ˆã‚Šç½®ãæ›ãˆï¼‰

        // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨æ©Ÿèƒ½
        function applyFilters() {
            // console.log('ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ä¸­...');
            loadProjects();
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆã®æ›´æ–°
        function updateProjectStats(projects) {
            const stats = {
                total: projects.length,
                planning: 0,
                in_progress: 0,
                completed: 0,
                cancelled: 0,
                totalTasks: 0,
                completedTasks: 0,
                notStartedTasks: 0,
                needsConfirmationTasks: 0
            };

            projects.forEach(project => {
                stats[project.status] = (stats[project.status] || 0) + 1;
                stats.totalTasks += parseInt(project.total_tasks || 0);
                stats.completedTasks += parseInt(project.completed_tasks || 0);
                stats.notStartedTasks += parseInt(project.not_started_tasks || 0);
                stats.needsConfirmationTasks += parseInt(project.needs_confirmation_tasks || 0);
            });

            // çµ±è¨ˆè¡¨ç¤ºã®æ›´æ–°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã¨ã—ã¦è¡¨ç¤ºï¼‰
            updateGlobalStats(stats);
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã®æ›´æ–°
        function updateGlobalStats(stats) {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°çµ±è¨ˆ
            const projectStatsElement = document.getElementById('projectStats');
            if (projectStatsElement) {
                projectStatsElement.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${stats.total}</span>
                        <span class="stat-label">ç·ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.in_progress}</span>
                        <span class="stat-label">é€²è¡Œä¸­</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.completed}</span>
                        <span class="stat-label">å®Œäº†</span>
                    </div>
                `;
            }

            // ã‚¿ã‚¹ã‚¯çµ±è¨ˆ
            const taskStatsElement = document.getElementById('taskStats');
            if (taskStatsElement) {
                taskStatsElement.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${stats.totalTasks}</span>
                        <span class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.notStartedTasks}</span>
                        <span class="stat-label">æœªç€æ‰‹</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.completedTasks}</span>
                        <span class="stat-label">å®Œäº†</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number danger">${stats.needsConfirmationTasks}</span>
                        <span class="stat-label">è¦ç¢ºèª</span>
                    </div>
                `;
            }
        }

        // è¦ç¢ºèªã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
        async function openNeedsConfirmationModal() {
            try {
                document.getElementById('needsConfirmationModal').style.display = 'block';
                await loadNeedsConfirmationTasks();
            } catch (error) {
                console.error('è¦ç¢ºèªã‚¿ã‚¹ã‚¯ä¸€è¦§è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showMessage('è¦ç¢ºèªã‚¿ã‚¹ã‚¯ä¸€è¦§ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function closeNeedsConfirmationModal() {
            document.getElementById('needsConfirmationModal').style.display = 'none';
        }

        async function loadNeedsConfirmationTasks() {
            try {
                const response = await fetch('api.php?path=tasks/needs_confirmation');
                const data = await response.json();
                
                if (data.success && data.tasks) {
                    displayNeedsConfirmationTasks(data.tasks);
                } else {
                    document.getElementById('needsConfirmationList').innerHTML = 
                        '<div class="empty">è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('è¦ç¢ºèªã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('needsConfirmationList').innerHTML = 
                    '<div class="error">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        function displayNeedsConfirmationTasks(tasks) {
            const container = document.getElementById('needsConfirmationList');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.map(task => `
                <div class="task-list-item needs-confirmation" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-item-header">
                        <h4>${task.task_name}</h4>
                        <span class="task-status status-needs_confirmation">è¦ç¢ºèª</span>
                    </div>
                    <div class="task-item-meta">
                        <div class="task-project">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${task.project_name}</div>
                        <div class="task-assignee">æ‹…å½“è€…: ${task.assigned_to_name || 'æœªå‰²å½“'}</div>
                        <div class="task-date">æœŸé™: ${task.planned_date ? formatDate(task.planned_date) : 'æœŸé™ãªã—'}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«
        async function openOverdueTasksModal() {
            try {
                document.getElementById('overdueTasksModal').style.display = 'block';
                await loadOverdueTasks();
            } catch (error) {
                console.error('æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ä¸€è¦§è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showMessage('æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ä¸€è¦§ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function closeOverdueTasksModal() {
            document.getElementById('overdueTasksModal').style.display = 'none';
        }

        async function loadOverdueTasks() {
            try {
                const response = await fetch('api.php?path=tasks/overdue');
                const data = await response.json();
                
                if (data.success && data.tasks) {
                    displayOverdueTasks(data.tasks);
                } else {
                    document.getElementById('overdueTasksList').innerHTML = 
                        '<div class="empty">æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                }
            } catch (error) {
                console.error('æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('overdueTasksList').innerHTML = 
                    '<div class="error">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        function displayOverdueTasks(tasks) {
            const container = document.getElementById('overdueTasksList');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.map(task => `
                <div class="task-list-item overdue" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-item-header">
                        <h4>${task.task_name}</h4>
                        <span class="task-status status-overdue">é…å»¶ ${task.days_overdue}æ—¥</span>
                    </div>
                    <div class="task-item-meta">
                        <div class="task-project">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${task.project_name}</div>
                        <div class="task-assignee">æ‹…å½“è€…: ${task.assigned_to_name || 'æœªå‰²å½“'}</div>
                        <div class="task-date overdue">æœŸé™: ${task.planned_date ? formatDate(task.planned_date) : 'æœŸé™ãªã—'}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’é–‹ã
        async function openTaskFromList(projectId, taskId) {
            try {
                console.log('openTaskFromListå‘¼ã³å‡ºã—:', projectId, taskId);
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
                selectProject(projectId);
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’é–‹ã
                setTimeout(() => {
                    editTask(taskId);
                }, 1000);
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeNeedsConfirmationModal();
                closeOverdueTasksModal();
            } catch (error) {
                console.error('ã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ›´æ–°æ©Ÿèƒ½
        function refreshNeedsConfirmationList() {
            loadNeedsConfirmationTasks();
        }

        function refreshOverdueTasksList() {
            loadOverdueTasks();
        }

        // ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openAddTaskModal() {
            if (!currentProject) {
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('taskEditForm').reset();
            document.getElementById('editTaskId').value = '';
            document.getElementById('editTaskProjectId').value = currentProject.id;
            document.getElementById('taskEditModalTitle').textContent = 'ã‚¿ã‚¹ã‚¯è¿½åŠ ';
            
            // ãƒ•ã‚§ãƒ¼ã‚ºé¸æŠè‚¢ã‚’è¨­å®š
            loadPhaseOptionsForTask();
            
            document.getElementById('taskEditModal').style.display = 'block';
        }

        // ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeTaskEditModal() {
            document.getElementById('taskEditModal').style.display = 'none';
        }

        // ã‚¿ã‚¹ã‚¯ç”¨ãƒ•ã‚§ãƒ¼ã‚ºé¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿
        async function loadPhaseOptionsForTask() {
            try {
                const response = await fetch('api.php?path=phases');
                const data = await response.json();
                
                if (data.success && data.phases) {
                    const select = document.getElementById('editTaskPhaseName');
                    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                    
                    data.phases.forEach(phase => {
                        const option = document.createElement('option');
                        option.value = phase.name;
                        option.textContent = phase.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('ãƒ•ã‚§ãƒ¼ã‚ºé¸æŠè‚¢èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditProjectModal() {
            if (!currentProject) {
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
            document.getElementById('editProjectId').value = currentProject.id;
            document.getElementById('editProjectName').value = currentProject.name;
            document.getElementById('editProjectCode').value = currentProject.project_code || '';
            document.getElementById('editProjectClient').value = currentProject.client_name || '';
            document.getElementById('editProjectDescription').value = currentProject.description || '';
            document.getElementById('editProjectStartDate').value = currentProject.start_date || '';
            document.getElementById('editProjectEndDate').value = currentProject.target_end_date || '';
            document.getElementById('editProjectStatus').value = currentProject.status || 'planning';
            
            document.getElementById('editProjectModal').style.display = 'block';
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEditProjectModal() {
            document.getElementById('editProjectModal').style.display = 'none';
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openDeleteProjectModal() {
            if (!currentProject) {
                showMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            document.getElementById('deleteProjectModal').style.display = 'block';
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').style.display = 'none';
        }


        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½
        async function loadDashboard() {
            try {
                // console.log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('api.php?path=dashboard');
                const data = await response.json();
                
                if (data.success) {
                    updateDashboard(data);
                } else {
                    console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.error);
                    showMessage('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        function updateDashboard(data) {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’è¡¨ç¤º
            if (currentProject) {
                updateDashboardForCurrentProject();
            } else {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆã®æ›´æ–°
                updateProjectStatsDisplay(data.stats.projects);
                
                // ã‚¿ã‚¹ã‚¯çµ±è¨ˆã®æ›´æ–°
                updateTaskStatsDisplay(data.stats.tasks);
                
                // è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º
                updateDashboardNeedsConfirmation(data.needs_confirmation_tasks);
                
                // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º
                updateDashboardOverdueTasks(data.overdue_tasks);
                
                // æœŸé™é–“è¿‘ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º
                updateDashboardUpcomingTasks(data.upcoming_tasks);
                
                // æœ€è¿‘ã®æ´»å‹•ã®è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
                updateRecentActivity(data);
            }
        }

        // ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        async function updateDashboardForCurrentProject() {
            if (!currentProject) return;
            
            try {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯çµ±è¨ˆã‚’å–å¾—
                const response = await fetch(`api.php?path=projects/${currentProject.id}/tasks`);
                const data = await response.json();
                
                if (data.success && data.tasks) {
                    const tasks = data.tasks;
                    
                    // ã‚¿ã‚¹ã‚¯çµ±è¨ˆã‚’è¨ˆç®—
                    const stats = {
                        total: tasks.length,
                        not_started: tasks.filter(t => t.status === 'not_started').length,
                        in_progress: tasks.filter(t => t.status === 'in_progress').length,
                        completed: tasks.filter(t => t.status === 'completed').length,
                        needs_confirmation: tasks.filter(t => t.status === 'needs_confirmation').length,
                        overdue: tasks.filter(t => {
                            return t.planned_date && new Date(t.planned_date) < new Date() && t.status !== 'completed';
                        }).length
                    };
                    
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯çµ±è¨ˆã‚’è¡¨ç¤º
                    updateTaskStatsDisplay(stats);
                    
                    // è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
                    const needsConfirmationTasks = tasks.filter(t => t.status === 'needs_confirmation');
                    updateDashboardNeedsConfirmation(needsConfirmationTasks);
                    
                    // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
                    const overdueTasks = tasks.filter(t => {
                        return t.planned_date && new Date(t.planned_date) < new Date() && t.status !== 'completed';
                    });
                    updateDashboardOverdueTasks(overdueTasks);
                    
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function updateProjectStatsDisplay(projectStats) {
            const container = document.getElementById('projectStats');
            if (!container) {
                // console.log('projectStatsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${projectStats.total}</span>
                    <span class="stat-label">ç·ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${projectStats.in_progress}</span>
                    <span class="stat-label">é€²è¡Œä¸­</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${projectStats.completed}</span>
                    <span class="stat-label">å®Œäº†</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${projectStats.planning}</span>
                    <span class="stat-label">è¨ˆç”»ä¸­</span>
                </div>
            `;
        }

        function updateTaskStatsDisplay(taskStats) {
            const container = document.getElementById('taskStats');
            if (!container) {
                // console.log('taskStatsè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${taskStats.total}</span>
                    <span class="stat-label">ç·ã‚¿ã‚¹ã‚¯æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${taskStats.not_started}</span>
                    <span class="stat-label">æœªç€æ‰‹</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${taskStats.in_progress}</span>
                    <span class="stat-label">é€²è¡Œä¸­</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${taskStats.completed}</span>
                    <span class="stat-label">å®Œäº†</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number danger">${taskStats.needs_confirmation}</span>
                    <span class="stat-label">è¦ç¢ºèª</span>
                </div>
            `;
        }

        function updateDashboardNeedsConfirmation(tasks) {
            const container = document.getElementById('dashboardNeedsConfirmation');
            if (!container) {
                // console.log('dashboardNeedsConfirmationè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="dashboard-task-item needs-confirmation" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-name">${task.task_name}</div>
                    <div class="task-project">${task.project_name}</div>
                    <div class="task-assignee">${task.assigned_to_name || 'æœªå‰²å½“'}</div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">ä»– ${tasks.length - 5} ä»¶...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateDashboardOverdueTasks(tasks) {
            const container = document.getElementById('dashboardOverdueTasks');
            if (!container) {
                // console.log('dashboardOverdueTasksè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="dashboard-task-item overdue" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-name">${task.task_name}</div>
                    <div class="task-project">${task.project_name}</div>
                    <div class="task-deadline">æœŸé™: ${formatDate(task.planned_date)} (${task.days_overdue}æ—¥é…ã‚Œ)</div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">ä»– ${tasks.length - 5} ä»¶...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateDashboardUpcomingTasks(tasks) {
            const container = document.getElementById('dashboardUpcomingTasks');
            if (!container) {
                // console.log('dashboardUpcomingTasksè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">æœŸé™é–“è¿‘ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="dashboard-task-item upcoming" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-name">${task.task_name}</div>
                    <div class="task-project">${task.project_name}</div>
                    <div class="task-deadline">æœŸé™: ${formatDate(task.planned_date)} (${task.days_until_deadline}æ—¥å¾Œ)</div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">ä»– ${tasks.length - 5} ä»¶...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateRecentActivity(data) {
            const container = document.getElementById('recentActivity');
            if (!container) {
                // console.log('recentActivityè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ç°¡æ˜“çš„ãªæœ€è¿‘ã®æ´»å‹•è¡¨ç¤º
            const activities = [];
            
            if (data.needs_confirmation_tasks.length > 0) {
                activities.push({
                    type: 'warning',
                    message: `${data.needs_confirmation_tasks.length}ä»¶ã®è¦ç¢ºèªã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™`,
                    time: 'ä»Š'
                });
            }
            
            if (data.overdue_tasks.length > 0) {
                activities.push({
                    type: 'error',
                    message: `${data.overdue_tasks.length}ä»¶ã®æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™`,
                    time: 'ä»Š'
                });
            }
            
            if (data.upcoming_tasks.length > 0) {
                activities.push({
                    type: 'info',
                    message: `${data.upcoming_tasks.length}ä»¶ã®æœŸé™é–“è¿‘ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™`,
                    time: 'ä»Š'
                });
            }
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="empty">æœ€è¿‘ã®æ´»å‹•ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = activities.map(activity => `
                <div class="activity-item ${activity.type}">
                    <div class="activity-message">${activity.message}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // å³ã‚«ãƒ©ãƒ ã®é‡è¦ãªã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
        function refreshImportantTasks() {
            loadImportantTasks();
        }

        async function loadImportantTasks() {
            try {
                // è¦ç¢ºèªã€æœŸé™åˆ‡ã‚Œã€æœŸé™é–“è¿‘ã‚¿ã‚¹ã‚¯ã‚’ä¸¦è¡Œå–å¾—
                const [needsConfirmationResponse, overdueResponse, upcomingResponse] = await Promise.all([
                    fetch('api.php?path=tasks/needs_confirmation'),
                    fetch('api.php?path=tasks/overdue'),
                    fetch('api.php?path=tasks/upcoming')
                ]);

                const needsConfirmationData = await needsConfirmationResponse.json();
                const overdueData = await overdueResponse.json();
                const upcomingData = await upcomingResponse.json();

                // è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
                updateRightColumnNeedsConfirmation(needsConfirmationData.success ? needsConfirmationData.tasks : []);
                
                // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
                updateRightColumnOverdueTasks(overdueData.success ? overdueData.tasks : []);
                
                // æœŸé™é–“è¿‘ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
                updateRightColumnUpcomingTasks(upcomingData.success ? upcomingData.tasks : []);
            } catch (error) {
                console.error('é‡è¦ãªã‚¿ã‚¹ã‚¯èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function updateRightColumnNeedsConfirmation(tasks) {
            const container = document.getElementById('rightColumnNeedsConfirmation');
            if (!container) {
                // console.log('rightColumnNeedsConfirmationè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="important-task-item needs-confirmation" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="important-task-name">${task.task_name}</div>
                    <div class="important-task-project">${task.project_name}</div>
                    <div class="important-task-meta">
                        <span>${task.assigned_to_name || 'æœªå‰²å½“'}</span>
                        <span>${task.planned_date ? formatDate(task.planned_date) : 'æœŸé™ãªã—'}</span>
                    </div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">ä»– ${tasks.length - 5} ä»¶...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateRightColumnOverdueTasks(tasks) {
            const container = document.getElementById('rightColumnOverdueTasks');
            if (!container) {
                // console.log('rightColumnOverdueTasksè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="important-task-item overdue" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="important-task-name">${task.task_name}</div>
                    <div class="important-task-project">${task.project_name}</div>
                    <div class="important-task-meta">
                        <span>${task.assigned_to_name || 'æœªå‰²å½“'}</span>
                        <span>${task.days_overdue}æ—¥é…ã‚Œ</span>
                    </div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">ä»– ${tasks.length - 5} ä»¶...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateRightColumnUpcomingTasks(tasks) {
            const container = document.getElementById('rightColumnUpcomingTasks');
            if (!container) {
                // console.log('rightColumnUpcomingTasksè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">æœŸé™é–“è¿‘ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="important-task-item upcoming" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="important-task-name">${task.task_name}</div>
                    <div class="important-task-project">${task.project_name}</div>
                    <div class="important-task-meta">
                        <span>${task.assigned_to_name || 'æœªå‰²å½“'}</span>
                        <span>${task.days_until_deadline}æ—¥å¾Œ</span>
                    </div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">ä»– ${tasks.length - 5} ä»¶...</div>` : '';
            container.innerHTML = html + moreText;
        }

        // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
        let notifications = [];
        let notificationCheckInterval = null;

        async function loadNotifications() {
            try {
                // è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã¨æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‹ã‚‰é€šçŸ¥ã‚’ç”Ÿæˆ
                const [needsConfirmationResponse, overdueResponse] = await Promise.all([
                    fetch('api.php?path=tasks/needs_confirmation'),
                    fetch('api.php?path=tasks/overdue')
                ]);

                const needsConfirmationData = await needsConfirmationResponse.json();
                const overdueData = await overdueResponse.json();

                notifications = [];

                // è¦ç¢ºèªã‚¿ã‚¹ã‚¯ã®é€šçŸ¥
                if (needsConfirmationData.success && needsConfirmationData.tasks) {
                    needsConfirmationData.tasks.forEach(task => {
                        notifications.push({
                            id: `needs_confirmation_${task.id}`,
                            type: 'warning',
                            title: 'è¦ç¢ºèªã‚¿ã‚¹ã‚¯',
                            message: `${task.task_name} (${task.project_name})`,
                            taskId: task.id,
                            projectId: task.project_id,
                            timestamp: new Date().toISOString(),
                            read: false
                        });
                    });
                }

                // æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã®é€šçŸ¥
                if (overdueData.success && overdueData.tasks) {
                    overdueData.tasks.forEach(task => {
                        notifications.push({
                            id: `overdue_${task.id}`,
                            type: 'error',
                            title: 'æœŸé™åˆ‡ã‚Œã‚¿ã‚¹ã‚¯',
                            message: `${task.task_name} (${task.project_name}) - ${task.days_overdue}æ—¥é…ã‚Œ`,
                            taskId: task.id,
                            projectId: task.project_id,
                            timestamp: new Date().toISOString(),
                            read: false
                        });
                    });
                }

                updateNotificationDisplay();
            } catch (error) {
                console.error('é€šçŸ¥èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function updateNotificationDisplay() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) {
                // console.log('notificationBadgeè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }

            // é€šçŸ¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown && dropdown.style.display !== 'none') {
                displayNotifications();
            }
        }

        function displayNotifications() {
            const container = document.getElementById('notificationList');
            if (!container) {
                // console.log('notificationListè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty">é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // æœªèª­ã®é€šçŸ¥ã‚’å…ˆã«è¡¨ç¤º
            const sortedNotifications = [...notifications].sort((a, b) => {
                if (a.read !== b.read) return a.read - b.read;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            const html = sortedNotifications.map(notification => `
                <div class="notification-item ${notification.read ? 'read' : 'unread'} ${notification.type}" 
                     onclick="handleNotificationClick('${notification.id}')">
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                    </div>
                    ${!notification.read ? '<div class="notification-unread-indicator"></div>' : ''}
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function formatNotificationTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'ãŸã£ãŸä»Š';
            if (diffMins < 60) return `${diffMins}åˆ†å‰`;
            if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`;
            return `${diffDays}æ—¥å‰`;
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            if (!dropdown) {
                // console.log('notificationDropdownè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                displayNotifications();
            } else {
                dropdown.style.display = 'none';
            }
        }

        function handleNotificationClick(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (!notification) return;

            // é€šçŸ¥ã‚’æ—¢èª­ã«ã™ã‚‹
            notification.read = true;
            updateNotificationDisplay();

            // ã‚¿ã‚¹ã‚¯ã‚’é–‹ã
            openTaskFromList(notification.projectId, notification.taskId);
        }

        function markAllAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            updateNotificationDisplay();
        }

        function startNotificationCheck() {
            // 5åˆ†ã”ã¨ã«é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
            notificationCheckInterval = setInterval(() => {
                loadNotifications();
            }, 5 * 60 * 1000);
        }

        function stopNotificationCheck() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
                notificationCheckInterval = null;
            }
        }

        // ãƒšãƒ¼ã‚¸å¤–ã‚¯ãƒªãƒƒã‚¯ã§é€šçŸ¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', function(event) {
            const notificationArea = document.querySelector('.notification-area');
            if (notificationArea && !notificationArea.contains(event.target)) {
                document.getElementById('notificationDropdown').style.display = 'none';
            }
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ãƒœã‚¿ãƒ³
            const applyFiltersBtn = document.getElementById('applyFilters');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }

            // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚ã®è‡ªå‹•é©ç”¨
            const statusFilter = document.getElementById('statusFilter');
            const sortBy = document.getElementById('sortBy');
            const sortOrder = document.getElementById('sortOrder');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', applyFilters);
            }
            if (sortBy) {
                sortBy.addEventListener('change', applyFilters);
            }
            if (sortOrder) {
                sortOrder.addEventListener('change', applyFilters);
            }
        });
    </script>
</body>
</html>
