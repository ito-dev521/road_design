<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>道路設計管理システム</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/index.css">
    <script>
        // キャッシュバスター
        const timestamp = new Date().getTime();
        const styleLink = document.createElement('link');
        styleLink.rel = 'stylesheet';
        styleLink.href = 'assets/css/index.css?v=' + timestamp;
        document.head.appendChild(styleLink);
    </script>
</head>
<body>
        <!-- ヘッダー -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">🚧</div>
                <div class="logo-text">
                    <h1>道路設計管理システム</h1>
                    <p>Road Design Management System</p>
            </div>
            </div>
            <div class="header-actions">
                <div class="notification-area">
                    <button class="notification-btn" id="notificationBtn">
                        🔔 <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown" style="display: none;">
                        <div class="notification-header">
                            <h4>通知</h4>
                            <button class="btn btn-small" onclick="markAllAsRead()">すべて既読</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="loading">読み込み中...</div>
                        </div>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-details">
                        <span class="user-name" id="userName">読み込み中...</span>
                        <span class="user-role" id="userRole">読み込み中...</span>
                </div>
                </div>
                <a href="settings.html" id="settingsBtn" class="btn btn-secondary" style="display:none;">⚙️ 設定</a>
                <a href="logout.php" class="btn btn-secondary">🚪 ログアウト</a>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main-container three-column-layout">
            <!-- 左カラム: プロジェクト一覧 -->
            <aside class="left-column">
                <div class="column-header">
                    <h2>📁 プロジェクト一覧</h2>
                    <button class="btn btn-primary btn-small" id="newProjectBtn">🚀 新規</button>
                </div>
                
                <div class="project-filters">
                    <div class="filter-group">
                        <label for="statusFilter">ステータス:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="">すべて</option>
                            <option value="planning">計画中</option>
                            <option value="in_progress">進行中</option>
                            <option value="completed">完了</option>
                            <option value="cancelled">キャンセル</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortBy">並び順:</label>
                        <select id="sortBy" class="filter-select">
                            <option value="created_at">登録日</option>
                            <option value="name">プロジェクト名</option>
                            <option value="start_date">開始日</option>
                            <option value="target_end_date">終了日</option>
                            <option value="status">ステータス</option>
                            <option value="total_tasks">タスク数</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortOrder">順序:</label>
                        <select id="sortOrder" class="filter-select">
                            <option value="DESC">降順</option>
                            <option value="ASC">昇順</option>
                        </select>
                    </div>
                    <button id="applyFilters" class="btn btn-secondary btn-small">適用</button>
                </div>
                
                <div class="project-list" id="projectList">
                    <div class="loading">読み込み中...</div>
                </div>
            </aside>

            <!-- 中央カラム: 選択されたプロジェクトの詳細 -->
            <main class="center-column">
                <!-- プロジェクト情報 -->
                <section class="project-info" id="projectInfo" style="display: none;">
                    <div class="project-header">
                        <div class="project-title">
                            <h2 id="projectName">プロジェクト名</h2>
                            <div class="project-meta">
                                <span id="projectPeriod"></span>
                                <span class="project-status" id="projectStatus"></span>
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-secondary" id="editProjectBtn">✏️ 編集</button>
                            <button class="btn btn-danger" id="deleteProjectBtn">🗑️ 削除</button>
                        </div>
                    </div>
                    
                    <!-- 進捗サマリー -->
                    <div class="progress-summary">
                        <div class="progress-card">
                            <div class="progress-number" id="totalTasks">0</div>
                            <div class="progress-label">総タスク数</div>
                        </div>
                        <div class="progress-card">
                            <div class="progress-number" id="notStartedTasks">0</div>
                            <div class="progress-label">未着手</div>
                        </div>
                        <div class="progress-card">
                            <div class="progress-number" id="inProgressTasks">0</div>
                            <div class="progress-label">進行中</div>
                        </div>
                        <div class="progress-card">
                            <div class="progress-number" id="completedTasks">0</div>
                            <div class="progress-label">完了済み</div>
                        </div>
                        <div class="progress-card clickable" onclick="openNeedsConfirmationModal()">
                            <div class="progress-number danger" id="needsConfirmationTasks">0</div>
                            <div class="progress-label">要確認</div>
                        </div>
                        <div class="progress-card clickable" onclick="openOverdueTasksModal()">
                            <div class="progress-number danger" id="overdueTasks">0</div>
                            <div class="progress-label">遅延</div>
                        </div>
                    </div>
                    
                    <!-- プログレスバー -->
                    <div class="overall-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                </section>

                <!-- タスク一覧 -->
                <section class="task-section" id="taskSection" style="display: none;">
                    <div class="task-header">
                        <h3>📋 タスク一覧</h3>
                        <button class="btn btn-primary" id="addTaskBtn">➕ タスク追加</button>
                    </div>
                    
                    <div class="task-filters">
                        <div class="filter-group">
                            <label for="taskStatusFilter">ステータス:</label>
                            <select id="taskStatusFilter" class="filter-select">
                                <option value="">すべて</option>
                                <option value="not_started">未着手</option>
                                <option value="in_progress">進行中</option>
                                <option value="completed">完了</option>
                                <option value="needs_confirmation">要確認</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="taskPhaseFilter">フェーズ:</label>
                            <select id="taskPhaseFilter" class="filter-select">
                                <option value="">すべて</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="task-list" id="taskList">
                        <div class="empty">プロジェクトを選択してください</div>
                    </div>
                </section>

                <!-- プロジェクト未選択状態 -->
                <section class="no-project-selected" id="noProjectSelected">
                    <div class="empty-state">
                        <div class="empty-icon">📁</div>
                        <h3>プロジェクトを選択してください</h3>
                        <p>左側のプロジェクト一覧からプロジェクトを選択するか、新しいプロジェクトを作成してください。</p>
                        <button class="btn btn-primary" onclick="document.getElementById('newProjectBtn').click()">🚀 新規プロジェクト作成</button>
                    </div>
                </section>
            </main>

            <!-- 右カラム: 要確認・期限切れタスク -->
            <aside class="right-column">
                <div class="column-header">
                    <h2>⚠️ 重要なタスク</h2>
                    <button class="btn btn-secondary btn-small" id="refreshImportantTasksBtn">🔄 更新</button>
                </div>
                
                <!-- 要確認タスク -->
                <div class="important-tasks-section">
                    <h3>要確認タスク</h3>
                    <div class="important-task-list" id="rightColumnNeedsConfirmation">
                        <div class="loading">読み込み中...</div>
                    </div>
                </div>
                
                <!-- 期限切れタスク -->
                <div class="important-tasks-section">
                    <h3>期限切れタスク</h3>
                    <div class="important-task-list" id="rightColumnOverdueTasks">
                        <div class="loading">読み込み中...</div>
                    </div>
                </div>
                
                <!-- 期限間近タスク -->
                <div class="important-tasks-section">
                    <h3>期限間近タスク</h3>
                    <div class="important-task-list" id="rightColumnUpcomingTasks">
                        <div class="loading">読み込み中...</div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- ローディング表示 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">読み込み中...</div>
        </div>

        <!-- メッセージ表示 -->
        <div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 2000;"></div>

        <!-- モーダルここに挿入される -->
        
        <!-- 新規プロジェクト作成モーダル -->
    <div class="modal-overlay" id="newProjectModal">
            <div class="modal project-modal">
            <div class="modal-header">
                    <h3 class="modal-title">新規プロジェクト作成</h3>
                    <button class="modal-close" onclick="closeNewProjectModal()">&times;</button>
            </div>
                <div class="modal-content">
            <form id="newProjectForm">
                        <div class="form-section">
                            <h4>プロジェクト基本情報</h4>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectName">プロジェクト名</label>
                                    <input type="text" id="projectName" name="name" required>
                </div>
                <div class="form-group">
                                    <label for="newProjectClient">発注者</label>
                                    <select id="newProjectClient" name="client_id" required>
                                        <option value="">発注者を選択</option>
                                    </select>
                </div>
                            </div>
                            <div class="form-row">
                <div class="form-group">
                                    <label for="projectStartDate">開始日</label>
                                    <input type="date" id="projectStartDate" name="start_date" required>
                </div>
                <div class="form-group">
                                    <label for="projectEndDate">終了日</label>
                                    <input type="date" id="projectEndDate" name="end_date" required>
                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h4>テンプレート選択</h4>
                            <div class="template-selection">
                                <div class="template-filters" id="templateFilters">
                                    <!-- フェーズフィルターボタンがここに動的に追加される -->
                                </div>
                                <div class="template-list">
                                    <div class="template-groups" id="templateGroups">
                                        <!-- テンプレートがここに動的に追加される -->
                                    </div>
                                </div>
                                <div class="template-summary">
                                    <span>選択済み: <span id="selectedCount">0</span>件</span>
                                    <button type="button" class="btn btn-secondary" onclick="selectAllTemplates()">すべて選択</button>
                                    <button type="button" class="btn btn-secondary" onclick="deselectAllTemplates()">すべて解除</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="createProject()">プロジェクト作成</button>
                </div>
            </div>
        </div>

        <!-- プロジェクト編集モーダル -->
        <div class="modal-overlay" id="editProjectModal">
            <div class="modal project-modal">
                <div class="modal-header">
                    <h3 class="modal-title">プロジェクト編集</h3>
                    <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="editProjectForm">
                        <input type="hidden" id="editProjectId">
                        <div class="form-section">
                            <h4>プロジェクト基本情報</h4>
                <div class="form-row">
                    <div class="form-group">
                                    <label for="editProjectName">プロジェクト名</label>
                                    <input type="text" id="editProjectName" name="name" required>
                    </div>
                    <div class="form-group">
                                    <label for="editProjectClient">発注者</label>
                                    <select id="editProjectClient" name="client_id" required>
                                        <option value="">発注者を選択</option>
                                    </select>
                    </div>
                </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editProjectStartDate">開始日</label>
                                    <input type="date" id="editProjectStartDate" name="start_date" required>
                                </div>
                                <div class="form-group">
                                    <label for="editProjectEndDate">終了日</label>
                                    <input type="date" id="editProjectEndDate" name="end_date" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editProjectStatus">ステータス</label>
                                <select id="editProjectStatus" name="status" required>
                                    <option value="planning">計画中</option>
                                    <option value="in_progress">進行中</option>
                                    <option value="completed">完了</option>
                                    <option value="cancelled">中止</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- タスク管理セクション -->
                        <div class="form-section">
                            <h4>タスク管理</h4>
                            
                            <!-- テンプレート選択エリア -->
                            <div class="template-selection-area" id="templateSelectionArea">
                                <h5>テンプレート選択</h5>
                                <div class="template-selection">
                                    <div class="template-filters" id="editTemplateFilters">
                                        <!-- フェーズフィルターボタンがここに動的に追加される -->
                                    </div>
                                    <div class="template-list">
                                        <div class="template-groups" id="editTemplateGroups">
                                            <!-- テンプレートがここに動的に追加される -->
                                        </div>
                                    </div>
                                    <div class="template-actions">
                                        <!-- アクションボタンがここに動的に追加される -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="updateProject()">更新</button>
                </div>
        </div>
    </div>

        <!-- タスク追加・編集モーダル -->
        <div class="modal-overlay" id="taskEditModal">
            <div class="modal task-modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="taskEditModalTitle">タスク追加</h3>
                    <button class="modal-close" onclick="closeTaskEditModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <form id="taskEditForm">
                        <input type="hidden" id="editTaskId">
                        <input type="hidden" id="editTaskProjectId">
                        
                        <div class="form-group">
                            <label for="editTaskName">タスク名</label>
                            <input type="text" id="editTaskName" name="task_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskPhase">フェーズ</label>
                            <select id="editTaskPhase" name="phase_name" required>
                                <option value="フェーズ1">フェーズ1</option>
                                <option value="フェーズ2">フェーズ2</option>
                                <option value="フェーズ3">フェーズ3</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskOrder">順序</label>
                            <input type="number" id="editTaskOrder" name="task_order" min="0" value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="editTaskEstimatedHours">見積時間（時間）</label>
                            <input type="number" id="editTaskEstimatedHours" name="estimated_hours" min="0" step="0.5">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editTaskIsTechnical" name="is_technical_work">
                                技術作業
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editTaskHasManual" name="has_manual">
                                マニュアルあり
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskEditModal()">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="saveTaskEdit()">保存</button>
                </div>
            </div>
        </div>

        <!-- プロジェクト削除確認モーダル -->
        <div class="modal-overlay" id="deleteProjectModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">プロジェクト削除確認</h3>
                    <button class="modal-close" onclick="closeDeleteProjectModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="project-delete-info">
                        <strong>このプロジェクトを削除しますか？</strong>
                        <p id="deleteProjectInfo">プロジェクト名: <span id="deleteProjectName"></span></p>
                        <p style="color: #dc3545; font-weight: bold;">※ この操作は取り消せません。プロジェクトに関連するすべてのタスクも削除されます。</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteProjectModal()">キャンセル</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProject()">削除</button>
                </div>
            </div>
        </div>

        <!-- 要確認タスク一覧モーダル -->
        <div class="modal-overlay" id="needsConfirmationModal">
            <div class="modal task-list-modal">
                <div class="modal-header">
                    <h3 class="modal-title">要確認タスク一覧</h3>
                    <button class="modal-close" onclick="closeNeedsConfirmationModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div id="needsConfirmationList" class="task-list-container">
                        <div class="loading">読み込み中...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNeedsConfirmationModal()">閉じる</button>
                    <button type="button" class="btn btn-primary" onclick="refreshNeedsConfirmationList()">更新</button>
                </div>
            </div>
        </div>

        <!-- 期限切れタスク一覧モーダル -->
        <div class="modal-overlay" id="overdueTasksModal">
            <div class="modal task-list-modal">
                <div class="modal-header">
                    <h3 class="modal-title">期限切れタスク一覧</h3>
                    <button class="modal-close" onclick="closeOverdueTasksModal()">&times;</button>
                </div>
                <div class="modal-content">
                    <div id="overdueTasksList" class="task-list-container">
                        <div class="loading">読み込み中...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeOverdueTasksModal()">閉じる</button>
                    <button type="button" class="btn btn-primary" onclick="refreshOverdueTasksList()">更新</button>
                </div>
            </div>
        </div>

        <!-- タスク編集モーダル -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal task-modal">
            <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">タスク編集</h3>
                    <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            </div>
                <div class="modal-content task-modal-content">
                    <form id="taskForm" onsubmit="return false;">
                        <input type="hidden" id="taskId">
                        
                        <!-- タスク基本情報 -->
                <div class="task-info">
                            <h4 id="taskTitle"></h4>
                        </div>
                        
                        <!-- タスクフォーム -->
                        <div class="task-form-row">
                    <div class="task-status-selector">
                                <label for="taskStatus">ステータス</label>
                                <select id="taskStatus" name="status" required>
                            <option value="not_started">未着手</option>
                            <option value="in_progress">進行中</option>
                            <option value="completed">完了</option>
                            <option value="needs_confirmation">要確認</option>
                            <option value="not_applicable">対象外</option>
                            <option value="pending">保留中</option>
                        </select>
                    </div>
                    <div class="task-assignment">
                                <label for="taskAssignee">担当者</label>
                                <select id="taskAssignee" name="assigned_to">
                            <option value="">未割当</option>
                        </select>
                    </div>
                    <div class="task-date">
                                <label for="taskDueDate">期限</label>
                                <input type="date" id="taskDueDate" name="due_date">
                            </div>
                    </div>
                    
                        <!-- タスク内容表示 -->
                        <div class="task-content">
                            <label>作業内容</label>
                            <div class="task-content-display" id="taskContentDisplay"></div>
                        </div>

                        <!-- タスクメタ情報 -->
                    <div class="task-meta">
                        <div class="task-meta-item">
                                <span class="meta-label">フェーズ:</span>
                                <span id="taskPhase"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">作業順序:</span>
                                <span id="taskOrder"></span>
                            </div>
                            <div class="task-meta-item">
                                <span class="meta-label">技術作業:</span>
                            <span id="taskTechnical"></span>
                        </div>
                        <div class="task-meta-item">
                            <span class="meta-label">マニュアル:</span>
                                <span id="taskManualInfo"></span>
                                <div id="taskManualLinks" class="task-manual" style="margin-top:8px; display:none;">
                                    <div id="taskManualList"></div>
                                </div>
                    </div>
                </div>
                
                        <!-- 作業メモ -->
                <div class="task-notes">
                            <label>作業メモ</label>
                            
                            <!-- 既存メモの履歴 -->
                            <div class="notes-history" id="notesHistory">
                                <!-- メモ履歴がここに表示される -->
                </div>
                
                            <!-- 新しいメモ追加 -->
                            <div class="add-note-section">
                                <div class="note-input-container">
                                    <textarea id="newNote" placeholder="新しいメモを入力してください... (@でユーザーをメンションできます)" rows="4" title="@を入力するとユーザーをメンションできます。メンションすると自動的に要確認ステータスになります。"></textarea>
                                    <div id="userSuggestions" class="user-suggestions" style="display: none;"></div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addNote()">メモを追加</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let allTasks = [];
        let filteredTasks = [];
        let allPhases = [];
        let currentPhaseFilter = 'all';
        let allUsers = [];
        let allClients = [];
        let allTemplates = [];
        let selectedTemplateIds = new Set(); // 選択されたテンプレートIDを保持

        // 選択テンプレートの永続化
        function loadSelectedTemplatesFromStorage() {
            try {
                const raw = localStorage.getItem('selectedTemplateIds');
                if (raw) {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr)) {
                        selectedTemplateIds = new Set(arr.map(String));
                    }
                }
            } catch (e) {
            }
        }

        function saveSelectedTemplatesToStorage() {
            try {
                localStorage.setItem('selectedTemplateIds', JSON.stringify(Array.from(selectedTemplateIds)));
            } catch (e) {
            }
        }

        // 新規プロジェクトモーダルの開閉状態・下書きの永続化
        function markNewProjectModalOpen(isOpen) {
            try { localStorage.setItem('newProjectModalOpen', isOpen ? 'true' : 'false'); } catch(e) {}
        }

        function saveNewProjectDraft() {
            try {
                const draft = {
                    name: document.getElementById('projectName')?.value || '',
                    client_id: document.getElementById('newProjectClient')?.value || '',
                    start_date: document.getElementById('projectStartDate')?.value || '',
                    end_date: document.getElementById('projectEndDate')?.value || ''
                };
                localStorage.setItem('newProjectDraft', JSON.stringify(draft));
            } catch (e) {
            }
        }

        function loadNewProjectDraft() {
            try {
                const raw = localStorage.getItem('newProjectDraft');
                if (!raw) return;
                const draft = JSON.parse(raw);
                if (!draft) return;
                
                const projectName = document.getElementById('projectName');
                const projectStartDate = document.getElementById('projectStartDate');
                const projectEndDate = document.getElementById('projectEndDate');
                const newProjectClient = document.getElementById('newProjectClient');
                
                if (draft.name && projectName) projectName.value = draft.name;
                if (draft.start_date && projectStartDate) projectStartDate.value = draft.start_date;
                if (draft.end_date && projectEndDate) projectEndDate.value = draft.end_date;
                
                // クライアントは loadClients 完了後に適用
                setTimeout(() => {
                    if (draft.client_id && newProjectClient) newProjectClient.value = draft.client_id;
                }, 0);
            } catch (e) {
            }
        }

        // モーダル強制クローズ防止（保存/キャンセル以外では閉じない）
        let newProjectModalObserver = null;
        function startNewProjectModalGuard() {
            try {
                const modal = document.getElementById('newProjectModal');
                if (!modal) return;
                if (newProjectModalObserver) newProjectModalObserver.disconnect();
                newProjectModalObserver = new MutationObserver(() => {
                    const shouldBeOpen = localStorage.getItem('newProjectModalOpen') === 'true';
                    if (!shouldBeOpen) return;
                    // display/hidden が変更されていたら復元
                    if (modal.style.display === 'none' || modal.hidden) {
                        modal.style.display = 'block';
                        modal.hidden = false;
                    }
                });
                newProjectModalObserver.observe(modal, { attributes: true, attributeFilter: ['style', 'hidden'] });
            } catch (e) {
            }
        }

        function stopNewProjectModalGuard() {
            try {
                if (newProjectModalObserver) newProjectModalObserver.disconnect();
                newProjectModalObserver = null;
            } catch (e) {}
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadSelectedTemplatesFromStorage();
            loadProjects();
            loadPhases(); // フェーズを読み込み
            loadDashboard();
            loadImportantTasks();
            loadNotifications();
            startNotificationCheck();
            
            // イベントリスナーを設定
            const refreshImportantTasksBtn = document.getElementById('refreshImportantTasksBtn');
            if (refreshImportantTasksBtn) {
                refreshImportantTasksBtn.addEventListener('click', refreshImportantTasks);
            }
            
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                notificationBtn.addEventListener('click', toggleNotifications);
            }
            
            // タスク追加ボタン
            const addTaskBtn = document.getElementById('addTaskBtn');
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', openAddTaskModal);
            }
            
            // プロジェクト編集ボタン
            const editProjectBtn = document.getElementById('editProjectBtn');
            if (editProjectBtn) {
                editProjectBtn.addEventListener('click', openEditProjectModal);
            }
            
            // プロジェクト削除ボタン
            const deleteProjectBtn = document.getElementById('deleteProjectBtn');
            if (deleteProjectBtn) {
                deleteProjectBtn.addEventListener('click', openDeleteProjectModal);
            }
            
            // 一度開いていた場合は再表示
            if (localStorage.getItem('newProjectModalOpen') === 'true') {
                // 必要データ読み込み後に復元
                Promise.allSettled([loadClients(), loadPhases(), loadTemplates()]).then(() => {
                    loadNewProjectDraft();
                    document.getElementById('newProjectModal').style.display = 'block';
                    startNewProjectModalGuard();
                });
            }
            loadUserInfo();
        });


        // デフォルトユーザー情報設定
        function setDefaultUserInfo() {
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            if (userName) userName.textContent = 'ゲスト';
            if (userRole) userRole.textContent = 'ゲスト';
            updateRoleBasedVisibility('guest');
        }

        // ユーザー情報読み込み
        async function loadUserInfo() {
            try {
                
                // まず専用のプロフィールエンドポイントを試す
                const response = await fetch('api.php?path=user/profile&t=' + Date.now(), { cache: 'no-store' });
                const data = await response.json();
                
                
                if (data.success && data.name) {
                    const userName = document.getElementById('userName');
                    const userRole = document.getElementById('userRole');
                    
                    if (userName) userName.textContent = data.name;
                    if (userRole) userRole.textContent = getRoleText(data.role || 'guest');
                    
                    // 設定ボタン表示制御
                    const settingsBtn = document.getElementById('settingsBtn');
                    if (settingsBtn) settingsBtn.style.display = (data.role === 'manager' || data.role === 'technical') ? 'inline-block' : 'none';
                    updateRoleBasedVisibility(data.role);
                } else {
                    // 未認証の場合はログインページにリダイレクト
                    window.location.href = 'login.html?message=' + encodeURIComponent('ログインが必要です');
                    return;
                }
            } catch (error) {
                // エラーの場合もログインページにリダイレクト
                window.location.href = 'login.html?message=' + encodeURIComponent('認証エラーが発生しました');
                return;
            }
        }

        // 代替ユーザー情報読み込み（削除 - セキュリティのため）

        // 役職名変換
        function getRoleText(role) {
            switch(role) {
                case 'manager': return '管理者';
                case 'technical': return '技術者';
                case 'general': return '一般';
                default: return 'ゲスト';
            }
        }

        // 役割に応じてプロジェクト操作ボタンを制御
        function updateRoleBasedVisibility(role) {
            const isGeneralOrGuest = !role || role === 'general' || role === 'guest';
            const createBtn = document.getElementById('newProjectBtn');
            const editBtn = document.getElementById('editProjectBtn');
            const deleteBtn = document.getElementById('deleteProjectBtn');
            if (createBtn) createBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
            if (editBtn) editBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
            if (deleteBtn) deleteBtn.style.display = isGeneralOrGuest ? 'none' : 'inline-block';
        }

        // プロジェクト一覧読み込み
        async function loadProjects() {
            try {
                
                // ソート・フィルタパラメータの取得
                const sortBy = document.getElementById('sortBy')?.value || 'created_at';
                const sortOrder = document.getElementById('sortOrder')?.value || 'DESC';
                const statusFilter = document.getElementById('statusFilter')?.value || '';
                
                const params = new URLSearchParams({
                    sort_by: sortBy,
                    sort_order: sortOrder,
                    t: Date.now()
                });
                
                if (statusFilter) {
                    params.append('status_filter', statusFilter);
                }
                
                const apiUrl = `api.php?path=projects&${params.toString()}`;
                
                const response = await fetch(apiUrl, { cache: 'no-store' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseText = await response.text();
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error('APIからの応答がJSON形式ではありません');
                }
                
                
                if (data.success && data.projects) {
                    populateProjectList(data.projects);
                    updateProjectStats(data.projects);
                } else {
                    showMessage('プロジェクトの読み込みに失敗しました: ' + (data.message || '不明なエラー'), 'error');
                }
            } catch (error) {
                showMessage('プロジェクトの読み込み中にエラーが発生しました: ' + error.message, 'error');
            }
        }

        // プロジェクト一覧を表示
        function populateProjectList(projects) {
            const container = document.getElementById('projectList');
            if (!container) {
                return;
            }
            
            if (projects.length === 0) {
                container.innerHTML = '<div class="empty">プロジェクトがありません</div>';
                return;
            }

            const html = projects.map(project => `
                <div class="project-item" data-project-id="${project.id}">
                    <div class="project-item-name">${project.name}</div>
                    <div class="project-item-meta">
                        <span>${project.total_tasks || 0}タスク</span>
                        <span class="project-item-status ${project.status}">${getStatusText(project.status)}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
            
            // プロジェクト項目にクリックイベントリスナーを追加
            container.querySelectorAll('.project-item').forEach(item => {
                item.addEventListener('click', function() {
                    const projectId = this.getAttribute('data-project-id');
                    selectProject(parseInt(projectId));
                });
            });
            
            // 保存されたプロジェクトを復元
            const savedProjectId = localStorage.getItem('selectedProjectId');
            if (savedProjectId) {
                // 保存されたプロジェクトが存在するかチェック
                const projectExists = projects.some(project => project.id == savedProjectId);
                if (projectExists) {
                    // プロジェクトを自動的に読み込み
                    selectProject(savedProjectId);
                } else {
                    // 存在しないプロジェクトの場合はローカルストレージをクリア
                    localStorage.removeItem('selectedProjectId');
                }
            }
            
        }

        // プロジェクト選択
        function selectProject(projectId) {
            // 選択状態を更新
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedItem = document.querySelector(`[data-project-id="${projectId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // 表示を切り替え
            const noProjectSelected = document.getElementById('noProjectSelected');
            const projectInfo = document.getElementById('projectInfo');
            const taskSection = document.getElementById('taskSection');
            
            if (noProjectSelected) noProjectSelected.style.display = 'none';
            if (projectInfo) projectInfo.style.display = 'block';
            if (taskSection) taskSection.style.display = 'block';
            
            // プロジェクトを読み込み
            loadProject(projectId);
            
            // ダッシュボードを更新
            updateDashboardForCurrentProject();
            
            // 選択したプロジェクトをローカルストレージに保存
            localStorage.setItem('selectedProjectId', projectId);
        }

        // プロジェクト読み込み
        async function loadProject(projectId) {
            try {
                showLoading();
                
                // プロジェクト詳細、タスク、フェーズを並行取得
                const [projectResponse, tasksResponse, phasesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${projectId}&t=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`api.php?path=projects/${projectId}/tasks&t=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`api.php?path=phases&t=${Date.now()}`, { cache: 'no-store' })
                ]);

                const [projectData, tasksData, phasesData] = await Promise.all([
                    projectResponse.json(),
                    tasksResponse.json(),
                    phasesResponse.json()
                ]);


                if (projectData.success && projectData.project) {
                    currentProject = projectData.project;
                    displayProject(currentProject);
                    
                    if (phasesData.success && phasesData.phases) {
                        allPhases = phasesData.phases;
                        setupPhaseFilters(allPhases);
                    }
                    
                    if (tasksData.success && tasksData.tasks) {
                        console.log('タスクデータ取得成功:', tasksData.tasks.length, '件');
                        allTasks = tasksData.tasks;
                        filteredTasks = [...allTasks]; // 直接コピー
                        displayTasks(filteredTasks);
                        updateProgress();
                    } else {
                        console.log('タスクデータ取得失敗:', tasksData);
                        allTasks = [];
                        filteredTasks = [];
                        displayTasks([]);
                        updateProgress();
                    }
                    
                    showProjectInfo();
                } else {
                    showMessage('プロジェクトの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                showMessage('プロジェクトの読み込み中にエラーが発生しました', 'error');
            } finally {
                hideLoading();
            }
        }


        // プロジェクト情報表示
        function displayProject(project) {
            const projectName = document.getElementById('projectName');
            const projectPeriod = document.getElementById('projectPeriod');
            const projectStatus = document.getElementById('projectStatus');
            
            if (projectName) projectName.textContent = project.name || '不明なプロジェクト';
            if (projectPeriod) {
                const end = project.end_date || project.target_end_date || '';
                projectPeriod.textContent = `期間: ${formatDate(project.start_date)} - ${formatDate(end)}`;
            }
            if (projectStatus) projectStatus.textContent = getStatusText(project.status);
            
            // プロジェクト情報を表示
            showProjectInfo();
        }

        // プロジェクト情報表示/非表示
        function showProjectInfo() {
            const projectInfo = document.getElementById('projectInfo');
            const taskSection = document.getElementById('taskSection');
            
            if (projectInfo) projectInfo.style.display = 'block';
            if (taskSection) taskSection.style.display = 'block';
        }

        function hideProjectInfo() {
            const projectInfo = document.getElementById('projectInfo');
            const taskSection = document.getElementById('taskSection');
            
            if (projectInfo) projectInfo.style.display = 'none';
            if (taskSection) taskSection.style.display = 'none';
            currentProject = null;
            allTasks = [];
            filteredTasks = [];
        }

        // フェーズフィルター設定（現在の選択を維持）
        function setupPhaseFilters(phases) {
            console.log('setupPhaseFilters呼び出し:', phases);
            const filtersContainer = document.getElementById('taskFilters');
            if (!filtersContainer) {
                console.log('taskFilters要素が見つかりません');
                return;
            }
            
            filtersContainer.innerHTML = '';

            if (phases.length > 0) {
                console.log('フェーズ数:', phases.length);
                // 直近の選択を優先（ローカル保存があればそれも考慮）
                const savedPhaseId = localStorage.getItem('currentPhaseFilter');
                let desiredPhaseId = currentPhaseFilter || savedPhaseId || 'all';
                const exists = phases.some(p => String(p.id) === String(desiredPhaseId));
                if (!exists && desiredPhaseId !== 'all') {
                    desiredPhaseId = 'all';
                }
                currentPhaseFilter = desiredPhaseId;

                // 「すべて」フィルターボタンを追加
                const allBtn = document.createElement('button');
                allBtn.className = currentPhaseFilter === 'all' ? 'filter-btn active' : 'filter-btn';
                allBtn.textContent = 'すべて';
                allBtn.onclick = () => filterByPhase('all');
                filtersContainer.appendChild(allBtn);

                // 各フェーズフィルター
                phases.forEach((phase) => {
                    const btn = document.createElement('button');
                    btn.className = String(phase.id) === String(currentPhaseFilter) ? 'filter-btn active' : 'filter-btn';
                    btn.textContent = phase.name;
                    btn.onclick = () => filterByPhase(phase.id);
                    filtersContainer.appendChild(btn);
                });
            }
        }

        // フェーズによるフィルタリング
        function filterByPhase(phaseId) {
            currentPhaseFilter = phaseId;
            try { localStorage.setItem('currentPhaseFilter', String(phaseId)); } catch (e) {}
            
            // フィルターボタンのアクティブ状態更新
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // 現在のボタンにactiveを付与
            const buttons = Array.from(document.querySelectorAll('.filter-btn'));
            const idx = buttons.findIndex(b => b.textContent === (allPhases.find(p => String(p.id) === String(phaseId))?.name));
            if (idx >= 0) {
                buttons[idx].classList.add('active');
            }

            displayTasks(filteredTasks);
        }

        // タスク表示
        function displayTasks(tasks) {
            console.log('displayTasks呼び出し:', tasks ? tasks.length : 'null', '件');
            const taskList = document.getElementById('taskList');
            
            if (!taskList) {
                console.log('taskList要素が見つかりません');
                return;
            }
            
            if (!tasks || tasks.length === 0) {
                console.log('タスクが空のため空メッセージを表示');
                taskList.innerHTML = '<div class="empty">タスクがありません</div>';
                return;
            }

            // フェーズによるフィルタリング
            let filteredByPhase = tasks;
            console.log('現在のフェーズフィルター:', currentPhaseFilter);
            if (currentPhaseFilter !== 'all') {
                filteredByPhase = tasks.filter(task => {
                    const phase = allPhases.find(p => p.name === task.phase_name);
                    return phase && phase.id == currentPhaseFilter;
                });
                console.log('フィルタリング後:', filteredByPhase.length, '件');
            } else {
                console.log('すべてのタスクを表示');
            }

            // フェーズごとにグループ化
            const tasksByPhase = {};
            filteredByPhase.forEach(task => {
                const phaseName = task.phase_name || '未分類';
                if (!tasksByPhase[phaseName]) {
                    tasksByPhase[phaseName] = [];
                }
                tasksByPhase[phaseName].push(task);
            });

            // フェーズごとに表示
            taskList.innerHTML = '';
            Object.entries(tasksByPhase).forEach(([phaseName, phaseTasks]) => {
                // 空のフェーズは表示しない
                if (phaseTasks.length === 0) {
                    return;
                }
                
                const phaseContainer = document.createElement('div');
                phaseContainer.className = 'phase-container';
                
                const phaseTitle = document.createElement('h3');
                phaseTitle.textContent = `${phaseName} (${phaseTasks.length})`;
                phaseContainer.appendChild(phaseTitle);
                
                const taskGrid = document.createElement('div');
                taskGrid.className = 'task-list';
                
                // タスクを順序でソート
                phaseTasks.sort((a, b) => (a.task_order || 0) - (b.task_order || 0));
                
                phaseTasks.forEach(task => {
                    const taskItem = createTaskItem(task);
                    taskGrid.appendChild(taskItem);
                });
                
                phaseContainer.appendChild(taskGrid);
                taskList.appendChild(phaseContainer);
            });

        }

        // タスクアイテム作成
        function createTaskItem(task) {
            const item = document.createElement('div');
            item.className = `task-item status-${task.status || 'not_started'}`;
            item.setAttribute('data-task-id', task.id);
            item.onclick = () => editTask(task.id);
            
            const isOverdue = task.planned_date && new Date(task.planned_date) < new Date() && task.status !== 'completed';
            const isNeedsConfirmation = task.status === 'needs_confirmation';
            
            // 要確認の場合の確認対象者を取得
            const confirmationTarget = isNeedsConfirmation ? getConfirmationTarget(task) : '';
            
            // 要確認ステータスの場合、直接スタイルを適用
            if (isNeedsConfirmation) {
                item.style.background = 'linear-gradient(135deg, #fff5f5, #ffe6e6)';
                item.style.border = '3px solid #ff0000';
                item.style.borderLeft = '6px solid #ff0000';
                item.style.boxShadow = '0 4px 15px rgba(255, 0, 0, 0.4)';
                item.style.transform = 'scale(1.02)';
                item.style.position = 'relative';
                item.style.zIndex = '10';
            }

            // そのほかのステータスのカード色を明示（CSS未適用環境対策）
            if (!isNeedsConfirmation) {
                switch (task.status) {
                    case 'not_started':
                        item.style.background = '#f8f9fa';
                        item.style.borderLeft = '4px solid #6c757d';
                        break;
                    case 'in_progress':
                        item.style.background = '#fff8e1';
                        item.style.borderLeft = '4px solid #ffc107';
                        break;
                    case 'completed':
                        item.style.background = '#eaf7ee';
                        item.style.borderLeft = '4px solid #28a745';
                        break;
                    case 'not_applicable':
                        item.style.background = '#f1f3f5';
                        item.style.borderLeft = '4px solid #adb5bd';
                        item.style.opacity = '0.95';
                        break;
                    case 'pending':
                        item.style.background = '#fff3e0';
                        item.style.borderLeft = '4px solid #ff9800';
                        item.style.border = '2px solid #ff9800';
                        item.style.boxShadow = '0 4px 15px rgba(255, 152, 0, 0.3)';
                        break;
                }
            }
            
            item.innerHTML = `
                ${isNeedsConfirmation ? '<div style="position: absolute; top: -12px; right: 8px; background: #ff0000; color: white; padding: 6px 16px; border-radius: 16px; font-size: 0.8rem; font-weight: 700; box-shadow: 0 4px 8px rgba(255, 0, 0, 0.5); z-index: 1000; border: 2px solid white;">⚠️ 要確認</div>' : ''}
                <div class="task-header">
                    <h4 class="task-title">${task.task_name || task.name}</h4>
                    <div class="task-status-group">
                        <span class="task-status status-${task.status || 'not_started'}">${getStatusText(task.status || 'not_started')}</span>
                        ${isOverdue ? '<span class="task-overdue">遅延</span>' : ''}
                    </div>
                </div>
                ${isNeedsConfirmation ? `
                <div style="background: rgba(255, 0, 0, 0.15); border: 2px solid #ff0000; border-radius: 12px; padding: 12px 16px; margin: 12px 0; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(255, 0, 0, 0.2);">
                    <span style="font-size: 1rem; color: #ff0000; font-weight: 700;">確認対象:</span>
                    <span style="font-size: 1.1rem; color: #cc0000; font-weight: 800; background: rgba(255, 0, 0, 0.3); padding: 4px 12px; border-radius: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${confirmationTarget}</span>
                </div>
                ` : ''}
                <div class="task-meta">
                    <div class="task-meta-row">
                        <div class="task-assignee">
                            <span class="icon-user"></span>
                            ${task.assigned_to_name || '未割当'}
                        </div>
                        <div class="task-date ${isOverdue ? 'overdue' : ''}">
                            <span class="icon-calendar"></span>
                            ${task.planned_date ? formatDate(task.planned_date) : '期限なし'}
                        </div>
                    </div>
                    <div class="task-flags">
                        ${task.is_technical_work == '1' ? '<span class="flag technical">技術作業</span>' : ''}
                        ${task.has_manual == '1' ? '<span class="flag manual">📚 マニュアルあり</span>' : ''}
                    </div>
                </div>
            `;
            
            return item;
        }

        // タスク編集
        async function editTask(taskId) {
            try {
                console.log('editTask呼び出し:', taskId);
                
                // ユーザー一覧を先に読み込む
                await loadUsers();
                
                // タスクを検索（filteredTasksとallTasksの両方を確認）
                let task = filteredTasks.find(t => t.id == taskId);
                if (!task) {
                    task = allTasks.find(t => t.id == taskId);
                }
                
                if (!task) {
                    console.log('タスクが見つかりません:', taskId);
                    showMessage('タスクが見つかりません', 'error');
                    return;
                }
                
                console.log('タスクが見つかりました:', task);


                // タスク詳細を取得
                console.log('タスク詳細を取得中:', taskId);
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('タスク詳細取得結果:', data);
                
                if (data.success && data.task) {
                    const taskData = data.task;
                    // モーダルにデータを設定
                    
                    document.getElementById('taskId').value = taskData.id;
                    
                    document.getElementById('taskTitle').textContent = taskData.task_name || taskData.name;
                    
                    // ステータス設定
                    const statusValue = taskData.status || 'not_started';
                    document.getElementById('taskStatus').value = statusValue;
                    
                    // 期限フィールドの設定
                    const plannedDate = taskData.planned_date || '';
                    document.getElementById('taskDueDate').value = plannedDate;
                    
                    document.getElementById('taskContentDisplay').textContent = taskData.template_content || '内容なし';
                    
                    // メタ情報表示
                    document.getElementById('taskPhase').textContent = task.phase_name || '未分類';
                    document.getElementById('taskOrder').textContent = task.task_order || '0';
                    document.getElementById('taskTechnical').textContent = task.is_technical_work == '1' ? 'はい' : 'いいえ';
                    document.getElementById('taskManualInfo').textContent = task.has_manual == '1' ? 'あり' : 'なし';
                    await loadTaskManuals(taskData.task_name || taskData.name);
                    
                    // 担当者設定（ユーザー読み込み後に設定）
                    if (taskData.assigned_to) {
                        document.getElementById('taskAssignee').value = taskData.assigned_to;
                    } else {
                        document.getElementById('taskAssignee').value = '';
                    }
                    
                    // メモ履歴読み込み
                    await loadTaskNotes(taskId);
                    
                    // メンション機能のイベントリスナー設定
                    setupNoteInputEvents();
                    
                    // モーダル表示
                    document.getElementById('taskModal').style.display = 'block';
                } else {
                    console.error('タスク詳細の読み込みに失敗:', data);
                    showMessage('タスク詳細の読み込みに失敗しました: ' + (data.message || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('タスク編集中のエラー:', error);
                showMessage('タスク編集中にエラーが発生しました: ' + error.message, 'error');
            }
        }

        // ユーザー一覧読み込み
        async function loadUsers() {
            try {
                const taskAssigneeSelect = document.getElementById('taskAssignee');
                const currentValue = taskAssigneeSelect.value; // 現在の値を保存
                
                
                const response = await fetch('api.php?path=users');
                const data = await response.json();
                
                
                if (data.success && data.users) {
                    allUsers = data.users;
                    
                    // ドロップダウンを再構築
                    taskAssigneeSelect.innerHTML = '<option value="">未割当</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        taskAssigneeSelect.appendChild(option);
                    });
                    
                    // 保存していた値を復元
                    if (currentValue) {
                        taskAssigneeSelect.value = currentValue;
                    }
                    
            } else {
                }
            } catch (error) {
            }
        }

        // タスクメモ読み込み
        async function loadTaskNotes(taskId) {
            try {
                const response = await fetch(`api.php?path=tasks/${taskId}/notes&t=${Date.now()}`, { cache: 'no-store' });
                const data = await response.json();
                
                
                const notesHistory = document.getElementById('notesHistory');
                
                if (data.success && data.notes && data.notes.length > 0) {
                    notesHistory.innerHTML = '';
                    data.notes.forEach((note, index) => {
                        const noteItem = document.createElement('div');
                        noteItem.className = 'note-item';
                        noteItem.setAttribute('data-note-id', note.id);
                        noteItem.innerHTML = `
                            <div class="note-header">
                                <div class="note-info">
                                    <span class="note-user">${note.user_name || '不明'}</span>
                                    <span class="note-date">${formatDateTime(note.created_at)}</span>
                                </div>
                                <div class="note-actions">
                                    <button type="button" class="btn-edit-note" onclick="editNote(${note.id})" title="編集">✏️</button>
                                    <button type="button" class="btn-delete-note" onclick="deleteNote(${note.id})" title="削除">🗑️</button>
                                </div>
                            </div>
                            <div class="note-content" id="note-content-${note.id}">${formatNoteContent(note.note)}</div>
                            <div class="note-edit-form" id="note-edit-${note.id}" style="display: none;">
                                <textarea class="note-edit-textarea" id="note-edit-text-${note.id}">${note.note}</textarea>
                                <div class="note-edit-actions">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="saveNoteEdit(${note.id})">保存</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="cancelNoteEdit(${note.id})">キャンセル</button>
                                </div>
                            </div>
                        `;
                        notesHistory.appendChild(noteItem);
                    });
            } else {
                    notesHistory.innerHTML = '<div class="note-item">メモはありません</div>';
                }
            } catch (error) {
                document.getElementById('notesHistory').innerHTML = '<div class="note-item">メモの読み込みに失敗しました</div>';
            }
        }

        // タスク名に紐づくマニュアル一覧を読み込み、表示/ダウンロードリンクを生成
        async function loadTaskManuals(taskName) {
            try {
                const linksWrap = document.getElementById('taskManualLinks');
                const list = document.getElementById('taskManualList');
                if (!linksWrap || !list) return;

                // タスク名でフィルタして取得（DBから確実に該当データのみ）
                const q = encodeURIComponent(taskName || '');
                const res = await fetch(`api.php?path=manuals&task_name=${q}&t=${Date.now()}`, { cache: 'no-store' });
                const data = await res.json();
                if (!data.success || !Array.isArray(data.manuals)) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                    return;
                }

                const manuals = data.manuals;
                if (manuals.length === 0) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                    return;
                }

                list.innerHTML = manuals.map(m => {
                    const id = m.id;
                    const name = m.original_name || m.file_name;
                    const sizeKb = m.file_size ? Math.round(m.file_size / 1024) + 'KB' : '';
                    const viewUrl = `api.php?path=admin/manuals/${id}`;
                    const dlUrl = `api.php?path=admin/manuals/${id}&download=1`;
                    return `
                        <div class="manual-link" style="margin:4px 0;">
                            <a href="${viewUrl}" target="_blank" rel="noopener">📄 表示</a>
                            <span style="margin: 0 6px; color:#adb5bd;">|</span>
                            <a href="${dlUrl}">⬇︎ ダウンロード</a>
                            <span style="margin-left:8px; color:#6c757d;">${name}${sizeKb ? ' ('+sizeKb+')' : ''}</span>
                        </div>`;
                }).join('');
                linksWrap.style.display = 'block';
            } catch (e) {
                const linksWrap = document.getElementById('taskManualLinks');
                const list = document.getElementById('taskManualList');
                if (linksWrap && list) {
                    linksWrap.style.display = 'none';
                    list.innerHTML = '';
                }
            }
        }

        // メンション機能の変数
        let mentionStartPos = -1;
        let currentMentionQuery = '';
        let selectedSuggestionIndex = -1;

        // メモ入力のイベントリスナー設定
        function setupNoteInputEvents() {
            const noteInput = document.getElementById('newNote');
            if (noteInput) {
                noteInput.addEventListener('input', handleNoteInput);
                noteInput.addEventListener('keydown', handleNoteKeydown);
                
                // blurイベントを遅延実行して、候補リストのクリックを妨げないようにする
                noteInput.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        hideUserSuggestions();
                    }, 150);
                });
            }
        }

        // メモ入力の処理
        function handleNoteInput(event) {
            const textarea = event.target;
            const cursorPos = textarea.selectionStart;
            const text = textarea.value;
            
            // @で始まる文字列を検索（日本語文字も含む）
            const mentionMatch = text.substring(0, cursorPos).match(/@([^\s]*)$/);
            
            if (mentionMatch) {
                mentionStartPos = cursorPos - mentionMatch[0].length;
                currentMentionQuery = mentionMatch[1];
                showUserSuggestions(currentMentionQuery, mentionStartPos);
            } else {
                hideUserSuggestions();
            }
        }

        // キーボードイベントの処理
        function handleNoteKeydown(event) {
            const suggestions = document.getElementById('userSuggestions');
            if (suggestions.style.display === 'none') return;

            const suggestionItems = suggestions.querySelectorAll('.suggestion-item');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                    updateSuggestionSelection();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSuggestionSelection();
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (selectedSuggestionIndex >= 0) {
                        selectUserSuggestion(suggestionItems[selectedSuggestionIndex]);
                    }
                    break;
                case 'Escape':
                    hideUserSuggestions();
                    break;
            }
        }

        // ユーザー候補の表示
        function showUserSuggestions(query, position) {
            const suggestions = document.getElementById('userSuggestions');
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase())
            );


            if (filteredUsers.length === 0) {
                hideUserSuggestions();
                return;
            }

            suggestions.innerHTML = '';
            filteredUsers.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.setAttribute('data-user-name', user.name);
                item.innerHTML = `
                    <span class="user-name">${user.name}</span>
                    <span class="user-role">${getRoleText(user.role)}</span>
                `;
                
                // より確実なクリックイベントの実装
                item.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectUserSuggestion(item);
                });
                
                // タッチイベントも追加（モバイル対応）
                item.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectUserSuggestion(item);
                });
                
                suggestions.appendChild(item);
            });
            
            // イベント委譲も追加
            suggestions.addEventListener('click', (e) => {
                const item = e.target.closest('.suggestion-item');
                if (item) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectUserSuggestion(item);
                }
            });

            selectedSuggestionIndex = 0;
            updateSuggestionSelection();
            suggestions.style.display = 'block';
        }

        // 候補選択の更新
        function updateSuggestionSelection() {
            const suggestions = document.getElementById('userSuggestions');
            const items = suggestions.querySelectorAll('.suggestion-item');
            
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedSuggestionIndex);
            });
        }

        // ユーザー候補の選択
        function selectUserSuggestion(selectedItem) {
            const textarea = document.getElementById('newNote');
            const userName = selectedItem.getAttribute('data-user-name') || selectedItem.querySelector('.user-name').textContent;
            const currentPos = textarea.selectionStart;
            const beforeMention = textarea.value.substring(0, mentionStartPos);
            const afterMention = textarea.value.substring(currentPos);
            
            
            // メンション部分を置き換え
            const newValue = beforeMention + '@' + userName + ' ' + afterMention;
            textarea.value = newValue;
            
            // カーソル位置を調整（メンションの後に配置）
            const newCursorPos = beforeMention.length + userName.length + 2;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            
            
            // メンションが追加された場合、要確認ステータスに自動変更
            const statusSelect = document.getElementById('taskStatus');
            if (statusSelect && statusSelect.value !== 'needs_confirmation') {
                statusSelect.value = 'needs_confirmation';
                
                // 視覚的なフィードバック
                statusSelect.style.backgroundColor = '#fff5f5';
                statusSelect.style.borderColor = '#ff6b6b';
                setTimeout(() => {
                    statusSelect.style.backgroundColor = '';
                    statusSelect.style.borderColor = '';
                }, 2000);
            } else {
            }
            
            hideUserSuggestions();
        }

        // ユーザー候補の非表示
        function hideUserSuggestions() {
            const suggestions = document.getElementById('userSuggestions');
            suggestions.style.display = 'none';
            selectedSuggestionIndex = -1;
        }

        // メモ内容のフォーマット（メンションをハイライト）
        function formatNoteContent(content) {
            if (!content) return '';
            
            // @ユーザー名 のパターンを検索してハイライト
            return content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        // メモ編集開始
        function editNote(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // 編集フォームを表示
            document.getElementById(`note-edit-${noteId}`).style.display = 'block';
            document.getElementById(`note-content-${noteId}`).style.display = 'none';
            
            // テキストエリアにフォーカス
            const textarea = document.getElementById(`note-edit-text-${noteId}`);
            textarea.focus();
            textarea.select();
        }

        // メモ編集キャンセル
        function cancelNoteEdit(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // 編集フォームを非表示
            document.getElementById(`note-edit-${noteId}`).style.display = 'none';
            document.getElementById(`note-content-${noteId}`).style.display = 'block';
        }

        // メモ編集保存
        async function saveNoteEdit(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const content = document.getElementById(`note-edit-text-${noteId}`).value.trim();
            
            
            if (!content) {
                showMessage('メモ内容を入力してください', 'error');
                return;
            }
            
            try {
                const requestData = {
                    note: content
                };
                
                const response = await fetch(`api.php?path=notes/${noteId}&t=${Date.now()}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 即座にメモ内容を更新
                    document.getElementById(`note-content-${noteId}`).innerHTML = formatNoteContent(content);
                    
                    // 編集フォームを非表示
                    document.getElementById(`note-edit-${noteId}`).style.display = 'none';
                    document.getElementById(`note-content-${noteId}`).style.display = 'block';
                    
                    showMessage('メモを更新しました', 'success');
                } else {
                    showMessage('メモの更新に失敗しました: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                showMessage('メモの更新中にエラーが発生しました', 'error');
            }
        }

        // メモ削除
        async function deleteNote(noteId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (!confirm('このメモを削除しますか？')) {
                return;
            }
            
            try {
                
                const response = await fetch(`api.php?path=notes/${noteId}&t=${Date.now()}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 即座にメモ要素を削除（アニメーション付き）
                    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
                    if (noteElement) {
                        // フェードアウトアニメーション
                        noteElement.style.transition = 'all 0.3s ease';
                        noteElement.style.opacity = '0';
                        noteElement.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            noteElement.remove();
                        }, 300);
                    }
                    
                    showMessage('メモを削除しました', 'success');
                } else {
                    showMessage('メモの削除に失敗しました: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                showMessage('メモの削除中にエラーが発生しました', 'error');
            }
        }

        // メモ追加
        async function addNote(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const taskId = document.getElementById('taskId').value;
            const content = document.getElementById('newNote').value.trim();
            
            
            if (!content) {
                showMessage('メモ内容を入力してください', 'error');
                return;
            }
            
            if (!taskId) {
                showMessage('タスクIDが取得できません', 'error');
                return;
            }
            
            try {
                const requestData = {
                    note: content
                };
                
                const response = await fetch(`api.php?path=tasks/${taskId}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    
                    // 入力フィールドをクリア
                    document.getElementById('newNote').value = '';
                    
                    // 即座にUIに新しいメモを追加
                    addMemoToUI(content, data.note_id || Date.now());
                    
                    showMessage('メモを追加しました', 'success');
                } else {
                    showMessage('メモの追加に失敗しました: ' + (data.error || data.message), 'error');
                }
            } catch (error) {
                showMessage('メモの追加中にエラーが発生しました', 'error');
            }
        }

        // タスク保存（リトライ機能付き）
        async function saveTask(retryCount = 0) {
            const maxRetries = 3;
            
            // 重複実行防止
            if (window.isSavingTask) {
                return;
            }
            
            window.isSavingTask = true;
            
            try {
                const taskId = document.getElementById('taskId').value;
                
                if (!taskId) {
                    showMessage('タスクIDが取得できません', 'error');
                    return;
                }
                
                // 各フィールドの値を個別に取得・確認
                const statusValue = document.getElementById('taskStatus').value;
                const assigneeValue = document.getElementById('taskAssignee').value;
                const dateValue = document.getElementById('taskDueDate').value;
                
                
                const formData = {
                    task_id: taskId,
                    status: statusValue,
                    assigned_to: assigneeValue || null,
                    planned_date: dateValue || null
                };


                // 保存ボタンを無効化
                const saveButton = document.querySelector('button[onclick="saveTask()"]');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = '保存中...';
                }

                // リクエストタイムアウトを設定
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒タイムアウト

                // ステータスのみの更新の場合は専用エンドポイントを使用
                const isStatusOnlyUpdate = formData.status && !formData.assigned_to && !formData.planned_date;
                const endpoint = isStatusOnlyUpdate ? 'tasks/status' : 'tasks/update';
                const method = isStatusOnlyUpdate ? 'POST' : 'PUT';
                
                
                const response = await fetch(`api.php?path=${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    showMessage('タスクを更新しました', 'success');
                    
                    // APIレスポンスから直接ステータスを取得
                    const responseStatus = data.task?.status || statusValue;
                    
                    // タスクカードの表示を即座に更新（プロジェクト再読み込み前）
                    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        const finalStatus = responseStatus || statusValue || 'not_started';
                        
                        // タスクカード全体のクラス名を更新
                        taskCard.className = `task-item status-${finalStatus}`;
                        
                        // 保留中ステータスの場合、直接スタイルを適用
                        if (finalStatus === 'pending') {
                            taskCard.style.background = '#fff3e0 !important';
                            taskCard.style.borderLeft = '4px solid #ff9800 !important';
                            taskCard.style.border = '2px solid #ff9800 !important';
                            taskCard.style.boxShadow = '0 4px 15px rgba(255, 152, 0, 0.3) !important';
                            taskCard.style.transform = 'scale(1.02) !important';
                            taskCard.style.position = 'relative !important';
                            taskCard.style.zIndex = '5 !important';
                            taskCard.setAttribute('style', taskCard.getAttribute('style') + '; background: #fff3e0 !important; border-left: 4px solid #ff9800 !important; border: 2px solid #ff9800 !important; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3) !important; transform: scale(1.02) !important; position: relative !important; z-index: 5 !important;');
                        }
                        
                        const statusElement = taskCard.querySelector('.task-status');
                        if (statusElement) {
                            // ステータス要素を強制的に更新
                            statusElement.className = `task-status status-${finalStatus}`;
                            statusElement.textContent = getStatusText(finalStatus);
                        }
                    }
                    
                    closeTaskModal();
                    
                    // プロジェクトデータを再読み込み
                    if (currentProject) {
                        await loadProject(currentProject.id);
                    }
                } else {
                    throw new Error(data.error || data.message || 'Unknown error');
                }
            } catch (error) {
                if (retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1))); // 指数バックオフ
                    return saveTask(retryCount + 1);
                } else {
                    showMessage('タスクの保存に失敗しました: ' + error.message, 'error');
                }
            } finally {
                // 保存ボタンを復元
                const saveButton = document.querySelector('button[onclick="saveTask()"]');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = '保存';
                }
                
                // フラグをリセット
                window.isSavingTask = false;
            }
        }

        // 進捗更新
        function updateProgress() {
            if (!filteredTasks || filteredTasks.length === 0) {
                const totalTasksEl = document.getElementById('totalTasks');
                const notStartedTasksEl = document.getElementById('notStartedTasks');
                const completedTasksEl = document.getElementById('completedTasks');
                const inProgressTasksEl = document.getElementById('inProgressTasks');
                const needsConfirmationTasksEl = document.getElementById('needsConfirmationTasks');
                const overdueTasksEl = document.getElementById('overdueTasks');
                const progressFillEl = document.getElementById('progressFill');
                const progressTextEl = document.getElementById('progressText');
                
                if (totalTasksEl) totalTasksEl.textContent = '0';
                if (notStartedTasksEl) notStartedTasksEl.textContent = '0';
                if (completedTasksEl) completedTasksEl.textContent = '0';
                if (inProgressTasksEl) inProgressTasksEl.textContent = '0';
                if (needsConfirmationTasksEl) needsConfirmationTasksEl.textContent = '0';
                if (overdueTasksEl) overdueTasksEl.textContent = '0';
                if (progressFillEl) progressFillEl.style.width = '0%';
                if (progressTextEl) progressTextEl.textContent = '0%';
                return;
            }

            const total = filteredTasks.length;
            const notStarted = filteredTasks.filter(task => task.status === 'not_started').length;
            const completed = filteredTasks.filter(task => task.status === 'completed').length;
            const inProgress = filteredTasks.filter(task => task.status === 'in_progress').length;
            const needsConfirmation = filteredTasks.filter(task => task.status === 'needs_confirmation').length;
            const overdue = filteredTasks.filter(task => {
                return task.planned_date && new Date(task.planned_date) < new Date() && task.status !== 'completed';
            }).length;

            const progressPercent = total > 0 ? Math.round((completed / total) * 100) : 0;

            const totalTasksEl = document.getElementById('totalTasks');
            const notStartedTasksEl = document.getElementById('notStartedTasks');
            const completedTasksEl = document.getElementById('completedTasks');
            const inProgressTasksEl = document.getElementById('inProgressTasks');
            const overdueTasksEl = document.getElementById('overdueTasks');
            const progressFillEl = document.getElementById('progressFill');
            const progressTextEl = document.getElementById('progressText');
            
            if (totalTasksEl) totalTasksEl.textContent = total;
            if (notStartedTasksEl) notStartedTasksEl.textContent = notStarted;
            if (completedTasksEl) completedTasksEl.textContent = completed;
            if (inProgressTasksEl) inProgressTasksEl.textContent = inProgress;
            if (overdueTasksEl) overdueTasksEl.textContent = overdue;
            
            // 要確認タスクの表示（要素が存在する場合のみ）
            const needsConfirmationElement = document.getElementById('needsConfirmationTasks');
            if (needsConfirmationElement) {
                needsConfirmationElement.textContent = needsConfirmation;
            }
            if (progressFillEl) progressFillEl.style.width = `${progressPercent}%`;
            if (progressTextEl) progressTextEl.textContent = `${progressPercent}%`;
        }

        // 新規プロジェクトモーダル関連
        async function openNewProjectModal() {
            try {
                
                // クライアント、フェーズを並行読み込み
                await Promise.allSettled([
                    loadClients(),
                    loadPhases()
                ]);
                
                // ライブラリ化したテンプレート選択機能を初期化
                TemplateSelector.init({
                    containerId: 'newProjectModal',
                    mode: 'new_project',
                    onSelectionChange: function(selectedIds) {
                        selectedTemplateIds.clear();
                        selectedIds.forEach(id => selectedTemplateIds.add(id));
                        saveSelectedTemplatesToStorage();
                    }
                });
                
                
                // 発注者セレクトボックスが正しく設定されているか確認
                const clientSelect = document.getElementById('newProjectClient');
                if (clientSelect) {
                } else {
                }
                
                document.getElementById('newProjectModal').style.display = 'block';
                markNewProjectModalOpen(true);
                // 途中の下書きがあれば復元
                loadNewProjectDraft();
                startNewProjectModalGuard();
            } catch (error) {
                showMessage('モーダルの表示に失敗しました', 'error');
            }
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
            document.getElementById('newProjectForm').reset();
            markNewProjectModalOpen(false);
            stopNewProjectModalGuard();
        }

        // クライアント読み込み
        async function loadClients() {
            try {
                const response = await fetch(`api.php?path=clients&t=${Date.now()}`, { cache: 'no-store' });
                
                const data = await response.json();
                
                if (data.success && data.clients) {
                    allClients = data.clients;
                    populateClientSelect();
                } else {
                }
            } catch (error) {
            }
        }

        function populateClientSelect() {
            const selects = ['newProjectClient', 'editProjectClient'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">発注者を選択</option>';
                    allClients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        select.appendChild(option);
                    });
                } else {
                }
            });
        }

        // フェーズ読み込み
        async function loadPhases() {
            try {
                const response = await fetch(`api.php?path=phases&t=${Date.now()}`, { cache: 'no-store' });
                const data = await response.json();
                
                if (data.success && data.phases) {
                    allPhases = data.phases;
                    setupTemplateFilters();
                    // タスクフィルターも設定
                    setupPhaseFilters(allPhases);
                }
            } catch (error) {
                console.error('フェーズ読み込みエラー:', error);
            }
        }

        // テンプレートフィルター設定
        function setupTemplateFilters() {
            const filtersContainer = document.getElementById('templateFilters');
            if (!filtersContainer) {
                return;
            }
            
            filtersContainer.innerHTML = '';

            // 全体フィルターは非表示（最初のフェーズをデフォルト選択）
            if (allPhases.length > 0) {
                // 各フェーズフィルター
                allPhases.forEach((phase, index) => {
                    const btn = document.createElement('button');
                    btn.className = index === 0 ? 'filter-btn active' : 'filter-btn';
                    btn.textContent = phase.name;
                    btn.dataset.phaseId = phase.id;
                    btn.addEventListener('click', function() {
                        filterTemplates(parseInt(this.dataset.phaseId));
                    });
                    filtersContainer.appendChild(btn);
                });
                
                // 最初のフェーズのテンプレートを表示
                if (allTemplates.length > 0) {
                    filterTemplates(allPhases[0].id);
                }
            }
        }

        // テンプレート読み込み
        async function loadTemplates() {
            try {
                const response = await fetch(`api.php?path=templates&t=${Date.now()}`, { cache: 'no-store' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.templates) {
                    allTemplates = data.templates;
                    
                    // フェーズが既に読み込まれている場合は、最初のフェーズのテンプレートを表示
                    if (allPhases.length > 0) {
                        filterTemplates(allPhases[0].id);
                    } else {
                        displayTemplates(allTemplates);
                    }
                } else {
                    allTemplates = [];
                    displayTemplates([]);
                }
            } catch (error) {
                allTemplates = [];
                displayTemplates([]);
            }
        }

        // テンプレートフィルタリング
        function filterTemplates(phaseId) {
            // フェーズIDからフェーズ名を取得
            const phase = allPhases.find(p => p.id == phaseId);
            if (!phase) {
                console.error('Phase not found for ID:', phaseId);
                return;
            }
            
            const phaseName = phase.name;
            
            // フィルターボタンのアクティブ状態更新
            const filterBtns = document.querySelectorAll('#templateFilters .filter-btn');
            if (filterBtns.length > 0) {
                filterBtns.forEach(btn => {
                    btn.classList.remove('active');
                });
            }
            
            // クリックされたボタンをアクティブにする
            const clickedBtn = document.querySelector(`#templateFilters .filter-btn[data-phase-id="${phaseId}"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }

            // フェーズ名でテンプレートをフィルタリング
            const filtered = allTemplates.filter(template => template.phase_name === phaseName);
            displayTemplates(filtered);
        }

        // テンプレート表示
        function displayTemplates(templates) {
            const container = document.getElementById('templateGroups');
            
            if (!container) {
                console.error('Template container element not found');
                return;
            }
            
            container.innerHTML = '';

            if (!templates || templates.length === 0) {
                container.innerHTML = '<div class="empty">テンプレートがありません</div>';
                return;
            }

            // フェーズごとにグループ化
            const templatesByPhase = {};
            templates.forEach(template => {
                const phaseName = template.phase_name || '未分類';
                
                if (!templatesByPhase[phaseName]) {
                    templatesByPhase[phaseName] = [];
                }
                templatesByPhase[phaseName].push(template);
            });

            // フェーズごとに表示
            Object.entries(templatesByPhase).forEach(([phaseName, phaseTemplates]) => {
                const phaseGroup = document.createElement('div');
                phaseGroup.className = 'template-group';
                
                const phaseTitle = document.createElement('h5');
                phaseTitle.className = 'phase-title';
                phaseTitle.textContent = phaseName;
                phaseGroup.appendChild(phaseTitle);
                
                const templateItems = document.createElement('div');
                templateItems.className = 'template-items';
                
                phaseTemplates.forEach(template => {
                    const isSelected = selectedTemplateIds.has(template.id.toString());
                    
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.innerHTML = `
                        <label class="template-checkbox">
                            <input type="checkbox" name="templates" value="${template.id}" ${isSelected ? 'checked' : ''}>
                            <div class="template-info">
                                <div class="template-name">${template.task_name || 'テンプレート名なし'}</div>
                                <div class="template-content">${template.content || ''}</div>
                                <div class="template-flags">
                                    ${template.is_technical_work == '1' ? '<span class="flag technical">技術作業</span>' : ''}
                                    ${template.has_manual == '1' ? '<span class="flag manual">マニュアルあり</span>' : ''}
                                </div>
                            </div>
                        </label>
                    `;
                    
                    // チェックボックスの変更イベントを追加
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedTemplateIds.add(template.id.toString());
                        } else {
                            selectedTemplateIds.delete(template.id.toString());
                        }
                        saveSelectedTemplatesToStorage();
                        updateSelectedCount();
                    });
                    
                    templateItems.appendChild(item);
                });
                
                phaseGroup.appendChild(templateItems);
                container.appendChild(phaseGroup);
            });

            updateSelectedCount();
        }

        // 選択数更新
        function updateSelectedCount() {
            const count = selectedTemplateIds.size;
            document.getElementById('selectedCount').textContent = count;
        }

        // すべて選択
        function selectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn.textContent;
            
            // アクティブなフェーズのテンプレートのみ選択
            const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                const title = group.querySelector('.phase-title');
                return title && title.textContent === activePhaseText;
            });
            
            if (phaseGroup) {
                phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = true;
                    selectedTemplateIds.add(checkbox.value);
                });
            }
            
            saveSelectedTemplatesToStorage();
            updateSelectedCount();
        }

        // すべて解除
        function deselectAllTemplates() {
            const activePhaseBtn = document.querySelector('#templateFilters .filter-btn.active');
            const activePhaseText = activePhaseBtn ? activePhaseBtn.textContent : null;
            
            // アクティブなフェーズのテンプレートのみ解除
            const phaseGroup = Array.from(document.querySelectorAll('.template-group')).find(group => {
                const title = group.querySelector('.phase-title');
                return title && (!activePhaseText || title.textContent === activePhaseText);
            });
            
            if (phaseGroup) {
                phaseGroup.querySelectorAll('input[name="templates"]').forEach(checkbox => {
                    checkbox.checked = false;
                    selectedTemplateIds.delete(checkbox.value);
                });
            }
            
            saveSelectedTemplatesToStorage();
            updateSelectedCount();
        }

        // プロジェクト作成
        async function createProject() {
            try {
                const form = document.getElementById('newProjectForm');
                const formData = new FormData(form);
                
                // フォームデータの取得と検証
                const name = formData.get('name')?.trim();
                const clientId = formData.get('client_id');
                const startDate = formData.get('start_date');
                const endDate = formData.get('end_date');
                
                
                // 必須フィールドの検証
                if (!name) {
                    showMessage('プロジェクト名を入力してください', 'error');
                    return;
                }
                
                if (!clientId) {
                    showMessage('発注者を選択してください', 'error');
                    return;
                }
                
                if (!startDate) {
                    showMessage('開始日を入力してください', 'error');
                    return;
                }
                
                if (!endDate) {
                    showMessage('終了日を入力してください', 'error');
                    return;
                }
                
                // 選択されたテンプレート（全フェーズ横断で保持しているSetから取得）
                const selectedTemplates = Array.from(selectedTemplateIds);

                if (selectedTemplates.length === 0) {
                    showMessage('少なくとも1つのテンプレートを選択してください', 'error');
                    return;
                }

                const projectData = {
                    name: name,
                    client_id: clientId,
                    start_date: startDate,
                    end_date: endDate,
                    templates: selectedTemplates
                };

                const response = await fetch('api.php?path=projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('プロジェクトを作成しました', 'success');
                    closeNewProjectModal(); // 保存時のみクローズ
                    await loadProjects();
                    
                    // 新しく作成されたプロジェクトを選択
                    if (data.project_id) {
                        document.getElementById('projectSelect').value = data.project_id;
                        await loadProject(data.project_id);
                    }
                } else {
                    console.error('プロジェクト作成エラー:', data.error || data.message);
                    const errorMessage = data.error || data.message || '不明なエラーが発生しました';
                    showMessage('プロジェクトの作成に失敗しました: ' + errorMessage, 'error');
                }
            } catch (error) {
                console.error('プロジェクト作成エラー:', error);
                showMessage('プロジェクトの作成中にエラーが発生しました: ' + error.message, 'error');
            }
        }

        // プロジェクト編集
        window.editProject = async function() {
            if (!currentProject) {
                showMessage('編集するプロジェクトが選択されていません', 'error');
                return;
            }

            try {
                // クライアント情報を読み込み
                await loadClients();
                
                // フォームにデータを設定
                document.getElementById('editProjectId').value = currentProject.id;
                document.getElementById('editProjectName').value = currentProject.name;
                document.getElementById('editProjectClient').value = currentProject.client_id;
                document.getElementById('editProjectStartDate').value = currentProject.start_date;
                document.getElementById('editProjectEndDate').value = currentProject.end_date || currentProject.target_end_date || '';
                document.getElementById('editProjectStatus').value = currentProject.status;
                
                // テンプレート選択を初期化
                await initProjectTemplateSelection();
                
                document.getElementById('editProjectModal').style.display = 'block';
            } catch (error) {
                console.error('プロジェクト編集モーダル表示エラー:', error);
                showMessage('編集画面の表示に失敗しました', 'error');
            }
        };

        window.closeEditProjectModal = function() {
            document.getElementById('editProjectModal').style.display = 'none';
        };

        // プロジェクト更新
        window.updateProject = async function() {
            try {
                const formData = {
                    id: document.getElementById('editProjectId').value,
                    name: document.getElementById('editProjectName').value,
                    client_id: document.getElementById('editProjectClient').value,
                    start_date: document.getElementById('editProjectStartDate').value,
                    end_date: document.getElementById('editProjectEndDate').value,
                    status: document.getElementById('editProjectStatus').value
                };


                const response = await fetch(`api.php?path=projects/${formData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('プロジェクトを更新しました', 'success');
                    closeEditProjectModal();
                    await loadProjects();
                    await loadProject(formData.id);
                } else {
                    console.error('プロジェクト更新エラー:', data.error || data.message);
                    showMessage('プロジェクトの更新に失敗しました: ' + (data.error || data.message || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('プロジェクト更新エラー:', error);
                showMessage('プロジェクトの更新中にエラーが発生しました: ' + error.message, 'error');
            }
        };

        // プロジェクト削除
        function deleteProject() {
            if (!currentProject) {
                showMessage('削除するプロジェクトが選択されていません', 'error');
                return;
            }

            document.getElementById('deleteProjectName').textContent = currentProject.name;
            document.getElementById('deleteProjectModal').style.display = 'block';
        }

        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').style.display = 'none';
        }

        async function confirmDeleteProject() {
            try {
                const projectId = currentProject.id;

                const response = await fetch(`api.php?path=projects/${projectId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('プロジェクトを削除しました', 'success');
                    closeDeleteProjectModal();
                    hideProjectInfo();
                    // ローカルストレージからも削除
                    localStorage.removeItem('selectedProjectId');
                    await loadProjects();
                    document.getElementById('projectSelect').value = '';
                } else {
                    console.error('プロジェクト削除エラー:', data.error);
                    showMessage('プロジェクトの削除に失敗しました: ' + (data.error || '不明なエラー'), 'error');
                }
            } catch (error) {
                console.error('プロジェクト削除エラー:', error);
                showMessage('プロジェクトの削除中にエラーが発生しました', 'error');
            }
        }

        // プロジェクトデータ更新
        async function refreshProjectData() {
            if (!currentProject) {
                showMessage('更新するプロジェクトが選択されていません', 'error');
                return;
            }

            try {
                showMessage('データを更新中...', 'info');
                await loadProject(currentProject.id);
                showMessage('データを更新しました', 'success');
            } catch (error) {
                console.error('データ更新エラー:', error);
                showMessage('データの更新に失敗しました', 'error');
            }
        }

        // タスクモーダル関連
        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('newNote').value = '';
        }

        // ユーティリティ関数
        function formatDate(dateString) {
            if (!dateString) {
                return '';
            }
            const date = new Date(dateString);
            const formatted = date.toLocaleDateString('ja-JP');
            return formatted;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }

        function getStatusText(status) {
            switch(status) {
                case 'not_started': return '未着手';
                case 'in_progress': return '進行中';
                case 'completed': return '完了';
                case 'needs_confirmation': return '要確認';
                case 'not_applicable': return '対象外';
                case 'pending': return '保留中';

                default: return status;
            }
        }

        // 確認対象者を取得
        function getConfirmationTarget(task) {
            // タスクのメモから@メンションを検索（日本語対応）
            if (task.notes) {
                
                // より柔軟なメンション検索（日本語、英数字、記号に対応）
                const mentionMatches = task.notes.match(/@([^\s@]+)/g);
                if (mentionMatches && mentionMatches.length > 0) {
                    // 最新のメンションを取得
                    const latestMention = mentionMatches[mentionMatches.length - 1];
                    const mentionedUser = latestMention.replace('@', '');
                    return mentionedUser;
                }
            }
            
            // メモがない場合は担当者を確認対象とする
            if (task.assigned_to_name) {
                return task.assigned_to_name;
            }
            
            // 担当者もない場合は管理者
            return '管理者';
        }

        // 新しいメモを即座にUIに追加
        function addMemoToUI(content, noteId) {
            const notesHistory = document.getElementById('notesHistory');
            
            // 現在のユーザー名を取得（デフォルトは「井上直樹」）
            const currentUserName = '井上直樹'; // 実際の実装では認証情報から取得
            
            // 新しいメモアイテムを作成
            const noteItem = document.createElement('div');
            noteItem.className = 'note-item new-memo';
            noteItem.setAttribute('data-note-id', noteId);
            noteItem.innerHTML = `
                <div class="note-header">
                    <div class="note-info">
                        <span class="note-user">${currentUserName}</span>
                        <span class="note-date">${formatDateTime(new Date())}</span>
                    </div>
                    <div class="note-actions">
                        <button type="button" class="btn-edit-note" onclick="editNote(${noteId})" title="編集">✏️</button>
                        <button type="button" class="btn-delete-note" onclick="deleteNote(${noteId})" title="削除">🗑️</button>
                    </div>
                </div>
                <div class="note-content" id="note-content-${noteId}">${formatNoteContent(content)}</div>
                <div class="note-edit-form" id="note-edit-${noteId}" style="display: none;">
                    <textarea class="note-edit-textarea" id="note-edit-text-${noteId}">${content}</textarea>
                    <div class="note-edit-actions">
                        <button type="button" class="btn btn-primary btn-sm" onclick="saveNoteEdit(${noteId})">保存</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelNoteEdit(${noteId})">キャンセル</button>
                    </div>
                </div>
            `;
            
            // メモ一覧の先頭に追加
            if (notesHistory.firstChild) {
                notesHistory.insertBefore(noteItem, notesHistory.firstChild);
            } else {
                notesHistory.appendChild(noteItem);
            }
            
            // アニメーション効果を追加
            noteItem.style.opacity = '0';
            noteItem.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                noteItem.style.transition = 'all 0.3s ease';
                noteItem.style.opacity = '1';
                noteItem.style.transform = 'translateY(0)';
            }, 10);
        }

        // ローディング表示/非表示
        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'block';
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // メッセージ表示
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            if (!container) {
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                background: ${type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ecdc4' : '#667eea'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                animation: slideInRight 0.3s ease;
            `;

            container.appendChild(messageDiv);

            // 3秒後に自動削除
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // テンプレート選択数更新のイベントリスナー
        document.addEventListener('change', function(e) {
            if (e.target.name === 'templates') {
                updateSelectedCount();
            }
        });


        // ==================== タスク管理機能 ====================
        
        // プロジェクトのタスク一覧を編集用に読み込み
        async function loadProjectTasksForEdit() {
            if (!currentProject) return;
            
            try {
                const response = await fetch(`api.php?path=projects/${currentProject.id}/tasks`);
                const data = await response.json();
                
                if (data.success) {
                    displayProjectTasksForEdit(data.tasks);
                } else {
                    console.error('タスク一覧の取得に失敗:', data.message);
                }
            } catch (error) {
                console.error('タスク一覧の取得エラー:', error);
            }
        }

        // プロジェクトのタスク一覧を編集画面に表示
        function displayProjectTasksForEdit(tasks) {
            const tasksList = document.getElementById('projectTasksList');
            if (!tasksList) {
                return;
            }
            
            tasksList.innerHTML = '';
            
            if (!tasks || tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">タスクがありません</p>';
                return;
            }
            
            // フェーズごとにグループ化
            const tasksByPhase = {};
            tasks.forEach(task => {
                if (!tasksByPhase[task.phase_name]) {
                    tasksByPhase[task.phase_name] = [];
                }
                tasksByPhase[task.phase_name].push(task);
            });
            
            // フェーズごとに表示
            Object.keys(tasksByPhase).sort().forEach(phaseName => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'phase-tasks-group';
                phaseDiv.innerHTML = `<h5>${phaseName}</h5>`;
                
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'phase-tasks-container';
                
                tasksByPhase[phaseName].forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'project-task-item';
                    taskItem.innerHTML = `
                        <div class="task-info">
                            <span class="task-name">${task.task_name}</span>
                            <span class="task-status status-${task.status || 'not_started'}">${getStatusText(task.status || 'not_started')}</span>
                            ${task.estimated_hours ? `<span class="task-hours">${task.estimated_hours}h</span>` : ''}
                            ${task.is_technical_work ? '<span class="task-flag technical">技術</span>' : ''}
                            ${task.has_manual ? '<span class="task-flag manual">マニュアル</span>' : ''}
                        </div>
                        <div class="task-actions">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="editProjectTask(${task.id})" title="編集">✏️</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeProjectTask(${task.id})" title="削除">🗑️</button>
                        </div>
                    `;
                    tasksContainer.appendChild(taskItem);
                });
                
                phaseDiv.appendChild(tasksContainer);
                tasksList.appendChild(phaseDiv);
            });
        }

        // 新しいタスクを追加
        window.addNewTaskToProject = function() {
            if (!currentProject) {
                showMessage('プロジェクトが選択されていません', 'error');
                return;
            }
            
            // フォームをリセット
            document.getElementById('taskEditForm').reset();
            document.getElementById('editTaskId').value = '';
            document.getElementById('editTaskProjectId').value = currentProject.id;
            document.getElementById('taskEditModalTitle').textContent = 'タスク追加';
            
            document.getElementById('taskEditModal').style.display = 'block';
        };

        // プロジェクトのタスクを編集
        async function editProjectTask(taskId) {
            try {
                const response = await fetch(`api.php?path=tasks/${taskId}`);
                const data = await response.json();
                
                if (data.success) {
                    const task = data.task;
                    
                    // フォームにデータを設定
                    document.getElementById('editTaskId').value = task.id;
                    document.getElementById('editTaskProjectId').value = task.project_id;
                    document.getElementById('editTaskName').value = task.task_name;
                    document.getElementById('editTaskPhase').value = task.phase_name;
                    document.getElementById('editTaskOrder').value = task.task_order || 0;
                    document.getElementById('editTaskEstimatedHours').value = task.estimated_hours || '';
                    document.getElementById('editTaskIsTechnical').checked = task.is_technical_work == 1;
                    document.getElementById('editTaskHasManual').checked = task.has_manual == 1;
                    
                    document.getElementById('taskEditModalTitle').textContent = 'タスク編集';
                    document.getElementById('taskEditModal').style.display = 'block';
                } else {
                    showMessage('タスク情報の取得に失敗しました', 'error');
                }
            } catch (error) {
                console.error('タスク編集エラー:', error);
                showMessage('タスク情報の取得中にエラーが発生しました', 'error');
            }
        }

        // タスク編集モーダルを閉じる
        window.closeTaskEditModal = function() {
            document.getElementById('taskEditModal').style.display = 'none';
        };

        // タスクの保存
        window.saveTaskEdit = async function() {
            const taskId = document.getElementById('editTaskId').value;
            const projectId = document.getElementById('editTaskProjectId').value;
            const taskName = document.getElementById('editTaskName').value.trim();
            const phaseName = document.getElementById('editTaskPhase').value;
            const taskOrder = parseInt(document.getElementById('editTaskOrder').value) || 0;
            const estimatedHours = parseFloat(document.getElementById('editTaskEstimatedHours').value) || null;
            const isTechnicalWork = document.getElementById('editTaskIsTechnical').checked;
            const hasManual = document.getElementById('editTaskHasManual').checked;
            
            if (!taskName) {
                showMessage('タスク名を入力してください', 'error');
                return;
            }
            
            try {
                const isEdit = taskId !== '';
                const endpoint = isEdit ? 'projects/tasks/update' : 'projects/tasks/add';
                
                const requestData = {
                    task_name: taskName,
                    phase_name: phaseName,
                    task_order: taskOrder,
                    estimated_hours: estimatedHours,
                    is_technical_work: isTechnicalWork,
                    has_manual: hasManual
                };
                
                if (isEdit) {
                    requestData.task_id = taskId;
                } else {
                    requestData.project_id = projectId;
                }
                
                const response = await fetch(`api.php?path=${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeTaskEditModal();
                    await loadProjectTasksForEdit();
                } else {
                    showMessage(data.message || 'タスクの保存に失敗しました', 'error');
                }
            } catch (error) {
                console.error('タスク保存エラー:', error);
                showMessage('タスクの保存中にエラーが発生しました', 'error');
            }
        };

        // プロジェクトからタスクを削除
        async function removeProjectTask(taskId) {
            if (!confirm('このタスクを削除しますか？')) {
                return;
            }
            
            try {
                const response = await fetch('api.php?path=projects/tasks/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task_id: taskId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    await loadProjectTasksForEdit();
                } else {
                    showMessage(data.message || 'タスクの削除に失敗しました', 'error');
                }
            } catch (error) {
                console.error('タスク削除エラー:', error);
                showMessage('タスクの削除中にエラーが発生しました', 'error');
            }
        }

        // ==================== テンプレート選択ライブラリ ====================
        
        // テンプレート選択ライブラリ
        const TemplateSelector = {
            // 設定
            config: {
                containerId: null,
                onSelectionChange: null,
                onAddTemplates: null,
                mode: 'new_project' // 'new_project' or 'edit_project'
            },
            
            // 状態
            state: {
                allTemplates: [],
                filteredTemplates: [],
                selectedTemplateIds: new Set(),
                activePhase: 'all'
            },
            
            // 初期化
            init: function(config) {
                this.config = { ...this.config, ...config };
                this.state.selectedTemplateIds.clear();
                this.state.activePhase = 'all';
                this.loadTemplates();
            },
            
            // テンプレート読み込み
            loadTemplates: async function() {
                try {
                    const response = await fetch('api.php?path=templates');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.success && data.templates) {
                        this.state.allTemplates = data.templates;
                        this.render();
                    } else {
                        console.error('テンプレート読み込みエラー:', data.error || data.message);
                    }
                } catch (error) {
                    console.error('テンプレート読み込みエラー:', error);
                }
            },
            
            // レンダリング
            render: function() {
                if (!this.config.containerId) return;
                
                const container = document.getElementById(this.config.containerId);
                if (!container) return;
                
                // フェーズフィルターボタンを生成
                this.renderPhaseFilters(container);
                
                // テンプレート一覧を生成
                this.renderTemplateList(container);
                
                // サマリーを生成
                this.renderSummary(container);
                
                // 選択済み件数を更新
                this.updateSelectedCount();
            },
            
            // フェーズフィルターボタンを生成
            renderPhaseFilters: function(container) {
                const filtersContainer = container.querySelector('.template-filters') || 
                                       container.querySelector('#templateFilters');
                if (!filtersContainer) return;
                
                // フェーズを取得
                const phases = [...new Set(this.state.allTemplates.map(t => t.phase_name))].sort();
                
                filtersContainer.innerHTML = '';
                phases.forEach(phase => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'phase-filter-btn';
                    button.textContent = phase;
                    button.onclick = () => this.setActivePhase(phase);
                    filtersContainer.appendChild(button);
                });
                
                // すべてボタンを追加
                const allButton = document.createElement('button');
                allButton.type = 'button';
                allButton.className = 'phase-filter-btn active';
                allButton.textContent = 'すべて';
                allButton.onclick = () => this.setActivePhase('all');
                filtersContainer.insertBefore(allButton, filtersContainer.firstChild);
            },
            
            // テンプレート一覧を生成
            renderTemplateList: function(container) {
                const listContainer = container.querySelector('.template-groups') || 
                                    container.querySelector('#templateGroups') ||
                                    container.querySelector('#templateList');
                if (!listContainer) return;
                
                // フィルタリング
                this.filterTemplates();
                
                // フェーズごとにグループ化
                const groupedTemplates = {};
                this.state.filteredTemplates.forEach(template => {
                    if (!groupedTemplates[template.phase_name]) {
                        groupedTemplates[template.phase_name] = [];
                    }
                    groupedTemplates[template.phase_name].push(template);
                });
                
                listContainer.innerHTML = '';
                Object.keys(groupedTemplates).sort().forEach(phase => {
                    const phaseGroup = document.createElement('div');
                    phaseGroup.className = 'template-phase-group';
                    phaseGroup.innerHTML = `<h6>${phase}</h6>`;
                    
                    const templatesContainer = document.createElement('div');
                    templatesContainer.className = 'template-items';
                    
                    groupedTemplates[phase].forEach(template => {
                        const templateItem = this.createTemplateItem(template);
                        templatesContainer.appendChild(templateItem);
                    });
                    
                    phaseGroup.appendChild(templatesContainer);
                    listContainer.appendChild(phaseGroup);
                });
                
                // 選択済み件数を更新
                this.updateSelectedCount();
            },
            
            // テンプレートアイテムを作成
            createTemplateItem: function(template) {
                const item = document.createElement('div');
                item.className = 'template-item';
                
                const isSelected = this.state.selectedTemplateIds.has(template.id.toString());
                
                item.innerHTML = `
                    <label class="template-checkbox-label">
                        <input type="checkbox" name="templates" value="${template.id}" 
                               ${isSelected ? 'checked' : ''}>
                        <div class="template-info">
                            <div class="template-name">${template.task_name}</div>
                            <div class="template-meta">
                                ${template.is_technical_work ? '<span class="template-flag technical">技術</span>' : ''}
                                ${template.has_manual ? '<span class="template-flag manual">マニュアル</span>' : ''}
                                ${template.estimated_hours ? `<span class="template-hours">${template.estimated_hours}h</span>` : ''}
                            </div>
                        </div>
                    </label>
                `;
                
                // チェックボックスのイベントリスナー
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.state.selectedTemplateIds.add(template.id.toString());
                    } else {
                        this.state.selectedTemplateIds.delete(template.id.toString());
                    }
                    
                    // 複数回試行して確実に更新
                    this.updateSelectedCount();
                    setTimeout(() => this.updateSelectedCount(), 50);
                    setTimeout(() => this.updateSelectedCount(), 150);
                    
                    if (this.config.onSelectionChange) {
                        this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                    }
                });
                
                return item;
            },
            
            // サマリーを生成
            renderSummary: function(container) {
                // プロジェクト編集モードでは template-actions を優先
                let summaryContainer;
                if (this.config.mode === 'edit_project') {
                    summaryContainer = container.querySelector('.template-actions');
                } else {
                    summaryContainer = container.querySelector('.template-summary') || 
                                     container.querySelector('.template-actions');
                }
                
                if (!summaryContainer) {
                    console.warn('Summary container not found for mode:', this.config.mode);
                    return;
                }
                
                
                if (this.config.mode === 'new_project') {
                    summaryContainer.innerHTML = `
                        <span>選択済み: <span id="selectedCount">0</span>件</span>
                        <button type="button" class="btn btn-secondary" onclick="TemplateSelector.selectAll()">すべて選択</button>
                        <button type="button" class="btn btn-secondary" onclick="TemplateSelector.deselectAll()">すべて解除</button>
                    `;
                } else {
                    summaryContainer.innerHTML = `
                        <span>選択済み: <span id="selectedCount">0</span>件</span>
                        <span style="color: #666; font-size: 0.9em; margin-left: 10px;">※ チェックを変更すると自動的に更新されます</span>
                    `;
                }
                
            },
            
            // アクティブフェーズを設定
            setActivePhase: function(phase) {
                this.state.activePhase = phase;
                
                // ボタンのアクティブ状態を更新
                const buttons = document.querySelectorAll('.phase-filter-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent === phase || (phase === 'all' && btn.textContent === 'すべて')) {
                        btn.classList.add('active');
                    }
                });
                
                this.renderTemplateList(document.getElementById(this.config.containerId));
            },
            
            // テンプレートをフィルタリング
            filterTemplates: function() {
                this.state.filteredTemplates = this.state.allTemplates.filter(template => {
                    if (this.state.activePhase !== 'all' && template.phase_name !== this.state.activePhase) {
                        return false;
                    }
                    return true;
                });
            },
            
            // 選択済み数を更新
            updateSelectedCount: function() {
                const count = this.state.selectedTemplateIds.size;
                
                // プロジェクト編集モードの場合は、templateSelectionArea内の要素のみを更新
                if (this.config.mode === 'edit_project') {
                    const templateArea = document.getElementById('templateSelectionArea');
                    if (templateArea) {
                        // template-actions内のselectedCount要素を更新
                        const actionsContainer = templateArea.querySelector('.template-actions');
                        if (actionsContainer) {
                            const countElement = actionsContainer.querySelector('#selectedCount');
                            if (countElement) {
                                countElement.textContent = count;
                            } else {
                                // 要素が見つからない場合は再生成
                                actionsContainer.innerHTML = `
                                    <span>選択済み: <span id="selectedCount">${count}</span>件</span>
                                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">※ チェックを変更すると自動的に更新されます</span>
                                `;
                            }
                        }
                    }
                } else {
                    // 新規プロジェクトモードの場合は、全てのselectedCount要素を更新
                    const allCountElements = document.querySelectorAll('#selectedCount');
                    // console.log('Found selectedCount elements:', allCountElements.length);
                    
                    allCountElements.forEach((element, index) => {
                        element.textContent = count;
                        // console.log(`Updated selectedCount element ${index + 1} to:`, count);
                    });
                }
            },
            
            // すべて選択
            selectAll: function() {
                this.state.filteredTemplates.forEach(template => {
                    this.state.selectedTemplateIds.add(template.id.toString());
                });
                this.renderTemplateList(document.getElementById(this.config.containerId));
                this.updateSelectedCount();
                if (this.config.onSelectionChange) {
                    this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // すべて解除
            deselectAll: function() {
                this.state.filteredTemplates.forEach(template => {
                    this.state.selectedTemplateIds.delete(template.id.toString());
                });
                this.renderTemplateList(document.getElementById(this.config.containerId));
                this.updateSelectedCount();
                if (this.config.onSelectionChange) {
                    this.config.onSelectionChange(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // 選択したテンプレートを追加（編集モード用）
            addSelectedTemplates: async function() {
                if (this.state.selectedTemplateIds.size === 0) {
                    showMessage('追加するテンプレートを選択してください', 'warning');
                    return;
                }
                
                if (this.config.onAddTemplates) {
                    await this.config.onAddTemplates(Array.from(this.state.selectedTemplateIds));
                }
            },
            
            // キャンセル（編集モード用）
            cancel: function() {
                if (this.config.onCancel) {
                    this.config.onCancel();
                }
            },
            
            // 選択されたテンプレートIDを取得
            getSelectedTemplateIds: function() {
                return Array.from(this.state.selectedTemplateIds);
            },
            
            // 選択をクリア
            clearSelection: function() {
                this.state.selectedTemplateIds.clear();
                this.updateSelectedCount();
            }
        };
        
        // ==================== 既存のテンプレート選択機能（後方互換性のため保持） ====================
        
        let filteredTemplates = [];
        
        // プロジェクト編集でテンプレート選択を初期化
        async function initProjectTemplateSelection() {
            if (!currentProject) return;
            
            try {
                // 現在のプロジェクトのタスクとテンプレート一覧を並行取得
                const [tasksResponse, templatesResponse] = await Promise.all([
                    fetch(`api.php?path=projects/${currentProject.id}/tasks`),
                    fetch('api.php?path=templates')
                ]);
                
                const [tasksData, templatesData] = await Promise.all([
                    tasksResponse.json(),
                    templatesResponse.json()
                ]);
                
                let usedTemplateIds = new Set();
                
                if (tasksData.success && tasksData.tasks && templatesData.success && templatesData.templates) {
                    // タスク名からテンプレートを特定
                    tasksData.tasks.forEach(task => {
                        // まずtemplate_idで確認
                        if (task.template_id) {
                            usedTemplateIds.add(task.template_id.toString());
                        } else {
                            // template_idがない場合は、タスク名でテンプレートを検索
                            const matchingTemplate = templatesData.templates.find(template => 
                                template.task_name === task.task_name || template.task_name === task.name
                            );
                            if (matchingTemplate) {
                                usedTemplateIds.add(matchingTemplate.id.toString());
                            }
                        }
                    });
                    
                    // console.log('使用中のテンプレートID:', Array.from(usedTemplateIds));
                }
                
                // ライブラリ化したテンプレート選択機能を初期化
                TemplateSelector.init({
                    containerId: 'templateSelectionArea',
                    mode: 'edit_project',
                    onSelectionChange: async function(selectedIds) {
                        // チェックボックス変更時に自動的にプロジェクトのタスクを更新
                        try {
                            // console.log('テンプレート選択が変更されました:', selectedIds);
                            
                            // 現在のプロジェクトのタスクを取得
                            const currentTasks = allTasks.filter(task => task.project_id == currentProject.id);
                            const currentTemplateIds = currentTasks
                                .filter(task => task.template_id)
                                .map(task => task.template_id.toString());
                            
                            // console.log('現在のテンプレートID:', currentTemplateIds);
                            // console.log('選択されたテンプレートID:', selectedIds);
                            
                            // 追加するテンプレート（選択されたが現在存在しないもの）
                            const toAdd = selectedIds.filter(id => !currentTemplateIds.includes(id));
                            
                            // 削除するテンプレート（現在存在するが選択されていないもの）
                            const toRemove = currentTemplateIds.filter(id => !selectedIds.includes(id));
                            
                            // console.log('追加するテンプレート:', toAdd);
                            // console.log('削除するテンプレート:', toRemove);
                            
                            // 削除処理
                            if (toRemove.length > 0) {
                                for (const templateId of toRemove) {
                                    const tasksToRemove = currentTasks.filter(task => task.template_id == templateId);
                                    for (const task of tasksToRemove) {
                                        const response = await fetch('api.php?path=projects/tasks/remove', {
                                            method: 'DELETE',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({
                                                task_id: task.id
                                            })
                                        });
                                        
                                        const data = await response.json();
                                        if (data.success) {
                                            // console.log(`タスク ${task.id} を削除しました`);
                                        }
                                    }
                                }
                            }
                            
                            // 追加処理
                            if (toAdd.length > 0) {
                                const response = await fetch('api.php?path=projects/tasks/add-from-templates', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        project_id: currentProject.id,
                                        template_ids: toAdd
                                    })
                                });
                                
                                const data = await response.json();
                                if (data.success) {
                                    // console.log('テンプレートからタスクを追加しました:', data.message);
                                }
                            }
                            
                            // プロジェクトを再読み込み
                            if (toAdd.length > 0 || toRemove.length > 0) {
                                await loadProject(currentProject.id);
                                showMessage('プロジェクトのタスクを更新しました', 'success');
                            }
                            
                        } catch (error) {
                            console.error('テンプレート選択変更エラー:', error);
                            showMessage('テンプレート選択の更新中にエラーが発生しました', 'error');
                        }
                    },
                    onCancel: function() {
                        // キャンセル時は何もしない（常に表示）
                    }
                });
                
                // 使用中のテンプレートにチェックを入れる
                setTimeout(() => {
                    // console.log('Setting up initial template selection for project edit');
                    // console.log('usedTemplateIds:', usedTemplateIds);
                    
                    usedTemplateIds.forEach(templateId => {
                        const checkbox = document.querySelector(`input[name="templates"][value="${templateId}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            TemplateSelector.state.selectedTemplateIds.add(templateId);
                            // console.log(`Checked template ${templateId}`);
                        } else {
                            console.warn(`Checkbox not found for template ${templateId}`);
                        }
                    });
                    
                    // console.log('Final selectedTemplateIds:', Array.from(TemplateSelector.state.selectedTemplateIds));
                    
                    // 複数回試行して確実に更新
                    TemplateSelector.updateSelectedCount();
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 100);
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 300);
                    setTimeout(() => TemplateSelector.updateSelectedCount(), 500);
                    
                    // 強制的にDOMを更新
                    setTimeout(() => {
                        const templateArea = document.getElementById('templateSelectionArea');
                        if (templateArea) {
                            const summaryContainer = templateArea.querySelector('.template-summary');
                            if (summaryContainer) {
                                const currentCount = TemplateSelector.state.selectedTemplateIds.size;
                                summaryContainer.innerHTML = `
                                    <span>選択済み: <span id="selectedCount">${currentCount}</span>件</span>
                                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">※ チェックを変更すると自動的に更新されます</span>
                                `;
                                // console.log('Force updated summary container with count:', currentCount);
                            }
                        }
                    }, 600);
                }, 200);
                
            } catch (error) {
                console.error('テンプレート選択初期化エラー:', error);
            }
        }
        
        // 古いテンプレート選択機能は削除されました（ライブラリ化により置き換え）

        // フィルタ適用機能
        function applyFilters() {
            // console.log('フィルタを適用中...');
            loadProjects();
        }

        // プロジェクト統計の更新
        function updateProjectStats(projects) {
            const stats = {
                total: projects.length,
                planning: 0,
                in_progress: 0,
                completed: 0,
                cancelled: 0,
                totalTasks: 0,
                completedTasks: 0,
                notStartedTasks: 0,
                needsConfirmationTasks: 0
            };

            projects.forEach(project => {
                stats[project.status] = (stats[project.status] || 0) + 1;
                stats.totalTasks += parseInt(project.total_tasks || 0);
                stats.completedTasks += parseInt(project.completed_tasks || 0);
                stats.notStartedTasks += parseInt(project.not_started_tasks || 0);
                stats.needsConfirmationTasks += parseInt(project.needs_confirmation_tasks || 0);
            });

            // 統計表示の更新（グローバル統計として表示）
            updateGlobalStats(stats);
        }

        // グローバル統計の更新
        function updateGlobalStats(stats) {
            // プロジェクト数統計
            const projectStatsElement = document.getElementById('projectStats');
            if (projectStatsElement) {
                projectStatsElement.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${stats.total}</span>
                        <span class="stat-label">総プロジェクト数</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.in_progress}</span>
                        <span class="stat-label">進行中</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.completed}</span>
                        <span class="stat-label">完了</span>
                    </div>
                `;
            }

            // タスク統計
            const taskStatsElement = document.getElementById('taskStats');
            if (taskStatsElement) {
                taskStatsElement.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${stats.totalTasks}</span>
                        <span class="stat-label">総タスク数</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.notStartedTasks}</span>
                        <span class="stat-label">未着手</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.completedTasks}</span>
                        <span class="stat-label">完了</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number danger">${stats.needsConfirmationTasks}</span>
                        <span class="stat-label">要確認</span>
                    </div>
                `;
            }
        }

        // 要確認タスク一覧モーダル
        async function openNeedsConfirmationModal() {
            try {
                document.getElementById('needsConfirmationModal').style.display = 'block';
                await loadNeedsConfirmationTasks();
            } catch (error) {
                console.error('要確認タスク一覧表示エラー:', error);
                showMessage('要確認タスク一覧の表示中にエラーが発生しました', 'error');
            }
        }

        function closeNeedsConfirmationModal() {
            document.getElementById('needsConfirmationModal').style.display = 'none';
        }

        async function loadNeedsConfirmationTasks() {
            try {
                const response = await fetch('api.php?path=tasks/needs_confirmation');
                const data = await response.json();
                
                if (data.success && data.tasks) {
                    displayNeedsConfirmationTasks(data.tasks);
                } else {
                    document.getElementById('needsConfirmationList').innerHTML = 
                        '<div class="empty">要確認タスクはありません</div>';
                }
            } catch (error) {
                console.error('要確認タスク読み込みエラー:', error);
                document.getElementById('needsConfirmationList').innerHTML = 
                    '<div class="error">読み込みに失敗しました</div>';
            }
        }

        function displayNeedsConfirmationTasks(tasks) {
            const container = document.getElementById('needsConfirmationList');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">要確認タスクはありません</div>';
                return;
            }

            const html = tasks.map(task => `
                <div class="task-list-item needs-confirmation" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-item-header">
                        <h4>${task.task_name}</h4>
                        <span class="task-status status-needs_confirmation">要確認</span>
                    </div>
                    <div class="task-item-meta">
                        <div class="task-project">プロジェクト: ${task.project_name}</div>
                        <div class="task-assignee">担当者: ${task.assigned_to_name || '未割当'}</div>
                        <div class="task-date">期限: ${task.planned_date ? formatDate(task.planned_date) : '期限なし'}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // 期限切れタスク一覧モーダル
        async function openOverdueTasksModal() {
            try {
                document.getElementById('overdueTasksModal').style.display = 'block';
                await loadOverdueTasks();
            } catch (error) {
                console.error('期限切れタスク一覧表示エラー:', error);
                showMessage('期限切れタスク一覧の表示中にエラーが発生しました', 'error');
            }
        }

        function closeOverdueTasksModal() {
            document.getElementById('overdueTasksModal').style.display = 'none';
        }

        async function loadOverdueTasks() {
            try {
                const response = await fetch('api.php?path=tasks/overdue');
                const data = await response.json();
                
                if (data.success && data.tasks) {
                    displayOverdueTasks(data.tasks);
                } else {
                    document.getElementById('overdueTasksList').innerHTML = 
                        '<div class="empty">期限切れタスクはありません</div>';
                }
            } catch (error) {
                console.error('期限切れタスク読み込みエラー:', error);
                document.getElementById('overdueTasksList').innerHTML = 
                    '<div class="error">読み込みに失敗しました</div>';
            }
        }

        function displayOverdueTasks(tasks) {
            const container = document.getElementById('overdueTasksList');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">期限切れタスクはありません</div>';
                return;
            }

            const html = tasks.map(task => `
                <div class="task-list-item overdue" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-item-header">
                        <h4>${task.task_name}</h4>
                        <span class="task-status status-overdue">遅延 ${task.days_overdue}日</span>
                    </div>
                    <div class="task-item-meta">
                        <div class="task-project">プロジェクト: ${task.project_name}</div>
                        <div class="task-assignee">担当者: ${task.assigned_to_name || '未割当'}</div>
                        <div class="task-date overdue">期限: ${task.planned_date ? formatDate(task.planned_date) : '期限なし'}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // タスク一覧からタスクを開く
        async function openTaskFromList(projectId, taskId) {
            try {
                console.log('openTaskFromList呼び出し:', projectId, taskId);
                
                // プロジェクトを選択
                selectProject(projectId);
                
                // 少し待ってからタスクを開く
                setTimeout(() => {
                    editTask(taskId);
                }, 1000);
                
                // モーダルを閉じる
                closeNeedsConfirmationModal();
                closeOverdueTasksModal();
            } catch (error) {
                console.error('タスク表示エラー:', error);
                showMessage('タスクの表示中にエラーが発生しました', 'error');
            }
        }

        // 更新機能
        function refreshNeedsConfirmationList() {
            loadNeedsConfirmationTasks();
        }

        function refreshOverdueTasksList() {
            loadOverdueTasks();
        }

        // タスク追加モーダルを開く
        function openAddTaskModal() {
            if (!currentProject) {
                showMessage('プロジェクトが選択されていません', 'error');
                return;
            }
            
            // フォームをリセット
            document.getElementById('taskEditForm').reset();
            document.getElementById('editTaskId').value = '';
            document.getElementById('editTaskProjectId').value = currentProject.id;
            document.getElementById('taskEditModalTitle').textContent = 'タスク追加';
            
            // フェーズ選択肢を設定
            loadPhaseOptionsForTask();
            
            document.getElementById('taskEditModal').style.display = 'block';
        }

        // タスク編集モーダルを閉じる
        function closeTaskEditModal() {
            document.getElementById('taskEditModal').style.display = 'none';
        }

        // タスク用フェーズ選択肢を読み込み
        async function loadPhaseOptionsForTask() {
            try {
                const response = await fetch('api.php?path=phases');
                const data = await response.json();
                
                if (data.success && data.phases) {
                    const select = document.getElementById('editTaskPhaseName');
                    select.innerHTML = '<option value="">選択してください</option>';
                    
                    data.phases.forEach(phase => {
                        const option = document.createElement('option');
                        option.value = phase.name;
                        option.textContent = phase.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('フェーズ選択肢読み込みエラー:', error);
            }
        }

        // プロジェクト編集モーダルを開く
        function openEditProjectModal() {
            if (!currentProject) {
                showMessage('プロジェクトが選択されていません', 'error');
                return;
            }
            
            // フォームに現在の値を設定
            document.getElementById('editProjectId').value = currentProject.id;
            document.getElementById('editProjectName').value = currentProject.name;
            document.getElementById('editProjectCode').value = currentProject.project_code || '';
            document.getElementById('editProjectClient').value = currentProject.client_name || '';
            document.getElementById('editProjectDescription').value = currentProject.description || '';
            document.getElementById('editProjectStartDate').value = currentProject.start_date || '';
            document.getElementById('editProjectEndDate').value = currentProject.target_end_date || '';
            document.getElementById('editProjectStatus').value = currentProject.status || 'planning';
            
            document.getElementById('editProjectModal').style.display = 'block';
        }

        // プロジェクト編集モーダルを閉じる
        function closeEditProjectModal() {
            document.getElementById('editProjectModal').style.display = 'none';
        }

        // プロジェクト削除モーダルを開く
        function openDeleteProjectModal() {
            if (!currentProject) {
                showMessage('プロジェクトが選択されていません', 'error');
                return;
            }
            
            document.getElementById('deleteProjectModal').style.display = 'block';
        }

        // プロジェクト削除モーダルを閉じる
        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').style.display = 'none';
        }


        // ダッシュボード機能
        async function loadDashboard() {
            try {
                // console.log('ダッシュボードデータを読み込み中...');
                const response = await fetch('api.php?path=dashboard');
                const data = await response.json();
                
                if (data.success) {
                    updateDashboard(data);
                } else {
                    console.error('ダッシュボード読み込みエラー:', data.error);
                    showMessage('ダッシュボードの読み込みに失敗しました', 'error');
                }
            } catch (error) {
                console.error('ダッシュボード読み込みエラー:', error);
                showMessage('ダッシュボードの読み込み中にエラーが発生しました', 'error');
            }
        }

        function updateDashboard(data) {
            // プロジェクトが選択されている場合は、そのプロジェクトのタスクのみを表示
            if (currentProject) {
                updateDashboardForCurrentProject();
            } else {
                // プロジェクト統計の更新
                updateProjectStatsDisplay(data.stats.projects);
                
                // タスク統計の更新
                updateTaskStatsDisplay(data.stats.tasks);
                
                // 要確認タスクの表示
                updateDashboardNeedsConfirmation(data.needs_confirmation_tasks);
                
                // 期限切れタスクの表示
                updateDashboardOverdueTasks(data.overdue_tasks);
                
                // 期限間近タスクの表示
                updateDashboardUpcomingTasks(data.upcoming_tasks);
                
                // 最近の活動の表示（簡易版）
                updateRecentActivity(data);
            }
        }

        // 現在のプロジェクト用ダッシュボード更新
        async function updateDashboardForCurrentProject() {
            if (!currentProject) return;
            
            try {
                // プロジェクトのタスク統計を取得
                const response = await fetch(`api.php?path=projects/${currentProject.id}/tasks`);
                const data = await response.json();
                
                if (data.success && data.tasks) {
                    const tasks = data.tasks;
                    
                    // タスク統計を計算
                    const stats = {
                        total: tasks.length,
                        not_started: tasks.filter(t => t.status === 'not_started').length,
                        in_progress: tasks.filter(t => t.status === 'in_progress').length,
                        completed: tasks.filter(t => t.status === 'completed').length,
                        needs_confirmation: tasks.filter(t => t.status === 'needs_confirmation').length,
                        overdue: tasks.filter(t => {
                            return t.planned_date && new Date(t.planned_date) < new Date() && t.status !== 'completed';
                        }).length
                    };
                    
                    // プロジェクトタスク統計を表示
                    updateTaskStatsDisplay(stats);
                    
                    // 要確認タスクを表示
                    const needsConfirmationTasks = tasks.filter(t => t.status === 'needs_confirmation');
                    updateDashboardNeedsConfirmation(needsConfirmationTasks);
                    
                    // 期限切れタスクを表示
                    const overdueTasks = tasks.filter(t => {
                        return t.planned_date && new Date(t.planned_date) < new Date() && t.status !== 'completed';
                    });
                    updateDashboardOverdueTasks(overdueTasks);
                    
                }
            } catch (error) {
                console.error('プロジェクトタスク取得エラー:', error);
            }
        }

        function updateProjectStatsDisplay(projectStats) {
            const container = document.getElementById('projectStats');
            if (!container) {
                // console.log('projectStats要素が見つかりません');
                return;
            }
            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${projectStats.total}</span>
                    <span class="stat-label">総プロジェクト数</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${projectStats.in_progress}</span>
                    <span class="stat-label">進行中</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${projectStats.completed}</span>
                    <span class="stat-label">完了</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${projectStats.planning}</span>
                    <span class="stat-label">計画中</span>
                </div>
            `;
        }

        function updateTaskStatsDisplay(taskStats) {
            const container = document.getElementById('taskStats');
            if (!container) {
                // console.log('taskStats要素が見つかりません');
                return;
            }
            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${taskStats.total}</span>
                    <span class="stat-label">総タスク数</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${taskStats.not_started}</span>
                    <span class="stat-label">未着手</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${taskStats.in_progress}</span>
                    <span class="stat-label">進行中</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${taskStats.completed}</span>
                    <span class="stat-label">完了</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number danger">${taskStats.needs_confirmation}</span>
                    <span class="stat-label">要確認</span>
                </div>
            `;
        }

        function updateDashboardNeedsConfirmation(tasks) {
            const container = document.getElementById('dashboardNeedsConfirmation');
            if (!container) {
                // console.log('dashboardNeedsConfirmation要素が見つかりません');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">要確認タスクはありません</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="dashboard-task-item needs-confirmation" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-name">${task.task_name}</div>
                    <div class="task-project">${task.project_name}</div>
                    <div class="task-assignee">${task.assigned_to_name || '未割当'}</div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">他 ${tasks.length - 5} 件...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateDashboardOverdueTasks(tasks) {
            const container = document.getElementById('dashboardOverdueTasks');
            if (!container) {
                // console.log('dashboardOverdueTasks要素が見つかりません');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">期限切れタスクはありません</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="dashboard-task-item overdue" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-name">${task.task_name}</div>
                    <div class="task-project">${task.project_name}</div>
                    <div class="task-deadline">期限: ${formatDate(task.planned_date)} (${task.days_overdue}日遅れ)</div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">他 ${tasks.length - 5} 件...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateDashboardUpcomingTasks(tasks) {
            const container = document.getElementById('dashboardUpcomingTasks');
            if (!container) {
                // console.log('dashboardUpcomingTasks要素が見つかりません');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">期限間近のタスクはありません</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="dashboard-task-item upcoming" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="task-name">${task.task_name}</div>
                    <div class="task-project">${task.project_name}</div>
                    <div class="task-deadline">期限: ${formatDate(task.planned_date)} (${task.days_until_deadline}日後)</div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">他 ${tasks.length - 5} 件...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateRecentActivity(data) {
            const container = document.getElementById('recentActivity');
            if (!container) {
                // console.log('recentActivity要素が見つかりません');
                return;
            }
            
            // 簡易的な最近の活動表示
            const activities = [];
            
            if (data.needs_confirmation_tasks.length > 0) {
                activities.push({
                    type: 'warning',
                    message: `${data.needs_confirmation_tasks.length}件の要確認タスクがあります`,
                    time: '今'
                });
            }
            
            if (data.overdue_tasks.length > 0) {
                activities.push({
                    type: 'error',
                    message: `${data.overdue_tasks.length}件の期限切れタスクがあります`,
                    time: '今'
                });
            }
            
            if (data.upcoming_tasks.length > 0) {
                activities.push({
                    type: 'info',
                    message: `${data.upcoming_tasks.length}件の期限間近タスクがあります`,
                    time: '今'
                });
            }
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="empty">最近の活動はありません</div>';
                return;
            }

            const html = activities.map(activity => `
                <div class="activity-item ${activity.type}">
                    <div class="activity-message">${activity.message}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // 右カラムの重要なタスクを更新
        function refreshImportantTasks() {
            loadImportantTasks();
        }

        async function loadImportantTasks() {
            try {
                // 要確認、期限切れ、期限間近タスクを並行取得
                const [needsConfirmationResponse, overdueResponse, upcomingResponse] = await Promise.all([
                    fetch('api.php?path=tasks/needs_confirmation'),
                    fetch('api.php?path=tasks/overdue'),
                    fetch('api.php?path=tasks/upcoming')
                ]);

                const needsConfirmationData = await needsConfirmationResponse.json();
                const overdueData = await overdueResponse.json();
                const upcomingData = await upcomingResponse.json();

                // 要確認タスクを表示
                updateRightColumnNeedsConfirmation(needsConfirmationData.success ? needsConfirmationData.tasks : []);
                
                // 期限切れタスクを表示
                updateRightColumnOverdueTasks(overdueData.success ? overdueData.tasks : []);
                
                // 期限間近タスクを表示
                updateRightColumnUpcomingTasks(upcomingData.success ? upcomingData.tasks : []);
            } catch (error) {
                console.error('重要なタスク読み込みエラー:', error);
            }
        }

        function updateRightColumnNeedsConfirmation(tasks) {
            const container = document.getElementById('rightColumnNeedsConfirmation');
            if (!container) {
                // console.log('rightColumnNeedsConfirmation要素が見つかりません');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">要確認タスクはありません</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="important-task-item needs-confirmation" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="important-task-name">${task.task_name}</div>
                    <div class="important-task-project">${task.project_name}</div>
                    <div class="important-task-meta">
                        <span>${task.assigned_to_name || '未割当'}</span>
                        <span>${task.planned_date ? formatDate(task.planned_date) : '期限なし'}</span>
                    </div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">他 ${tasks.length - 5} 件...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateRightColumnOverdueTasks(tasks) {
            const container = document.getElementById('rightColumnOverdueTasks');
            if (!container) {
                // console.log('rightColumnOverdueTasks要素が見つかりません');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">期限切れタスクはありません</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="important-task-item overdue" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="important-task-name">${task.task_name}</div>
                    <div class="important-task-project">${task.project_name}</div>
                    <div class="important-task-meta">
                        <span>${task.assigned_to_name || '未割当'}</span>
                        <span>${task.days_overdue}日遅れ</span>
                    </div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">他 ${tasks.length - 5} 件...</div>` : '';
            container.innerHTML = html + moreText;
        }

        function updateRightColumnUpcomingTasks(tasks) {
            const container = document.getElementById('rightColumnUpcomingTasks');
            if (!container) {
                // console.log('rightColumnUpcomingTasks要素が見つかりません');
                return;
            }
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty">期限間近のタスクはありません</div>';
                return;
            }

            const html = tasks.slice(0, 5).map(task => `
                <div class="important-task-item upcoming" onclick="openTaskFromList(${task.project_id}, ${task.id})">
                    <div class="important-task-name">${task.task_name}</div>
                    <div class="important-task-project">${task.project_name}</div>
                    <div class="important-task-meta">
                        <span>${task.assigned_to_name || '未割当'}</span>
                        <span>${task.days_until_deadline}日後</span>
                    </div>
                </div>
            `).join('');

            const moreText = tasks.length > 5 ? `<div class="more-items">他 ${tasks.length - 5} 件...</div>` : '';
            container.innerHTML = html + moreText;
        }

        // 通知システム
        let notifications = [];
        let notificationCheckInterval = null;

        async function loadNotifications() {
            try {
                // 要確認タスクと期限切れタスクから通知を生成
                const [needsConfirmationResponse, overdueResponse] = await Promise.all([
                    fetch('api.php?path=tasks/needs_confirmation'),
                    fetch('api.php?path=tasks/overdue')
                ]);

                const needsConfirmationData = await needsConfirmationResponse.json();
                const overdueData = await overdueResponse.json();

                notifications = [];

                // 要確認タスクの通知
                if (needsConfirmationData.success && needsConfirmationData.tasks) {
                    needsConfirmationData.tasks.forEach(task => {
                        notifications.push({
                            id: `needs_confirmation_${task.id}`,
                            type: 'warning',
                            title: '要確認タスク',
                            message: `${task.task_name} (${task.project_name})`,
                            taskId: task.id,
                            projectId: task.project_id,
                            timestamp: new Date().toISOString(),
                            read: false
                        });
                    });
                }

                // 期限切れタスクの通知
                if (overdueData.success && overdueData.tasks) {
                    overdueData.tasks.forEach(task => {
                        notifications.push({
                            id: `overdue_${task.id}`,
                            type: 'error',
                            title: '期限切れタスク',
                            message: `${task.task_name} (${task.project_name}) - ${task.days_overdue}日遅れ`,
                            taskId: task.id,
                            projectId: task.project_id,
                            timestamp: new Date().toISOString(),
                            read: false
                        });
                    });
                }

                updateNotificationDisplay();
            } catch (error) {
                console.error('通知読み込みエラー:', error);
            }
        }

        function updateNotificationDisplay() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) {
                // console.log('notificationBadge要素が見つかりません');
                return;
            }
            
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }

            // 通知ドロップダウンが開いている場合は更新
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown && dropdown.style.display !== 'none') {
                displayNotifications();
            }
        }

        function displayNotifications() {
            const container = document.getElementById('notificationList');
            if (!container) {
                // console.log('notificationList要素が見つかりません');
                return;
            }
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty">通知はありません</div>';
                return;
            }

            // 未読の通知を先に表示
            const sortedNotifications = [...notifications].sort((a, b) => {
                if (a.read !== b.read) return a.read - b.read;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            const html = sortedNotifications.map(notification => `
                <div class="notification-item ${notification.read ? 'read' : 'unread'} ${notification.type}" 
                     onclick="handleNotificationClick('${notification.id}')">
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                    </div>
                    ${!notification.read ? '<div class="notification-unread-indicator"></div>' : ''}
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function formatNotificationTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'たった今';
            if (diffMins < 60) return `${diffMins}分前`;
            if (diffHours < 24) return `${diffHours}時間前`;
            return `${diffDays}日前`;
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            if (!dropdown) {
                // console.log('notificationDropdown要素が見つかりません');
                return;
            }
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                displayNotifications();
            } else {
                dropdown.style.display = 'none';
            }
        }

        function handleNotificationClick(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (!notification) return;

            // 通知を既読にする
            notification.read = true;
            updateNotificationDisplay();

            // タスクを開く
            openTaskFromList(notification.projectId, notification.taskId);
        }

        function markAllAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            updateNotificationDisplay();
        }

        function startNotificationCheck() {
            // 5分ごとに通知をチェック
            notificationCheckInterval = setInterval(() => {
                loadNotifications();
            }, 5 * 60 * 1000);
        }

        function stopNotificationCheck() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
                notificationCheckInterval = null;
            }
        }

        // ページ外クリックで通知ドロップダウンを閉じる
        document.addEventListener('click', function(event) {
            const notificationArea = document.querySelector('.notification-area');
            if (notificationArea && !notificationArea.contains(event.target)) {
                document.getElementById('notificationDropdown').style.display = 'none';
            }
        });

        // イベントリスナーの設定
        document.addEventListener('DOMContentLoaded', function() {
            // フィルタ適用ボタン
            const applyFiltersBtn = document.getElementById('applyFilters');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }

            // フィルタ変更時の自動適用
            const statusFilter = document.getElementById('statusFilter');
            const sortBy = document.getElementById('sortBy');
            const sortOrder = document.getElementById('sortOrder');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', applyFilters);
            }
            if (sortBy) {
                sortBy.addEventListener('change', applyFilters);
            }
            if (sortOrder) {
                sortOrder.addEventListener('change', applyFilters);
            }
        });
    </script>
</body>
</html>
